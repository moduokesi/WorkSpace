(function($, window, document, undefined) {
	window.addEventListener("dragover", function(e) {
		e = e || event;
		e.preventDefault();
	}, true);
	window.addEventListener("drop", function(e) {
		e = e || event;
		e.preventDefault();
	}, true);
	const compareMimeType = (mimeTypes, fileType, formatFile) => {
		return true;
	}
	$.fn.imageuploadify = function(opts) {
		console.log("22222");
		const settings = $.extend({}, $.fn.imageuploadify.defaults, opts);
		this.each(function() {
			const self = this;
			if (!$(self).attr("multiple")) {
				return;
			}//尽头
			let result = [];
			let totalFiles = [];
			let counter = 0;
			let dragbox = $(`<div class="imageuploadify well">
			<div class="imageuploadify-overlay">
			<i class="fa fa-picture-o"></i></div>
			<div class="imageuploadify-images-list text-center">
			<i class="bx bxs-cloud-upload"></i>
			<span class='imageuploadify-message'>将文件拖到这里上传</span>
			<button type="button" class="btn btn-default">点击按钮选择文件</button></div></div>`);
			let overlay = dragbox.find(".imageuploadify-overlay");
			let uploadIcon = dragbox.find(".imageuploadify-overlay i");
			let imagesList = dragbox.find(".imageuploadify-images-list");
			let addIcon = dragbox.find(".imageuploadify-images-list i");
			let addMsg = dragbox.find(".imageuploadify-images-list span");
			let button = dragbox.find(".imageuploadify-images-list button");
			const retrieveFiles = (files) => {
				for (let index = 0; index < files.length; ++index) {
					if (compareMimeType(settings.mimeTypes, files[index].type, /(?:\.([^.]+))?$/.exec(files[index].name)[1])) {
						const id = Math.random().toString(36).substr(2, 9);
						readingFile(id, files[index]);
						totalFiles.push({ // 将文件添加到totalFiles数组中
							id: id,
							file: files[index]
						});
					}
				}
			}
			const readingFile = (id, file) => {
				const fReader = new FileReader();
				const width = dragbox.width();
				const boxesNb = Math.floor(width / 100);
				const marginSize = Math.floor((width - (boxesNb * 100)) / (boxesNb + 1));
				let container = $(`<div class='imageuploadify-container'><button type='button' class='btn btn-danger bx bx-x'></button><div class='imageuploadify-details'><span>${file.name}</span><span>${file.type}</span><span>${file.size}</span></div></div>`);
				let details = container.find(".imageuploadify-details");
				let deleteBtn = container.find("button");
				container.css("margin-left", marginSize + "px");
				details.hover(function() {
					$(this).css("opacity", "1");
				}).mouseleave(function() {
					$(this).css("opacity", "0");
				});


				//imagesList.append(container);这里
				console.log(file.type);
				if (file.type && file.type.search(/image/) != -1) {
					fReader.onloadend = function(e) {
						let image = $("<img>");
						image.attr("src", e.target.result);
						container.append(image);
						imagesList.append(container);
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+4)").css("margin-left", marginSize + "px");
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+3)").css("margin-right", marginSize + "px");
					};
				} else if (file.type && file.type === 'application/x-gzip' || file.type === '') {
					fReader.onloadend = function(e) {
						let span = $("<span>"+".nii"+"</span>");
						span.css({
							"font-size": "3em",
							"display": "flex",
							"align-items": "center",
							"justify-content": "center",
							"height": "100%",
						});
						container.append(span);
						imagesList.append(container);
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+4)").css("margin-left", marginSize + "px");
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+3)").css("margin-right", marginSize + "px");
					};
				} else {
					fReader.onloadend = function(e) {
						let span = $("<span>"+".dcm"+"</span>");
						span.css({
							"font-size": "3em",
							"display": "flex",
							"align-items": "center",
							"justify-content": "center",
							"height": "100%",
						});
						container.append(span);
						imagesList.append(container);
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+4)").css("margin-left", marginSize + "px");
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+3)").css("margin-right", marginSize + "px");
					};
				};

				deleteBtn.on("click", function() {
					$(this.parentElement).remove();
					for (let index = 0; totalFiles.length > index; ++index) {
						if (totalFiles[index].id === id) {
							console.log("id="+id);
							totalFiles.splice(index, 1);
							break;
						}
					}
				});
				fReader.readAsDataURL(file);
			};
			const disableMouseEvents = () => {
				overlay.css("display", "flex");
				dragbox.css("border-color", "#3AA0FF");
				button.css("pointer-events", "none");
				addMsg.css("pointer-events", "none");
				addIcon.css("pointer-events", "none");
				imagesList.css("pointer-events", "none");
			}
			const enableMouseEvents = () => {
				overlay.css("display", "none");
				dragbox.css("border-color", "rgb(210, 210, 210)");
				button.css("pointer-events", "initial");
				addMsg.css("pointer-events", "initial");
				addIcon.css("pointer-events", "initial");
				imagesList.css("pointer-events", "initial");
			}
			button.mouseenter(function onMouseEnter(event) {
				button.css("background", "#3AA0FF").css("color", "white");
			}).mouseleave(function onMouseLeave() {
				button.css("background", "white").css("color", "#3AA0FF");
			});
			button.on("click", function onClick(event) {
				event.stopPropagation();
				event.preventDefault();
				$(self).click();
			});
			dragbox.on("dragenter", function onDragenter(event) {
				event.stopPropagation();
				event.preventDefault();
				counter++;
				disableMouseEvents();
			});
			dragbox.on("dragleave", function onDragLeave(event) {
				event.stopPropagation();
				event.preventDefault();
				counter--;
				if (counter === 0) {
					enableMouseEvents();
				}
			});
			dragbox.on("drop", function onDrop(event) {
				event.stopPropagation();
				event.preventDefault();
				enableMouseEvents();
				const files = event.originalEvent.dataTransfer.files;
				retrieveFiles(files);
			});
			$(window).bind("resize", function(e) {
				window.resizeEvt;
				$(window).resize(function() {
					clearTimeout(window.resizeEvt);
					window.resizeEvt = setTimeout(function() {
						const width = dragbox.width();
						const boxesNb = Math.floor(width / 100);
						const marginSize = Math.floor((width - (boxesNb * 100)) / (boxesNb + 1));
						let containers = imagesList.find(".imageuploadify-container");
						for (let index = 0; index < containers.length; ++index) {
							$(containers[index]).css("margin-right", "0px");
							$(containers[index]).css("margin-left", marginSize + "px");
						}
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+4)").css("margin-left", marginSize + "px");
						imagesList.find(".imageuploadify-container:nth-child(" + boxesNb + "n+3)").css("margin-right", marginSize + "px");
					}, 500);
				});
			})

			$(self).on("change", function onChange() {
				const files = this.files;
				retrieveFiles(files);
			});

			$(self).closest("form").on("submit", function(event) {
				console.log("11111");
				event.stopPropagation();
				event.preventDefault(event);
				const inputs = this.querySelectorAll("input, textarea, select, button");
				const formData = new FormData();

				for (var i = 0; i < totalFiles.length; i++) {
					formData.append("files", totalFiles[i].file);
				}

				var xhr = new XMLHttpRequest();

				xhr.onreadystatechange = function(e) {
					console.log("xhr.status="+xhr.status);
					console.log("xhr.readyState="+xhr.readyState);
					console.log("XMLHttpRequest.DONE="+XMLHttpRequest.DONE);
					if (xhr.readyState === 4) {
						if (xhr.status === 200) {
							// 文件上传成功
							Swal.fire({
								icon: 'success',
								title: '文件上传成功！',
							})
						} else {
							// 文件上传失败
							Swal.fire({
								icon: 'warning',
								title: '还未选择文件！',
							})
						}
					}
				}
				xhr.open("POST", $(this).attr("action"), true);
				const jwtToken = storage.getToken();
				xhr.setRequestHeader("token", jwtToken); // 将 YOUR_JWT_TOKEN_HERE 替换为实际的 JWT 令牌值
				xhr.send(formData);
				return false;
			});
			$(self).hide();
			dragbox.insertAfter(this);
		});
		return this;
	};
	$.fn.imageuploadify.defaults = {};
}(jQuery, window, document));