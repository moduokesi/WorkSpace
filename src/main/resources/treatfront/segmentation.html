<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--favicon-->
	<link rel="icon" href="assets/images/3D医疗图标.svg" type="image/png" />
	<!--plugins-->
	<link href="assets/plugins/simplebar/css/simplebar.css" rel="stylesheet" />
	<link href="assets/plugins/select2/css/select2.min.css" rel="stylesheet" />
	<link href="assets/plugins/select2/css/select2-bootstrap4.css" rel="stylesheet" />
	<link href="assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet" />
	<link href="assets/plugins/metismenu/css/metisMenu.min.css" rel="stylesheet" />
	<link href="assets/plugins/fancy-file-uploader/fancy_fileupload.css" rel="stylesheet" />
	<link href="assets/plugins/Drag-And-Drop/dist/imageuploadify.min.css" rel="stylesheet" />
	<!-- loader-->
	<script src="assets/js/storage.js"></script>
	<!-- Bootstrap CSS -->
	<link href="assets/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
	<link href="assets/css/app.css" rel="stylesheet">
	<link href="assets/css/icons.css" rel="stylesheet">
	<!-- Theme Style CSS -->
	<link rel="stylesheet" href="assets/css/dark-theme.css" />
	<link rel="stylesheet" href="assets/css/semi-dark.css" />
	<link rel="stylesheet" href="assets/css/header-colors.css" />
	<link rel="stylesheet" href="assets/css/bootstrap.min.css">

	<!--数据可视化 -->
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

	<!-- iOS meta tags -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

	<link rel="stylesheet" type="text/css" href="papaya/papaya.css?build=1455" />
	<script type="text/javascript" src="papaya/papaya.js?build=1455"></script>


	<title>MED-AI</title>
	<style type="text/css">
		button[type="submit"] {
			color: #FFFFFF;
			background: #0dcaf0;
			border: none;
			padding: 13px 0;
			margin-top: 30px;
			outline: none;
			width: 15%;
			font-size: 8px;
			cursor: pointer;
			letter-spacing: 2px;
			-webkit-transition: 0.5s all;
			-o-transition: 0.5s all;
			-moz-transition: 0.5s all;
			-ms-transition: 0.5s all;
			transition: 0.5s all;
			box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.49);
		}
		button[type="submit"]:hover {
			background: #000;
			-webkit-transition: 0.5s all;
			-o-transition: 0.5s all;
			-moz-transition: 0.5s all;
			-ms-transition: 0.5s all;
			transition: 0.5s all;
			border-collapse: separate;
			-webkit-box-shadow: 0px 0px rgba(255,251,251,1.00);
			box-shadow: 0px 0px rgba(255,251,251,1.00);
			border-style: none;
		}
		input[type="submit"] {
			width: 30%;
		}

		.delete-button {
			background-color: #35aadc; /* 指定背景颜色 */
			color: #fff; /* 指定文字颜色 */
			border: 1px solid #35c9dc; /* 指定边框样式 */
			padding: 5px 10px; /* 指定内边距 */
			/* 添加其他样式属性 */
		}

	</style>

	<style>
		#video-background {
			position: fixed;
			top: 0;
			left: 0;
			width: 200%;
			height: 200%;
			z-index: -1;
		}
	</style>

	<!--THREE.js-->
	<script type="importmap">
		{
		"imports":{
			"three": "./three.js/build/three.module.js",
			"three/addons/": "./three.js/examples/jsm/"
		}
	}
	</script>
</head>

<body>
<!--	<video id="video-background" autoplay loop muted>-->
<!--		<source src="assets/images/background1.mp4" type="video/mp4">-->
<!--		Your browser does not support the video tag.-->
<!--	</video>-->
     <div id="page-layout"></div>
		<!--start page wrapper -->
		<div class="page-wrapper">
			<div class="page-content">
				<!--breadcrumb-->
				<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
					<div class="breadcrumb-title pe-3">器官分割</div>
					<div class="ps-3">
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb mb-0 p-0">
								<li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i></a>
								</li>
								<li class="breadcrumb-item active" aria-current="page">器官分割</li>
							</ol>
						</nav>
					</div>
				</div>
				<!--end breadcrumb-->

				<div class="row">
					<div class="col-xl-9 mx-auto">
						<h6 class="mb-0 text-uppercase">上传文件</h6>
						<hr/>
						<div class="card" id="mochu">
							<div class="card-body">
								<form action="http://localhost:8080/treatment/segt">
									<input id="image-uploadify" type="file" name='test1'multiple>
									<div align="center"><button type="submit" id="btnPost">上传文件</button></div>
								</form>
							</div>
						</div>
						<h6 class="mb-0 text-uppercase">文件管理</h6>
						<hr/>
						<div class="card">
							<div class="card-body">
								<div class="table-responsive">
									<table id="example" class="table table-striped table-bordered" style="width:100%">
										<thead>
										<tr>
											<th>文件名</th>
											<th>文件类型</th>
											<th>文件大小</th>
											<th>操作</th>
										</tr>
										</thead>
										<tbody id="tableBody">
										<!-- JavaScript将动态生成的表格行插入此处 -->
										</tbody>
									</table>
								</div>
							</div>
						</div>
						<h6 class="mb-0 text-uppercase">文件视图</h6>
						<hr/>
						<div class="card">
							<div class="card-body">
								<div class="border p-3 rounded">
									<div class="mb-3">
										<label class="form-label">请选择需要展示的文件</label>
										<select id="fileSelect" class="single-select">
											<option selected="selected" disabled="disabled" hidden="hidden">请选择一个文件</option>
										</select>
										<div class="card-body">
											<div id="papayaViewer"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<h6 class="mb-0 text-uppercase">器官分割</h6>
						<hr/>
						<label class="form-label">选择分割前景</label>
						<select class="single-select">
							<option selected="selected" disabled="disabled" hidden="hidden">请选择一个前景</option>
							<option value="United States">肺肿瘤</option>
							<option value="United Kingdom">多器官</option>
							<option value="Afghanistan">心脏</option>
						</select>
						<hr/>

						<label class="form-label">选择模型</label>
						<select class="single-select">
							<option selected="selected" disabled="disabled" hidden="hidden">请选择一个模型</option>
							<option value="United States">高精度模型：nnU-Net</option>
							<option value="United Kingdom">快速分割模型：V-net</option>
							<option value="Afghanistan">高效模型：nnFormer</option>
						</select>
						<hr/>
						<div class="card">
							<div class="card-body">
								<div class="border p-3 rounded">
									<div class="mb-2">
										<label class="form-label">请选择文件进行分割</label>
										<div class="row">
											<div class="col-10">
												<select id="selectmx" class="single-select">
													<option selected="selected" disabled="disabled" hidden="hidden">请选择一个文件</option>
												</select>
											</div>
											<div class="col-2">
												<button class="btn btn-outline-secondary" type="button" id="submit1">开始分割</button>
											</div>
											<div class="card-body">
												<div id="papayaSeg"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--end switcher-->
	 <button id="change102" hidden="hidden"></button>
	 <script src="assets/js/jquery.min.js"></script>
	 <script src="assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
	 <script src="assets/plugins/fancy-file-uploader/jquery.ui.widget.js"></script>
	 <script src="assets/plugins/fancy-file-uploader/jquery.fileupload.js"></script>
	 <script src="assets/plugins/fancy-file-uploader/jquery.iframe-transport.js"></script>
	 <script src="assets/plugins/fancy-file-uploader/jquery.fancy-fileupload.js"></script>
	 <script src="assets/plugins/Drag-And-Drop/dist/imageuploadify.min.js"></script>
	 <script src="assets/plugins/apexcharts-bundle/js/apexcharts.min.js"></script>
	 <script src="assets/plugins/select2/js/select2.min.js"></script>

	 <script>
		 $(document).ready(function () {
			 $('#image-uploadify').imageuploadify();
		 })
	 </script>

	<script>
		$('.single-select').select2({
			width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
		});

	</script>
	<!--app JS-->
	<script src="assets/js/app.js"></script>
	<!-- 加载边栏资源 -->
	<script>
		$(function() {
			$("#page-layout").load("index.html");
		});
	</script>

	 <script type="text/javascript">
		 $(function() {
			 $.ajax({
				 url: 'http://localhost:8080/treatment/filesInfo',
				 type: 'GET',
				 data: { userAccount: localStorage.getItem('userAccount') },
				 contentType: "application/json",
				 beforeSend: function(xhr) {
					 // 获取JWT字符串
					 const jwtToken = storage.getToken();
					 // 设置 "token" 键名
					 xhr.setRequestHeader("token", jwtToken);
				 },
				 success: function(res) {
					 if (res.status != 200) {
						 alert(res.msg);
					 }

					 const fileAttributes = res.data;
					 const selectBox = $("#selectmx");
					 fileAttributes.forEach(function(file) {
						 const option = $("<option></option>");
						 option.attr('id', 'seg-' + file.fileId); // 使用 attr 方法设置 id 属性
						 option.text(file.fileName + "." + file.fileType);
						 //设置路径
						 option.val(file.fileUrl.replace("\\infile\\", "\\outfile\\dataset\\"));
						 selectBox.append(option);
					 });

					 // 获取下拉框元素
					 var selectFile = document.querySelector("#fileSelect");

					 // 根据数据生成每个选项
					 for (var i = 0; i < res.data.length; i++) {
						 // 创建选项元素
						 var optionElement = document.createElement('option');

						 optionElement.setAttribute('id', 'option-' + res.data[i].fileId);

						 // 设置选项的值和显示文本
						 optionElement.value = res.data[i].fileUrl;

						 optionElement.textContent = res.data[i].fileName + "." + res.data[i].fileType;

						 // 将选项添加到下拉框中
						 selectFile.appendChild(optionElement);
					 }

					 var tableBody = document.getElementById('tableBody');

					 // 根据数据生成每一行的内容
					 for (var i = 0; i < res.data.length; i++) {
						 // 创建表格行
						 var rowElement = document.createElement('tr');
						 rowElement.setAttribute('id', 'row-' + res.data[i].fileId);

						 // 创建文件名单元格并添加数据
						 var fileNameCell = document.createElement('td');
						 var fileNameSpan = document.createElement('span');
						 fileNameSpan.textContent = res.data[i].fileName;
						 fileNameSpan.classList.add('file-name');
						 fileNameCell.appendChild(fileNameSpan);
						 rowElement.appendChild(fileNameCell);

						 // 创建文件类型单元格并添加数据
						 var fileTypeCell = document.createElement('td');
						 fileTypeCell.textContent = res.data[i].fileType;
						 rowElement.appendChild(fileTypeCell);

						 // 创建文件大小单元格并添加数据
						 var fileSizeCell = document.createElement('td');
						 fileSizeCell.textContent = res.data[i].fileSize;
						 rowElement.appendChild(fileSizeCell);

						 // 创建操作单元格并添加按钮
						 var actionCell = document.createElement('td');
						 var actionButton = document.createElement('button');
						 actionButton.textContent = '删除'; // 按钮文本
						 actionButton.classList.add('delete-button'); // 按钮样式类
						 actionButton.dataset.fileId = res.data[i].fileId; // 按钮自定义属性，例如文件ID
						 actionButton.addEventListener('click', handleButtonClick); // 按钮点击事件处理程序
						 actionCell.appendChild(actionButton);
						 rowElement.appendChild(actionCell);

						 // 将行元素添加到表格主体中
						 tableBody.appendChild(rowElement);
					 }
				 },
				 error: function(res) {
					 // 错误处理代码
				 }
			 });
		 });
	 </script>

	 <script>
		 // 按钮点击事件处理程序
		 function handleButtonClick(event) {
			 var fileId = event.target.dataset.fileId;
			 // 根据文件ID执行相应的操作

			 var data = {
				 fileId: fileId
			 }
			 $.ajax({
				 url: 'http://localhost:8080/treatment/deletefile',
				 type: 'POST',
				 data: JSON.stringify(data),
				 contentType: "application/json",
				 beforeSend: function(xhr) {
					 // 获取JWT字符串
					 const jwtToken = storage.getToken();
					 // 设置 "token" 键名
					 xhr.setRequestHeader("token", jwtToken);
				 },
				 success: function (res) {
					 if (res.status != 200) {
						 alert(res.msg)
					 } else {
						 // 1. 获取表格元素
						 var table = document.getElementById("tableBody");
						 // 2. 获取要删除的行
						 var row = document.getElementById("row-" + fileId); // 假设每行的ID为 "row-fileId"
						 // 3. 从表格中移除被删除的行
						 table.removeChild(row);

						 // 1.获取下拉框元素
						 var selectElement1 = document.getElementById("fileSelect");
						 var selectElement2 = document.getElementById("selectmx");

						 // 2.获取当前选中的选项以及需要删除的选项
						 var selectedOption1 = selectElement1.options[selectElement1.selectedIndex];
						 var selectedOption2 = selectElement2.options[selectElement2.selectedIndex];

						 var option1 = document.getElementById("option-" + fileId);
						 var option2 = document.getElementById("seg-" + fileId);
						 // 3. 从下拉框中移除被删除的选项
						 selectElement1.removeChild(option1);
						 selectElement2.removeChild(option2);

						 if (selectedOption1.id === "option-" + fileId) {
							 // 清空Papaya容器内容
							 var div = document.getElementById("papayaViewer");
							 div.innerHTML = "";
							 // 将下拉框的选中值设置为默认值
							 selectElement1.selectedIndex = 0;
						 }

						 if (selectedOption2.id === "seg-" + fileId) {
							 // 清空Papaya容器内容
							 var div = document.getElementById("papayaSeg");
							 div.innerHTML = "";
							 // 将下拉框的选中值设置为默认值
							 selectElement2.selectedIndex = 0;
						 }
					 }
				 },
				 error: function (res) {
					 alert("请求发送失败，请检查网络连接或服务器状态。");
				 }
			 });
		 }
	 </script>

	 <script>
		 // 指定要初始化的元素id
		 var containerId = "papayaViewer";

		 var params = [];
		 params["kioskMode"] = true;
		 params["allowScroll"] = false;
		 params["showControlBar"] = true;

		 $(function () {
			 // 绑定下拉框的change事件处理函数
			 $("#fileSelect").on('change', function () {
				 var url =  $(this).val();
				 var file = $(this).find('option:selected').text(); // 将选中的值赋给变量
				 params["images"] = [url + file];
				console.log(url+file);

				 // 初始化查看器，将其添加到指定的容器中
				 papaya.Container.addViewer(containerId, params);

				 // 在window.onload事件中调用startPapaya函数，确保页面加载完成后再启动Papaya
				 window.onload = function() {
					 papaya.Container.startPapaya();
				 };
			 });
		 });
	 </script>


	 <script>
		 // 获取开始分割按钮元素
		 var submitButton = document.getElementById("submit1");

		 // 为开始分割按钮绑定点击事件处理程序
		 submitButton.addEventListener("click", function() {
			 // 获取下拉框元素
			 const url = $("#selectmx").val();
			 const file = $("#selectmx option:selected").text();

			 // 打印选中的选项的值
			 console.log("选中的值为：" + url);
			 console.log("选中的文本：", file);

			 var data = {
				 fileName : file
			 }
			 $.ajax({
				 url: 'http://localhost:8080/treatment/segOutFiles',
				 type: 'POST',
				 data: JSON.stringify(data),
				 contentType: "application/json",
				 beforeSend: function(xhr) {
					 // 获取JWT字符串
					 const jwtToken = storage.getToken();
					 // 设置 "token" 键名
					 xhr.setRequestHeader("token", jwtToken);
				 },
				 success: function (res) {
					 // 执行其他需要的操作
					 // 指定要初始化的元素id
					 var containerId = "papayaSeg";

					 var params = [];
					 params["kioskMode"] = true;
					 params["allowScroll"] = false;
					 params["showControlBar"] = true;

					 params["images"] = [url + file];

					 params[url + file] = {lut: "Fire"};

					 // 初始化查看器，将其添加到指定的容器中
					 papaya.Container.addViewer(containerId, params);

					 // 在window.onload事件中调用startPapaya函数，确保页面加载完成后再启动Papaya
					 window.onload = function() {
						 papaya.Container.startPapaya();
					 };
				 },
				 error: function (res) {
					 alert("请求发送失败，请检查网络连接或服务器状态。");
				 }
			 });

		 });
	 </script>

</body>

</html>