(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[270],{57270:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AngleTool:()=>ec,AnnotationTool:()=>da,ArrowAnnotateTool:()=>Xd,BaseTool:()=>Ci,BidirectionalTool:()=>Fs,BrushTool:()=>Dr,CONSTANTS:()=>K,CircleROITool:()=>hl,CircleScissorsTool:()=>wc,CobbAngleTool:()=>ic,CrosshairsTool:()=>Rs,DragProbeTool:()=>Js,EllipticalROITool:()=>al,Enums:()=>o,LengthTool:()=>$s,MIPJumpToClickTool:()=>ns,MagnifyTool:()=>Ls,PaintFillTool:()=>Pc,PanTool:()=>Nr,PlanarFreehandROITool:()=>jd,PlanarRotateTool:()=>Br,ProbeTool:()=>Zs,RectangleROIStartEndThresholdTool:()=>Sc,RectangleROIThresholdTool:()=>bc,RectangleROITool:()=>tl,RectangleScissorsTool:()=>pc,ReferenceCursors:()=>rc,ReferenceLines:()=>ks,ReferenceLinesTool:()=>ks,ScaleOverlayTool:()=>dc,SegmentationDisplayTool:()=>ha,SphereScissorsTool:()=>Cc,StackScrollMouseWheelTool:()=>$r,StackScrollTool:()=>Hr,Synchronizer:()=>Fg,SynchronizerManager:()=>B,ToolGroupManager:()=>G,TrackballRotateTool:()=>Ar,Types:()=>z,VolumeRotateMouseWheelTool:()=>Zr,WindowLevelTool:()=>kr,ZoomTool:()=>qr,addTool:()=>ze,annotation:()=>b,cancelActiveManipulations:()=>Vg,cursors:()=>C,destroy:()=>wu,drawing:()=>p,init:()=>Eu,removeTool:()=>je,segmentation:()=>v,state:()=>Ke,synchronizers:()=>q,utilities:()=>F});var o={};n.r(o),n.d(o,{AnnotationStyleStates:()=>ee,Events:()=>ne,KeyboardBindings:()=>Z,MouseBindings:()=>j,SegmentationRepresentations:()=>ie,Swipe:()=>ae,ToolModes:()=>X});var i={};n.r(i),n.d(i,{checkAndDefineIsLockedProperty:()=>me,getAnnotationsLocked:()=>he,getAnnotationsLockedCount:()=>ue,isAnnotationLocked:()=>ge,setAnnotationLocked:()=>de,unlockAllAnnotations:()=>ce});var a={};n.r(a),n.d(a,{deselectAnnotation:()=>Te,getAnnotationsSelected:()=>be,getAnnotationsSelectedByToolName:()=>_e,getAnnotationsSelectedCount:()=>Se,isAnnotationSelected:()=>De,setAnnotationSelected:()=>Ce});var r={};n.r(r),n.d(r,{checkAndDefineIsVisibleProperty:()=>Le,isAnnotationVisible:()=>Pe,setAnnotationVisibility:()=>Re,showAllAnnotations:()=>Ne});var s={};n.r(s),n.d(s,{copyPoints:()=>Bt,copyPointsList:()=>Ft,getDeltaDistance:()=>Vt,getDeltaDistanceBetweenIPoints:()=>Wt,getDeltaPoints:()=>kt,getDeltaRotation:()=>Ht,getMeanPoints:()=>Gt,getMeanTouchPoints:()=>$t});var l={};n.r(l),n.d(l,{triggerSegmentationDataModified:()=>Kn,triggerSegmentationModified:()=>$n,triggerSegmentationRemoved:()=>Fn,triggerSegmentationRepresentationModified:()=>Gn,triggerSegmentationRepresentationRemoved:()=>Bn});var d={};n.r(d),n.d(d,{addColorLUT:()=>mo,addSegmentation:()=>Yn,addSegmentationRepresentation:()=>ao,getColorLUT:()=>uo,getDefaultSegmentationStateManager:()=>zn,getGlobalConfig:()=>ro,getSegmentSpecificRepresentationConfig:()=>oo,getSegmentation:()=>jn,getSegmentationRepresentationByUID:()=>lo,getSegmentationRepresentationSpecificConfig:()=>no,getSegmentationRepresentations:()=>Jn,getSegmentations:()=>Zn,getToolGroupIdsWithSegmentation:()=>Xn,getToolGroupSpecificConfig:()=>Qn,removeColorLUT:()=>go,removeSegmentation:()=>co,removeSegmentationRepresentation:()=>ho,setGlobalConfig:()=>so,setSegmentSpecificRepresentationConfig:()=>io,setSegmentationRepresentationSpecificConfig:()=>to,setToolGroupSpecificConfig:()=>eo});var c={};n.r(c),n.d(c,{getActiveSegmentationRepresentation:()=>ai,setActiveSegmentationRepresentation:()=>ri});var h={};n.r(h),n.d(h,{getLockedSegments:()=>di,isSegmentIndexLocked:()=>si,setSegmentIndexLocked:()=>li});var g={};n.r(g),n.d(g,{addColorLUT:()=>ci,getColorForSegmentIndex:()=>gi,setColorForSegmentIndex:()=>ui,setColorLUT:()=>hi});var u={};n.r(u),n.d(u,{getSegmentationVisibility:()=>fi,setSegmentVisibility:()=>pi,setSegmentationVisibility:()=>mi,setSegmentsVisibility:()=>vi});var m={};n.r(m),n.d(m,{color:()=>g,getGlobalConfig:()=>fo,getGlobalRepresentationConfig:()=>po,getSegmentSpecificConfig:()=>bo,getSegmentationRepresentationSpecificConfig:()=>Co,getToolGroupSpecificConfig:()=>wo,setGlobalConfig:()=>vo,setGlobalRepresentationConfig:()=>Eo,setSegmentSpecificConfig:()=>_o,setSegmentationRepresentationSpecificConfig:()=>To,setToolGroupSpecificConfig:()=>Io,visibility:()=>u});var f={};n.r(f),n.d(f,{getActiveSegmentIndex:()=>wi,setActiveSegmentIndex:()=>Ei});var v={};n.r(v),n.d(v,{activeSegmentation:()=>c,addSegmentationRepresentations:()=>ii,addSegmentations:()=>oi,config:()=>m,removeSegmentationsFromToolGroup:()=>ei,segmentIndex:()=>f,segmentLocking:()=>h,state:()=>d,triggerSegmentationEvents:()=>l});var p={};n.r(p),n.d(p,{draw:()=>xi,drawArrow:()=>Ki,drawCircle:()=>Pi,drawEllipse:()=>Li,drawHandles:()=>Ai,drawLine:()=>Ui,drawLinkedTextBox:()=>Gi,drawPolyline:()=>ki,drawRect:()=>$i,drawTextBox:()=>Wi});var E={};n.r(E),n.d(E,{getFont:()=>aa,getState:()=>ia,style:()=>na});var w={};n.r(w),n.d(w,{extend2DBoundingBoxInViewAxis:()=>Pa,getBoundingBoxAroundShape:()=>La});var I={};n.r(I),n.d(I,{getCanvasEllipseCorners:()=>Fa,pointInEllipse:()=>Wa});var C={};n.r(C),n.d(C,{CursorNames:()=>pr,CursorSVG:()=>rr,ImageMouseCursor:()=>Xa,MouseCursor:()=>Za,SVGMouseCursor:()=>gr,elementCursor:()=>T,registerCursor:()=>lr,setCursorForElement:()=>vr});var T={};n.r(T),n.d(T,{hideElementCursor:()=>Tr,initElementCursor:()=>wr,resetElementCursor:()=>Cr,setElementCursor:()=>Ir});var b={};n.r(b),n.d(b,{FrameOfReferenceSpecificAnnotationManager:()=>Be,config:()=>E,locking:()=>i,selection:()=>a,state:()=>$,visibility:()=>r});var _={};n.r(_),n.d(_,{default:()=>Qr,filterAnnotationsForDisplay:()=>ta,filterAnnotationsWithinSlice:()=>ea,getPointInLineOfSightWithCriteria:()=>Jr,getWorldWidthAndHeightFromCorners:()=>Yr});var D={};n.r(D),n.d(D,{filterViewportsWithFrameOfReferenceUID:()=>is,filterViewportsWithParallelNormals:()=>cs,filterViewportsWithToolEnabled:()=>ls,getViewportIdsWithToolToRender:()=>hs});var S={};n.r(S),n.d(S,{distanceToPoint:()=>ws,distanceToPointSquared:()=>Es,intersectLine:()=>Cs});var O={};n.r(O),n.d(O,{getTextBoxCoordsCanvas:()=>Vs});var y={};n.r(y),n.d(y,{distanceToPoint:()=>Xs});var x={};n.r(x),n.d(x,{distanceToPoint:()=>rl});var M={};n.r(M),n.d(M,{findClosestPoint:()=>Fi,liangBarksyClip:()=>vs});var R={};n.r(R),n.d(R,{addCanvasPointsToArray:()=>Tl,calculateAreaOfPoints:()=>_l,getClosestIntersectionWithPolyline:()=>ml,getFirstIntersectionWithPolyline:()=>ul,getSubPixelSpacingAndXYDirections:()=>Il,pointCanProjectOnLine:()=>bl,pointsAreWithinCloseContourProximity:()=>Cl});var N={};n.r(N),n.d(N,{ellipse:()=>I,lineSegment:()=>S,point:()=>x,polyline:()=>R,rectangle:()=>y,vec2:()=>M});var P={};n.r(P),n.d(P,{createLabelmapVolumeForViewport:()=>Hc,createMergedLabelmapForIndex:()=>Uc,floodFill:()=>xc,getBrushSizeForToolGroup:()=>Fc,getBrushThresholdForToolGroup:()=>Gc,getDefaultRepresentationConfig:()=>Vc,isValidRepresentationConfig:()=>kc,rectangleROIThresholdVolumeByRange:()=>Ac,setBrushSizeForToolGroup:()=>Wc,setBrushThresholdForToolGroup:()=>Bc,thresholdSegmentationByRange:()=>$c,thresholdVolumeByRange:()=>Mr,triggerSegmentationRender:()=>ua});var L={};n.r(L),n.d(L,{getOrientationStringLPS:()=>Kc,invertOrientationStringLPS:()=>qc});var A={};n.r(A),n.d(A,{Events:()=>jc,addToolState:()=>Yc,getToolState:()=>Jc,playClip:()=>nh,stopClip:()=>oh});var U={};n.r(U),n.d(U,{default:()=>lh,interpolateAnnotation:()=>sh});var k={};n.r(k),n.d(k,{getBoundsIJKFromRectangleAnnotations:()=>Lc});var V={};n.r(V),n.d(V,{disable:()=>Th,enable:()=>Ch,getConfiguration:()=>bh,setConfiguration:()=>_h});var H={};n.r(H),n.d(H,{isViewportPreScaled:()=>qs,jumpToSlice:()=>Ra,jumpToWorld:()=>es});var W={};n.r(W),n.d(W,{generateImageFromTimeData:()=>Sh,getDataInTime:()=>Dh});var F={};n.r(F),n.d(F,{boundingBox:()=>w,calibrateImageSpacing:()=>ya,cine:()=>A,clip:()=>Sa,debounce:()=>ba,drawing:()=>O,dynamicVolume:()=>W,getAnnotationNearPoint:()=>wa,getAnnotationNearPointOnEnabledElement:()=>Ia,isObject:()=>Ta,jumpToSlice:()=>Ra,math:()=>N,orientation:()=>L,planar:()=>_,planarFreehandROITool:()=>U,pointInShapeCallback:()=>Na,pointInSurroundingSphereCallback:()=>Ua,rectangleROITool:()=>k,scroll:()=>Ma,segmentation:()=>P,stackPrefetch:()=>V,throttle:()=>_a,touch:()=>s,triggerAnnotationRender:()=>Ji,triggerAnnotationRenderForViewportIds:()=>xa,triggerEvent:()=>J.triggerEvent,viewport:()=>H,viewportFilters:()=>D});var B={};n.r(B),n.d(B,{createSynchronizer:()=>Bg,destroy:()=>Gg,destroySynchronizer:()=>qg,getAllSynchronizers:()=>Kg,getSynchronizer:()=>$g,getSynchronizersForViewport:()=>Rg});var G={};n.r(G),n.d(G,{createToolGroup:()=>eu,destroy:()=>nu,destroyToolGroup:()=>tu,getAllToolGroups:()=>iu,getToolGroup:()=>ou,getToolGroupForViewport:()=>Ng,getToolGroupsWithToolName:()=>ru});var $={};n.r($),n.d($,{addAnnotation:()=>gu,getAnnotation:()=>fu,getAnnotationManager:()=>lu,getAnnotations:()=>hu,getNumberOfAnnotations:()=>uu,removeAllAnnotations:()=>vu,removeAnnotation:()=>mu,resetAnnotationManager:()=>cu,setAnnotationManager:()=>du});var K={};n.r(K),n.d(K,{COLOR_LUT:()=>Nn});var q={};n.r(q),n.d(q,{createCameraPositionSynchronizer:()=>_u,createStackImageSynchronizer:()=>Pu,createVOISynchronizer:()=>Su,createZoomPanSynchronizer:()=>xu});var z={};n.r(z);var j,Z,Y,J=n(77331);!function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button"}(j||(j={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(Z||(Z={})),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(Y||(Y={}));const X=Y;var Q;!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked"}(Q||(Q={}));const ee=Q;var te;!function(e){e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(te||(te={}));const ne=te;var oe;!function(e){e.Labelmap="LABELMAP",e.Contour="CONTOUR"}(oe||(oe={}));const ie=oe;var ae;!function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(ae||(ae={}));var re=n(71975),se=n.n(re);const le=new Set;function de(e,t=!0){const n=fe();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,le,n):ve(e,le,n)),pe(n,le)}function ce(){const e=fe();!function(e,t){e.forEach((n=>{ve(n,e,t)}))}(le,e),pe(e,le)}function he(){return Array.from(le)}function ge(e){return le.has(e)}function ue(){return le.size}function me(e){if(e){const t=!!e.isLocked;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isLocked");if(t)return t.configurable&&(t.set!==Ee||t.get!==we);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:Ee,get:we}),de(e,t)}}function fe(){return Object.freeze({added:[],removed:[],locked:[]})}function ve(e,t,n){t.delete(e)&&n.removed.push(e)}function pe(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.locked.push(t)})),(0,J.triggerEvent)(J.eventTarget,ne.ANNOTATION_LOCK_CHANGE,e))}function Ee(e){de(this,e)}function we(){return ge(this)}const Ie=new Set;function Ce(e,t=!0,n=!1){t?function(e,t=!1){const n=Oe();t||ye(Ie,n);e&&!Ie.has(e)&&(Ie.add(e),n.added.push(e));xe(n,Ie)}(e,n):Te(e)}function Te(e){const t=Oe();e?Ie.delete(e)&&t.removed.push(e):ye(Ie,t),xe(t,Ie)}function be(){return Array.from(Ie)}function _e(e){return be().filter((t=>fu(t).metadata.toolName===e))}function De(e){return Ie.has(e)}function Se(){return Ie.size}function Oe(){return Object.freeze({added:[],removed:[],selection:[]})}function ye(e,t){e.forEach((n=>{e.delete(n)&&t.removed.push(n)}))}function xe(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.selection.push(t)})),(0,J.triggerEvent)(J.eventTarget,ne.ANNOTATION_SELECTION_CHANGE,e))}const Me=new Set;function Re(e,t=!0){const n=Ae();e&&(t?Ue(e,Me,n):function(e,t,n){t.has(e)||(t.add(e),De(e)&&Te(e),n.lastHidden.push(e))}(e,Me,n)),ke(n)}function Ne(){const e=Ae();Me.forEach((t=>{Ue(t,Me,e)})),ke(e)}function Pe(e){if(fu(e))return!Me.has(e)}function Le(e){if(e){const t=e.isVisible??!0;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isVisible");if(t)return t.configurable&&(t.set!==Ve||t.get!==He);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:Ve,get:He}),Re(e.annotationUID,t)}}function Ae(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function Ue(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function ke(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(Me.forEach((t=>{e.hidden.push(t)})),(0,J.triggerEvent)(J.eventTarget,ne.ANNOTATION_VISIBILITY_CHANGE,e))}function Ve(e){Re(this.annotationUID,e)}function He(){return Pe(this.annotationUID)}class We{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;const t=e,n=(0,J.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,o=this.annotations[n];o&&Object.keys(o).forEach((e=>{o[e].forEach((e=>{void 0!==e.invalidated&&(e.invalidated=!0)}))}))},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]:n[e]:[]},this.getAnnotation=e=>{const t=this.annotations;for(const n in t){const o=t[n];for(const t in o){const n=o[t];for(const t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let o=0;for(const e in n)o+=n[e].length;return o},this.addAnnotation=(e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:o,toolName:i}=n;t=t||o;const a=this.annotations;let r=a[t];r||(a[t]={},r=a[t]);let s=r[i];s||(r[i]=[],s=r[i]),s.push(e),me(e),Le(e)},this.removeAnnotation=e=>{const{annotations:t}=this;for(const n in t){const o=t[n];for(const t in o){const n=o[t],i=n.findIndex((t=>t.annotationUID===e));-1!==i&&(n.splice(i,1),0===n.length&&delete o[t])}0===Object.keys(o).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{const n=this.annotations;n[e]&&(t?delete n[e][t]:delete n[e])},this.saveAnnotations=(e,t)=>{const n=this.annotations;if(e&&t){const o=n[e];if(!o)return;const i=o[t];return se()(i)}if(e){const t=n[e];return se()(t)}return se()(n)},this.restoreAnnotations=(e,t,n)=>{const o=this.annotations;if(t&&n){let i=o[t];i||(o[t]={},i=o[t]),i[n]=e}else t?o[t]=e:this.annotations=se()(e)},this.getNumberOfAllAnnotations=()=>{let e=0;const t=this.annotations;for(const n in t){const o=t[n];for(const t in o){e+=o[t].length}}return e},this.removeAllAnnotations=()=>{this.annotations={}},e||(e=J.utilities.uuidv4()),this.annotations={},this.uid=e,J.eventTarget.addEventListener(J.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}const Fe=new We("DEFAULT"),Be=We;let Ge={};const $e={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:Ge,enabledElements:[],handleRadius:6};let Ke={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:Ge,enabledElements:[],handleRadius:6};function qe(){Ge={},Ke=se()($e)}function ze(e){const t=e.toolName,n=void 0!==Ke.tools[t];if(!t)throw new Error(`No Tool Found for the ToolClass ${e.name}`);if(n)throw new Error(`${t} has already been added globally`);Ke.tools[t]={toolClass:e}}function je(e){const t=e.toolName;if(!t)throw new Error(`No tool found for: ${e.name}`);if(void 0===!Ke.tools[t])throw new Error(`${t} cannot be removed because it has not been added`);delete Ke.tools[t]}function Ze(e,t){const n=t||e.currentTarget,{viewport:o}=(0,J.getEnabledElement)(n),i=function(e){return[e.clientX,e.clientY]}(e),a=function(e){return[e.pageX,e.pageY]}(e),r=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,a);return{page:a,client:i,canvas:r,world:o.canvasToWorld(r)}}const Ye=function(e){const t=e.currentTarget,{viewportId:n,renderingEngineId:o}=(0,J.getEnabledElement)(t),i=Ze(e,t),a={event:e,eventName:ne.MOUSE_DOUBLE_CLICK,viewportId:n,renderingEngineId:o,camera:{},element:t,startPoints:i,lastPoints:i,currentPoints:i,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};!(0,J.triggerEvent)(t,ne.MOUSE_DOUBLE_CLICK,a)&&(e.stopImmediatePropagation(),e.preventDefault())},Je=ne.MOUSE_MOVE;const Xe=function(e){const t=e.currentTarget,n=(0,J.getEnabledElement)(t),{renderingEngineId:o,viewportId:i}=n,a={renderingEngineId:o,viewportId:i,camera:{},element:t,currentPoints:Ze(e),eventName:Je,event:e};(0,J.triggerEvent)(t,Je,a)},{MOUSE_DOWN:Qe,MOUSE_DOWN_ACTIVATE:et,MOUSE_CLICK:tt,MOUSE_UP:nt,MOUSE_DRAG:ot}=ne,it=3,at={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};let rt={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};const st={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function lt(e){const t=Ze(e,rt.element),n=pt(rt.element,rt.lastPoints),o=Et(t,n);if(st.doubleClickTimeout){if(!ht(o.canvas))return;ut()}const i={event:e,eventName:ot,mouseButton:rt.mouseButton,renderingEngineId:rt.renderingEngineId,viewportId:rt.viewportId,camera:{},element:rt.element,startPoints:vt(rt.startPoints),lastPoints:vt(n),currentPoints:t,deltaPoints:o};(0,J.triggerEvent)(rt.element,ot,i),rt.lastPoints=vt(t)}function dt(e){if(clearTimeout(rt.preventClickTimeout),st.doubleClickTimeout)st.mouseUpEvent?ft():(st.mouseUpEvent=e,rt.element.addEventListener("mousemove",ct));else{const t=rt.isClickEvent?tt:nt,n=Ze(e,rt.element),o=Et(n,rt.lastPoints),i={event:e,eventName:t,mouseButton:rt.mouseButton,element:rt.element,renderingEngineId:rt.renderingEngineId,viewportId:rt.viewportId,camera:{},startPoints:vt(rt.startPoints),lastPoints:vt(rt.lastPoints),currentPoints:n,deltaPoints:o};(0,J.triggerEvent)(i.element,t,i),ft()}document.removeEventListener("mousemove",lt)}function ct(e){ht(Et(Ze(e,rt.element),pt(rt.element,rt.lastPoints)).canvas)&&(ut(),Xe(e))}function ht(e){return Math.abs(e[0])+Math.abs(e[1])>it}function gt(){rt.isClickEvent=!1}function ut(){st.ignoreDoubleClick=!0;const e=st.mouseDownEvent,t=st.mouseUpEvent;mt(),function(e){const t=Et(rt.startPoints,rt.startPoints),n={event:e,eventName:Qe,element:rt.element,mouseButton:rt.mouseButton,renderingEngineId:rt.renderingEngineId,viewportId:rt.viewportId,camera:{},startPoints:rt.startPoints,lastPoints:rt.startPoints,currentPoints:rt.startPoints,deltaPoints:t};rt.lastPoints=vt(n.lastPoints),(0,J.triggerEvent)(n.element,Qe,n)&&(0,J.triggerEvent)(n.element,et,n)}(e),t&&dt(t)}function mt(){st.doubleClickTimeout&&(clearTimeout(st.doubleClickTimeout),st.doubleClickTimeout=null),st.mouseDownEvent=null,st.mouseUpEvent=null}function ft(){document.removeEventListener("mouseup",dt),rt.element?.removeEventListener("mousemove",ct),rt.element?.addEventListener("mousemove",Xe),mt(),rt=JSON.parse(JSON.stringify(at))}function vt(e){return JSON.parse(JSON.stringify(e))}function pt(e,t){const{viewport:n}=(0,J.getEnabledElement)(e),o=n.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:o}}function Et(e,t){return{page:wt(e.page,t.page),client:wt(e.client,t.client),canvas:wt(e.canvas,t.canvas),world:(n=e.world,o=t.world,[n[0]-o[0],n[1]-o[1],n[2]-o[2]])};var n,o}function wt(e,t){return[e[0]-t[0],e[1]-t[1]]}function It(e){st.ignoreDoubleClick?(st.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):ft()}const Ct=function(e){if(st.doubleClickTimeout){if(e.buttons===st.mouseDownEvent.buttons)return;return st.mouseDownEvent=e,void ut()}st.doubleClickTimeout=setTimeout(ut,1===e.buttons?400:150),st.mouseDownEvent=e,st.ignoreDoubleClick=!1,rt.element=e.currentTarget,rt.mouseButton=e.buttons;const t=(0,J.getEnabledElement)(rt.element),{renderingEngineId:n,viewportId:o}=t;rt.renderingEngineId=n,rt.viewportId=o,rt.preventClickTimeout=setTimeout(gt,rt.clickDelay),rt.element.removeEventListener("mousemove",Xe);const i=Ze(e,rt.element);rt.startPoints=vt(i),rt.lastPoints=vt(i),document.addEventListener("mouseup",dt),document.addEventListener("mousemove",lt)};function Tt(e){e.removeEventListener("dblclick",Ye),e.removeEventListener("mousedown",Ct),e.removeEventListener("mousemove",Xe),e.removeEventListener("dblclick",It,{capture:!0})}const bt={enable:function(e){Tt(e),e.addEventListener("dblclick",Ye),e.addEventListener("mousedown",Ct),e.addEventListener("mousemove",Xe),e.addEventListener("dblclick",It,{capture:!0})},disable:Tt},_t={mouse:0,touch:1};let Dt,St;function Ot(e,t){const n=Date.now();if(e!==Dt){if(n-St<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Dt=e}St=n}const yt=Ot.bind(null,_t.mouse),xt=Ot.bind(null,_t.touch);function Mt(e,t,n){const o=n?yt:xt;t.forEach((function(t){e.addEventListener(t,o,{passive:!1})}))}function Rt(e,t,n){const o=n?yt:xt;t.forEach((function(t){e.removeEventListener(t,o)}))}const Nt=["mousedown","mouseup","mousemove"],Pt=["touchstart","touchend"];function Lt(e){Rt(e,Nt,_t.mouse),Rt(e,Pt,_t.touch)}const At={enable:function(e){Lt(e),Mt(e,Nt,_t.mouse),Mt(e,Pt,_t.touch)},disable:Lt};function Ut(e,t){const n=t||e.currentTarget,o="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(o).map((e=>{const t=function(e){return[e.clientX,e.clientY]}(o[e]),i=function(e){return[e.pageX,e.pageY]}(o[e]),a=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,i),{viewport:r}=(0,J.getEnabledElement)(n);return{page:i,client:t,canvas:a,world:r.canvasToWorld(a),touch:{identifier:e,radiusX:o[e].radiusX,radiusY:o[e].radiusY,force:o[e].force,rotationAngle:o[e].rotationAngle}}}))}function kt(e,t){const n=Gt(e),o=Gt(t);return{page:Kt(n.page,o.page),client:Kt(n.client,o.client),canvas:Kt(n.canvas,o.canvas),world:(i=n.world,a=o.world,[i[0]-a[0],i[1]-a[1],i[2]-a[2]])};var i,a}function Vt(e,t){const n=Gt(e),o=Gt(t);return{page:zt(n.page,o.page),client:zt(n.client,o.client),canvas:zt(n.canvas,o.canvas),world:jt(n.world,o.world)}}function Ht(e,t){}function Wt(e,t){const n=qt(e),o=qt(t);return{page:n.page-o.page,client:n.client-o.client,canvas:n.canvas-o.canvas,world:n.world-o.world}}function Ft(e){return JSON.parse(JSON.stringify(e))}function Bt(e){return JSON.parse(JSON.stringify(e))}function Gt(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function $t(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function Kt(e,t){return[e[0]-t[0],e[1]-t[1]]}function qt(e){const t=[];for(let n=0;n<e.length;n++)for(let o=0;o<e.length;o++)n<o&&t.push({page:zt(e[n].page,e[o].page),client:zt(e[n].client,e[o].client),canvas:zt(e[n].canvas,e[o].canvas),world:jt(e[n].world,e[o].world)});return t.reduce(((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length})),{page:0,client:0,canvas:0,world:0})}function zt(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function jt(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}const Zt=J.Settings.getRuntimeSettings(),{TOUCH_START:Yt,TOUCH_START_ACTIVATE:Jt,TOUCH_PRESS:Xt,TOUCH_DRAG:Qt,TOUCH_END:en,TOUCH_TAP:tn,TOUCH_SWIPE:nn}=ne,on={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},an={page:0,client:0,canvas:0,world:0},rn={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...on,touch:null}],lastPointsList:[{...on,touch:null}],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:an,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},sn={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...on,touch:null}],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300};let ln=JSON.parse(JSON.stringify(rn)),dn=JSON.parse(JSON.stringify(sn));function cn(e,t,n){return Zt.get("debug")&&("CORNERSTONE_TOOLS_TOUCH_DRAG"===t?console.debug(t):console.debug(t,n)),(0,J.triggerEvent)(e,t,n)}function hn(e){const t=Ut(e,ln.element),n=un(ln.element,ln.lastPointsList),o=t.length===n.length?kt(t,n):on,i=t.length===n.length?Wt(t,n):an,a=t.length===n.length?Vt(t,ln.lastPointsList):an;ln.accumulatedDistance={page:ln.accumulatedDistance.page+a.page,client:ln.accumulatedDistance.client+a.client,canvas:ln.accumulatedDistance.canvas+a.canvas,world:ln.accumulatedDistance.world+a.world};const r={event:e,eventName:Qt,renderingEngineId:ln.renderingEngineId,viewportId:ln.viewportId,camera:{},element:ln.element,startPoints:$t(ln.startPointsList),lastPoints:$t(n),currentPoints:$t(t),startPointsList:Ft(ln.startPointsList),lastPointsList:Ft(n),currentPointsList:t,deltaPoints:o,deltaDistance:i};cn(ln.element,Qt,r),function(e,t){const n=(new Date).getTime(),o=ln.startTime.getTime();if(ln.swiped||n-o>ln.swipeToleranceMs)return;const[i,a]=t.canvas,r={event:e,eventName:nn,renderingEngineId:ln.renderingEngineId,viewportId:ln.viewportId,camera:{},element:ln.element,swipe:null};Math.abs(i)>ln.swipeDistanceThreshold&&(r.swipe=i>0?ae.RIGHT:ae.LEFT,cn(r.element,nn,r),ln.swiped=!0);Math.abs(a)>ln.swipeDistanceThreshold&&(r.swipe=a>0?ae.DOWN:ae.UP,cn(r.element,nn,r),ln.swiped=!0)}(e,o),ln.lastPointsList=Ft(t)}function gn(e){clearTimeout(ln.pressTimeout);const t=Ut(e,ln.element),n=un(ln.element,ln.lastPointsList),o=t.length===n.length?kt(t,n):kt(t,t),i=t.length===n.length?Wt(t,n):Wt(t,t),a={event:e,eventName:en,element:ln.element,renderingEngineId:ln.renderingEngineId,viewportId:ln.viewportId,camera:{},startPointsList:Ft(ln.startPointsList),lastPointsList:Ft(n),currentPointsList:t,startPoints:$t(ln.startPointsList),lastPoints:$t(n),currentPoints:$t(t),deltaPoints:o,deltaDistance:i};cn(a.element,en,a),function(e){const t=(new Date).getTime(),n=ln.startTime.getTime();if(t-n>dn.tapToleranceMs)return;0===dn.taps&&(dn.element=ln.element,dn.renderingEngineId=ln.renderingEngineId,dn.viewportId=ln.viewportId,dn.startPointsList=ln.startPointsList);if(dn.taps>0&&(dn.element!=ln.element||dn.renderingEngineId!=ln.renderingEngineId||dn.viewportId!=ln.viewportId))return;const o=Ut(e,dn.element),i=Vt(o,dn.startPointsList).canvas;if(i>dn.tapMaxDistance)return;clearTimeout(dn.tapTimeout),dn.taps+=1,dn.tapTimeout=setTimeout((()=>{const t={event:e,eventName:tn,element:dn.element,renderingEngineId:dn.renderingEngineId,viewportId:dn.viewportId,camera:{},currentPointsList:o,currentPoints:$t(o),taps:dn.taps};cn(t.element,tn,t),dn=JSON.parse(JSON.stringify(sn))}),dn.tapToleranceMs)}(e),ln=JSON.parse(JSON.stringify(rn)),document.removeEventListener("touchmove",hn),document.removeEventListener("touchend",gn)}function un(e,t){const{viewport:n}=(0,J.getEnabledElement)(e);return t.map((e=>{const t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}}))}const mn=function(e){ln.element=e.currentTarget;const t=(0,J.getEnabledElement)(ln.element),{renderingEngineId:n,viewportId:o}=t;ln.renderingEngineId=n,ln.viewportId=o,ln.isTouchStart||(clearTimeout(ln.pressTimeout),ln.pressTimeout=setTimeout((()=>function(e){if(ln.accumulatedDistance.canvas>ln.pressMaxDistance)return;const t={event:e,eventName:Xt,renderingEngineId:ln.renderingEngineId,viewportId:ln.viewportId,camera:{},element:ln.element,startPointsList:Ft(ln.startPointsList),lastPointsList:Ft(ln.lastPointsList),startPoints:Bt($t(ln.startPointsList)),lastPoints:Bt($t(ln.lastPointsList))};cn(t.element,Xt,t)}(e)),ln.pressDelay),function(e){ln.isTouchStart=!0,ln.startTime=new Date;const t=Ut(e,ln.element),n=$t(t),o=on,i=an,a={event:e,eventName:Yt,element:ln.element,renderingEngineId:ln.renderingEngineId,viewportId:ln.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:o,deltaDistance:i};ln.startPointsList=Ft(a.startPointsList),ln.lastPointsList=Ft(a.lastPointsList);cn(a.element,Yt,a)&&cn(a.element,Jt,a)}(e),document.addEventListener("touchmove",hn),document.addEventListener("touchend",gn))};function fn(e){At.disable(e),e.removeEventListener("touchstart",mn)}const vn={enable:function(e){fn(e),At.enable(e),e.addEventListener("touchstart",mn,{passive:!1})},disable:fn},pn=10,En=40,wn=800;const In=function(e){const t=e.currentTarget,n=(0,J.getEnabledElement)(t),{renderingEngineId:o,viewportId:i}=n;if(e.deltaY>-1&&e.deltaY<1)return;e.preventDefault();const{spinX:a,spinY:r,pixelX:s,pixelY:l}=function(e){let t=0,n=0,o=0,i=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),o=t*pn,i=n*pn,"deltaY"in e&&(i=e.deltaY),"deltaX"in e&&(o=e.deltaX),(o||i)&&e.deltaMode&&(1===e.deltaMode?(o*=En,i*=En):(o*=wn,i*=wn)),o&&!t&&(t=o<1?-1:1),i&&!n&&(n=i<1?-1:1),{spinX:t,spinY:n,pixelX:o,pixelY:i}}(e),d=r<0?-1:1,c={event:e,eventName:ne.MOUSE_WHEEL,renderingEngineId:o,viewportId:i,element:t,camera:{},detail:e,wheel:{spinX:a,spinY:r,pixelX:s,pixelY:l,direction:d},points:Ze(e)};(0,J.triggerEvent)(t,ne.MOUSE_WHEEL,c)};function Cn(e){e.removeEventListener("wheel",In)}const Tn={enable:function(e){Cn(e),e.addEventListener("wheel",In,{passive:!1})},disable:Cn},bn={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};let _n={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function Dn(e){_n.element=e.currentTarget;const t=(0,J.getEnabledElement)(_n.element),{renderingEngineId:n,viewportId:o}=t;_n.renderingEngineId=n,_n.viewportId=o,_n.key=e.key,_n.keyCode=e.keyCode,e.preventDefault();const i={renderingEngineId:_n.renderingEngineId,viewportId:_n.viewportId,element:_n.element,key:_n.key,keyCode:_n.keyCode};(0,J.triggerEvent)(i.element,ne.KEY_DOWN,i),document.addEventListener("keyup",Sn),_n.element.removeEventListener("keydown",Dn)}function Sn(e){const t={renderingEngineId:_n.renderingEngineId,viewportId:_n.viewportId,element:_n.element,key:_n.key,keyCode:_n.keyCode};document.removeEventListener("keyup",Sn),_n.element.addEventListener("keydown",Dn),_n=se()(bn),(0,J.triggerEvent)(t.element,ne.KEY_UP,t)}const On=Dn;function yn(e){e.removeEventListener("keydown",On)}const xn={enable:function(e){yn(e),e.addEventListener("keydown",On)},disable:yn,getModifierKey:function(){return _n.keyCode}};var Mn=n(17394),Rn=n(92632);const Nn=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]],Pn={renderOutline:!0,outlineWidthActive:2,outlineWidthInactive:2,outlineOpacity:1,outlineOpacityInactive:.85,renderFill:!0,fillAlpha:1,fillAlphaInactive:0};const Ln=function(){return Pn},An={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85};const Un=function(){return An},kn=Un(),Vn=Ln(),Hn={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:{[ie.Labelmap]:kn,[ie.Contour]:Vn}},toolGroups:{}};const Wn=new class{constructor(e){e||(e=J.utilities.uuidv4()),this.state=se()(Hn),this.uid=e}getState(){return this.state}getToolGroups(){return Object.keys(this.state.toolGroups)}getColorLUT(e){return this.state.colorLUT[e]}resetState(){this.state=se()(Hn)}getSegmentation(e){return this.state.segmentations.find((t=>t.segmentationId===e))}addSegmentation(e){if(this._initDefaultColorLUTIfNecessary(),this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.state.segmentations.push(e)}getSegmentationRepresentations(e){const t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}addSegmentationRepresentation(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}getGlobalConfig(){return this.state.globalConfig}setGlobalConfig(e){this.state.globalConfig=e}getSegmentationRepresentationByUID(e,t){return this.getSegmentationRepresentations(e).find((e=>e.segmentationRepresentationUID===t))}removeSegmentation(e){this.state.segmentations=this.state.segmentations.filter((t=>t.segmentationId!==e))}removeSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No viewport specific segmentation state found for viewport ${e}`);const o=n.findIndex((e=>e.segmentationRepresentationUID===t));-1===o&&console.warn(`No viewport specific segmentation state data found for viewport ${e} and segmentation data UID ${t}`);const i=n[o];n.splice(o,1),this._handleActiveSegmentation(e,i)}setActiveSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No segmentation data found for toolGroupId: ${e}`);const o=n.find((e=>e.segmentationRepresentationUID===t));if(!o)throw new Error(`No segmentation data found for segmentation data UID ${t}`);o.active=!0,this._handleActiveSegmentation(e,o)}getToolGroupSpecificConfig(e){const t=this.state.toolGroups[e];if(t)return t.config}getSegmentationRepresentationSpecificConfig(e,t){const n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}setSegmentationRepresentationSpecificConfig(e,t,n){const o=this.getSegmentationRepresentationByUID(e,t);o&&(o.segmentationRepresentationSpecificConfig=n)}getSegmentSpecificConfig(e,t,n){const o=this.getSegmentationRepresentationByUID(e,t);if(o)return o.segmentSpecificConfig[n]}setSegmentSpecificConfig(e,t,n){const o=this.getSegmentationRepresentationByUID(e,t);o&&(o.segmentSpecificConfig=n)}setSegmentationRepresentationConfig(e,t){let n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config={...n.config,...t}}addColorLUT(e,t){this.state.colorLUT[t]&&console.log("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=e}removeColorLUT(e){delete this.state.colorLUT[e]}_handleActiveSegmentation(e,t){const n=this.getSegmentationRepresentations(e);if(0===n.length)return;if(1===n.length)return void(n[0].active=!0);0!==n.filter((e=>e.active)).length?t.active&&n.forEach((e=>{e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0}_initDefaultColorLUTIfNecessary(){0!==this.state.colorLUT.length&&this.state.colorLUT[0]||this.addColorLUT(Nn,0)}}("DEFAULT");function Fn(e){const t={segmentationId:e};(0,J.triggerEvent)(J.eventTarget,ne.SEGMENTATION_REMOVED,t)}function Bn(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};(0,J.triggerEvent)(J.eventTarget,ne.SEGMENTATION_REPRESENTATION_REMOVED,n)}function Gn(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};if(t)return void(0,J.triggerEvent)(J.eventTarget,ne.SEGMENTATION_REPRESENTATION_MODIFIED,n);(Jn(e)||[]).forEach((t=>{const{segmentationRepresentationUID:n}=t,o={toolGroupId:e,segmentationRepresentationUID:n};(0,J.triggerEvent)(J.eventTarget,ne.SEGMENTATION_REPRESENTATION_MODIFIED,o)}))}function $n(e){let t;t=e?[e]:Zn().map((({segmentationId:e})=>e)),t.forEach((e=>{const t={segmentationId:e};(0,J.triggerEvent)(J.eventTarget,ne.SEGMENTATION_MODIFIED,t)}))}function Kn(e,t){const n={segmentationId:e,modifiedSlicesToUse:t};(0,J.triggerEvent)(J.eventTarget,ne.SEGMENTATION_DATA_MODIFIED,n)}const qn=function(e){const{segmentationId:t,representation:n}=e;return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:{[n.type]:{...n.data}}}};function zn(){return Wn}function jn(e){return zn().getSegmentation(e)}function Zn(){return zn().getState().segmentations}function Yn(e,t){const n=zn(),o=qn(e);n.addSegmentation(o),t||$n(o.segmentationId)}function Jn(e){return zn().getSegmentationRepresentations(e)}function Xn(e){const t=zn(),n=t.getState(),o=Object.keys(n.toolGroups),i=[];return o.forEach((n=>{t.getSegmentationRepresentations(n).forEach((t=>{t.segmentationId===e&&i.push(n)}))})),i}function Qn(e){return zn().getToolGroupSpecificConfig(e)}function eo(e,t,n){zn().setSegmentationRepresentationConfig(e,t),n||Gn(e)}function to(e,t,n,o=!1){zn().setSegmentationRepresentationSpecificConfig(e,t,n),o||Gn(e,t)}function no(e,t){return zn().getSegmentationRepresentationSpecificConfig(e,t)}function oo(e,t,n){return zn().getSegmentSpecificConfig(e,t,n)}function io(e,t,n,o=!1){zn().setSegmentSpecificConfig(e,t,n),o||Gn(e,t)}function ao(e,t,n){zn().addSegmentationRepresentation(e,t),n||Gn(e,t.segmentationRepresentationUID)}function ro(){return zn().getGlobalConfig()}function so(e,t){zn().setGlobalConfig(e),t||$n()}function lo(e,t){return zn().getSegmentationRepresentationByUID(e,t)}function co(e){zn().removeSegmentation(e),Fn(e)}function ho(e,t){zn().removeSegmentationRepresentation(e,t),Bn(e,t)}function go(e){zn().removeColorLUT(e)}function uo(e){return zn().getColorLUT(e)}function mo(e,t){zn().addColorLUT(e,t)}function fo(){return ro()}function vo(e){so(e)}function po(e){return fo().representations[e]}function Eo(e,t){const n=fo();vo({...n,representations:{...n.representations,[e]:{...n.representations[e],...t}}})}function wo(e){return Qn(e)}function Io(e,t){eo(e,t)}function Co(e,t){return no(e,t)}function To(e,t,n){to(e,t,n)}function bo(e,t,n){return oo(e,t,n)}function _o(e,t,n){io(e,t,n)}const Do=async function(e,t,n){const o=(0,J.getEnabledElement)(e),{renderingEngine:i,viewport:a}=o,{id:r}=a,s=[{volumeId:t,actorUID:n,visibility:!0,blendMode:J.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND}];await(0,J.addVolumesToViewports)(i,s,[r],!1,!0)};const So=function(e,t,n=!1){const o=(0,J.getEnabledElement)(e),{viewport:i}=o;i.removeVolumeActors([t])},Oo=255,yo=new Map;function xo(e,t,n,o){const i={...e,...t,...o||{}};return{fillAlpha:n?i.fillAlpha:i.fillAlphaInactive,outlineWidth:n?i.outlineWidthActive:i.outlineWidthInactive,renderFill:n?i.renderFill:i.renderFillInactive,renderOutline:i.renderOutline,outlineOpacity:n?i.outlineOpacity:i.outlineOpacityInactive}}function Mo(e,t,n,{fillAlpha:o,renderFill:i,renderOutline:a,segmentColor:r,outlineWidth:s,segmentsHidden:l}){const d=`${e}-${t}-${n}`,c=yo.get(d);if(!c)return yo.set(d,{fillAlpha:o,renderFill:i,renderOutline:a,outlineWidth:s,segmentColor:r,segmentsHidden:new Set(l)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:h,renderFill:g,renderOutline:u,outlineWidth:m,segmentColor:f,segmentsHidden:v}=c,p=f[0]!==r[0]||f[1]!==r[1]||f[2]!==r[2],E=f[3]!==r[3]||h!==o||g!==i||u!==a||m!==s||v.has(n)!==l.has(n);return yo.set(d,{fillAlpha:o,renderFill:i,renderOutline:a,outlineWidth:s,segmentColor:r.slice(),segmentsHidden:new Set(l)}),{forceOpacityUpdate:E,forceColorUpdate:p}}const Ro={render:async function(e,t,n){const{colorLUTIndex:o,active:i,segmentationId:a,segmentationRepresentationUID:r,segmentsHidden:s,config:l}=t,d=jn(a).representationData[ie.Labelmap],{volumeId:c}=d;if(!J.cache.getVolume(c))throw new Error(`No Labelmap found for volumeId: ${c}`);if(!function(e,t){if(!t)return!0;const n=e.getDefaultActor();if(!n)return!1;const{uid:o}=n,i=J.cache.getVolume(o);if(i){const e=J.cache.getVolume(t);if(e&&i.metadata.FrameOfReferenceUID===e.metadata.FrameOfReferenceUID)return!0}return!1}(e,d?.referencedVolumeId))return;let h=e.getActor(r);if(!h){const t=jn(a),{volumeId:n}=t.representationData[ie.Labelmap];await async function(e,t,n){await Do(e.element,t,n)}(e,n,r),h=e.getActor(r)}if(!h)return;const{cfun:g,ofun:u}=l,m=n.renderInactiveSegmentations;!function(e,t,n,o,i,a,r,s,l,d){const{segmentSpecificConfig:c,segmentationRepresentationSpecificConfig:h}=r,g=h[ie.Labelmap],u=uo(i),m=Math.min(256,u.length),f=t.actor,{uid:v}=t,{outlineWidth:p,renderOutline:E,outlineOpacity:w}=xo(a,g,s);for(let t=0;t<m;t++){const i=t,r=u[i],l=c[i]?.[ie.Labelmap],{fillAlpha:h,outlineWidth:m,renderFill:f,renderOutline:p}=xo(a,g,s,l),{forceOpacityUpdate:E,forceColorUpdate:w}=Mo(e,v,i,{fillAlpha:h,renderFill:f,renderOutline:p,segmentColor:r,outlineWidth:m,segmentsHidden:d});if(w&&n.addRGBPoint(i,r[0]/Oo,r[1]/Oo,r[2]/Oo),E)if(f){const e=d.has(i)?0:r[3]/255*h;o.removePoint(i),o.addPointLong(i,e,.5,1)}else o.addPointLong(i,.01,.5,1)}f.getProperty().setRGBTransferFunction(0,n),o.setClamping(!1),f.getProperty().setScalarOpacity(0,o),f.getProperty().setInterpolationTypeToNearest(),f.getProperty().setUseLabelOutline(E),f.getProperty().setLabelOutlineOpacity(w),f.getProperty().setLabelOutlineThickness(p);const I=s||l;f.setVisibility(I)}(e.id,h,g,u,o,n.representations[ie.Labelmap],t,i,m,s)},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:o}=t,i=J.utilities.uuidv4(),a=new Set,r=Rn.ZP.newInstance(),s=Mn.ZP.newInstance();s.addPoint(0,0);const l={segmentationId:o,segmentationRepresentationUID:i,type:ie.Labelmap,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{cfun:r,ofun:s}};if(n){const t=wo(e),o=J.utilities.deepMerge(t,n);Io(e,{renderInactiveSegmentations:o.renderInactiveSegmentations||!0,representations:{...o.representations}})}return ao(e,l),i},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){const n=ou(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:o}=n;for(const e of o){const{viewportId:n,renderingEngineId:o}=e,i=(0,J.getEnabledElementByIds)(n,o);So(i.viewport.element,t)}}(e,t),ho(e,t),n){ou(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{(0,J.getEnabledElementByIds)(e,t).viewport.render()}))}}};var No=n(19013),Po=n(91924),Lo=n(95138),Ao=n(52284),Uo=n(19386),ko=n(94378),Vo=Po.default.vtkErrorMacro;function Ho(e,t,n,o){var i,a;e.set((i=n,a=0,t.map((function(e,t){return t===a?(a+=e+1,e):e+i}))),o)}var Wo={outputPointsPrecision:Uo.XJ.DEFAULT};function Fo(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,Wo,n),Po.default.setGet(e,t,["outputPointsPrecision"]),Po.default.obj(e,t),Po.default.algo(e,t,1,1),function(e,t){t.classHierarchy.push("vtkAppendPolyData"),e.requestData=function(n,o){var i=e.getNumberOfInputPorts();if(i)if(1!==i){for(var a=Ao.ZP.newInstance(),r=0,s=0,l=1,d=1,c=0,h=0,g=0,u=0,m=!0,f=!0,v=!0,p=0;p<i;p++){var E=n[p];if(E){var w=E.getPoints().getNumberOfPoints();r+=w,c+=E.getVerts().getNumberOfValues(),h+=E.getLines().getNumberOfValues(),g+=E.getStrips().getNumberOfValues(),u+=E.getPolys().getNumberOfValues(),w&&(d&&(d=0,s=E.getPoints().getDataType()),s=s>(l=E.getPoints().getDataType())?s:l);var I=E.getPointData();I?(m=m&&null!==I.getNormals(),f=f&&null!==I.getTCoords(),v=v&&null!==I.getScalars()):(m=!1,f=!1,v=!1)}}t.outputPointsPrecision===Uo.XJ.SINGLE?s=ko.Tu.FLOAT:t.outputPointsPrecision===Uo.XJ.DOUBLE&&(s=ko.Tu.DOUBLE);var C=Lo.ZP.newInstance({dataType:s});C.setNumberOfPoints(r);var T=C.getData(),b=new Uint32Array(c),_=new Uint32Array(h),D=new Uint32Array(g),S=new Uint32Array(u),O=null,y=null,x=null,M=n[i-1];if(m){var R=M.getPointData().getNormals();O=No.ZP.newInstance({numberOfComponents:3,numberOfTuples:r,size:3*r,dataType:R.getDataType(),name:R.getName()})}if(f){var N=M.getPointData().getTCoords();y=No.ZP.newInstance({numberOfComponents:2,numberOfTuples:r,size:2*r,dataType:N.getDataType(),name:N.getName()})}if(v){var P=M.getPointData().getScalars();x=No.ZP.newInstance({numberOfComponents:P.getNumberOfComponents(),numberOfTuples:r,size:r*P.getNumberOfComponents(),dataType:P.getDataType(),name:P.getName()})}r=0,c=0,h=0,g=0,u=0;for(var L=0;L<i;L++){var A=n[L];T.set(A.getPoints().getData(),3*r),Ho(b,A.getVerts().getData(),r,c),c+=A.getVerts().getNumberOfValues(),Ho(_,A.getLines().getData(),r,h),h+=A.getLines().getNumberOfValues(),Ho(D,A.getStrips().getData(),r,g),g+=A.getStrips().getNumberOfValues(),Ho(S,A.getPolys().getData(),r,u),u+=A.getPolys().getNumberOfValues();var U=A.getPointData();if(m){var k=U.getNormals();O.getData().set(k.getData(),3*r)}if(f){var V=U.getTCoords();y.getData().set(V.getData(),2*r)}if(v){var H=U.getScalars();x.getData().set(H.getData(),r*x.getNumberOfComponents())}r+=A.getPoints().getNumberOfPoints()}a.setPoints(C),a.getVerts().setData(b),a.getLines().setData(_),a.getStrips().setData(D),a.getPolys().setData(S),O&&a.getPointData().setNormals(O),y&&a.getPointData().setTCoords(y),x&&a.getPointData().setScalars(x),o[0]=a}else o[0]=n[0];else Vo("No input specified.")}}(e,t)}var Bo={newInstance:Po.default.newInstance(Fo,"vtkAppendPolyData"),extend:Fo},Go=n(31954),$o=n(84661),Ko=n(74462);function qo(e,t,n){let o=e.segmentSpecificConfig?.[t];return o||(o=e.segmentSpecificConfig?.[n]),o?o.CONTOUR:null}const zo=new Map;function jo(e){return zo.get(e)}function Zo(e,t){zo.set(e,t)}function Yo(e,t,n,o,i){const{segmentationRepresentationUID:a,segmentsHidden:r}=n,s=Bo.newInstance(),l=new Map,d=new Map;t.forEach((e=>{const t=J.cache.getGeometry(e);if(!t)return void console.warn(`No geometry found for geometryId ${e}. Skipping render.`);const o=t.data.getSegmentIndex();!function(e){if(!e)throw new Error(`No contours found for geometryId ${e.id}`);const t=e.id;if(e.type!==J.Enums.GeometryType.CONTOUR)throw new Error(`Geometry type ${e.type} not supported for rendering.`);e.data||console.warn(`No contours found for geometryId ${t}. Skipping render.`)}(t);const i=qo(n,e,o),a=t.data,c=function(e){const t=[],n=Lo.ZP.newInstance(),o=Ko.ZP.newInstance();let i=0;e.getContours().forEach((e=>{const n=e.getPoints(),a=e.getFlatPointsArray(),r=e.getType(),s=n.map(((e,t)=>t+i));r===J.Enums.ContourType.CLOSED_PLANAR&&s.push(s[0]);const l=Float32Array.from(a);t.push(...l),o.insertNextCell([...s]),i+=n.length})),n.setData(t,3);const a=Ao.ZP.newInstance();return a.setPoints(n),a.setLines(o),a}(a),h=a.getColor(),g=c.getPoints().getNumberOfPoints(),u=No.ZP.newInstance({size:4*g,numberOfComponents:4,dataType:"Uint8Array"});for(let e=0;e<g;++e)u.setTuple(e,[...h,255]);c.getPointData().setScalars(u),i&&d.set(o,i),l.set(o,[...h,r.has(o)?0:255]),0===o?s.setInputData(c):s.addInputData(c)}));const c=s.getOutputData(),h=o.representations.CONTOUR.outlineWidthActive,g=$o.ZP.newInstance();g.setInputData(c);const u=Go.ZP.newInstance();u.setMapper(g),u.getProperty().setLineWidth(h),Zo(a,Object.assign({},jo(a),{segmentsHidden:new Set(r),segmentSpecificMap:d,outlineWidthActive:h})),u.setForceOpaque(!0),e.addActor({uid:i,actor:u}),e.resetCamera(),e.render()}function Jo(e,t,n,o,i){const{segmentationRepresentationUID:a,segmentsHidden:r}=n,s=o.representations.CONTOUR,l=jo(a),d=e.getActor(i);if(!d)return void console.warn(`No contour actor found for actorUID ${i}. Skipping render.`);const{actor:c}=d,h=s.outlineWidthActive;l?.outlineWidthActive!==h&&(c.getProperty().setLineWidth(h),Zo(a,Object.assign({},l,{outlineWidthActive:h})));const g=c.getMapper(),u=g.getLookupTable(),m=[],f=[];for(const e of r)l.segmentsHidden.has(e)||m.push(e);for(const e of l.segmentsHidden)r.has(e)||f.push(e);const v=Array.from(l.segmentsHidden).filter((e=>!f.includes(e))).concat(m),{contourSets:p,segmentSpecificConfigs:E}=t.reduce(((e,t)=>{const o=J.cache.getGeometry(t),{data:i}=o,a=i.getSegmentIndex(),r=qo(n,t,a);return e.contourSets.push(i),e.segmentSpecificConfigs[a]=r??{},e}),{contourSets:[],segmentSpecificConfigs:{}}),w=[...v,...f],I=Object.values(E).some((e=>Object.keys(e).length>0));let C=!1;if(w.length||I){const e=g.getInputData(),t=e.getPointData().getScalars().getData();let n=0;p.forEach((e=>{const o=e.getSegmentIndex(),i=e.getTotalNumberOfPoints();if(w.includes(o)||E[o]?.fillAlpha){const a=e.getColor();let r=v.includes(o)?0:255;const s=E[o];void 0!==s.fillAlpha&&(r=255*s.fillAlpha);for(let e=0;e<i;++e)t[n+4*e]=a[0],t[n+4*e+1]=a[1],t[n+4*e+2]=a[2],t[n+4*e+3]=r;C=!0}n+=4*i})),C&&e.modified(),Zo(a,Object.assign({},l,{segmentsHidden:new Set(r)})),g.setLookupTable(u)}e.render()}const Xo=function(e,t,n=!1){const o=(0,J.getEnabledElement)(e),{viewport:i}=o,a=i.getActors().map((({uid:e})=>e.includes(t)?e:void 0)).filter(Boolean);i.removeActors(a)};const Qo={render:async function(e,t,n){const{segmentationId:o}=t,i=jn(o).representationData[ie.Contour],{geometryIds:a}=i;a?.length||console.warn(`No contours found for segmentationId ${o}. Skipping render.`),function(e,t,n,o){const{segmentationRepresentationUID:i}=n,a=`CONTOUR_${i}`;(e.getActor(a)?Jo:Yo)(e,t,n,o,a)}(e,a,t,n)},addSegmentationRepresentation:async function(e,t,n){const{segmentationId:o}=t,i=J.utilities.uuidv4(),a=new Set,r={segmentationId:o,segmentationRepresentationUID:i,type:ie.Contour,segmentsHidden:a,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}};if(n){const t=wo(e),o=J.utilities.deepMerge(t,n);Io(e,{renderInactiveSegmentations:o.renderInactiveSegmentations||!0,representations:{...o.representations}})}return ao(e,r),i},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){const n=ou(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:o}=n;for(const e of o){const{viewportId:n,renderingEngineId:o}=e,i=(0,J.getEnabledElementByIds)(n,o);Xo(i.viewport.element,t)}}(e,t),ho(e,t),function(e){zo.delete(e)}(t),n){ou(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{(0,J.getEnabledElementByIds)(e,t).viewport.render()}))}}};const ei=function(e,t,n){const o=Jn(e);if(!o||0===o.length)return;const i=o.map((e=>e.segmentationRepresentationUID));let a=t;if(a){const e=t.filter((e=>!i.includes(e)));if(e.length>0)throw new Error(`The following segmentationRepresentationUIDs are not part of the toolGroup: ${JSON.stringify(e)}`)}else a=i;a.forEach((t=>{!function(e,t,n){const o=lo(e,t),{type:i}=o;if(i===ie.Labelmap)Ro.removeSegmentationRepresentation(e,t,n);else{if(i!==ie.Contour)throw new Error(`The representation ${i} is not supported yet`);Qo.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))};const ti=function(e){if(!e.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");const t=e.representation.data;if(!t.volumeId)throw new Error("The segmentationInput.representationData.volumeId is undefined, please provide a valid representationData.volumeId");if(!J.cache.getVolume(t.volumeId))throw new Error(`volumeId of ${t.volumeId} not found in cache, you should load and cache volume before adding segmentation`)};const ni=function(e){if(!e||!e.length)throw new Error("The segmentationInputArray is undefined or empty array");e.forEach((e=>{if(void 0===e.segmentationId)throw new Error("The segmentationInput.segmentationId is undefined, please provide a valid segmentationId");if(void 0===e.representation)throw new Error("The segmentationInput.representation is undefined, please provide a valid representation");e.representation.type===ie.Labelmap&&ti(e)}))};const oi=function(e){ni(e),e.map((e=>{Yn(se()(e))}))};const ii=async function(e,t,n){if(!ou(e))throw new Error(`No tool group found for toolGroupId: ${e}`);const o=t.map((t=>async function(e,t,n){let o;if(t.type===ie.Labelmap)o=await Ro.addSegmentationRepresentation(e,t,n);else{if(t.type!==ie.Contour)throw new Error(`The representation type ${t.type} is not supported`);o=await Qo.addSegmentationRepresentation(e,t,n)}return o}(e,t,n)));return await Promise.all(o)};function ai(e){const t=zn().getSegmentationRepresentations(e);if(!t)return;return t.find((e=>e.active))}function ri(e,t){zn().setActiveSegmentationRepresentation(e,t),Gn(e,t)}function si(e,t){const n=jn(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:o}=n;return o.has(t)}function li(e,t,n=!0){const o=jn(e);if(!o)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:i}=o;n?i.add(t):i.delete(t),$n(e)}function di(e){const t=jn(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:n}=t;return Array.from(n)}function ci(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");J.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),mo(e,t)}function hi(e,t,n){const o=lo(e,t);if(!o)throw new Error(`setColorLUT: could not find segmentation representation with UID ${t}`);if(!uo(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);o.colorLUTIndex=n,Gn(e,t)}function gi(e,t,n){const o=lo(e,t);if(!o)throw new Error(`segmentation representation with UID ${t} does not exist for tool group ${e}`);const{colorLUTIndex:i}=o;return uo(i)[n]}function ui(e,t,n,o){const i=gi(e,t,n);for(let e=0;e<o.length;e++)i[e]=o[e];Gn(e,t)}function mi(e,t,n){const o=Jn(e);if(!o)return;const i=o.find((e=>e.segmentationRepresentationUID===t));if(!i)return;const{segmentsHidden:a,segmentationId:r}=i,s=function(e){const t=jn(e);if(t.type===ie.Labelmap){const t=J.cache.getVolume(e).getScalarData(),n={};for(let e=0;e<t.length;e++){const o=t[e];0===o||n[o]||(n[o]=!0)}return Object.keys(n).map((e=>parseInt(e,10)))}if(t.type===ie.Contour){const n=t.representationData.CONTOUR?.geometryIds;if(!n)throw new Error(`No geometryIds found for segmentationId ${e}`);return n.map((e=>J.cache.getGeometry(e).data.getSegmentIndex()))}}(r);n?a.clear():s.forEach((e=>{a.add(e)})),Gn(e,i.segmentationRepresentationUID)}function fi(e,t){const n=Jn(e).find((e=>e.segmentationRepresentationUID===t));if(!n)return;const{segmentsHidden:o}=n;return 0===o.size}function vi(e,t,n,o){const i=lo(e,t);i&&(n.forEach((e=>{o?i.segmentsHidden.delete(e):i.segmentsHidden.add(e)})),Gn(e,t))}function pi(e,t,n,o){const i=lo(e,t);i&&(o?i.segmentsHidden.delete(n):i.segmentsHidden.add(n),Gn(e,t))}function Ei(e,t){const n=jn(e);n?.activeSegmentIndex!==t&&(n.activeSegmentIndex=t,$n(e))}function wi(e){const t=jn(e);if(t)return t.activeSegmentIndex}class Ii{constructor(e,t){const n=J.utilities.deepMerge(t,e),{configuration:o={},supportedInteractionTypes:i,toolGroupId:a}=n;o.strategies||(o.strategies={},o.defaultStrategy=void 0,o.activeStrategy=void 0,o.strategyOptions={}),this.toolGroupId=a,this.supportedInteractionTypes=i||[],this.configuration=Object.assign({},o),this.mode=X.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:o}=this.configuration;return n[o].call(this,e,t)}setConfiguration(e){this.configuration=J.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetVolumeId(e){if(this.configuration.volumeId)return this.configuration.volumeId;const t=e.getActors();return t?t.find((e=>"vtkVolume"===e.actor.getClassName()))?.uid:void 0}getTargetIdImage(e,t){if(e.startsWith("imageId:")){const n=e.split("imageId:")[1],o=J.utilities.imageIdToURI(n);let i=J.utilities.getViewportsWithImageURI(o,t.id);if(!i||!i.length)return;if(i=i.filter((e=>e.getCurrentImageId()===n)),!i||!i.length)return;return i[0].getImageData()}if(e.startsWith("volumeId:")){const n=e.split("volumeId:")[1],o=J.utilities.getViewportsWithVolumeId(n,t.id);if(!o||!o.length)return;return o[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){if(e instanceof J.StackViewport)return`imageId:${e.getCurrentImageId()}`;if(e instanceof J.BaseVolumeViewport)return`volumeId:${this.getTargetVolumeId(e)}`;throw new Error("getTargetId: viewport must be a StackViewport or VolumeViewport")}}Ii.toolName="BaseTool";const Ci=Ii;var Ti=n(88256);const bi="viewport-element";function _i(e,t){if(Ke.svgNodeCache[e])return Ke.svgNodeCache[e][t]?Ke.svgNodeCache[e][t].domRef:void 0}function Di(e,t,n,o){if(!Ke.svgNodeCache[t])return null;Ke.svgNodeCache[t][o]={touched:!0,domRef:n},e.appendChild(n)}function Si(e,t){Ke.svgNodeCache[e]&&Ke.svgNodeCache[e][t]&&(Ke.svgNodeCache[e][t].touched=!0)}function Oi(e,t){Ke.svgNodeCache[t]&&Object.keys(Ke.svgNodeCache[t]).forEach((n=>{const o=Ke.svgNodeCache[t][n];!o.touched&&o.domRef&&(e.removeChild(o.domRef),delete Ke.svgNodeCache[t][n])}))}const yi=function(e){const t=(0,J.getEnabledElement)(e),{viewportId:n,renderingEngineId:o}=t,i=`${n}:${o}`,a=function(e){const t=`.${bi}`,n=e.querySelector(t);return n.querySelector(".svg-layer")}(e);return Object.keys(Ke.svgNodeCache[i]).forEach((e=>{Ke.svgNodeCache[i][e].touched=!1})),{svgLayerElement:a,svgNodeCacheForCanvas:Ke.svgNodeCache,getSvgNode:_i.bind(this,i),appendNode:Di.bind(this,a,i),setNodeTouched:Si.bind(this,i),clearUntouched:Oi.bind(this,a,i)}};const xi=function(e,t){const n=yi(e);t(n),n.clearUntouched()};const Mi=function(e,t,n){return`${e}::${t}::${n}`};const Ri=function(e,t){Object.keys(e).forEach((n=>{const o=t.getAttribute(n),i=e[n];void 0===i||""===i?t.removeAttribute(n):o!==i&&t.setAttribute(n,i)}))};const Ni=function(e,t){Object.keys(e).forEach((n=>{const o=e[n];void 0!==o&&""!==o&&t.setAttribute(n,o)}))};const Pi=function(e,t,n,o,i,a={},r=""){const{color:s,fill:l,width:d,lineWidth:c,lineDash:h}=Object.assign({color:"dodgerblue",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0},a),g=c||d,u=Mi(t,"circle",n),m=e.getSvgNode(u),f={cx:`${o[0]}`,cy:`${o[1]}`,r:`${i}`,stroke:s,fill:l,"stroke-width":g,"stroke-dasharray":h};if(m)Ri(f,m),e.setNodeTouched(u);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==r&&t.setAttribute("data-id",r),Ni(f,t),e.appendNode(t,u)}};const Li=function(e,t,n,o,i,a={},r=""){const{color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),h=d||l,g=Mi(t,"ellipse",n),u=e.getSvgNode(g),m=Math.abs(o[0]-i[0]),f=Math.abs(o[1]-i[1]),v=[Math.min(o[0],i[0])+m/2,Math.min(o[1],i[1])+f/2],p={cx:`${v[0]}`,cy:`${v[1]}`,rx:`${m/2}`,ry:`${f/2}`,stroke:s,fill:"transparent","stroke-width":h,"stroke-dasharray":c};if(u)Ri(p,u),e.setNodeTouched(g);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==r&&t.setAttribute("data-id",r),Ni(p,t),e.appendNode(t,g)}};const Ai=function(e,t,n,o,i={}){const{color:a,handleRadius:r,width:s,lineWidth:l,fill:d,type:c,opacity:h}=Object.assign({color:"dodgerblue",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},i),g=l||s;for(let i=0;i<o.length;i++){const s=o[i],l="http://www.w3.org/2000/svg",u=Mi(t,"handle",`hg-${n}-index-${i}`);let m;if("circle"===c)m={cx:`${s[0]}`,cy:`${s[1]}`,r,stroke:a,fill:d,"stroke-width":g,opacity:h};else{if("rect"!==c)throw new Error(`Unsupported handle type: ${c}`);{const e=1.5*parseFloat(r);m={x:`${s[0]-.5*e}`,y:`${s[1]-.5*e}`,width:`${e}`,height:`${e}`,stroke:a,fill:d,"stroke-width":g,rx:""+.1*e,opacity:h}}}const f=e.getSvgNode(u);if(f)Ri(m,f),e.setNodeTouched(u);else{const t=document.createElementNS(l,c);Ni(m,t),e.appendNode(t,u)}}};function Ui(e,t,n,o,i,a={},r=""){if(isNaN(o[0])||isNaN(o[1])||isNaN(i[0])||isNaN(i[1]))return;const{color:s,width:l,lineWidth:d,lineDash:c,shadow:h}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},a),g=d||l,u=Mi(t,"line",n),m=e.getSvgNode(u),f=h?`filter:url(#shadow-${e.svgLayerElement.id});`:"",v={x1:`${o[0]}`,y1:`${o[1]}`,x2:`${i[0]}`,y2:`${i[1]}`,stroke:s,style:f,"stroke-width":g,"stroke-dasharray":c};if(m)Ri(v,m),e.setNodeTouched(u);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==r&&t.setAttribute("data-id",r),Ni(v,t),e.appendNode(t,u)}}function ki(e,t,n,o,i){if(o.length<2)return;const{color:a,width:r,lineWidth:s,lineDash:l}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},i),d=s||r,c=Mi(t,"polyline",n),h=e.getSvgNode(c);let g="";for(const e of o)g+=`${e[0]}, ${e[1]} `;if(i.connectLastToFirst){const e=o[0];g+=`${e[0]}, ${e[1]}`}const u={points:g,stroke:a,fill:"none","stroke-width":d,"stroke-dasharray":l};if(h)Ri(u,h),e.setNodeTouched(c);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");Ni(u,t),e.appendNode(t,c)}}function Vi(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function Hi(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const o=e.getBBox(),i={x:`${o.x}`,y:`${o.y}`,width:`${o.width}`,height:`${o.height}`,fill:t};return Ri(i,n),o}const Wi=function(e,t,n,o,i,a={}){return function(e,t,n,o=[""],i,a){const{padding:r,color:s,fontFamily:l,fontSize:d,background:c}=a;let h;const[g,u]=[i[0]+r,i[1]+r],m="http://www.w3.org/2000/svg",f=Mi(t,"text",n),v=e.getSvgNode(f);if(v){const t=v.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){const t=n[e],i=o[e]||"";t.textContent=i}if(o.length>n.length){for(let e=0;e<o.length-n.length;e++){const i=Vi(o[e+n.length]);t.appendChild(i)}v.appendChild(t),e.appendNode(v,f)}const i={transform:`translate(${g} ${u})`};Ri({fill:s,"font-size":d,"font-family":l},t),Ri(i,v),h=Hi(v,c),e.setNodeTouched(f)}else{const t=document.createElementNS(m,"g");t.setAttribute("transform",`translate(${g} ${u})`);const n=function(e,t){const{color:n,fontFamily:o,fontSize:i}=t,a="http://www.w3.org/2000/svg",r=document.createElementNS(a,"text"),s="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",l=`filter:url(#shadow-${e.svgLayerElement.id});`,d=`${s}${l}`;return r.setAttribute("x","0"),r.setAttribute("y","0"),r.setAttribute("fill",n),r.setAttribute("font-family",o),r.setAttribute("font-size",i),r.setAttribute("style",d),r}(e,a);for(let e=0;e<o.length;e++){const t=Vi(o[e]);n.appendChild(t)}t.appendChild(n),e.appendNode(t,f),h=Hi(t,c)}return Object.assign({},h,{x:g,y:u,height:h.height+r,width:h.width+r})}(e,t,n,o,i,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a))};function Fi(e,t){let n=[0,0],o=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){const i=function(e,t){const[n,o]=e,[i,a]=t;return Math.sqrt(Math.pow(n-i,2)+Math.pow(o-a,2))}(t,e);i<o&&(o=i,n=[...e])})),n}const Bi=function(e,t,n,o,i,a,r={}){const s=o.length>0?Fi(o,i):i,l=function(e){const{x:t,y:n,height:o,width:i}=e,a=i/2,r=o/2;return[[t+a,n],[t,n+r],[t+a,n+o],[t+i,n+r]]}(a);Ui(e,t,`link-${n}`,s,Fi(l,s),Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},r))};const Gi=function(e,t,n,o,i,a,r,s={}){const l=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},s),d=Wi(e,t,n,o,i,l);return Bi(e,t,n,a,i,d,l),d};function $i(e,t,n,o,i,a={},r=""){const{color:s,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),h=d||l,g=Mi(t,"rect",n),u=e.getSvgNode(g),m=[Math.min(o[0],i[0]),Math.min(o[1],i[1])],f=Math.abs(o[0]-i[0]),v=Math.abs(o[1]-i[1]),p={x:`${m[0]}`,y:`${m[1]}`,width:`${f}`,height:`${v}`,stroke:s,fill:"transparent","stroke-width":h,"stroke-dasharray":c};if(u)Ri(p,u),e.setNodeTouched(g);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==r&&t.setAttribute("data-id",r),Ni(p,t),e.appendNode(t,g)}}function Ki(e,t,n,o,i,a={}){if(isNaN(o[0])||isNaN(o[1])||isNaN(i[0])||isNaN(i[1]))return;const{color:r,width:s,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a);Ui(e,t,n,o,i,{color:r,width:s,lineWidth:l,lineDash:d});const c=Math.atan2(i[1]-o[1],i[0]-o[0]),h={start:[i[0]-10*Math.cos(c-Math.PI/7),i[1]-10*Math.sin(c-Math.PI/7)],end:i},g={start:[i[0]-10*Math.cos(c+Math.PI/7),i[1]-10*Math.sin(c+Math.PI/7)],end:i};Ui(e,t,"2",h.start,h.end,{color:r,width:s,lineWidth:l}),Ui(e,t,"3",g.start,g.end,{color:r,width:s,lineWidth:l})}function qi(e,t){const n=(0,J.getEnabledElement)(e),{renderingEngineId:o,viewportId:i}=n,a=Ng(i,o);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const n=s[e],o=a.toolOptions[n];if(o&&t.includes(o.mode)){const e=a.getToolInstance(n);r.push(e)}}return r}const{Active:zi,Passive:ji,Enabled:Zi}=X;const Yi=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach((e=>{this._needsRender.add(e)})),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach((e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,J.getEnabledElement)(e);if(!t)return void console.warn("Element has been disabled");if(!(0,J.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=qi(e,[zi,ji,Zi]),{renderingEngineId:o,viewportId:i}=t,a={element:e,renderingEngineId:o,viewportId:i};xi(e,(o=>{let i=!1;n.forEach((e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,o);i=i||n}})),i&&(0,J.triggerEvent)(e,ne.ANNOTATION_RENDERED,{...a})}))}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}};const Ji=function(e){Yi.renderViewport(e)},{EPSILON:Xi}=J.CONSTANTS,Qi=1-Xi;function ea(e,t,n){const{viewPlaneNormal:o}=t,i=e.filter((e=>{let t=e.metadata.viewPlaneNormal;if(!t){const{referencedImageId:n}=e.metadata,{imageOrientationPatient:o}=J.metaData.get("imagePlaneModule",n),i=Ti.R3.fromValues(o[0],o[1],o[2]),a=Ti.R3.fromValues(o[3],o[4],o[5]);t=Ti.R3.create(),Ti.R3.cross(t,i,a),e.metadata.viewPlaneNormal=t}const n=Math.abs(Ti.R3.dot(o,t))>Qi;return t&&n}));if(!i.length)return[];const a=n/2,{focalPoint:r}=t,s=[];for(const e of i){const t=e.data.handles.points[0];if(!e.isVisible)continue;const n=Ti.R3.create();Ti.R3.sub(n,r,t);const i=Ti.R3.dot(n,o);Math.abs(i)<a&&s.push(e)}return s}function ta(e,t){if(e instanceof J.StackViewport){const n=e.getCurrentImageId(),o=n.indexOf(":"),i=n.substring(o+1);return t.filter((e=>{if(!e.isVisible)return!1;const t=e.metadata.referencedImageId;if(void 0===t)return!1;const n=t.indexOf(":");return t.substring(n+1)===i}))}if(e instanceof J.VolumeViewport){const n=e.getCamera(),{spacingInNormalDirection:o}=J.utilities.getTargetVolumeAndSpacingInNormalDir(e,n);return ea(t,n,o)}throw new Error(`Viewport Type ${e.type} not supported`)}const na=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:o,toolGroupId:i,toolName:a}=t;return this._getToolStyle(e,n,o,i,a)}_getToolStyle(e,t,n,o,i){if(t){const n=this.getAnnotationToolStyles(t);if(n&&n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[i]&&t[i][e])return t[i][e];if(t.global&&t.global[e])return t.global[e]}}if(o){const t=this.getToolGroupToolStyles(o);if(t){if(t[i]&&t[i][e])return t[i][e];if(t.global&&t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[i]&&a[i][e]?a[i][e]:a.global&&a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}};function oa(e,t,n,o){const i=function(e,t,n){const o=[`${e}`];return t&&o.push(`${o[0]}${t}`),n&&o.push(`${o[o.length-1]}${n}`),o}(e,n,o);for(let e=i.length-1;e>=0;--e){const n=na.getStyleProperty(i[e],t);if(void 0!==n)return n}}const ia=function(e){if(e){if(e.data&&e.highlighted)return ee.Highlighted;if(De(e.annotationUID))return ee.Selected;if(ge(e))return ee.Locked}return ee.Default};const aa=function(e,t,n){return`${oa("textBoxFontSize",e,t,n)}px ${oa("textBoxFontFamily",e,t,n)}`};class ra extends Ci{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{const{element:t,rowScale:n,columnScale:o,imageId:i,imageData:a,worldToIndex:r}=e.detail,{viewport:s}=(0,J.getEnabledElement)(t);if(s instanceof J.VolumeViewport)throw new Error("Cannot calibrate a volume viewport");const l=a.getIndexToWorld(),d=J.utilities.imageIdToURI(i),c=lu();c.getFramesOfReference().forEach((e=>{const i=c.getAnnotations(e)[this.getToolName()];i&&i.length&&(i.forEach((e=>{J.utilities.imageIdToURI(e.metadata.referencedImageId)===d&&(e.invalidated=!0,e.data.cachedStats={},e.data.handles.points=e.data.handles.points.map((e=>{const t=Ti.vh.fromValues(...e,1),i=Ti.vh.fromValues(0,0,0,1),a=Ti.vh.create();Ti.vh.transformMat4(a,t,r);const s=[o*a[0],n*a[1],a[2]];return Ti.vh.transformMat4(i,Ti.vh.fromValues(s[0],s[1],s[2],1),l),i.slice(0,3)})))})),Ji(t))}))}}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,J.getEnabledElement)(e),{viewport:o}=n;return ta(o,t)}getReferencedImageId(e,t,n,o){const i=this.getTargetId(e);let a;if(e instanceof J.StackViewport)a=i.split("imageId:")[1];else{const e=i.split("volumeId:")[1],o=J.cache.getVolume(e);a=J.utilities.getClosestImageId(o,t,n)}return a}getStyle(e,t,n){return oa(e,t,ia(n),this.mode)}}ra.toolName="AnnotationDisplayTool";const sa=ra;class la extends sa{constructor(){super(...arguments),this.mouseMoveCallback=(e,t)=>{if(!t)return!1;const{element:n,currentPoints:o}=e.detail,i=o.canvas;let a=!1;for(const e of t){if(ge(e)||!Pe(e.annotationUID))continue;const{data:t}=e,o=t.handles?t.handles.activeHandleIndex:void 0,r=this._imagePointNearToolOrHandle(n,e,i,6),s=r&&!e.highlighted,l=!r&&e.highlighted;s||l?(e.highlighted=!e.highlighted,a=!0):t.handles&&t.handles.activeHandleIndex!==o&&(a=!0)}return a}}getHandleNearImagePoint(e,t,n,o){const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s,textBox:l}=r.handles,{worldBoundingBox:d}=l;if(d){const e={topLeft:a.worldToCanvas(d.topLeft),topRight:a.worldToCanvas(d.topRight),bottomLeft:a.worldToCanvas(d.bottomLeft),bottomRight:a.worldToCanvas(d.bottomRight)};if(n[0]>=e.topLeft[0]&&n[0]<=e.bottomRight[0]&&n[1]>=e.topLeft[1]&&n[1]<=e.bottomRight[1])return r.handles.activeHandleIndex=null,l}for(let e=0;e<s.length;e++){const t=s[e],i=a.worldToCanvas(t);if(!0===Ti.K4.distance(n,i)<o)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null}getLinkedTextBoxStyle(e,t){return{fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}isSuvScaled(e,t,n){if(e instanceof J.BaseVolumeViewport){const e=t.split("volumeId:")[1],n=J.cache.getVolume(e);return void 0!==n.scaling?.PET}if(e instanceof J.StackViewport){const e=n&&J.metaData.get("scalingModule",n);return"number"==typeof e?.suvbw}throw new Error("Viewport is not a valid type")}_imagePointNearToolOrHandle(e,t,n,o){if(this.getHandleNearImagePoint(e,t,n,o))return!0;return!!this.isPointNearTool(e,t,n,o,"mouse")||void 0}}la.toolName="AnnotationTool";const da=la;class ca extends Ci{constructor(e={},t={configuration:{}}){super(e,t),this.renderSegmentation=e=>{const t=ou(e);if(!t)return;const n=Jn(e);if(!n||0===n.length)return;const o=t.viewportsInfo.map((({renderingEngineId:e,viewportId:t})=>{const n=(0,J.getEnabledElementByIds)(t,e);if(n)return n.viewport})),i=n.map((t=>{const n=this._getMergedRepresentationsConfig(e),i=[];for(const e of o)t.type==ie.Labelmap?i.push(Ro.render(e,t,n)):t.type==ie.Contour&&i.push(Qo.render(e,t,n));return i}));Promise.allSettled(i).then((()=>{o.forEach((e=>{e.render()}))}))}}onSetToolEnabled(){const e=this.toolGroupId,t=Jn(e);t&&0!==t.length&&t.forEach((t=>{mi(e,t.segmentationRepresentationUID,!0)}))}onSetToolDisabled(){const e=this.toolGroupId,t=Jn(e);t&&0!==t.length&&t.forEach((t=>{mi(e,t.segmentationRepresentationUID,!1)}))}_getMergedRepresentationsConfig(e){const t=wo(e),n=fo();return J.utilities.deepMerge(n,t)}}ca.toolName="SegmentationDisplay";const ha=ca;const ga=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedToolGroups=()=>{this._throwIfDestroyed();const e=Array.from(this._needsRender.values());for(const t of e)if(this._triggerRender(t),this._needsRender.delete(t),0===this._needsRender.size)return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}}removeToolGroup(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}renderToolGroupSegmentations(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setToolGroupSegmentationToBeRenderedNextFrame(e){e.forEach((e=>{this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}_triggerRender(e){const t=ou(e);if(!t)return void console.warn(`No tool group found with toolGroupId: ${e}`);const{viewportsInfo:n}=t,o=[];n.forEach((({viewportId:e,renderingEngineId:t})=>{const n=(0,J.getRenderingEngine)(t);n?o.push(n.getViewport(e)):console.warn("rendering Engine has been destroyed")}));const i=t.getToolInstance(ha.toolName);function a(e){const{element:t,viewportId:n,renderingEngineId:o}=e.detail;t.removeEventListener(J.Enums.Events.IMAGE_RENDERED,a);const i=Ng(n,o);if(!i)return void console.warn("toolGroup has been destroyed");const r={toolGroupId:i.id,viewportId:n};(0,J.triggerEvent)(J.eventTarget,ne.SEGMENTATION_RENDERED,{...r})}i?(o.forEach((({element:e})=>{e.addEventListener(J.Enums.Events.IMAGE_RENDERED,a)})),i.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}};function ua(e){ga.renderToolGroupSegmentations(e)}const ma=ua,fa=function(e){const{toolGroupId:t}=e.detail;ma(t)},va=function(e){const{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:o,type:i}=jn(t);let a;if(i!==ie.Labelmap)throw new Error(`onSegmentationDataModified: representationType ${i} not supported yet`);{const e=J.cache.getVolume(o[i].volumeId);if(!e)return void console.warn("segmentation not found in cache");const{imageData:r,vtkOpenGLTexture:s}=e;let l;if(n&&Array.isArray(n))l=n;else{const e=r.getDimensions()[2];l=[...Array(e).keys()]}l.forEach((e=>{s.setUpdatedFrame(e)})),r.modified(),a=Xn(t)}a.forEach((e=>{ma(e)}))},pa=function(e){const{toolGroupId:t,segmentationRepresentationUID:n}=e.detail;ma(t)},Ea=function(e){const{segmentationId:t}=e.detail;Xn(t).forEach((e=>{Jn(e).forEach((n=>{n.segmentationId===t&&Gn(e,n.segmentationRepresentationUID)}))}))};function wa(e,t,n=5){const o=(0,J.getEnabledElement)(e);if(!o)throw new Error("getAnnotationNearPoint: enabledElement not found");return Ia(o,t,n)}function Ia(e,t,n){const{renderingEngineId:o,viewportId:i}=e,a=Ng(i,o);if(!a)return null;const{_toolInstances:r}=a;for(const o in r){const i=Ca(r[o],e,t,n);if(i)return i}return null}function Ca(e,t,n,o){const{viewport:i}=t,a=hu(e.constructor.toolName,i?.element),r=i?.getCurrentImageId?.();if(a?.length){const{element:i}=t.viewport;for(const t of a){const a=t.metadata?.referencedImageId;if(!(r&&a&&r!==a||!e.isPointNearTool)&&(e.isPointNearTool(i,t,n,o,"")||e.getHandleNearImagePoint(i,t,n,o)))return t}}return null}const Ta=function(e){const t=typeof e;return null!==e&&("object"===t||"function"===t)};const ba=function(e,t,n){let o,i,a,r,s,l,d=0,c=!1,h=!1,g=!0;const u=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function m(t){const n=o,a=i;return o=i=void 0,d=t,r=e.apply(a,n),r}function f(e,t){return u?window.requestAnimationFrame(e):setTimeout(e,t)}function v(e){const n=e-l;return void 0===l||n>=t||n<0||h&&e-d>=a}function p(){const e=Date.now();if(v(e))return E(e);s=f(p,function(e){const n=e-d,o=t-(e-l);return h?Math.min(o,a-n):o}(e))}function E(e){return s=void 0,g&&o?m(e):(o=i=void 0,r)}function w(...e){const n=Date.now(),a=v(n);if(o=e,i=this,l=n,a){if(void 0===s)return function(e){return d=e,s=f(p,t),c?m(e):r}(l);if(h)return s=f(p,t),m(l)}return void 0===s&&(s=f(p,t)),r}return t=Number(t)||0,Ta(n)&&(c=Boolean(n.leading),h="maxWait"in n,a=h?Math.max(Number(n.maxWait)||0,t):a,g="trailing"in n?Boolean(n.trailing):g),w.cancel=function(){void 0!==s&&function(e){if(u)return window.cancelAnimationFrame(e);clearTimeout(e)}(s),d=0,o=l=i=s=void 0},w.flush=function(){return void 0===s?r:E(Date.now())},w.pending=function(){return void 0!==s},w};const _a=function(e,t,n){let o=!0,i=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return Ta(n)&&(o="leading"in n?Boolean(n.leading):o,i="trailing"in n?Boolean(n.trailing):i),ba(e,t,{leading:o,trailing:i,maxWait:t})};function Da(e,t,n){return Math.min(Math.max(t,e),n)}const Sa=Da,{calibratedPixelSpacingMetadataProvider:Oa}=J.utilities;function ya(e,t,n,o){o||(o=n),Oa.add(e,{rowPixelSpacing:n,columnPixelSpacing:o});t.getStackViewports().forEach((t=>{t.getImageIds().includes(e)&&t.calibrateSpacing(e)}))}const xa=function(e,t){t.length&&t.forEach((t=>{const{element:n}=e.getViewport(t);Ji(n)}))};function Ma(e,t){if(!(0,J.getEnabledElement)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof J.StackViewport&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");const{type:n}=e,{volumeId:o,delta:i}=t;if(e instanceof J.StackViewport)e.scroll(i,t.debounceLoading,t.loop);else{if(!(e instanceof J.VolumeViewport))throw new Error(`Not implemented for Viewport Type: ${n}`);!function(e,t,n){const{numScrollSteps:o,currentStepIndex:i,sliceRangeInfo:a}=J.utilities.getVolumeViewportScrollInfo(e,t);if(!a)return;const{sliceRange:r,spacingInNormalDirection:s,camera:l}=a,{focalPoint:d,viewPlaneNormal:c,position:h}=l,{newFocalPoint:g,newPosition:u}=J.utilities.snapFocalPointToSlice(d,h,r,c,s,n);e.setCamera({focalPoint:g,position:u}),e.render();const m=i+n;if((m>o||m<0)&&e.getCurrentImageId()){const a={volumeId:t,viewport:e,delta:n,desiredStepIndex:m,currentStepIndex:i,numScrollSteps:o,currentImageId:e.getCurrentImageId()};J.utilities.triggerEvent(J.eventTarget,J.EVENTS.VOLUME_SCROLL_OUT_OF_BOUNDS,a)}}(e,o,i)}}const Ra=async function(e,t={}){const{imageIndex:n,debounceLoading:o,volumeId:i}=t,a=(0,J.getEnabledElement)(e);if(!a)throw new Error("Element has been disabled");const{viewport:r}=a,{imageIndex:s,numberOfSlices:l}=function(e,t){if(e instanceof J.StackViewport)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof J.VolumeViewport)return J.utilities.getImageSliceDataForVolumeViewport(e);throw new Error("Unsupported viewport type")}(r,o),d=function(e,t){const n=e-1;return Sa(t,0,n)}(l,n);Ma(r,{delta:d-s,debounceLoading:o,volumeId:i})};function Na(e,t,n,o){let i,a,r,s,l,d,c;c=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();const h=e.getDimensions();o?[[i,a],[r,s],[l,d]]=o:(i=0,a=h[0],r=0,s=h[1],l=0,d=h[2]);const g=Ti.R3.fromValues(i,r,l),u=e.getDirection(),m=u.slice(0,3),f=u.slice(3,6),v=u.slice(6,9),p=e.getSpacing(),[E,w,I]=p,C=e.indexToWorld(g),T=Ti.R3.fromValues(m[0]*E,m[1]*E,m[2]*E),b=Ti.R3.fromValues(f[0]*w,f[1]*w,f[2]*w),_=Ti.R3.fromValues(v[0]*I,v[1]*I,v[2]*I),D=h[0],S=h[0]*h[1];for(let e=l;e<=d;e++)for(let o=r;o<=s;o++)for(let s=i;s<=a;s++){const a=[s,o,e],d=s-i,h=o-r,g=e-l,u=C,m=[u[0]+d*T[0]+h*b[0]+g*_[0],u[1]+d*T[1]+h*b[1]+g*_[1],u[2]+d*T[2]+h*b[2]+g*_[2]];if(t(m,a)){const t=e*S+o*D+s;n({value:c[t],index:t,pointIJK:a,pointLPS:m})}}}const Pa=function(e,t){const n=e.findIndex((([e,t])=>e===t));if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e};const La=function(e,t){let n=1/0,o=0,i=1/0,a=0,r=1/0,s=0;if(e.forEach((e=>{n=Math.min(e[0],n),o=Math.max(e[0],o),i=Math.min(e[1],i),a=Math.max(e[1],a),r=Math.min(e[2],r),s=Math.max(e[2],s)})),n=Math.floor(n),o=Math.floor(o),i=Math.floor(i),a=Math.floor(a),r=Math.floor(r),s=Math.floor(s),t){const[e,l,d]=t;n=Math.max(0,n),o=Math.min(e-1,o),i=Math.max(0,i),a=Math.min(l-1,a),r=Math.max(0,r),s=Math.min(d-1,s)}return[[n,o],[i,a],[r,s]]},{transformWorldToIndex:Aa}=J.utilities;function Ua(e,t,n,o){const{boundsIJK:i,centerWorld:a,radiusWorld:r}=function(e,t,n){const[o,i]=e,a=Ti.R3.fromValues((o[0]+i[0])/2,(o[1]+i[1])/2,(o[2]+i[2])/2),r=Ti.R3.distance(o,i)/2;let s;if(!n){const e=Aa(t,a),n=t.getSpacing(),o=Math.min(...n),i=Math.ceil(r/o);return s=[[e[0]-i,e[0]+i],[e[1]-i,e[1]+i],[e[2]-i,e[2]+i]],{boundsIJK:s,centerWorld:a,radiusWorld:r}}return s=function(e,t,n,o,i){const[a,r]=n,s=e.getDimensions(),l=t.getCamera(),d=Ti.R3.fromValues(l.viewUp[0],l.viewUp[1],l.viewUp[2]),c=Ti.R3.fromValues(l.viewPlaneNormal[0],l.viewPlaneNormal[1],l.viewPlaneNormal[2]),h=Ti.R3.create();Ti.R3.cross(h,d,c);const g=Ti.R3.create(),u=Ti.R3.create();Ti.R3.scaleAndAdd(g,r,c,i),Ti.R3.scaleAndAdd(u,a,c,-i),Ti.R3.scaleAndAdd(g,g,h,-i),Ti.R3.scaleAndAdd(u,u,h,i);const m=[Aa(e,g),Aa(e,u)],f=La(m,s);return f}(t,n,e,0,r),{boundsIJK:s,centerWorld:a,radiusWorld:r}}(t,e,o),s={center:a,radius:r};Na(e,(e=>function(e,t){const{center:n,radius:o}=e;return(t[0]-n[0])**2+(t[1]-n[1])**2+(t[2]-n[2])**2<=o**2}(s,e)),n,i)}function ka(e,t,n=!0){const{viewport:o}=e,{volume:i,segmentsLocked:a,segmentIndex:r,segmentationId:s,points:l}=t,{imageData:d,dimensions:c}=i,h=i.getScalarData(),g=[];Ua(d,[l[0],l[1]],(({index:e,value:t})=>{a.includes(t)||(h[e]=r,g.push(e))}),o);const u=c[0]*c[1],m=Math.floor(g[0]/u),f=Math.floor(g[g.length-1]/u);Kn(s,Array.from({length:f-m+1},((e,t)=>t+m)))}function Va(e,t){ka(e,t,!0)}function Ha(e,t){Va(e,Object.assign({},t,{segmentIndex:0}))}function Wa(e,t){const{center:n,xRadius:o,yRadius:i,zRadius:a}=e,[r,s,l]=t,[d,c,h]=n;let g=0;return 0!==o&&(g+=(r-d)*(r-d)/(o*o)),0!==i&&(g+=(s-c)*(s-c)/(i*i)),0!==a&&(g+=(l-h)*(l-h)/(a*a)),g<=1}function Fa(e){const[t,n,o,i]=e;return[[o[0],n[1]],[i[0],t[1]]]}const{transformWorldToIndex:Ba}=J.utilities;function Ga(e,t,n=!1){const{volume:o,imageVolume:i,points:a,segmentsLocked:r,segmentIndex:s,segmentationId:l,strategySpecificConfiguration:d}=t,{imageData:c,dimensions:h}=o,g=o.getScalarData(),{viewport:u}=e,m=Ti.R3.fromValues(0,0,0);a.forEach((e=>{Ti.R3.add(m,m,e)})),Ti.R3.scale(m,m,1/a.length);const f=a.map((e=>u.worldToCanvas(e))),[v,p]=Fa(f),E=u.canvasToWorld(v),w=u.canvasToWorld(p),I=[Ba(c,E),Ba(c,w)],C=La(I,h);if(C.every((([e,t])=>e!==t)))throw new Error("Oblique segmentation tools are not supported yet");const T={center:m,xRadius:Math.abs(E[0]-w[0])/2,yRadius:Math.abs(E[1]-w[1])/2,zRadius:Math.abs(E[2]-w[2])/2},b=new Set;let _;_=n?({value:e,index:t,pointIJK:n})=>{r.includes(e)||function(e,t,n){const{THRESHOLD_INSIDE_CIRCLE:o}=n,i=t.getScalarData()[e],{threshold:a}=o;return a[0]<=i&&i<=a[1]}(t,i,d)&&(g[t]=s,b.add(n[2]))}:({value:e,index:t,pointIJK:n})=>{r.includes(e)||(g[t]=s,b.add(n[2]))},Na(c,((e,t)=>Wa(T,e)),_,C);Kn(l,Array.from(b))}function $a(e,t){Ga(e,t,!1)}function Ka(e,t){const{volume:n,imageVolume:o}=t;if(!J.utilities.isEqual(n.dimensions,o.dimensions)||!J.utilities.isEqual(n.direction,o.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");Ga(e,t,!0)}function qa(e,t){$a(e,{...t,segmentIndex:0})}const za=Symbol("DefinedCursors"),ja=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class Za{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof Za?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=Ya(Za,za);let n=t.get(e);return n instanceof Za?n:ja.has(e)?(n=new Za(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof Za){return Ya(Za,za).set(e,t),!0}return!1}}function Ya(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const Ja=ja.values();class Xa extends Za{constructor(e,t,n,o,i){super(o||Xa.getUniqueInstanceName("image-cursor"),i),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){const{url:e,x:t,y:n}=this;let o=`url('${e}')`;return t>=0&&n>=0&&(t>0||n>0)&&(o+=` ${t} ${n}`),this.addFallbackStyleProperty(o)}static getUniqueInstanceName(e){return`${e}-${J.utilities.getRuntimeId(Xa)}`}}const Qa={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},er={x:127,y:60},tr='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',nr='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',or='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',ir='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',ar='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',rr={Angle:sr(Qa,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:sr(Qa,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:sr(Qa,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:sr(Qa,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:sr(Qa,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:sr(Qa,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:sr(Qa,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:sr(Qa,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:sr(Qa,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:sr(Qa,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:sr(Qa,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:sr(Qa,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:sr(Qa,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:sr(Qa,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:sr(Qa,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:sr(Qa,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:sr(Qa,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:sr(Qa,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:sr(Qa,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:sr(Qa,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:sr(Qa,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:sr(Qa,{iconContent:`${or} ${tr}`,viewBox:er}),SegmentationFreeHandFillInside:sr(Qa,{iconContent:`${or} ${nr}`,viewBox:er}),SegmentationFreeHandEraseOutside:sr(Qa,{iconContent:`${or} ${tr}`,viewBox:er}),SegmentationFreeHandFillOutside:sr(Qa,{iconContent:`${or} ${nr}`,viewBox:er}),SegmentationRectangleEraseInside:sr(Qa,{iconContent:`${ir} ${tr}`,viewBox:er}),RectangleScissor:sr(Qa,{iconContent:`${ir} ${nr}`,viewBox:er}),"RectangleScissor.FILL_INSIDE":sr(Qa,{iconContent:`${ir} ${nr}`,viewBox:er}),"RectangleScissor.FILL_OUTSIDE":sr(Qa,{iconContent:`${ir} ${nr}`,viewBox:er}),"RectangleScissor.ERASE_OUTSIDE":sr(Qa,{iconContent:`${ir} ${tr}`,viewBox:er}),"RectangleScissor.ERASE_INSIDE":sr(Qa,{iconContent:`${ir} ${tr}`,viewBox:er}),CircleScissor:sr(Qa,{iconContent:`${ar} ${nr}`,viewBox:er}),"CircleScissor.FILL_INSIDE":sr(Qa,{iconContent:`${ar} ${nr}`,viewBox:er}),"CircleScissor.ERASE_OUTSIDE":sr(Qa,{iconContent:`${ar} ${tr}`,viewBox:er}),"CircleScissor.FILL_OUTSIDE":sr(Qa,{iconContent:`${ar} ${nr}`,viewBox:er})};function sr(e,t){return Object.assign(Object.create(e),t)}function lr(e,t,n){rr[e]=sr(Qa,{iconContent:t,viewBox:n})}const dr=Object.keys(rr),cr=ee.Highlighted,hr=X.Active;class gr extends Xa{constructor(e,t,n,o,i){super(e,t,n,o,i)}static getDefinedCursor(e,t=!1,n){n||(n=oa("color",{},cr,hr));const o=function(e,t,n){const o=t?"pointer":"cursor";return`${o}:${e}/${n}`}(e,t,n);let i=super.getDefinedCursor(o);if(!i){const a=function(e){if(Object.prototype.hasOwnProperty.call(rr,e))return rr[e]}(e);a&&(i=function(e,t,n,o,i){const{x:a,y:r}=e.mousePoint;return new gr(function(e,t,n){return URL.createObjectURL(function(e,t,n){const o=(t?fr:mr)(e,n);return new Blob([o],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:o}),a,r,t,i)}(a,o,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(o,i))}return i}}function ur(e,t){const n=Object(t),o=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,((e,t)=>o(t)?n[t]+"":""))}function mr(e,t){const{iconContent:n,iconSize:o,viewBox:i}=e;return ur(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${o}" height="${o}" viewBox="0 0\n      ${i.x} ${i.y}">\n      ${n}\n    </svg>`,t)}function fr(e,t){const{iconContent:n,iconSize:o,viewBox:i,mousePointerGroupString:a}=e,r=16+o;return ur(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${r}" height="${r}" viewBox="0 0 ${r} ${r}">\n      <g>${a}</g>\n      <g transform="translate(16, 16) scale(${o/Math.max(i.x,i.y,1)})">${n}</g>\n    </svg>`,t)}const vr=function(e,t){let n=gr.getDefinedCursor(t,!0);n||(n=Za.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=Za.getDefinedCursor(t)),Ir(e,n)},pr=[...dr,...Ja],Er=Symbol("ElementCursorsMap");function wr(e,t){br(e)[0]=t,Ir(e,t)}function Ir(e,t){const n=br(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof Za?t:Za.getDefinedCursor("auto")).getStyleProperty()}function Cr(e){Ir(e,br(e)[1])}function Tr(e){Ir(e,Za.getDefinedCursor("none"))}function br(e){let t=br[Er];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(br,Er,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}class _r extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:$a,THRESHOLD_INSIDE_CIRCLE:Ka,ERASE_INSIDE_CIRCLE:qa,FILL_INSIDE_SPHERE:Va,ERASE_INSIDE_SPHERE:Ha},strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25}}){super(e,t),this.onSetToolPassive=()=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=()=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{viewport:i,renderingEngine:a}=o;if(i instanceof J.StackViewport)throw new Error("Not implemented yet");const r=ai(this.toolGroupId);if(!r)throw new Error("No active segmentation detected, create one before using the brush tool");const{segmentationId:s,type:l}=r,d=di(s),{representationData:c}=jn(s),{volumeId:h}=c[l],g=J.cache.getVolume(h),u=i.getActors()[0].uid,m=J.cache.getVolume(u),f=[i.id];return this._editData={segmentation:g,imageVolume:m,segmentsLocked:d},this._activateDraw(n),Tr(n),e.preventDefault(),xa(a,f),!0},this.mouseMoveCallback=e=>{this.mode===X.Active&&this.updateCursor(e)},this._dragCallback=e=>{const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{renderingEngine:i}=o,{imageVolume:a,segmentation:r,segmentsLocked:s}=this._editData;this.updateCursor(e);const{segmentIndex:l,segmentationId:d,segmentationRepresentationUID:c,brushCursor:h,viewportIdsToRender:g}=this._hoverData,{data:u}=h,{viewPlaneNormal:m,viewUp:f}=h.metadata;xa(i,g);const v={points:u.handles.points,volume:r,imageVolume:a,segmentIndex:l,segmentsLocked:s,viewPlaneNormal:m,toolGroupId:this.toolGroupId,segmentationId:d,segmentationRepresentationUID:c,viewUp:f,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(o,v)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{imageVolume:o,segmentation:i,segmentsLocked:a}=this._editData,{segmentIndex:r,segmentationId:s,segmentationRepresentationUID:l,brushCursor:d}=this._hoverData,{data:c}=d,{viewPlaneNormal:h,viewUp:g}=d.metadata;this._deactivateDraw(n),Cr(n);const u=(0,J.getEnabledElement)(n),{viewport:m}=u;if(this._editData=null,this.updateCursor(e),m instanceof J.StackViewport)throw new Error("Not implemented yet");const f={points:c.handles.points,volume:i,imageVolume:o,segmentIndex:r,segmentsLocked:a,viewPlaneNormal:h,toolGroupId:this.toolGroupId,segmentationId:s,segmentationRepresentationUID:l,viewUp:g,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(u,f)},this._activateDraw=e=>{e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.toolGroupId,g=ai(h);if(!g)return void console.warn("No active segmentation detected, create one before using the brush tool");const{segmentationRepresentationUID:u,segmentationId:m}=g,f=wi(m),v=gi(h,u,f),p=[s.id],E={metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:v},data:{}};this._hoverData={brushCursor:E,centerCanvas:i,segmentIndex:f,segmentationId:m,segmentationRepresentationUID:u,segmentColor:v,viewportIdsToRender:p},this._calculateCursor(n,i),xa(r,p)}_calculateCursor(e,t){const n=(0,J.getEnabledElement)(e),{viewport:o}=n,{canvasToWorld:i}=o,{brushSize:a}=this.configuration,r=a,s=[t[0],t[1]+r],l=[t[0],t[1]-r],d=[t[0]-r,t[1]],c=[t[0]+r,t[1]],{brushCursor:h}=this._hoverData,{data:g}=h;void 0===g.handles&&(g.handles={}),g.handles.points=[i(s),i(l),i(d),i(c)],g.invalidated=!1}invalidateBrushCursor(){if(void 0!==this._hoverData){const{data:e}=this._hoverData.brushCursor;e.invalidated=!0}}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const o=this._hoverData.brushCursor;if(!0===o.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const i=o.metadata,a=i.brushCursorUID,r=o.data,{points:s}=r.handles,l=s.map((e=>n.worldToCanvas(e))),d=l[0],c=l[1],h=[Math.floor((d[0]+c[0])/2),Math.floor((d[1]+c[1])/2)],g=Math.abs(d[1]-Math.floor((d[1]+c[1])/2)),u=`rgb(${i.segmentColor.slice(0,3)})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");Pi(t,a,"0",h,g,{color:u})}}_r.toolName="Brush";const Dr=_r;function Sr(e){const t=ou(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;return Object.values(n).filter((e=>e instanceof Dr))}const Or=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function yr(e,t,n,o){const i=[];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let a=0;a<2;a++){const r=o;r[0]=r[0]+(2*e-1)*n[0]/2,r[1]=r[1]+(2*t-1)*n[1]/2,r[2]=r[2]+(2*a-1)*n[2]/2,i.push(r)}const a=i.map((t=>J.utilities.transformWorldToIndex(e,t)));return La(a,t)}function xr(e,t){const{spacing:n,imageData:o}=e,i=e.getScalarData(),a=[];let r=0;for(let e=0;e<t.length;e++){const{imageData:o,spacing:s,dimensions:l}=t[e].volume,d=t[e].volume.getScalarData().length;d===i.length&&Or(s,n)&&(r=e);const c=o.getPointData().getScalars().getData(),h=t[e].lower,g=t[e].upper;a.push({imageData:o,referenceValues:c,lower:h,upper:g,spacing:s,dimensions:l,volumeSize:d})}return{volumeInfoList:a,baseVolumeIdx:r}}const Mr=function(e,t,n){const{imageData:o}=e,i=e.getScalarData(),{overwrite:a,boundsIJK:r}=n,s=n?.overlapType||0;if(a)for(let e=0;e<i.length;e++)i[e]=0;const{baseVolumeIdx:l,volumeInfoList:d}=xr(e,t);let c,h,g;const u=(e,t,n)=>{const{imageData:o,dimensions:i,lower:a,upper:r}=e,l=yr(o,i,t,n);h=0,c=0,g={lower:a,upper:r};let d=!1;return Na(o,(()=>!0),(({value:e})=>{h+=1,e>=g.lower&&e<=g.upper&&(c+=1)}),l),0===s?d=c>0:1==s&&(d=c===h),d},m=(e,t)=>{const{imageData:n,referenceValues:o,lower:i,upper:a}=e,r=o[n.computeOffsetIndex(t)];return!(r<=i||r>=a)};return Na(o,(()=>!0),(({index:e,pointIJK:t,pointLPS:n})=>{let o=d.length>0;for(let e=0;e<d.length&&(o=d[e].volumeSize===i.length?m(d[e],t):u(d[e],d[l].spacing,n),o);e++);o&&(i[e]=1)}),r),Kn(e.volumeId),e};class Rr extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,J.getEnabledElement)(t),i=n.world,a=o.viewport.getCamera(),{focalPoint:r,position:s}=a,l=[s[0]-i[0],s[1]-i[1],s[2]-i[2]],d=[r[0]-i[0],r[1]-i[1],r[2]-i[2]];o.viewport.setCamera({focalPoint:d,position:l}),o.viewport.render()}}Rr.toolName="Pan";const Nr=Rr;var Pr=n(92780);class Lr extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}}){super(e,t),this.rotateCamera=(e,t,n,o)=>{const i=e.getVtkActiveCamera(),a=i.getViewUp(),r=i.getFocalPoint(),s=i.getPosition(),l=[0,0,0],d=[0,0,0],c=[0,0,0],h=Ti._E.identity(new Float32Array(16));Ti._E.translate(h,h,t),Ti._E.rotate(h,h,o,n),Ti._E.translate(h,h,[-t[0],-t[1],-t[2]]),Ti.R3.transformMat4(l,s,h),Ti.R3.transformMat4(d,r,h),Ti._E.identity(h),Ti._E.rotate(h,h,o,n),Ti.R3.transformMat4(c,a,h),e.setCamera({position:l,viewUp:c,focalPoint:d})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:o}=e.detail,i=n.canvas,a=o.canvas,{rotateIncrementDegrees:r}=this.configuration,s=(0,J.getEnabledElement)(t),{viewport:l}=s,d=l.getCamera(),c=t.clientWidth,h=t.clientHeight,g=[i[0]/c,i[1]/h],u=[a[0]/c,a[1]/h],m=[.5*c,.5*h],f=l.canvasToWorld(m),v=(1+Math.abs(.5))**2,p=[u[0],0,0],E=[g[0],0,0],w=p[0]**2,I=E[0]**2,C=w>v?0:Math.sqrt(v-w),T=I>v?0:Math.sqrt(v-I),b=[p[0],0,C];Pr.ZP.normalize(b);const _=[E[0],0,T];Pr.ZP.normalize(_);const D=Pr.ZP.dot(b,_);if(Math.abs(D)>1e-4){const e=-2*Math.acos(Pr.ZP.clampValue(D,-1,1))*Math.sign(g[0]-u[0])*r,t=d.viewUp,n=d.viewPlaneNormal,o=[0,0,0],i=[0,0,0];Pr.ZP.cross(t,n,o),Pr.ZP.normalize(o),Pr.ZP.cross(n,o,i),Pr.ZP.normalize(i),Pr.ZP.normalize(t),this.rotateCamera(l,f,i,e);const a=(u[1]-g[1])*r;this.rotateCamera(l,f,o,a),l.render()}}}Lr.toolName="TrackballRotate";const Ar=Lr;class Ur extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),o=t[0]*t[1];let i,a;e instanceof Float32Array?(i=4,a=Float32Array):e instanceof Uint8Array?(i=1,a=Uint8Array):e instanceof Uint16Array?(i=2,a=Uint16Array):e instanceof Int16Array&&(i=2,a=Int16Array);const r=new a(e.buffer,n*o*i,o),{max:s,min:l}=this._getMinMax(r,o);return s-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,J.getEnabledElement)(t),{renderingEngine:i,viewport:a}=o;let r,s,l,d,c,h,g=!1;if(a instanceof J.VolumeViewport){r=this.getTargetId(a).split("volumeId:")[1],h=J.utilities.getViewportsWithVolumeId(r,i.id);const e=a.getProperties();({lower:s,upper:l}=e.voiRange);const t=J.cache.getVolume(r);d=t.metadata.Modality,g=t.scaling&&Object.keys(t.scaling).length>0}else{if(!(a instanceof J.StackViewport))throw new Error("Viewport is not a valid type");{const e=a.getProperties();d=a.modality,({lower:s,upper:l}=e.voiRange);const{preScale:t}=a.getImageData();g=t.scaled&&void 0!==t.scalingParameters?.suvbw}}return c="PT"===d?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:s,upper:l,clientHeight:t.clientHeight,isPreScaled:g,viewport:a,volumeId:r}):this.getNewRange({viewport:a,deltaPointsCanvas:n.canvas,volumeId:r,lower:s,upper:l}),a instanceof J.StackViewport?(a.setProperties({voiRange:c}),void a.render()):a instanceof J.VolumeViewport?(a.setProperties({voiRange:c}),void h.forEach((e=>{e.render()}))):void 0}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:o,viewport:i,volumeId:a,isPreScaled:r}){let s=4;s=r?5/o:this._getMultiplierFromDynamicRange(i,a)||4;return n-=e[1]*s,{lower:t,upper:n=r?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:o,upper:i}){const a=this._getMultiplierFromDynamicRange(e,n)||4,r=t[0]*a,s=t[1]*a;let{windowWidth:l,windowCenter:d}=J.utilities.windowLevel.toWindowLevel(o,i);return l+=r,d+=s,l=Math.max(l,1),J.utilities.windowLevel.toLowHighRange(l,d)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const e=J.cache.getVolume(t),{dimensions:o}=e,i=e.getScalarData(),a=this._getImageDynamicRangeFromMiddleSlice(i,o),r=e?.metadata?.BitsStored,s=r?2**r:1/0;n=Math.min(a,s)}else n=this._getImageDynamicRangeFromViewport(e);const o=n/1024;let i=4;return o>1&&(i=Math.round(o)),i}_getImageDynamicRangeFromViewport(e){const{imageData:t}=e.getImageData(),n=t.getDimensions();let o,i;if(o=t.getScalarData?t.getScalarData():t.getPointData().getScalars(),1!==n[2])return this._getImageDynamicRangeFromMiddleSlice(o,n);if(o.getRange)i=o.getRange();else{const{min:e,max:t}=this._getMinMax(o,o.length);i=[e,t]}return i[1]-i[0]}_getMinMax(e,t){let n=1/0,o=-1/0;for(let i=0;i<t;i++){const t=e[i];t<n&&(n=t),t>o&&(o=t)}return{max:o,min:n}}}Ur.toolName="WindowLevel";const kr=Ur;class Vr extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{deltaPoints:t,viewportId:n,renderingEngineId:o}=e.detail,{viewport:i}=(0,J.getEnabledElementByIds)(n,o),a=this.getTargetId(i),{debounceIfNotLoaded:r,invert:s,loop:l}=this.configuration,d=t.canvas[1];let c;i instanceof J.VolumeViewport&&(c=a.split("volumeId:")[1]);const h=this._getPixelPerImage(i),g=d+this.deltaY;if(h)if(Math.abs(g)>=h){const e=Math.round(g/h);Ma(i,{delta:s?-e:e,volumeId:c,debounceLoading:r,loop:l}),this.deltaY=g%h}else this.deltaY=g}_getPixelPerImage(e){const{element:t}=e,n=this._getNumberOfSlices(e);return Math.max(2,t.offsetHeight/Math.max(n,8))}_getNumberOfSlices(e){if(e instanceof J.VolumeViewport){const{numberOfSlices:t}=J.utilities.getImageSliceDataForVolumeViewport(e);return t}if(e instanceof J.StackViewport)return e.getImageIds().length}}Vr.toolName="StackScroll";const Hr=Vr;function Wr(e,t){const[n,o]=e,[i,a]=t,r=Ti.R3.sub(Ti.R3.create(),o,n),s=Ti.R3.sub(Ti.R3.create(),i,a),l=Ti.R3.dot(r,s)/(Ti.R3.length(r)*Ti.R3.length(s));return 180*Math.acos(l)/Math.PI}class Fr extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:o}=e.detail,i=n.world,a=o.world,r=(0,J.getEnabledElement)(t),{viewport:s}=r,l=s.getCamera(),d=[.5*t.clientWidth,.5*t.clientHeight],c=s.canvasToWorld(d);let h=Wr([a,c],[c,i]);const{viewPlaneNormal:g,viewUp:u}=l,m=Ti.R3.sub(Ti.R3.create(),c,a),f=Ti.R3.sub(Ti.R3.create(),c,i),v=Ti.R3.cross(Ti.R3.create(),m,f);if(Ti.R3.dot(g,v)>0&&(h=-h),!Number.isNaN(h)){if(s instanceof J.BaseVolumeViewport){const e=h*Math.PI/180,t=Ti._E.identity(new Float32Array(16));Ti._E.rotate(t,t,e,g);const n=Ti.R3.transformMat4(Ti.R3.create(),u,t);s.setCamera({viewUp:n})}else{const{rotation:e}=s.getProperties();s.setProperties({rotation:e+h})}s.render()}}}Fr.toolName="PlanarRotate";const Br=Fr;class Gr extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t)}mouseWheelCallback(e){const{wheel:t,element:n}=e.detail,{direction:o}=t,{invert:i}=this.configuration,{viewport:a}=(0,J.getEnabledElement)(n),r=o*(i?-1:1),s=this.getTargetId(a).split("volumeId:")[1];Ma(a,{delta:r,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:s})}}Gr.toolName="StackScrollMouseWheel";const $r=Gr;class Kr extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,i=o.world,a=(0,J.getEnabledElement)(n).viewport.getCamera(),{focalPoint:r}=a;this.initialMousePosWorld=i;let s=Ti.R3.fromValues(r[0]-i[0],r[1]-i[1],r[2]-i[2]);return s=Ti.R3.normalize(Ti.R3.create(),s),this.dirVec=s,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,o=!1)=>{const{element:i,deltaPoints:a}=e.detail,r=o?e.detail.deltaDistance.canvas:a.canvas[1],s=[i.clientWidth,i.clientHeight],{parallelScale:l,focalPoint:d,position:c}=n;let h=(1-r*(1.5/s[1])*(this.configuration.invert?-1:1))*l,g=d,u=c;if(!this.configuration.zoomToCenter){const e=Ti.R3.distance(d,this.initialMousePosWorld),t=r*(5/s[1])*(this.configuration.invert?-1:1);h=(1-t)*l,u=Ti.R3.scaleAndAdd(Ti.R3.create(),c,this.dirVec,-e*t),g=Ti.R3.scaleAndAdd(Ti.R3.create(),d,this.dirVec,-e*t)}const m=t.getImageData();let f=[1,1,1];m&&(f=m.spacing);const{minZoomScale:v,maxZoomScale:p}=this.configuration,E=i.clientHeight*f[1]*.5,w=E/h;let I=h,C=!1;m&&(w<v?(I=E/v,C=!0):w>=p&&(I=E/p,C=!0)),t.setCamera({parallelScale:I,focalPoint:C?d:g,position:C?c:u})},this._dragPerspectiveProjection=(e,t,n,o=!1)=>{const{element:i,deltaPoints:a}=e.detail,r=o?e.detail.deltaDistance.canvas:a.canvas[1],s=[i.clientWidth,i.clientHeight],{position:l,focalPoint:d,viewPlaneNormal:c}=n,h=Pr.ZP.distance2BetweenPoints(l,d),g=Math.sqrt(h)/s[1],u=[-c[0],-c[1],-c[2]],m=this.configuration.invert?r/g:r*g;let f=m*u[0];l[0]+=f,d[0]+=f,f=m*u[1],l[1]+=f,d[1]+=f,f=m*u[2],l[2]+=f,d[2]+=f,t.setCamera({position:l,focalPoint:d})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,o=(0,J.getEnabledElement)(t),{viewport:i}=o,a=i.getCamera(),r=n.world,{focalPoint:s}=a;this.initialMousePosWorld=r;let l=Ti.R3.fromValues(s[0]-r[0],s[1]-r[1],s[2]-r[2]);l=Ti.R3.normalize(Ti.R3.create(),l),this.dirVec=l,a.parallelProjection?this._dragParallelProjection(e,i,a,!0):this._dragPerspectiveProjection(e,i,a,!0),i.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,J.getEnabledElement)(t),{viewport:o}=n,i=o.getCamera();i.parallelProjection?this._dragParallelProjection(e,o,i):this._dragPerspectiveProjection(e,o,i),o.render()}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,J.getEnabledElement)(t),i=n.world,a=o.viewport.getCamera(),{focalPoint:r,position:s}=a,l=[s[0]-i[0],s[1]-i[1],s[2]-i[2]],d=[r[0]-i[0],r[1]-i[1],r[2]-i[2]];o.viewport.setCamera({focalPoint:d,position:l}),o.viewport.render()}}Kr.toolName="Zoom";const qr=Kr,zr=[0,0,1];class jr extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:zr,rotateIncrementDegrees:.5}}){super(e,t)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,o=(0,J.getEnabledElement)(t),{viewport:i}=o,{direction:a,rotateIncrementDegrees:r}=this.configuration,s=i.getCamera(),{viewUp:l,position:d,focalPoint:c}=s,{direction:h}=n,[g,u,m]=c,[f,v,p]=a,E=h*r,w=[0,0,0],I=[0,0,0],C=[0,0,0],T=Ti._E.identity(new Float32Array(16));Ti._E.translate(T,T,[g,u,m]),Ti._E.rotate(T,T,E,[f,v,p]),Ti._E.translate(T,T,[-g,-u,-m]),Ti.R3.transformMat4(w,d,T),Ti.R3.transformMat4(I,c,T),Ti._E.identity(T),Ti._E.rotate(T,T,E,[f,v,p]),Ti.R3.transformMat4(C,l,T),i.setCamera({position:w,viewUp:C,focalPoint:I}),i.render()}}jr.toolName="VolumeRotateMouseWheel";const Zr=jr;function Yr(e,t,n,o){const i=Ti.R3.create();Ti.R3.cross(i,t,e);const a=Ti.R3.fromValues(...n),r=Ti.R3.fromValues(...o),s=Ti.R3.create();Ti.R3.subtract(s,a,r);const l=Ti.R3.length(s);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=Ti.R3.dot(s,i)/(l*Ti.R3.length(i));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}function Jr(e,t,n,o,i=.25){const a=e.getCamera(),{position:r}=a,{spacingInNormalDirection:s}=J.utilities.getTargetVolumeAndSpacingInNormalDir(e,a,n),l=s*i,d=e.getBounds(),c=d[0],h=d[1],g=[0,0,0];let u,m=[0,0,0];Pr.ZP.subtract(t,r,g);for(let t=c;t<=h;t+=l){m=[t,0,0];const n=(t-r[0])/g[0];if(m[1]=n*g[1]+r[1],m[2]=n*g[2]+r[2],Xr(m,d)){const t=o(e.getIntensityFromWorld(m),m);t&&(u=t)}}return u}const Xr=function(e,t){const[n,o,i,a,r,s]=t;return e[0]>n&&e[0]<o&&e[1]>i&&e[1]<a&&e[2]>r&&e[2]<s},Qr={filterAnnotationsWithinSlice:ea,getWorldWidthAndHeightFromCorners:Yr,filterAnnotationsForDisplay:ta,getPointInLineOfSightWithCriteria:Jr};function es(e,t){if(!(e instanceof J.VolumeViewport))return;const{focalPoint:n}=e.getCamera(),o=[0,0,0];return Ti.R3.sub(o,t,n),function(e,t){const n=e.getCamera(),o=n.viewPlaneNormal,i=Ti.R3.dot(t,o),a=Ti.R3.fromValues(o[0],o[1],o[2]);if(Ti.R3.scale(a,a,i),Math.abs(a[0])>.001||Math.abs(a[1])>.001||Math.abs(a[2])>.001){const t=[0,0,0],o=[0,0,0];Ti.R3.add(t,n.focalPoint,a),Ti.R3.add(o,n.position,a),e.setCamera({focalPoint:t,position:o}),e.render()}}(e,o),!0}class ts extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,o=(0,J.getEnabledElement)(t),{viewport:i,renderingEngine:a}=o,r=this.getTargetId(i);if(!r.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");const s=r.split("volumeId:")[1];let l=-1/0;const d=Jr(i,n.world,s,((e,t)=>{if(e>l)return l=e,t}));if(!d||!d.length)return;const{targetViewportIds:c,toolGroupId:h}=this.configuration;a.getViewports().filter((e=>{if(c?.indexOf(e.id)>=0)return!0;const t=Ng(e.id,a.id);return!(!h||h!==t?.id)})).forEach((e=>{e instanceof J.VolumeViewport?es(e,d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}ts.toolName="MIPJumpToClickTool";const ns=ts;var os=n(81291);function is(e,t){const n=e.length,o=[];for(let i=0;i<n;i++){const n=e[i];n.getFrameOfReferenceUID()===t&&o.push(n)}return o}const{Active:as,Passive:rs,Enabled:ss}=X;function ls(e,t){const n=e.length,o=[];for(let i=0;i<n;i++){const n=e[i],a=Ng(n.id,n.renderingEngineId);if(!a)continue;ds(a,t)&&o.push(n)}return o}function ds(e,t){const{toolOptions:n}=e,o=n[t];if(!o)return!1;const i=o.mode;return i===as||i===rs||i===ss}const cs=function(e,t,n=.999){return e.filter((e=>{const o=e.getCamera();return Math.abs(Ti.R3.dot(o.viewPlaneNormal,t.viewPlaneNormal))>n}))};function hs(e,t,n=!0){const o=(0,J.getEnabledElement)(e),{renderingEngine:i,FrameOfReferenceUID:a}=o;let r=i.getViewports();r=is(r,a),r=ls(r,t);const s=i.getViewport(o.viewportId);n&&(r=cs(r,s.getCamera()));return r.map((e=>e.id))}const gs=1e-6,us=1,ms=0;function fs(e,t,n){const[o,i]=n;if(Math.abs(t)<gs)return e<0;const a=e/t;if(t>0){if(a>i)return 0;a>o&&(n[0]=a)}else{if(a<o)return 0;a<i&&(n[1]=a)}return 1}function vs(e,t,n,o,i){const[a,r]=e,[s,l]=t,d=s-a,c=l-r;if(void 0===o||void 0===i?(o=e,i=t):(o[0]=e[0],o[1]=e[1],i[0]=t[0],i[1]=t[1]),Math.abs(d)<gs&&Math.abs(c)<gs&&a>=n[0]&&a<=n[2]&&r>=n[1]&&r<=n[3])return us;const h=[0,1];if(fs(n[0]-a,d,h)&&fs(a-n[2],-d,h)&&fs(n[1]-r,c,h)&&fs(r-n[3],-c,h)){const[e,t]=h;return t<1&&(i[0]=a+t*d,i[1]=r+t*c),e>0&&(o[0]+=e*d,o[1]+=e*c),us}return ms}function ps(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function Es(e,t,n){const o=ps(e,t);if(0===o)return ps(n,e);const i=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/o;if(i<0)return ps(n,e);if(i>1)return ps(n,t);return ps(n,[e[0]+i*(t[0]-e[0]),e[1]+i*(t[1]-e[1])])}function ws(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(Es(e,t,n))}function Is(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function Cs(e,t,n,o){const[i,a]=e,[r,s]=t,[l,d]=n,[c,h]=o,g=s-a,u=i-r,m=r*a-i*s,f=g*l+u*d+m,v=g*c+u*h+m;if(0!==f&&0!==v&&Is(f)===Is(v))return;const p=h-d,E=l-c,w=c*d-l*h,I=p*i+E*a+w,C=p*r+E*s+w;if(0!==I&&0!==C&&Is(I)===Is(C))return;const T=g*E-p*u;let b;b=u*w-E*m;const _=b/T;b=p*m-g*w;return[_,b/T]}const{RENDERING_DEFAULTS:Ts}=J.CONSTANTS;function bs(){return"rgb(0, 200, 0)"}function _s(){return!0}function Ds(){return!0}function Ss(){return!0}const Os=1,ys=2,xs=3;class Ms extends da{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:J.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{const n=(0,J.getEnabledElementByIds)(t,e),{FrameOfReferenceUID:o,viewport:i}=n,{element:a}=i,{position:r,focalPoint:s,viewPlaneNormal:l}=i.getCamera();let d=this._getAnnotations(n);d=this.filterInteractableAnnotationsForElement(a,d),d.length&&mu(d[0].annotationUID);return gu({highlighted:!1,metadata:{cameraPosition:[...r],cameraFocalPoint:[...s],FrameOfReferenceUID:o,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}},a),{normal:l,point:i.canvasToWorld([i.canvas.clientWidth/2,i.canvas.clientHeight/2])}},this._getViewportsInfo=()=>ou(this.toolGroupId).viewportsInfo,this.computeToolCenter=e=>{if(!e.length||1===e.length)throw new Error("For crosshairs to operate, at least two viewports must be given.");const[t,n,o]=e,{normal:i,point:a}=this.initializeViewport(t),{normal:r,point:s}=this.initializeViewport(n);let l=[0,0,0],d=Ti.R3.create();o?({normal:l,point:d}=this.initializeViewport(o)):(Ti.R3.add(d,a,s),Ti.R3.scale(d,d,.5),Ti.R3.cross(l,i,r));const c=J.utilities.planar.planeEquation(i,a),h=J.utilities.planar.planeEquation(r,s),g=J.utilities.planar.planeEquation(l,d);this.toolCenter=J.utilities.planar.threePlaneIntersection(c,h,g);const{renderingEngine:u}=(0,J.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId);xa(u,e.map((({viewportId:e})=>e)))},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.world,a=(0,J.getEnabledElement)(n),{viewport:r}=a;this._jump(a,i);const s=this._getAnnotations(a),l=this.filterInteractableAnnotationsForElement(r.element,s),{data:d}=l[0],{rotationPoints:c}=d.handles,h=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],n=this._getReferenceLineControllable(t.id),o=this._getReferenceLineDraggableRotatable(t.id);n&&o&&(h.push(t.id),e++)}return d.activeViewportIds=[...h],d.handles.activeOperation=Os,e.preventDefault(),Tr(n),this._activateModify(n),l[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0,this._activateModify(o),Tr(o),e.preventDefault()},this.isPointNearTool=(e,t,n,o)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o;t.highlighted=!0,this._activateModify(i),Tr(i),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{renderingEngine:i}=o,a=o.viewport,r=this._getAnnotations(o),s=this.filterInteractableAnnotationsForElement(n,r)[0];if(!s)return;const l=a.getCamera(),d=s.metadata.cameraPosition,c=[0,0,0];Pr.ZP.subtract(l.position,d,c);const h=s.metadata.cameraFocalPoint,g=[0,0,0];Pr.ZP.subtract(l.focalPoint,h,g),s.metadata.cameraPosition=[...l.position],s.metadata.cameraFocalPoint=[...l.focalPoint];const u=this._getReferenceLineControllable(a.id),m=this._getReferenceLineDraggableRotatable(a.id);if(!J.utilities.isEqual(l.position,d,.001)&&u&&m){let e=!1;J.utilities.isEqual(c,g,.001)||(e=!0);const t=Math.abs(Pr.ZP.dot(c,l.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=c[0],this.toolCenter[1]+=c[1],this.toolCenter[2]+=c[2])}if(this.configuration.autoPan?.enabled){Ng(a.id,i.id).getViewportIds().filter((e=>e!==a.id)).forEach((e=>{this._autoPanViewportIfNecessary(e,i)}))}const f=hs(n,this.getToolName(),!1);xa(i,f)},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:o}=e.detail,i=o.canvas;let a=!1;for(let e=0;e<t.length;e++){const o=t[e];if(ge(o))continue;const{data:r,highlighted:s}=o;if(!r.handles)continue;const l=r.handles.activeOperation,d=r.activeViewportIds&&r.activeViewportIds.length>0?[...r.activeViewportIds]:[];r.activeViewportIds=[],r.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,o,i,6)||this._pointNearTool(n,o,i,6);c&&!s||!c&&s?(o.highlighted=!s,a=!0):r.handles.activeOperation===l&&this._areViewportIdArraysEqual(r.activeViewportIds,d)||(a=!0)}return a},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,J.getEnabledElement)(e),{viewportId:o}=n;return t.filter((e=>e.data.viewportId===o))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,renderingEngine:i}=e,{element:a}=o,r=this._getAnnotations(e),s=o.getCamera(),l=this.filterInteractableAnnotationsForElement(a,r)[0];if(!r?.length||!l?.data)return n;const d=l.annotationUID,{clientWidth:c,clientHeight:h}=o.canvas,g=Math.sqrt(c*c+h*h),u=Math.min(c,h),m=l.data,f=o.worldToCanvas(this.toolCenter),v=this._filterAnnotationsByUniqueViewportOrientations(e,r),p=[],E=[0,0,c,h];v.forEach((e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=i.getViewport(t.viewportId),a=n.getCamera(),r=this._getReferenceLineControllable(n.id),l=this._getReferenceLineDraggableRotatable(n.id),d=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:c,clientHeight:h}=n.canvas,m=Math.sqrt(c*c+h*h),w=[.5*c,.5*h],I=n.canvasToWorld(w),C=[0,0,0];Pr.ZP.cross(s.viewPlaneNormal,a.viewPlaneNormal,C),Pr.ZP.normalize(C),Pr.ZP.multiplyScalar(C,m);const T=[0,0,0];Pr.ZP.add(I,C,T);const b=[0,0,0];Pr.ZP.subtract(I,C,b);const _=o.worldToCanvas(T),D=o.worldToCanvas(I),S=Ti.K4.create();Ti.K4.subtract(S,_,D),Ti.K4.normalize(S,S);const O=Ti.K4.create();Ti.K4.scale(O,S,100*g);const y=Ti.K4.create();Ti.K4.scale(y,S,.4*u);const x=Ti.K4.create();Ti.K4.scale(x,S,.2*u);const M=Ti.K4.create(),R=this.configuration.referenceLinesCenterGapRadius;Ti.K4.scale(M,S,2===v.length?R:0);const N=Ti.K4.create(),P=Ti.K4.create(),L=Ti.K4.create(),A=Ti.K4.create();let U=Ti.K4.clone(f);l&&r||(U=Ti.K4.clone(D)),Ti.K4.add(N,U,M),Ti.K4.add(P,U,O),Ti.K4.subtract(L,U,M),Ti.K4.subtract(A,U,O),vs(N,P,E),vs(L,A,E);const k=Ti.K4.create();Ti.K4.subtract(k,f,y);const V=Ti.K4.create();Ti.K4.add(V,f,y);let H=Ti.K4.clone(f);!l&&d&&(H=Ti.K4.clone(D));let W=[...this.toolCenter];!l&&d&&(W=[...I]);const F=[0,0,0];Pr.ZP.subtract(T,b,F),Pr.ZP.normalize(F);const{viewPlaneNormal:B}=s,{matrix:G}=os.Z.buildFromDegree().rotate(90,B),$=[0,0,0];Ti.R3.transformMat4($,F,G);const K=n.getSlabThickness(),q=[...$];Pr.ZP.multiplyScalar(q,K);const z=[0,0,0];Pr.ZP.add(W,q,z);const j=o.worldToCanvas(z),Z=Ti.K4.create();Ti.K4.subtract(Z,H,j);const Y=Ti.K4.create();Ti.K4.subtract(Y,H,O),Ti.K4.add(Y,Y,Z);const J=Ti.K4.create();Ti.K4.add(J,H,O),Ti.K4.add(J,J,Z),vs(Y,J,E);const X=Ti.K4.create();Ti.K4.add(X,H,O),Ti.K4.subtract(X,X,Z);const Q=Ti.K4.create();Ti.K4.subtract(Q,H,O),Ti.K4.subtract(Q,Q,Z),vs(X,Q,E);const ee=Ti.K4.create(),te=Ti.K4.create(),ne=Ti.K4.create(),oe=Ti.K4.create();Ti.K4.subtract(ee,H,x),Ti.K4.add(ee,ee,Z),Ti.K4.add(te,H,x),Ti.K4.add(te,te,Z),Ti.K4.subtract(ne,H,x),Ti.K4.subtract(ne,ne,Z),Ti.K4.add(oe,H,x),Ti.K4.subtract(oe,oe,Z),p.push([n,N,P,L,A,Y,J,X,Q,k,V,ee,te,ne,oe])}));const w=[],I=[],C=this._getReferenceLineColor(o.id),T=void 0!==C?C:"rgb(200, 200, 200)";if(p.forEach(((e,n)=>{const i=e[0],a=this._getReferenceLineColor(i.id),r=this._getReferenceLineControllable(i.id),s=this._getReferenceLineDraggableRotatable(i.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(i.id)||this.configuration.mobile?.enabled,c=m.activeViewportIds.find((e=>e===i.id));let h=void 0!==a?a:"rgb(200, 200, 200)",g=1;const u=null!==m.handles.activeOperation&&m.handles.activeOperation===Os&&c;u&&(g=2.5);let f=`${n}`;if(r&&s?(f=`${n}One`,Ui(t,d,f,e[1],e[2],{color:h,lineWidth:g}),f=`${n}Two`,Ui(t,d,f,e[3],e[4],{color:h,lineWidth:g})):Ui(t,d,f,e[2],e[4],{color:h,lineWidth:g}),r){h=void 0!==a?a:"rgb(200, 200, 200)";const r=m.handles.activeOperation===ys,g=[e[9],e[10]],v=[o.canvasToWorld(e[9]),i,e[1],e[2]],p=[o.canvasToWorld(e[10]),i,e[3],e[4]];w.push(v,p);const E=m.handles.activeOperation===xs,C=[e[11],e[12],e[13],e[14]],T=[o.canvasToWorld(e[11]),i,e[5],e[6]],b=[o.canvasToWorld(e[12]),i,e[5],e[6]],_=[o.canvasToWorld(e[13]),i,e[7],e[8]],D=[o.canvasToWorld(e[14]),i,e[7],e[8]];if(I.push(T,b,_,D),(u||this.configuration.mobile?.enabled)&&!r&&!E&&s&&l){let e=`${n}One`;Ai(t,d,e,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"}),e=`${n}Two`,Ai(t,d,e,C,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(u&&!r&&!E&&s){Ai(t,d,`${n}`,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"})}else if(c&&!r&&!E&&l){Ai(t,d,`${n}`,C,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(r&&s){Ai(t,d,`${n}`,g,{color:h,handleRadius:2,fill:h,type:"circle"})}else E&&c&&l&&Ai(t,d,f,C,{color:h,handleRadius:2,fill:h,type:"rect"});i.getSlabThickness()>.5&&l&&(f=`${n}STOne`,Ui(t,d,f,e[5],e[6],{color:h,width:1,lineDash:[2,3]}),f=`${n}STTwo`,Ui(t,d,f,e[7],e[8],{color:h,width:e,lineDash:[2,3]}))}})),n=!0,m.handles.rotationPoints=w,m.handles.slabThicknessPoints=I,this.configuration.viewportIndicators){Pi(t,d,"0",[.95*c,.05*h],.01*g,{color:T,fill:T})}return n},this._getAnnotations=e=>{const{viewport:t}=e;return hu(this.getToolName(),t.element)},this._onNewVolume=e=>{const t=this._getViewportsInfo();this.computeToolCenter(t)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach((e=>{let n=!1;for(let o=0;o<t.length;++o)if(e===t[o]){n=!0;break}if(!1===n)return!1})),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:o,viewport:i}=e,a=t.filter((e=>e.data.viewportId!==n));if(!a||!a.length)return[];const r=i.getCamera(),{viewPlaneNormal:s,position:l}=r,d=a.filter((e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera();return!(J.utilities.isEqual(n.viewPlaneNormal,s,.01)&&J.utilities.isEqual(n.position,l,1))}));return d},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:o}=e,{data:i}=t,a=o.getViewport(i.viewportId),r=n.filter((e=>{const{data:t}=e,n=o.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)}));if(!r||!r.length)return[];const s=a.getCamera(),l=s.viewPlaneNormal;Pr.ZP.normalize(l);return r.filter((e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera(),i=n.viewPlaneNormal;return Pr.ZP.normalize(i),J.utilities.isEqual(l,i,.01)&&J.utilities.isEqual(s.viewUp,n.viewUp,.01)}))},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:o}=e,i=o.getCamera().viewPlaneNormal;Pr.ZP.normalize(i);const a=t.filter((e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0===a})),r=[];for(let e=0;e<a.length;++e){const t=a[e],{viewportId:o}=t.data,s=n.getViewport(o).getCamera(),l=s.viewPlaneNormal;if(Pr.ZP.normalize(l),J.utilities.isEqual(i,l,.01)||J.utilities.isOpposite(i,l,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();J.utilities.isEqual(i.viewPlaneNormal,s.viewPlaneNormal,.01)&&J.utilities.isEqual(i.position,s.position,1)&&(d=!0)}d||r.push(t)}const s=t.filter((e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0!==a}));for(let e=0;e<s.length;++e){const t=s[e],{viewportId:o}=t.data,a=n.getViewport(o).getCamera(),l=a.viewPlaneNormal;if(Pr.ZP.normalize(l),J.utilities.isEqual(i,l,.01)||J.utilities.isOpposite(i,l,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();J.utilities.isEqual(i.viewPlaneNormal,a.viewPlaneNormal,.01)&&J.utilities.isEqual(i.position,a.position,1)&&(d=!0)}d||r.push(t)}const l=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<l.length;++e){const t=l[e];if(r.some((e=>e===t)))continue;const{viewportId:o}=t.data,a=n.getViewport(o).getCamera(),s=a.viewPlaneNormal;if(Pr.ZP.normalize(s),J.utilities.isEqual(i,s,.01)||J.utilities.isOpposite(i,s,.01))continue;let d=!1;for(let e=0;e<r.length;++e){const t=r[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();J.utilities.isEqual(i.viewPlaneNormal,a.viewPlaneNormal,.01)&&J.utilities.isEqual(i.position,a.position,1)&&(d=!0)}d||r.push(t)}return r},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getActors(),o=t.getActors();let i=!0;return n.forEach((e=>{n.length===o.length&&void 0!==o.find((({uid:t})=>t===e.uid))||(i=!1)})),i},this._jump=(e,t)=>{Ke.isInteractingWithTool=!0;const{viewport:n,renderingEngine:o}=e,i=this._getAnnotations(e),a=[0,0,0];Pr.ZP.subtract(t,this.toolCenter,a);const r=this._getAnnotationsForViewportsWithDifferentCameras(e,i).filter((e=>{const{data:t}=e,i=o.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,i);return this._getReferenceLineControllable(i.id)&&this._getReferenceLineDraggableRotatable(i.id)&&a}));return 0===r.length?(Ke.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(o,r,a),Ke.isInteractingWithTool=!1,!0)},this._activateModify=e=>{Ke.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),Cr(n),this.editData=null;const o=(0,J.getEnabledElement)(n),{renderingEngine:i}=o,a=hs(n,this.getToolName(),!1);xa(i,a)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:o}=t,i=(0,J.getEnabledElement)(o),{renderingEngine:a,viewport:r}=i,s=this._getAnnotations(i),l=this.filterInteractableAnnotationsForElement(o,s)[0];if(!l)return;const{handles:d}=l.data,{currentPoints:c}=e.detail,h=c.canvas;if(d.activeOperation===Os){const e=this._getAnnotationsForViewportsWithDifferentCameras(i,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineDraggableRotatable(n.id);return!0===o&&!0===i&&l.data.activeViewportIds.find((e=>e===n.id))}));this._applyDeltaShiftToSelectedViewportCameras(a,e,n)}else if(d.activeOperation===ys){const e=this._getAnnotationsForViewportsWithDifferentCameras(i,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineDraggableRotatable(n.id);return!0===o&&!0===i})),n=Ti.K4.create(),o=Ti.K4.create(),l=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],d=r.worldToCanvas(l),c=t.currentPoints.canvas,h=Ti.K4.create();Ti.K4.sub(h,c,t.deltaPoints.canvas),Ti.K4.sub(n,h,d),Ti.K4.sub(o,c,d);let g=Ti.K4.angle(n,o);this._isClockWise(d,h,c)&&(g*=-1),g=Math.round(100*g)/100;const u=r.getCamera().viewPlaneNormal,{matrix:m}=os.Z.buildFromRadian().translate(l[0],l[1],l[2]).rotate(g,u).translate(-l[0],-l[1],-l[2]),f=[];e.forEach((e=>{const{data:t}=e;t.handles.toolCenter=l;const n=a.getViewport(t.viewportId),o=n.getCamera(),{viewUp:i,position:r,focalPoint:s}=o;i[0]+=r[0],i[1]+=r[1],i[2]+=r[2],Ti.R3.transformMat4(s,s,m),Ti.R3.transformMat4(r,r,m),Ti.R3.transformMat4(i,i,m),i[0]-=r[0],i[1]-=r[1],i[2]-=r[2],n.setCamera({position:r,viewUp:i,focalPoint:s}),f.push(n.id)})),a.renderViewports(f)}else if(d.activeOperation===xs){const e=this._getAnnotationsForViewportsWithDifferentCameras(i,s).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===o&&!0===i&&l.data.activeViewportIds.find((e=>e===n.id))}));if(0===e.length)return;const o=this._filterViewportWithSameOrientation(i,e[0],s),d=[];d.push(r.id),o.forEach((e=>{const{data:o}=e,i=a.getViewport(o.viewportId),s=i.getCamera().viewPlaneNormal,c=Pr.ZP.dot(n,s),g=[...s];if(Pr.ZP.multiplyScalar(g,c),Math.abs(g[0])>.001||Math.abs(g[1])>.001||Math.abs(g[2])>.001){const e=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),n=t.lastPoints.world,o=[0,0,0],c=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(i.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter((e=>e[1].uid===i.id));if(2===t.length){const e=r.canvasToWorld(t[0][3]),n=r.canvasToWorld(t[1][3]);Pr.ZP.add(e,n,c),Pr.ZP.multiplyScalar(c,.5)}}Pr.ZP.subtract(n,c,o);const u=Pr.ZP.dot(o,s),m=[...s];Pr.ZP.multiplyScalar(m,u);const f=[m[0],m[1],m[2]];Ti.R3.normalize(f,f);const v=[g[0],g[1],g[2]];Ti.R3.normalize(v,v);let p=i.getSlabThickness();J.utilities.isOpposite(f,v,.001)?p-=e:p+=e,p=Math.abs(p),p=Math.max(Ts.MINIMUM_SLAB_THICKNESS,p);this._pointNearReferenceLine(l,h,6,i)&&(p=Ts.MINIMUM_SLAB_THICKNESS);Ng(i.id,a.id).getToolInstance(this.getToolName()).setSlabThickness(i,p),d.push(i.id)}})),a.renderViewports(d)}},this._pointNearReferenceLine=(e,t,n,o)=>{const{data:i}=e,{rotationPoints:a}=i.handles;for(let e=0;e<a.length-1;++e){const i=a[e][1];if(i.id!==o.id)continue;if(!this._getReferenceLineControllable(i.id))continue;const r={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},s=ws([r.start.x,r.start.y],[r.end.x,r.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=ws([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(s<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||bs,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||_s,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||Ds,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||Ss}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach((({renderingEngineId:e,viewportId:t})=>{const n=(0,J.getEnabledElementByIds)(t,e);if(!n)return;const o=this._getAnnotations(n);o?.length&&o.forEach((e=>{mu(e.annotationUID)}))}))}getHandleNearImagePoint(e,t,n,o){const i=(0,J.getEnabledElement)(e),{viewport:a}=i;let r=this._getRotationHandleNearImagePoint(a,t,n,o);return null!==r?r:(r=this._getSlabThicknessHandleNearImagePoint(a,t,n,o),null!==r?r:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,J.getEnabledElementByIds)(e,t),{element:o}=n;o.removeEventListener(J.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_subscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,J.getEnabledElementByIds)(e,t),{element:o}=n;o.addEventListener(J.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:o,clientHeight:i}=n.canvas,a=n.worldToCanvas(this.toolCenter),r=this.configuration.autoPan.panSize,s=[a[0],a[1]];if(a[0]<0?s[0]=r:a[0]>o&&(s[0]=o-r),a[1]<0?s[1]=r:a[1]>i&&(s[1]=i-r),s[0]===a[0]&&s[1]===a[1])return;const l=n.canvasToWorld(s),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:h,position:g}=c,u=[g[0]-d[0],g[1]-d[1],g[2]-d[2]],m=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];n.setCamera({focalPoint:m,position:u}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:o}=this.configuration;o&&o.length>0&&(n=o);let i=this.configuration.slabThicknessBlendMode;t===Ts.MINIMUM_SLAB_THICKNESS&&(i=J.Enums.BlendModes.COMPOSITE);e.setBlendMode(i,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach((t=>{this._applyDeltaShiftToViewportCamera(e,t,n)}))}_applyDeltaShiftToViewportCamera(e,t,n){const{data:o}=t,i=e.getViewport(o.viewportId),a=i.getCamera(),r=a.viewPlaneNormal,s=Pr.ZP.dot(n,r),l=[...r];if(Pr.ZP.multiplyScalar(l,s),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const e=[0,0,0],t=[0,0,0];Pr.ZP.add(a.focalPoint,l,e),Pr.ZP.add(a.position,l,t),i.setCamera({focalPoint:e,position:t}),i.render()}}_getRotationHandleNearImagePoint(e,t,n,o){const{data:i}=t,{rotationPoints:a}=i.handles;for(let r=0;r<a.length;r++){const s=a[r][0],l=a[r][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineDraggableRotatable(l.id))continue;const d=e.worldToCanvas(s);if(Ti.K4.distance(n,d)<o)return i.handles.activeOperation=ys,this.editData={annotation:t},s}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,o){const{data:i}=t,{slabThicknessPoints:a}=i.handles;for(let r=0;r<a.length;r++){const s=a[r][0],l=a[r][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(l.id))continue;const d=e.worldToCanvas(s);if(Ti.K4.distance(n,d)<o)return i.handles.activeOperation=xs,i.activeViewportIds=[l.id],this.editData={annotation:t},s}return null}_pointNearTool(e,t,n,o){const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{clientWidth:r,clientHeight:s}=a.canvas,l=Math.sqrt(r*r+s*s),{data:d}=t,{rotationPoints:c}=d.handles,{slabThicknessPoints:h}=d.handles,g=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],i=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!i||!a)continue;const r={start:{x:c[e][2][0],y:c[e][2][1]},end:{x:c[e][3][0],y:c[e][3][1]}},s=ws([r.start.x,r.start.y],[r.end.x,r.end.y],[n[0],n[1]]),l={start:{x:c[e+1][2][0],y:c[e+1][2][1]},end:{x:c[e+1][3][0],y:c[e+1][3][1]}},h=ws([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(s<=o||h<=o)&&(g.push(t.id),d.handles.activeOperation=Os),e++}for(let e=0;e<h.length-1;++e){const t=h[e][1];if(g.find((e=>e===t.id)))continue;const i=this._getReferenceLineControllable(t.id),a=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!i||!a)continue;const r=h[e][2],s=h[e][3],c=Ti.K4.create();Ti.K4.add(c,r,s),Ti.K4.scale(c,c,.5);const u=Ti.K4.create();Ti.K4.subtract(u,r,c),Ti.K4.normalize(u,u);const m=Ti.K4.create();Ti.K4.scale(m,u,.05*l);const f=Ti.K4.create(),v=Ti.K4.create();Ti.K4.add(f,c,m),Ti.K4.subtract(v,c,m);const p={start:{x:f[0],y:f[1]},end:{x:r[0],y:r[1]}},E=ws([p.start.x,p.start.y],[p.end.x,p.end.y],[n[0],n[1]]),w={start:{x:v[0],y:v[1]},end:{x:s[0],y:s[1]}},I=ws([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]);(E<=o||I<=o)&&(g.push(t.id),d.handles.activeOperation=null),e++}return d.activeViewportIds=[...g],this.editData={annotation:t},d.handles.activeOperation===Os}}Ms.toolName="Crosshairs";const Rs=Ms,Ns="magnify-viewport";class Ps extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,i=(0,J.getEnabledElement)(n),{viewport:a,renderingEngine:r}=i;if(!(a instanceof J.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const s=this._getReferencedImageId(a);if(!s)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const l=hs(n,this.getToolName());return this.editData={referencedImageId:s,viewportIdsToRender:l,enabledElement:i,renderingEngine:r,currentPoints:o},this._createMagnificationViewport(),this._activateDraw(n),Tr(n),e.preventDefault(),xa(r,l),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:o,currentPoints:i}=this.editData,{viewport:a}=e,{element:r}=a,{voiRange:s}=a.getProperties(),{canvas:l,world:d}=i;let c;if(c=r.querySelector(".magnifyTool"),null===c){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",c=e;r.querySelector(".viewport-element").appendChild(e);const t={viewportId:Ns,type:J.Enums.ViewportType.STACK,element:c};o.enableElement(t)}c.style.top=l[1]-this.configuration.magnifyHeight/2+"px",c.style.left=l[0]-this.configuration.magnifyWidth/2+"px";const h=o.getViewport(Ns);h.setStack([t]).then((()=>{h.setProperties({voiRange:s});const{parallelScale:e}=a.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:o}=h.getCamera(),i=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),r=[d[0],d[1],d[2]],l=[r[0]+i*o[0],r[1]+i*o[1],r[2]+i*o[2]];h.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:r,position:l}),h.render()})),c.style.display="block",xa(o,n)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:o,currentPoints:i}=t,a=n.world,r=i.canvas,s=(0,J.getEnabledElement)(o),{renderingEngine:l}=s,d=l.getViewport(Ns),c=o.querySelector(".magnifyTool");if(!c)return;c.style.top=r[1]-this.configuration.magnifyHeight/2+"px",c.style.left=r[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:h,position:g}=d.getCamera(),u=[g[0]+a[0],g[1]+a[1],g[2]+a[2]],m=[h[0]+a[0],h[1]+a[1],h[2]+a[2]];d.setCamera({focalPoint:m,position:u}),d.render()},this._dragEndCallback=e=>{const{element:t}=e.detail,n=(0,J.getEnabledElement)(t),{renderingEngine:o}=n;o.disableElement(Ns);const i=t.querySelector(".viewport-element"),a=i.querySelector(".magnifyTool");i.removeChild(a),this._deactivateDraw(t),Cr(t)},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._dragEndCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(ne.TOUCH_END,this._dragEndCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._dragEndCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(ne.TOUCH_END,this._dragEndCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof J.StackViewport&&(n=t.split("imageId:")[1]),n}}Ps.toolName="Magnify";const Ls=Ps,{EPSILON:As}=J.CONSTANTS;class Us extends sa{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:""}}){super(e,t),this.editData={},this._init=()=>{const e=(0,J.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=ls(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n||!n.getImageData())return;const{element:o}=n,{viewUp:i,viewPlaneNormal:a}=n.getCamera(),r=J.utilities.getViewportImageCornersInWorld(n);let s=this.editData.annotation;const l=n.getFrameOfReferenceUID();if(s)this.editData.annotation.data.handles.points=r;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...a],viewUp:[...i],FrameOfReferenceUID:l,referencedImageId:null},data:{handles:{points:r}}};gu(e,o),s=e}this.editData={sourceViewport:n,renderingEngine:e,annotation:s},xa(e,t.filter((e=>e.id!==n.id)).map((e=>e.id)))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{annotation:o,sourceViewport:i}=this.editData;let a=!1;if(!i)return a;if(i.id===n.id)return a;if(!o||!o?.data?.handles?.points)return a;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},s=o.data.handles.points[0],l=o.data.handles.points[1],d=o.data.handles.points[2],c=o.data.handles.points[3],{focalPoint:h,viewPlaneNormal:g}=n.getCamera(),{viewPlaneNormal:u}=i.getCamera();if(this.isParallel(g,u))return a;const m=J.utilities.planar.planeEquation(g,h),f=[s,d,l,c],v=[s,l,d,c];let p=f,E=Ti.R3.subtract(Ti.R3.create(),f[0],f[1]);E=Ti.R3.normalize(Ti.R3.create(),E);let w=Ti.R3.subtract(Ti.R3.create(),f[2],f[0]);w=Ti.R3.normalize(Ti.R3.create(),w);const I=Ti.R3.cross(Ti.R3.create(),E,w);if(this.isParallel(I,g))return a;this.isPerpendicular(E,g)&&(p=v);const C=J.utilities.planar.linePlaneIntersection(p[0],p[1],m),T=J.utilities.planar.linePlaneIntersection(p[2],p[3],m),{annotationUID:b}=o;r.annotationUID=b;const _=this.getStyle("lineWidth",r,o),D=this.getStyle("lineDash",r,o),S=this.getStyle("color",r,o),O=this.getStyle("shadow",r,o),y=[C,T].map((e=>n.worldToCanvas(e))),x=`${b}-line`;return Ui(t,b,"1",y[0],y[1],{color:S,width:_,lineDash:D,shadow:O},x),a=!0,a},this.isPerpendicular=(e,t)=>{const n=Ti.R3.dot(e,t);return Math.abs(n)<As}}isParallel(e,t){return Math.abs(Ti.R3.dot(e,t))>1-As}}Us.toolName="ReferenceLines";const ks=Us;function Vs(e){const t=function(e){const t=[e[0],e[1]].sort(r),n=[e[0],e[1]].sort(s),o=t[t.length-1],i=n[0],a=n[n.length-1];return{top:i,bottom:a,right:o};function r(e,t){return e[0]<t[0]?-1:1}function s(e,t){return e[1]<t[1]?-1:1}}(e),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}const{transformWorldToIndex:Hs}=J.utilities;class Ws extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}}){super(e,t),this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles;let l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[1]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},h=ws([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return h<=o||(l=a.worldToCanvas(s[2]),d=a.worldToCanvas(s[3]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},h=ws([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]),h<=o)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),Tr(o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,a=t.data;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=hs(i,this.getToolName());Tr(i),this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i);const d=(0,J.getEnabledElement)(i),{renderingEngine:c}=d;xa(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(void 0!==this.editData.handleIndex){const{points:e}=s.handles,t=Ti.R3.distance(e[0],e[1]);if(Ti.R3.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],o=[...e[1]],i=Ti.K4.create();Ti.K4.set(i,t[1][0]-t[0][0],t[1][1]-t[1][0]);const a=Ti.K4.create();Ti.K4.set(a,-i[1],i[0]);const r=Ti.K4.create();let l;Ti.K4.set(r,o[0]-n[0],o[1]-n[0]),l=Ti.K4.dot(r,a)>0?[n,o]:[o,n],s.handles.points=[t[0],t[1],l[0],l[1]]}}if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(d,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=(0,J.getEnabledElement)(o),{renderingEngine:a,viewport:r}=i,{worldToCanvas:s}=r,{annotation:l,viewportIdsToRender:d,handleIndex:c}=this.editData,{data:h}=l,g=n.world;h.handles.points[c]=[...g];const u=h.handles.points.map(s),m={start:{x:u[0][0],y:u[0][1]},end:{x:u[1][0],y:u[1][1]}},f=(u[2][0],u[2][1],u[3][0],u[3][1],Ti.K4.distance(u[0],u[1])/3),v=m.start.x-m.end.x,p=m.start.y-m.end.y,E=Math.sqrt(v*v+p*p),w=v/E,I=p/E,C=(m.start.x+m.end.x)/2,T=(m.start.y+m.end.y)/2,b=C+f*I,_=T-f*w,D=C-f*I,S=T+f*w;h.handles.points[2]=r.canvasToWorld([b,_]),h.handles.points[3]=r.canvasToWorld([D,S]),l.invalidated=!0,xa(a,d),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{renderingEngine:i}=o,{annotation:a,viewportIdsToRender:r,handleIndex:s,movingTextBox:l}=this.editData,{data:d}=a;if(l){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),a.invalidated=!0}else this._dragModifyHandle(e),a.invalidated=!0;xa(i,r)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=(0,J.getEnabledElement)(o),{viewport:a}=i,{annotation:r,handleIndex:s}=this.editData,{data:l}=r,d=n.world,c=[a.worldToCanvas(l.handles.points[0]),a.worldToCanvas(l.handles.points[1]),a.worldToCanvas(l.handles.points[2]),a.worldToCanvas(l.handles.points[3])],h={start:{x:c[0][0],y:c[0][1]},end:{x:c[1][0],y:c[1][1]}},g={start:{x:c[2][0],y:c[2][1]},end:{x:c[3][0],y:c[3][1]}},u=[...d],m=a.worldToCanvas(u);if(0===s||1===s){const e=c[0===s?1:0],t=Ti.K4.set(Ti.K4.create(),m[0]-e[0],m[1]-e[1]),n=Ti.K4.set(Ti.K4.create(),c[s][0]-e[0],c[s][1]-e[1]);Ti.K4.normalize(t,t),Ti.K4.normalize(n,n);const o={start:{x:e[0],y:e[1]},end:{x:m[0],y:m[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(o,g))return;const i=e,r=this._getSignedAngle(n,t);let d=c[2][0],h=c[2][1],f=c[3][0],v=c[3][1];d-=i[0],h-=i[1],f-=i[0],v-=i[1];const p=d*Math.cos(r)-h*Math.sin(r),E=d*Math.sin(r)+h*Math.cos(r),w=f*Math.cos(r)-v*Math.sin(r),I=f*Math.sin(r)+v*Math.cos(r);d=p+i[0],h=E+i[1],f=w+i[0],v=I+i[1];const C=a.canvasToWorld([d,h]),T=a.canvasToWorld([f,v]);l.handles.points[s]=u,l.handles.points[2]=C,l.handles.points[3]=T}else{const e=2===s?3:2,t={longLineSegment:{start:h.start,end:h.end},shortLineSegment:{start:g.start,end:g.end}},n=Ti.K4.subtract(Ti.K4.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),o=Ti.K4.normalize(Ti.K4.create(),n),i=Ti.K4.subtract(Ti.K4.create(),[m[0],m[1]],[c[s][0],c[s][1]]),r=Ti.K4.length(i),d=this._getSignedAngle(o,i),f=Math.cos(d)*r,v=Ti.K4.scaleAndAdd(Ti.K4.create(),[c[e][0],c[e][1]],o,f);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:m[0],y:m[1]},end:{x:v[0],y:v[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!Cs([m[0],m[1]],[v[0],v[1]],[h.start.x,h.start.y],[h.end.x,h.end.y]))return;l.handles.points[e]=a.canvasToWorld(v),l.handles.points[s]=u}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(ne.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(ne.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles,m=g.map((e=>o.worldToCanvas(e)));l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),v=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),E=this.getStyle("shadow",l,d);if(h.cachedStats[r]&&void 0!==h.cachedStats[r].unit?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(h.cachedStats[r]={length:null,width:null,unit:null},this._calculateCachedStats(d,s,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let w;if(!Pe(c))continue;if(ge(d)||this.editData||null===u||(w=[m[u]]),w){Ai(t,c,"0",w,{color:p})}const I=`${c}-line-1`,C=`${c}-line-2`;Ui(t,c,"0",m[0],m[1],{color:p,lineDash:v,lineWidth:f,shadow:E},I);Ui(t,c,"1",m[2],m[3],{color:p,lineDash:v,lineWidth:f,shadow:E},C),n=!0;const T=this._getTextLines(h,r);if(!T||0===T.length)continue;let b;h.handles.textBox.hasMoved||(b=Vs(m),h.handles.textBox.worldPosition=o.canvasToWorld(b));const _=o.worldToCanvas(h.handles.textBox.worldPosition),D=Gi(t,c,"1",T,_,m,{},this.getLinkedTextBoxStyle(l,d)),{x:S,y:O,width:y,height:x}=D;h.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([S,O]),topRight:o.canvasToWorld([S+y,O]),bottomLeft:o.canvasToWorld([S,O+x]),bottomRight:o.canvasToWorld([S+y,O+x])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=Ti.K4.create();Ti.K4.set(n,t.end.x-t.start.x,t.end.y-t.start.y),Ti.K4.normalize(n,n);const o={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!Cs([o.start.x,o.start.y],[o.end.x,o.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._getTextLines=(e,t)=>{const{cachedStats:n}=e,{length:o,width:i,unit:a}=n[t];if(void 0===o)return;return[`L: ${o.toFixed(2)} ${a}`,`W: ${i.toFixed(2)} ${a}`]},this._calculateCachedStats=(e,t,n)=>{const{data:o}=e,{viewportId:i,renderingEngineId:a}=n,r=o.handles.points[0],s=o.handles.points[1],l=o.handles.points[2],d=o.handles.points[3],{cachedStats:c}=o,h=Object.keys(c);for(let e=0;e<h.length;e++){const n=h[e],o=this.getTargetIdImage(n,t);if(!o)continue;const{imageData:i,dimensions:a,hasPixelSpacing:g}=o,u=this._calculateLength(r,s),m=this._calculateLength(l,d),f=u>m?u:m,v=u>m?m:u,p=Hs(i,r),E=Hs(i,s),w=Hs(i,l),I=Hs(i,d);this._isInsideVolume(p,E,w,I,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[n]={length:f,width:v,unit:g?"mm":"px"}}e.invalidated=!1;const g=ne.ANNOTATION_MODIFIED,u={annotation:e,viewportId:i,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,g,u),c},this._isInsideVolume=(e,t,n,o,i)=>J.utilities.indexWithinDimensions(e,i)&&J.utilities.indexWithinDimensions(t,i)&&J.utilities.indexWithinDimensions(n,i)&&J.utilities.indexWithinDimensions(o,i),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=r.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...i],[...i],[...i],[...i]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};gu(u,o);const m=hs(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(s,m),u}_calculateLength(e,t){const n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}}Ws.toolName="Bidirectional";const Fs=Ws,{transformWorldToIndex:Bs}=J.utilities;class Gs extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;Tr(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=r.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};gu(u,o);const m=hs(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),xa(s,m),u},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,[s,l]=r.handles.points,d=a.worldToCanvas(s),c=a.worldToCanvas(l),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return ws([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),Tr(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(d,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;xa(d,i)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_MOVE,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_MOVE,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),f=this.getStyle("lineDash",l,d),v=this.getStyle("color",l,d),p=this.getStyle("shadow",l,d),E=g.map((e=>o.worldToCanvas(e)));let w;if(h.cachedStats[r]&&void 0!==h.cachedStats[r].unit?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(h.cachedStats[r]={length:null,unit:null},this._calculateCachedStats(d,s,e)),!Pe(c))continue;if(ge(d)||this.editData||null===u||(w=[E[u]]),w){Ai(t,c,"0",E,{color:v,lineDash:f,lineWidth:m})}const I=`${c}-line`;if(Ui(t,c,"1",E[0],E[1],{color:v,width:m,lineDash:f,shadow:p},I),n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const C=this._getTextLines(h,r);if(!h.handles.textBox.hasMoved){const e=Vs(E);h.handles.textBox.worldPosition=o.canvasToWorld(e)}const T=o.worldToCanvas(h.handles.textBox.worldPosition),b=Gi(t,c,"1",C,T,E,{},this.getLinkedTextBoxStyle(l,d)),{x:_,y:D,width:S,height:O}=b;h.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([_,D]),topRight:o.canvasToWorld([_+S,D]),bottomLeft:o.canvasToWorld([_,D+O]),bottomRight:o.canvasToWorld([_+S,D+O])}}return n},this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=hs(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),Tr(i);const d=(0,J.getEnabledElement)(i),{renderingEngine:c}=d;xa(c,l),e.preventDefault()}_getTextLines(e,t){const n=e.cachedStats[t],{length:o,unit:i}=n;if(null==o||isNaN(o))return;return[`${o.toFixed(2)} ${i}`]}_calculateLength(e,t){const n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a}=n,r=o.handles.points[0],s=o.handles.points[1],{cachedStats:l}=o,d=Object.keys(l);for(let e=0;e<d.length;e++){const n=d[e],o=this.getTargetIdImage(n,t);if(!o)continue;const{imageData:i,dimensions:a,hasPixelSpacing:c}=o,h=this._calculateLength(r,s),g=Bs(i,r),u=Bs(i,s);this._isInsideVolume(g,u,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,l[n]={length:h,unit:c?"mm":"px"}}e.invalidated=!1;const c=ne.ANNOTATION_MODIFIED,h={annotation:e,viewportId:i,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,c,h),l}_isInsideVolume(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)}}Gs.toolName="Length";const $s=Gs;function Ks(e,t,n){return"CT"===e?"HU":"PT"===e&&!0===t&&!0===n?"SUV":""}function qs(e,t){if(e instanceof J.BaseVolumeViewport){const e=t.split("volumeId:")[1],n=J.cache.getVolume(e);return!!n?.scaling&&Object.keys(n.scaling).length>0}if(e instanceof J.StackViewport){const{preScale:t}=e.getImageData()||{};return!!t?.scaled}throw new Error("Viewport is not a valid type")}const{transformWorldToIndex:zs}=J.utilities;class js extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=r.getFrameOfReferenceUID(),u={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{label:"",handles:{points:[[...i]]},cachedStats:{}}};gu(u,o);const m=hs(o,this.getToolName());return this.editData={annotation:u,newAnnotation:!0,viewportIdsToRender:m},this._activateModify(o),Tr(o),e.preventDefault(),xa(s,m),u},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a}=this.editData,r=(0,J.getEnabledElement)(n),{renderingEngine:s}=r,{viewportId:l}=r;if(this.eventDispatchDetail={viewportId:l,renderingEngineId:s.id},this._deactivateModify(n),Cr(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(s,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,{annotation:a,viewportIdsToRender:r}=this.editData,{data:s}=a;s.handles.points[0]=[...i],a.invalidated=!0;const l=(0,J.getEnabledElement)(o),{renderingEngine:d}=l;xa(d,r)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],c=d.annotationUID,h=d.data,g=h.handles.points[0],u=o.worldToCanvas(g);l.annotationUID=c;const m=this.getStyle("color",l,d);if(h.cachedStats[r]){if(d.invalidated&&(this._calculateCachedStats(d,s,e),o instanceof J.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=J.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[r]={Modality:null,index:null,value:null},this._calculateCachedStats(d,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;Ai(t,c,"0",[u],{color:m}),n=!0;const f=qs(o,r),v=this.isSuvScaled(o,r,d.metadata.referencedImageId),p=this._getTextLines(h,r,f,v);if(p){const e=[u[0]+6,u[1]-6];Wi(t,c,"0",p,[e[0],e[1]],this.getLinkedTextBoxStyle(l,d))}}return n}}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,o){const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,s=r.handles.points[0],l=a.worldToCanvas(s);if(!0===Ti.K4.distance(n,l)<o)return s}handleSelectedCallback(e,t){const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i},this._activateModify(o),Tr(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),e.preventDefault()}_getTextLines(e,t,n,o){const i=e.cachedStats[t],{index:a,Modality:r,value:s,SUVBw:l,SUVLbm:d,SUVBsa:c}=i;if(void 0===s&&void 0===l)return;const h=[],g=Ks(r,n,o);return h.push(`(${a[0]}, ${a[1]}, ${a[2]})`),"PT"===r&&!0===n&&void 0!==l?(h.push(`${l.toFixed(2)} SUV bw`),d&&h.push(`${d.toFixed(2)} SUV lbm`),c&&h.push(`${c.toFixed(2)} SUV bsa`)):h.push(`${s.toFixed(2)} ${g}`),h}_getValueForModality(e,t,n){const o={};if(o.value=e,"PT"===n&&t.scaling?.PET&&(t.scaling.PET.suvbwToSuvbsa||t.scaling.PET.suvbwToSuvlbm)){const{suvbwToSuvlbm:n,suvbwToSuvbsa:i}=t.scaling.PET;if(o.SUVBw=e,n){const t=e*n;o.SUVLbm=t}if(i){const t=e*i;o.SUVBsa=t}}return o}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a}=n,r=o.handles.points[0],{cachedStats:s}=o,l=Object.keys(s);for(let n=0;n<l.length;n++){const o=l[n],d=this.getTargetIdImage(o,t);if(!d)continue;const{dimensions:c,imageData:h,metadata:g}=d,u="getScalarData"in d?d.getScalarData():d.scalarData,m=g.Modality,f=zs(h,r);if(f[0]=Math.round(f[0]),f[1]=Math.round(f[1]),f[2]=Math.round(f[2]),J.utilities.indexWithinDimensions(f,c)){this.isHandleOutsideImage=!1;const e=c[0],t=c[0]*c[1],n=u[f[2]*t+f[1]*e+f[0]];if(o.startsWith("imageId:")){const e=o.split("imageId:")[1],t=J.utilities.imageIdToURI(e),n=J.utilities.getViewportsWithImageURI(t,a)[0];f[2]=n.getCurrentImageIdIndex()}const i=this._getValueForModality(n,d,m);s[o]={index:f,...i,Modality:m}}else this.isHandleOutsideImage=!0,s[o]={index:f,Modality:m};e.invalidated=!1;const v=ne.ANNOTATION_MODIFIED,p={annotation:e,viewportId:i,renderingEngineId:a};(0,J.triggerEvent)(J.eventTarget,v,p)}return s}}js.toolName="Probe";const Zs=js;class Ys extends Zs{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:h},data:{label:"",handles:{points:[[...i]]},cachedStats:{}}},u=hs(o,this.getToolName());return this.editData={annotation:g,newAnnotation:!0,viewportIdsToRender:u},this._activateModify(o),Tr(o),e.preventDefault(),xa(s,u),g},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e;if(!this.editData)return n;const i=this.filterInteractableAnnotationsForElement(o.element,[this.editData.annotation]);if(!i?.length)return n;const a=this.getTargetId(o),r=o.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=this.editData.annotation,d=l.annotationUID,c=l.data,h=c.handles.points[0],g=o.worldToCanvas(h);s.annotationUID=d;const u=this.getStyle("color",s,l);if(c.cachedStats[a]?l.invalidated&&this._calculateCachedStats(l,r,e):(c.cachedStats[a]={Modality:null,index:null,value:null},this._calculateCachedStats(l,r,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;Ai(t,d,"0",[g],{color:u}),n=!0;const m=qs(o,a),f=this.isSuvScaled(o,a,l.metadata.referencedImageId),v=this._getTextLines(c,a,m,f);if(v){const e=[g[0]+6,g[1]-6];Wi(t,d,"0",v,[e[0],e[1]],this.getLinkedTextBoxStyle(s,l))}return n}}}Ys.toolName="DragProbe";const Js=Ys;function Xs(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");const[n,o,i,a]=e;let r=655535;const s=function(e,t,n,o){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+o]],bottom:[[e+n,t+o],[e,t+o]],left:[[e,t+o],[e,t]]}}(n,o,i,a);return Object.keys(s).forEach((e=>{const[n,o]=s[e],i=ws(n,o,t);i<r&&(r=i)})),r}const{transformWorldToIndex:Qs}=J.utilities;class el extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=r.getFrameOfReferenceUID(),u={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{label:"",handles:{points:[[...i],[...i],[...i],[...i]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};gu(u,o);const m=hs(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(s,m),u},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[3]),c=this._getRectangleImageCoordinates([l,d]),h=[n[0],n[1]],{left:g,top:u,width:m,height:f}=c;return Xs([g,u,m,f],h)<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),Tr(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=hs(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),Tr(i);const d=(0,J.getEnabledElement)(i),{renderingEngine:c}=d;xa(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(d,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:i}=s.handles;i.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,i=(0,J.getEnabledElement)(n),{worldToCanvas:r,canvasToWorld:l}=i.viewport,d=e.world,{points:c}=s.handles;let h,g,u,m,f,v,p,E;switch(c[a]=[...d],a){case 0:case 3:h=r(c[0]),m=r(c[3]),g=[m[0],h[1]],u=[h[0],m[1]],v=l(g),p=l(u),c[1]=v,c[2]=p;break;case 1:case 2:g=r(c[1]),u=r(c[2]),h=[u[0],g[1]],m=[g[0],u[1]],f=l(h),E=l(m),c[0]=f,c[3]=E}o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;xa(d,i)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_MOVE,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_MOVE,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles,m=g.map((e=>o.worldToCanvas(e)));l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),v=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),{viewPlaneNormal:E,viewUp:w}=o.getCamera();if(h.cachedStats[r]&&void 0!==h.cachedStats[r].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,E,w,s,e),o instanceof J.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=J.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(d,E,w,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let I;if(!Pe(c))continue;if(ge(d)||this.editData||null===u||(I=[m[u]]),I){Ai(t,c,"0",I,{color:p})}const C=`${c}-rect`;$i(t,c,"0",m[0],m[3],{color:p,lineDash:v,lineWidth:f},C),n=!0;const T=qs(o,r),b=this.isSuvScaled(o,r,d.metadata.referencedImageId),_=this._getTextLines(h,r,T,b);if(!_||0===_.length)continue;if(!h.handles.textBox.hasMoved){const e=Vs(m);h.handles.textBox.worldPosition=o.canvasToWorld(e)}const D=o.worldToCanvas(h.handles.textBox.worldPosition),S=Gi(t,c,"1",_,D,m,{},this.getLinkedTextBoxStyle(l,d)),{x:O,y,width:x,height:M}=S;h.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([O,y]),topRight:o.canvasToWorld([O+x,y]),bottomLeft:o.canvasToWorld([O,y+M]),bottomRight:o.canvasToWorld([O+x,y+M])}}return n},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._getTextLines=(e,t,n,o)=>{const i=e.cachedStats[t],{area:a,mean:r,max:s,stdDev:l,Modality:d,areaUnit:c}=i;if(void 0===r)return;const h=[],g=Ks(d,n,o);return h.push(`Area: ${a.toFixed(2)} ${c}²`),h.push(`Mean: ${r.toFixed(2)} ${g}`),h.push(`Max: ${s.toFixed(2)} ${g}`),h.push(`Std Dev: ${l.toFixed(2)} ${g}`),h},this._calculateCachedStats=(e,t,n,o,i)=>{const{data:a}=e,{viewportId:r,renderingEngineId:s}=i,l=a.handles.points[0],d=a.handles.points[3],{cachedStats:c}=a,h=Object.keys(c);for(let e=0;e<h.length;e++){const i=h[e],a=this.getTargetIdImage(i,o);if(!a)continue;const{dimensions:r,imageData:s,metadata:g,hasPixelSpacing:u}=a,m="getScalarData"in a?a.getScalarData():a.scalarData,f=Qs(s,l);f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]);const v=Qs(s,d);if(v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),this._isInsideVolume(f,v,r)){this.isHandleOutsideImage=!1;const e=Math.min(f[0],v[0]),o=Math.max(f[0],v[0]),a=Math.min(f[1],v[1]),s=Math.max(f[1],v[1]),h=Math.min(f[2],v[2]),p=Math.max(f[2],v[2]),{worldWidth:E,worldHeight:w}=Yr(t,n,l,d),I=Math.abs(E*w);let C=0,T=0,b=0,_=-1/0;const D=r[0],S=r[0]*r[1];for(let t=h;t<=p;t++)for(let n=a;n<=s;n++)for(let i=e;i<=o;i++){const e=m[t*S+n*D+i];e>_&&(_=e),C++,T+=e}T/=C;for(let t=h;t<=p;t++)for(let n=a;n<=s;n++)for(let i=e;i<=o;i++){const e=m[t*S+n*D+i]-T;b+=e*e}b/=C,b=Math.sqrt(b),c[i]={Modality:g.Modality,area:I,mean:T,stdDev:b,max:_,areaUnit:u?"mm":"px"}}else this.isHandleOutsideImage=!0,c[i]={Modality:g.Modality}}e.invalidated=!1;const g=ne.ANNOTATION_MODIFIED,u={annotation:e,viewportId:r,renderingEngineId:s};return(0,J.triggerEvent)(J.eventTarget,g,u),c},this._isInsideVolume=(e,t,n)=>J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}}el.toolName="RectangleROI";const tl=el;function nl(e,t,n,o){const i=Ti.R3.create();Ti.R3.cross(i,t,e);const a=Ti.R3.fromValues(...n),r=Ti.R3.fromValues(...o),s=Ti.R3.create();Ti.R3.subtract(s,a,r);const l=Ti.R3.length(s);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=Ti.R3.dot(s,i)/(l*Ti.R3.length(i));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}const{transformWorldToIndex:ol}=J.utilities;class il extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,J.getEnabledElement)(o),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.getReferencedImageId(s,i,c,h),u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:u,referencedImageId:g},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},cachedStats:{},initialRotation:s.getRotation()}};gu(m,o);const f=hs(o,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:f,centerCanvas:a,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(l,f),m},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=Fa(s.map((e=>a.worldToCanvas(e)))),[d,c]=l,h={left:Math.min(d[0],c[0])+o/2,top:Math.min(d[1],c[1])+o/2,width:Math.abs(d[0]-c[0])-o,height:Math.abs(d[1]-c[1])-o},g={left:Math.min(d[0],c[0])-o/2,top:Math.min(d[1],c[1])-o/2,width:Math.abs(d[0]-c[0])+o,height:Math.abs(d[1]-c[1])+o},u=this._pointInEllipseCanvas(h,n);return!(!this._pointInEllipseCanvas(g,n)||u)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},Tr(o),this._activateModify(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s,l,d,c,h=!1;if(n.worldPosition)h=!0;else{const{points:e}=a.handles,t=(0,J.getEnabledElement)(i),{worldToCanvas:o}=t.viewport;r=e.findIndex((e=>e===n));const h=e.map(o);c=h[r],l=Math.abs(h[2][0]-h[3][0]),d=Math.abs(h[0][1]-h[1][1]),s=[(h[2][0]+h[3][0])/2,(h[0][1]+h[1][1])/2]}const g=hs(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:g,handleIndex:r,canvasWidth:l,canvasHeight:d,centerCanvas:s,originalHandleCanvas:c,movingTextBox:h},this._activateModify(i),Tr(i);const u=(0,J.getEnabledElement)(i),{renderingEngine:m}=u;xa(m,g),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;o.highlighted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(d,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerCanvas:h}=this.editData,{data:g}=d,u=Math.abs(i[0]-h[0]),m=Math.abs(i[1]-h[1]),f=[h[0],h[1]-m],v=[h[0],h[1]+m],p=[h[0]-u,h[1]],E=[h[0]+u,h[1]];g.handles.points=[l(f),l(v),l(p),l(E)],d.invalidated=!0,this.editData.hasMoved=!0,xa(r,c)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;xa(d,i)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{canvasToWorld:i}=o.viewport,{annotation:a,canvasWidth:r,canvasHeight:s,handleIndex:l,centerCanvas:d,originalHandleCanvas:c}=this.editData,{data:h}=a,{points:g}=h.handles,{currentPoints:u}=t,m=u.canvas;if(0===l||1===l){const e=Math.abs(m[1]-d[1]),t=[d[0],d[1]-e],n=[d[0],d[1]+e];g[0]=i(t),g[1]=i(n);const o=r/2+(m[0]-c[0]),a=[d[0]-o,d[1]],s=[d[0]+o,d[1]];g[2]=i(a),g[3]=i(s)}else{const e=Math.abs(m[0]-d[0]),t=[d[0]-e,d[1]],n=[d[0]+e,d[1]];g[2]=i(t),g[3]=i(n);const o=s/2+(m[1]-c[1]),a=[d[0],d[1]-o],r=[d[0],d[1]+o];g[0]=i(a),g[1]=i(r)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(ne.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(ne.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:h}=d,{handles:g}=h,{points:u,activeHandleIndex:m}=g;l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),v=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),E=u.map((e=>o.worldToCanvas(e))),w=Math.abs(o.getRotation()-(h.initialRotation||0));let I;I=Fa(90==w||270==w?[E[2],E[3],E[0],E[1]]:E);const{centerPointRadius:C}=this.configuration;if(h.cachedStats[r]&&void 0!==h.cachedStats[r].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,o,s,e),o instanceof J.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=J.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(d,o,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!Pe(c))continue;if(ge(d)||this.editData||null===m||(T=[E[m]]),T){Ai(t,c,"0",T,{color:p})}const b=`${c}-ellipse`,_="0";if(Li(t,c,_,I[0],I[1],{color:p,lineDash:v,lineWidth:f},b),C>0){if(Math.min(Math.abs(I[0][0]-I[1][0])/2,Math.abs(I[0][1]-I[1][1])/2)>3*C){const e=this._getCanvasEllipseCenter(E);Pi(t,c,`${_}-center`,e,C,{color:p,lineDash:v,lineWidth:f})}}n=!0;const D=qs(o,r),S=this.isSuvScaled(o,r,d.metadata.referencedImageId),O=this._getTextLines(h,r,D,S);if(!O||0===O.length)continue;let y;h.handles.textBox.hasMoved||(y=Vs(I),h.handles.textBox.worldPosition=o.canvasToWorld(y));const x=o.worldToCanvas(h.handles.textBox.worldPosition),M=Gi(t,c,"1",O,x,E,{},this.getLinkedTextBoxStyle(l,d)),{x:R,y:N,width:P,height:L}=M;h.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([R,N]),topRight:o.canvasToWorld([R+P,N]),bottomLeft:o.canvasToWorld([R,N+L]),bottomRight:o.canvasToWorld([R+P,N+L])}}return n},this._getTextLines=(e,t,n,o)=>{const i=e.cachedStats[t],{area:a,mean:r,stdDev:s,max:l,isEmptyArea:d,Modality:c,areaUnit:h}=i,g=[],u=Ks(c,n,o);if(a){const e=d?"Area: Oblique not supported":`Area: ${a.toFixed(2)} ${h}²`;g.push(e)}return r&&g.push(`Mean: ${r.toFixed(2)} ${u}`),l&&g.push(`Max: ${l.toFixed(2)} ${u}`),s&&g.push(`Std Dev: ${s.toFixed(2)} ${u}`),g},this._calculateCachedStats=(e,t,n,o)=>{const i=e.data,{viewportId:a,renderingEngineId:r}=o,{points:s}=i.handles,l=s.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[h,g]=Fa(l),u=t.canvasToWorld(h),m=t.canvasToWorld(g),{cachedStats:f}=i,v=Object.keys(f),p=u,E=m;for(let e=0;e<v.length;e++){const t=v[e],o=this.getTargetIdImage(t,n);if(!o)continue;const{dimensions:i,imageData:a,metadata:r,hasPixelSpacing:s}=o,l=ol(a,p);l[0]=Math.floor(l[0]),l[1]=Math.floor(l[1]),l[2]=Math.floor(l[2]);const h=ol(a,E);if(h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]),this._isInsideVolume(l,h,i)){const e=[[Math.min(l[0],h[0]),Math.max(l[0],h[0])],[Math.min(l[1],h[1]),Math.max(l[1],h[1])],[Math.min(l[2],h[2]),Math.max(l[2],h[2])]],n={center:[(u[0]+m[0])/2,(u[1]+m[1])/2,(u[2]+m[2])/2],xRadius:Math.abs(u[0]-m[0])/2,yRadius:Math.abs(u[1]-m[1])/2,zRadius:Math.abs(u[2]-m[2])/2},{worldWidth:o,worldHeight:i}=nl(d,c,p,E),g=0===o&&0===i,v=Math.abs(Math.PI*(o/2)*(i/2));let w=0,I=0,C=0,T=-1/0;Na(a,((e,t)=>Wa(n,e)),(({value:e})=>{e>T&&(T=e),I+=e,w+=1}),e),I/=w;Na(a,((e,t)=>Wa(n,e)),(({value:e})=>{const t=e-I;C+=t*t}),e),C/=w,C=Math.sqrt(C),f[t]={Modality:r.Modality,area:v,mean:I,max:T,stdDev:C,isEmptyArea:g,areaUnit:s?"mm":"px"}}else this.isHandleOutsideImage=!0,f[t]={Modality:r.Modality}}e.invalidated=!1;const w=ne.ANNOTATION_MODIFIED,I={annotation:e,viewportId:a,renderingEngineId:r};return(0,J.triggerEvent)(J.eventTarget,w,I),f},this._isInsideVolume=(e,t,n)=>J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){const n=e.width/2,o=e.height/2;if(n<=0||o<=0)return!1;const i=[e.left+n,e.top+o],a=[t[0]-i[0],t[1]-i[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(o*o)<=1}_getCanvasEllipseCenter(e){const[t,n,o,i]=e,a=[o[0],n[1]],r=[i[0],t[1]];return[(a[0]+r[0])/2,(a[1]+r[1])/2]}}il.toolName="EllipticalROI";const al=il;function rl(e,t){if(2!==e?.length||2!==t?.length)throw Error("points should have 2 elements of [x, y]");const[n,o]=e,[i,a]=t;return Math.sqrt(Math.pow(n-i,2)+Math.pow(o-a,2))}function sl(e){const[t,n]=e;return rl(t,n)}function ll(e){const[t,n]=e,o=rl(t,n);return[[t[0]-o,t[1]-o],[t[0]+o,t[1]+o]]}const{transformWorldToIndex:dl}=J.utilities;class cl extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(n.canvas,(0,J.getEnabledElement)(o)),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=r.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...i],[...i]],activeHandleIndex:null},cachedStats:{}}};gu(u,o);const m=hs(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(s,m),u},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,{points:s}=r.handles,l=s.map((e=>a.worldToCanvas(e))),d=sl(l),c=sl([l[0],n]);return Math.abs(c-d)<o/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},Tr(o),this._activateModify(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;if(n.worldPosition)s=!0;else{const{points:e}=a.handles;r=e.findIndex((e=>e===n))}const l=hs(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),Tr(i);const d=(0,J.getEnabledElement)(i),{renderingEngine:c}=d;xa(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;o.highlighted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(d,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c}=this.editData,{data:h}=d;h.handles.points=[h.handles.points[0],l(i)],d.invalidated=!0,this.editData.hasMoved=!0,xa(r,c)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;xa(d,i)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{canvasToWorld:i,worldToCanvas:a}=o.viewport,{annotation:r,handleIndex:s}=this.editData,{data:l}=r,{points:d}=l.handles,c=d.map((e=>a(e))),{currentPoints:h}=t,g=h.canvas;if(0===s){const e=g[0]-c[0][0],t=g[1]-c[0][1],n=g,o=[c[1][0]+e,c[1][1]+t];d[0]=i(n),d[1]=i(o)}else d[1]=i(g)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(ne.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(ne.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:h}=d,{handles:g}=h,{points:u,activeHandleIndex:m}=g;l.annotationUID=c;const f=this.getStyle("lineWidth",l,d),v=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),E=u.map((e=>o.worldToCanvas(e))),w=E[0],I=sl(E),C=ll(E),{centerPointRadius:T}=this.configuration;if(h.cachedStats[r]&&void 0!==h.cachedStats[r].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,o,s,e),o instanceof J.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){s.getStackViewports().find((t=>{const n=J.utilities.imageIdToURI(e),o=t.hasImageURI(n),i=J.utilities.imageIdToURI(t.getCurrentImageId());return o&&i!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(d,o,s,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!Pe(c))continue;if(ge(d)||this.editData||null===m||(b=[E[m]]),b){Ai(t,c,"0",b,{color:p})}const _="0";Pi(t,c,_,w,I,{color:p,lineDash:v,lineWidth:f},`${c}-circle`),T>0&&I>3*T&&Pi(t,c,`${_}-center`,w,T,{color:p,lineDash:v,lineWidth:f}),n=!0;const D=qs(o,r),S=this.isSuvScaled(o,r,d.metadata.referencedImageId),O=this._getTextLines(h,r,D,S);if(!O||0===O.length)continue;let y;h.handles.textBox.hasMoved||(y=Vs(C),h.handles.textBox.worldPosition=o.canvasToWorld(y));const x=o.worldToCanvas(h.handles.textBox.worldPosition),M=Gi(t,c,"1",O,x,E,{},this.getLinkedTextBoxStyle(l,d)),{x:R,y:N,width:P,height:L}=M;h.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([R,N]),topRight:o.canvasToWorld([R+P,N]),bottomLeft:o.canvasToWorld([R,N+L]),bottomRight:o.canvasToWorld([R+P,N+L])}}return n},this._getTextLines=(e,t,n,o)=>{const i=e.cachedStats[t],{radius:a,radiusUnit:r,area:s,mean:l,stdDev:d,max:c,isEmptyArea:h,Modality:g,areaUnit:u}=i,m=[],f=Ks(g,n,o);if(a){const e=h?"Radius: Oblique not supported":`Radius: ${a.toFixed(2)} ${r}`;m.push(e)}if(s){const e=h?"Area: Oblique not supported":`Area: ${s.toFixed(2)} ${u}²`;m.push(e)}return l&&m.push(`Mean: ${l.toFixed(2)} ${f}`),c&&m.push(`Max: ${c.toFixed(2)} ${f}`),d&&m.push(`Std Dev: ${d.toFixed(2)} ${f}`),m},this._calculateCachedStats=(e,t,n,o)=>{const i=e.data,{viewportId:a,renderingEngineId:r}=o,{points:s}=i.handles,l=s.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[h,g]=ll(l),u=t.canvasToWorld(h),m=t.canvasToWorld(g),{cachedStats:f}=i,v=Object.keys(f),p=u,E=m;for(let e=0;e<v.length;e++){const t=v[e],o=this.getTargetIdImage(t,n);if(!o)continue;const{dimensions:i,imageData:a,metadata:r,hasPixelSpacing:s}=o,l=dl(a,p);l[0]=Math.floor(l[0]),l[1]=Math.floor(l[1]),l[2]=Math.floor(l[2]);const h=dl(a,E);if(h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]),this._isInsideVolume(l,h,i)){const e=[[Math.min(l[0],h[0]),Math.max(l[0],h[0])],[Math.min(l[1],h[1]),Math.max(l[1],h[1])],[Math.min(l[2],h[2]),Math.max(l[2],h[2])]],n={center:[(u[0]+m[0])/2,(u[1]+m[1])/2,(u[2]+m[2])/2],xRadius:Math.abs(u[0]-m[0])/2,yRadius:Math.abs(u[1]-m[1])/2,zRadius:Math.abs(u[2]-m[2])/2},{worldWidth:o,worldHeight:i}=nl(d,c,p,E),g=0===o&&0===i,v=Math.abs(Math.PI*(o/2)*(i/2));let w=0,I=0,C=0,T=-1/0;Na(a,((e,t)=>Wa(n,e)),(({value:e})=>{e>T&&(T=e),I+=e,w+=1}),e),I/=w;Na(a,((e,t)=>Wa(n,e)),(({value:e})=>{const t=e-I;C+=t*t}),e),C/=w,C=Math.sqrt(C),f[t]={Modality:r.Modality,area:v,mean:I,max:T,stdDev:C,isEmptyArea:g,areaUnit:s?"mm":"px",radius:o/2,radiusUnit:s?"mm":"px",perimeter:2*Math.PI*(o/2)}}else this.isHandleOutsideImage=!0,f[t]={Modality:r.Modality}}e.invalidated=!1;const w=ne.ANNOTATION_MODIFIED,I={annotation:e,viewportId:a,renderingEngineId:r};return(0,J.triggerEvent)(J.eventTarget,w,I),f},this._isInsideVolume=(e,t,n)=>J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}}cl.toolName="CircleROI";const hl=cl;function gl(e,t,n,o=!0){const i=[],a=function(e,t,n,o=!0){let i,a;const r=[];o?(a=e.length-1,i=0):(a=0,i=1);for(let o=i;o<e.length;o++)fl(t,n,e[a],e[o])&&r.push([a,o]),a=o;return r}(e,t,n,o);for(let o=0;o<a.length;o++){const r=El(t,n,e[a[o][0]],e[a[o][1]]);i.push(r)}return i}function ul(e,t,n,o=!0){let i,a;o?(a=e.length-1,i=0):(a=0,i=1);for(let o=i;o<e.length;o++){if(fl(t,n,e[a],e[o]))return[a,o];a=o}}function ml(e,t,n,o=!0){let i,a;o?(a=e.length-1,i=0):(a=0,i=1);const r=[];for(let o=i;o<e.length;o++){const i=e[a],s=e[o];fl(t,n,i,s)&&r.push([a,o]),a=o}if(0===r.length)return;const s=[];r.forEach((n=>{const o=[e[n[0]],e[n[1]]],i=[(o[0][0]+o[1][0])/2,(o[0][1]+o[1][1])/2];s.push(Ti.K4.distance(i,t))}));const l=Math.min(...s);return{segment:r[s.indexOf(l)],distance:l}}function fl(e,t,n,o){let i=!1;const a=[vl(e,t,n),vl(e,t,o),vl(n,o,e),vl(n,o,t)];return a[0]!==a[1]&&a[2]!==a[3]||((0===a[0]&&pl(e,n,t)||0===a[1]&&pl(e,o,t)||0===a[2]&&pl(n,e,o)||0===a[3]&&pl(n,t,o))&&(i=!0),i)}function vl(e,t,n){const o=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===o?0:o>0?1:2}function pl(e,t,n){return t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1])}function El(e,t,n,o){const i=(o[1]-n[1])*(t[0]-e[0])-(o[0]-n[0])*(t[1]-e[1]);if(0==i)return;let a=e[1]-n[1],r=e[0]-n[0];const s=(o[0]-n[0])*a-(o[1]-n[1])*r,l=(t[0]-e[0])*a-(t[1]-e[1])*r;a=s/i,r=l/i;return[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}const wl=.001,Il=(e,t)=>{let n,o,i;if(e instanceof J.StackViewport){const t=e.getImageData();o=t.direction.slice(0,3),i=t.direction.slice(3,6),n=t.spacing}else{const t=e.getImageData(),{direction:a,spacing:r}=t,{viewPlaneNormal:s,viewUp:l}=e.getCamera(),d=a.slice(0,3),c=a.slice(3,6),h=a.slice(6,9),g=Ti.R3.create();Ti.R3.cross(g,l,s);const u=Math.abs(Ti.R3.dot(g,d)),m=Math.abs(Ti.R3.dot(g,c)),f=Math.abs(Ti.R3.dot(g,h));let v;if(Math.abs(1-u)<wl)v=r[0],o=d;else if(Math.abs(1-m)<wl)v=r[1],o=c;else{if(!(Math.abs(1-f)<wl))throw new Error("No support yet for oblique plane planar contours");v=r[2],o=h}const p=Math.abs(Ti.R3.dot(l,d)),E=Math.abs(Ti.R3.dot(l,c)),w=Math.abs(Ti.R3.dot(l,h));let I;if(Math.abs(1-p)<wl)I=r[0],i=d;else if(Math.abs(1-E)<wl)I=r[1],i=c;else{if(!(Math.abs(1-w)<wl))throw new Error("No support yet for oblique plane planar contours");I=r[2],i=h}n=[v,I]}return{spacing:[n[0]/t,n[1]/t],xDir:o,yDir:i}},Cl=(e,t,n)=>Ti.K4.dist(e,t)<n,Tl=(e,t,n,o)=>{const{xDir:i,yDir:a,spacing:r}=o,s=(0,J.getEnabledElement)(e),{viewport:l}=s,d=l.canvasToWorld(t[t.length-1]),c=l.canvasToWorld(n),h=Ti.R3.create();Ti.R3.subtract(h,c,d);const g=Math.abs(Ti.R3.dot(h,i)),u=Math.abs(Ti.R3.dot(h,a)),m=Math.max(Math.floor(g/r[0]),Math.floor(u/r[0]));if(m>1){const e=t[t.length-1],o=Ti.K4.dist(e,n),i=Ti.K4.create();Ti.K4.subtract(i,n,e),Ti.K4.set(i,i[0]/o,i[1]/o);const a=o/m;for(let n=1;n<=m;n++)t.push([e[0]+a*i[0]*n,e[1]+a*i[1]*n])}else t.push(n);return m},bl=(e,t,n,o)=>{const i=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],r=i[0]*a[0]+i[1]*a[1];if(r<0)return!1;const s=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===s)return!1;const l=r/s,d=[a[0]/s,a[1]/s],c=[d[0]*l,d[1]*l],h=[t[0]+c[0],t[1]+c[1]];return!(Ti.K4.distance(e,h)>o)&&!(Ti.K4.distance(t,h)>Ti.K4.distance(t,n))};function _l(e){const t=e.length;let n=0,o=t-1;for(let i=0;i<t;i++)n+=(e[o][0]+e[i][0])*(e[o][1]-e[i][1]),o=i;return Math.abs(n/2)}var Dl=n(33394),Sl=n(21129);function Ol(e,t,n,o){const i=n-t+1,a=Math.floor(o/100*i)??1,r=Math.floor(i/a)??1;if(isNaN(i)||!i||!r)return e;if(i/r<2)return e;const s=Math.max(0,t),l=Math.min(e.length-1,n),d=e.slice(0,s),c=e.slice(l+1,e.length),h=function(e,t){if(!t||0===t.length||t.length===e.length)return e;const n=t[t.length-1]-t[0]+1,o=(0,Dl.nH)(t.map((t=>e[t][0]))),i=(0,Dl.nH)(t.map((t=>e[t][1])));if(a=e,3===a[0]?.length){const a=(0,Dl.nH)(t.map((t=>e[t][2])));return(0,Sl.$R)((0,Dl.q$)(o,n),(0,Dl.q$)(i,n),(0,Dl.q$)(a,n))}return(0,Sl.$R)((0,Dl.q$)(o,n),(0,Dl.q$)(i,n));var a}(e,function(e,t){const n=[],[o,i]=t,a=i-o+1,r=Math.floor(a/e);let s=0,l=Math.round((a-1)/(r-1)*s)+o;for(;l<=i;)n.push(l),s++,l=Math.round((a-1)/(r-1)*s)+o;return n}(r,[s,l]));return[...d,...h,...c]}function yl(e){return!0===e?.interpolation?.interpolateOnAdd||!0===e?.interpolation?.interpolateOnEdit}function xl(e,t,n){return(e+t+n)%t}function Ml(e,t,n,o){const[,i,a]=e,[,r,s]=t,l=a.length,d=s.length;let c=e[0],h=t[0];if(!(a[c]&&s[h]&&a[i]&&s[r]))return[void 0,void 0];for(;c!==i&&h!==r;){if(n(s[h],a[c]))return[c,h];c=xl(c,l,o),h=xl(h,d,o)}return[void 0,void 0]}function Rl(e,t){const[n,o]=function(e,t){for(let i=0;i<e.length;i++)for(let a=0;a<t.length;a++)if(n=e[i],o=t[a],0===rl(n,o))return[i,a];var n,o}(e,t)||[],i=(e,t)=>!1===function(e,t){return rl(e,t)<.001}(e,t),[a,r]=Ml([xl(n,e.length,1),n,e],[xl(o,t.length,1),o,t],i,1),[s]=Ml([xl(a,e.length,-1),a,e],[xl(r,t.length,-1),r,t],i,-1);return[a,s]}function Nl(e,t,n){const{interpolation:o}=e,i=t;if(o){const{knotsRatioPercentageOnAdd:e,knotsRatioPercentageOnEdit:i,interpolateOnAdd:a=!1,interpolateOnEdit:r=!1}=o,s=n?i:e;if(n?r:a){const[e,o]=n?Rl(t,n):[0,t.length-1];return t[e]&&t[o]?Ol(t,e,o,s):t}}return i}function Pl(e,t){const n=e[0],o=e[e.length-1],i=Ti.K4.create();Ti.K4.set(i,o[0]-n[0],o[1]-n[1]),Ti.K4.normalize(i,i);const a=Ti.K4.create(),r=Ti.K4.create();Ti.K4.set(a,-i[1],i[0]),Ti.K4.set(r,i[1],-i[0]);const s=[(n[0]+o[0])/2,(n[1]+o[1])/2],l={dist:0,index:null};for(let t=0;t<e.length;t++){const n=e[t],o=Ti.K4.dist(n,s);o>l.dist&&(l.dist=o,l.index=t)}return[e[l.index],s].map(t.canvasToWorld)}const{addCanvasPointsToArray:Ll,pointsAreWithinCloseContourProximity:Al,getFirstIntersectionWithPolyline:Ul,getSubPixelSpacingAndXYDirections:kl}=R;function Vl(e,t,n){this.isDrawing=!0;const o=e.detail,{currentPoints:i,element:a}=o,r=i.canvas,s=(0,J.getEnabledElement)(a),{viewport:l}=s,{spacing:d,xDir:c,yDir:h}=kl(l,this.configuration.subPixelResolution);this.drawData={canvasPoints:[r],polylineIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:c,yDir:h,movingTextBox:!1},Ke.isInteractingWithTool=!0,a.addEventListener(ne.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(ne.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(ne.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(ne.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(ne.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(ne.TOUCH_TAP,this.mouseUpDrawCallback),Tr(a)}function Hl(e){Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(ne.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(ne.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(ne.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(ne.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(ne.TOUCH_TAP,this.mouseUpDrawCallback),Cr(e)}function Wl(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,J.getEnabledElement)(o),{renderingEngine:s,viewport:l}=r,{annotation:d,viewportIdsToRender:c,xDir:h,yDir:g,spacing:u,movingTextBox:m}=this.commonData,{polylineIndex:f,canvasPoints:v}=this.drawData,p=v[v.length-1],E=l.canvasToWorld(p),w=Ti.R3.create();Ti.R3.subtract(w,i,E);const I=Math.abs(Ti.R3.dot(w,h)),C=Math.abs(Ti.R3.dot(w,g));if(!(I<=u[0]&&C<=u[1])){if(m){this.isDrawing=!1;const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.data.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else{const t=this.findCrossingIndexDuringCreate(e);if(void 0!==t)this.applyCreateOnCross(e,t);else{const e=Ll(o,v,a,this.commonData);this.drawData.polylineIndex=f+e}}xa(s,c)}}function Fl(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,o=n[0],i=n[n.length-1],a=e.detail,{element:r}=a;t&&!Al(o,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(r):this.completeDrawClosedContour(r)}function Bl(e){this.removeCrossedLinesOnCompleteDraw();const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:o}=this.commonData,i=(0,J.getEnabledElement)(e),{viewport:a,renderingEngine:r}=i;Ll(e,t,t[0],this.commonData),t.pop();const s=(yl(this.configuration)?Nl(this.configuration,t):t).map((e=>a.canvasToWorld(e)));return n.data.polyline=s,n.data.isOpenContour=!1,this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,xa(r,o),this.deactivateDraw(e),!0}function Gl(){const{canvasPoints:e}=this.drawData,t=e.length,n=[e[0],e[t-1]],o=e.slice(0,-1).slice(1),i=Ul(o,n[0],n[1],!1);if(i){const t=i[1];this.drawData.canvasPoints=e.splice(0,t)}}function $l(e){const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:o}=this.commonData,i=(0,J.getEnabledElement)(e),{viewport:a,renderingEngine:r}=i,s=(yl(this.configuration)?Nl(this.configuration,t):t).map((e=>a.canvasToWorld(e)));return n.data.polyline=s,n.data.isOpenContour=!0,n.data.handles.points=[s[0],s[s.length-1]],n.data.isOpenUShapeContour&&(n.data.openUShapeContourVectorToPeak=Pl(t,a)),this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,xa(r,o),this.deactivateDraw(e),!0}function Kl(e){const t=e.detail,{currentPoints:n,lastPoints:o}=t,i=n.canvas,a=o.canvas,{canvasPoints:r}=this.drawData,s=r.slice(0,-1),l=Ul(s,i,a,!1);if(void 0===l)return;return l[0]}function ql(e,t){const n=e.detail,{element:o}=n,{canvasPoints:i}=this.drawData,{annotation:a,viewportIdsToRender:r}=this.commonData;Ll(o,i,i[t],this.commonData),i.pop();for(let e=0;e<t;e++)i.shift();this.completeDrawClosedContour(o)&&this.activateClosedContourEdit(e,a,r)}function zl(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,o=n[0],i=n[n.length-1];t&&!Al(o,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e):this.completeDrawClosedContour(e)}function jl(e,t){const{subPixelResolution:n}=this.configuration;if(function(e,t){const n=Math.max(3*t,3);return e.length<n}(t,n)){const{annotation:t,viewportIdsToRender:n}=this.commonData,o=(0,J.getEnabledElement)(e),{renderingEngine:i}=o;return mu(t.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,xa(i,n),this.deactivateDraw(e),!0}return!1}const Zl=function(e){e.activateDraw=Vl.bind(e),e.deactivateDraw=Hl.bind(e),e.applyCreateOnCross=ql.bind(e),e.findCrossingIndexDuringCreate=Kl.bind(e),e.completeDrawOpenContour=$l.bind(e),e.removeCrossedLinesOnCompleteDraw=Gl.bind(e),e.mouseDragDrawCallback=Wl.bind(e),e.mouseUpDrawCallback=Fl.bind(e),e.completeDrawClosedContour=Bl.bind(e),e.cancelDrawing=zl.bind(e),e.haltDrawing=jl.bind(e)},{addCanvasPointsToArray:Yl,getFirstIntersectionWithPolyline:Jl}=R;function Xl(e,t){const n=e.detail,{element:o,currentPoints:i,lastPoints:a}=n,r=i.canvas,s=a.canvas,{editCanvasPoints:l,prevCanvasPoints:d}=this.editData,c=Jl(d,r,s,t);if(c)this.editData.startCrossingIndex=c[0],this.removePointsUpUntilFirstCrossing(t);else if(d.length>=2)if(l.length>this.configuration.checkCanvasEditFallbackProximity){const e=l[0],t=[];for(let n=0;n<d.length;n++){const o=d[n],i=Ti.K4.distance(o,e);t.push({distance:i,index:n})}t.sort(((e,t)=>e.distance-t.distance));const n=[t[0],t[1]],o=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=o}else{const e=Ti.K4.create();Ti.K4.subtract(e,l[1],l[0]),Ti.K4.normalize(e,e);const n=6,i=[l[0][0]-e[0]*n,l[0][1]-e[1]*n],a=Jl(d,i,l[0],t);if(a){const e=[i];Yl(o,e,l[0],this.commonData),l.unshift(...e),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=l.length-1,this.editData.startCrossingIndex=a[0]}}}function Ql(e){const{editCanvasPoints:t,prevCanvasPoints:n}=this.editData;let o=0;for(let i=0;i<t.length-1;i++){const a=[t[i],t[i+1]];if(o++,!!Jl(n,a[0],a[1],e))break}t.splice(0,o),this.editData.editIndex=t.length-1}function ed(e,t){const n=e.detail,{currentPoints:o,lastPoints:i}=n,a=o.canvas,r=i.canvas,{prevCanvasPoints:s}=this.editData;return!!Jl(s,a,r,t)}function td(e){const{prevCanvasPoints:t,editCanvasPoints:n}=this.editData;for(let o=n.length-1;o>0;o--){const i=[n[o],n[o-1]],a=!!Jl(t,i[0],i[1],e);if(n.pop(),a)break}}function nd(){const{editCanvasPoints:e,prevCanvasPoints:t,startCrossingIndex:n}=this.editData;if(void 0===n)return;const o=e[e.length-1],i=[];for(let e=0;e<t.length;e++){const n=t[e],a=Ti.K4.distance(n,o);i.push({distance:a,index:e})}i.sort(((e,t)=>e.distance-t.distance));const a=e.slice(0,-1);for(let n=0;n<i.length;n++){const{index:o}=i[n],r=t[o],s=e[e.length-1];if(!Jl(a,r,s,!1))return o}return-1}function od(e){const t=e.detail,{currentPoints:n,lastPoints:o}=t,i=n.canvas,a=o.canvas,{editCanvasPoints:r}=this.editData,s=r.slice(0,-2),l=Jl(s,i,a,!1);if(!l)return;const d=l[0],c=r.length-d;for(let e=0;e<c;e++)r.pop()}const id=function(e){e.checkForFirstCrossing=Xl.bind(e),e.removePointsUpUntilFirstCrossing=Ql.bind(e),e.checkForSecondCrossing=ed.bind(e),e.findSnapIndex=nd.bind(e),e.removePointsAfterSecondCrossing=td.bind(e),e.checkAndRemoveCrossesOnEditLine=od.bind(e)},{getSubPixelSpacingAndXYDirections:ad,addCanvasPointsToArray:rd,calculateAreaOfPoints:sd}=R;function ld(e,t,n){this.isEditingClosed=!0;const o=e.detail,{currentPoints:i,element:a}=o,r=i.canvas,s=(0,J.getEnabledElement)(a),{viewport:l}=s,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:h,yDir:g}=ad(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:h,yDir:g,movingTextBox:!1},Ke.isInteractingWithTool=!0,a.addEventListener(ne.MOUSE_UP,this.mouseUpClosedContourEditCallback),a.addEventListener(ne.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(ne.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),a.addEventListener(ne.TOUCH_END,this.mouseUpClosedContourEditCallback),a.addEventListener(ne.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(ne.TOUCH_TAP,this.mouseUpClosedContourEditCallback),Tr(a)}function dd(e){Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(ne.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(ne.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(ne.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(ne.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(ne.TOUCH_TAP,this.mouseUpClosedContourEditCallback),Cr(e)}function cd(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,J.getEnabledElement)(o),{renderingEngine:s,viewport:l}=r,{viewportIdsToRender:d,xDir:c,yDir:h,spacing:g}=this.commonData,{editIndex:u,editCanvasPoints:m,startCrossingIndex:f}=this.editData,v=m[m.length-1],p=l.canvasToWorld(v),E=Ti.R3.create();Ti.R3.subtract(E,i,p);const w=Math.abs(Ti.R3.dot(E,c)),I=Math.abs(Ti.R3.dot(E,h));if(w<=g[0]&&I<=g[1])return;void 0!==f&&this.checkAndRemoveCrossesOnEditLine(e);const C=u+rd(o,m,a,this.commonData);this.editData.editIndex=C,void 0===f&&m.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==f&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),xa(s,d)):this.finishEditAndStartNewEdit(e)}function hd(e){const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{viewport:i,renderingEngine:a}=o,{annotation:r,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>i.canvasToWorld(e)));r.data.polyline=c,r.data.isOpenContour=!1,this.triggerAnnotationModified(r,o);const h=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[h],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},xa(a,s)}function gd(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:o,snapIndex:i}=this.editData;if(void 0===o||void 0===i)return;const a=e.detail,{element:r}=a,s=[...n];let l,d;rd(r,s,t[i],this.commonData),s.length>n.length&&s.pop(),o>i?(l=i,d=o):(l=o,d=i);const c=Ti.K4.distance(t[l],s[0]),h=Ti.K4.distance(t[l],s[s.length-1]),g=Ti.K4.distance(t[d],s[0]),u=Ti.K4.distance(t[d],s[s.length-1]),m=[];for(let e=0;e<l;e++){const n=t[e];m.push([n[0],n[1]])}let f=c+u,v=h+g;if(f<v)for(let e=0;e<s.length;e++){const t=s[e];m.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];m.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];m.push([n[0],n[1]])}const p=[];for(let e=l;e<d;e++){const n=t[e];p.push([n[0],n[1]])}if(f=g+h,v=u+c,f<v)for(let e=0;e<s.length;e++){const t=s[e];p.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];p.push([t[0],t[1]])}return sd(m)>sd(p)?m:p}function ud(e){const t=e.detail,{element:n}=t;this.completeClosedContourEdit(n)}function md(e){const t=(0,J.getEnabledElement)(e),{viewport:n,renderingEngine:o}=t,{annotation:i,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(yl(this.configuration)?Nl(this.configuration,r,s):r).map((e=>n.canvasToWorld(e)));i.data.polyline=e,i.data.isOpenContour=!1,this.triggerAnnotationModified(i,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,xa(o,a),this.deactivateClosedContourEdit(e)}function fd(e){this.completeClosedContourEdit(e)}const vd=function(e){e.activateClosedContourEdit=ld.bind(e),e.deactivateClosedContourEdit=dd.bind(e),e.mouseDragClosedContourEditCallback=cd.bind(e),e.mouseUpClosedContourEditCallback=ud.bind(e),e.finishEditAndStartNewEdit=hd.bind(e),e.fuseEditPointsWithClosedContour=gd.bind(e),e.cancelClosedContourEdit=fd.bind(e),e.completeClosedContourEdit=md.bind(e)},{addCanvasPointsToArray:pd,getSubPixelSpacingAndXYDirections:Ed}=R;function wd(e,t,n){this.isEditingOpen=!0;const o=e.detail,{currentPoints:i,element:a}=o,r=i.canvas,s=(0,J.getEnabledElement)(a),{viewport:l}=s,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:h,yDir:g}=Ed(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:h,yDir:g,movingTextBox:!1},Ke.isInteractingWithTool=!0,a.addEventListener(ne.MOUSE_UP,this.mouseUpOpenContourEditCallback),a.addEventListener(ne.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(ne.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),a.addEventListener(ne.TOUCH_END,this.mouseUpOpenContourEditCallback),a.addEventListener(ne.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(ne.TOUCH_TAP,this.mouseUpOpenContourEditCallback),Tr(a)}function Id(e){Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(ne.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(ne.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(ne.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(ne.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(ne.TOUCH_TAP,this.mouseUpOpenContourEditCallback),Cr(e)}function Cd(e){const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,J.getEnabledElement)(o),{renderingEngine:s,viewport:l}=r,{viewportIdsToRender:d,xDir:c,yDir:h,spacing:g}=this.commonData,{editIndex:u,editCanvasPoints:m,startCrossingIndex:f}=this.editData,v=m[m.length-1],p=l.canvasToWorld(v),E=Ti.R3.create();Ti.R3.subtract(E,i,p);const w=Math.abs(Ti.R3.dot(E,c)),I=Math.abs(Ti.R3.dot(E,h));if(w<=g[0]&&I<=g[1])return;void 0!==f&&this.checkAndRemoveCrossesOnEditLine(e);const C=u+pd(o,m,a,this.commonData);this.editData.editIndex=C,void 0===f&&m.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==f&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),xa(s,d)}function Td(e){const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{viewport:i}=o,{annotation:a,viewportIdsToRender:r}=this.commonData,s=this.fuseEditPointsForOpenContourEndEdit().map((e=>i.canvasToWorld(e)));a.data.polyline=s,a.data.isOpenContour=!0,a.data.handles.points=[s[0],s[s.length-1]],a.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(a,o),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(e,a,r,null)}function bd(e){const t=e.detail,{currentPoints:n,lastPoints:o}=t,i=n.canvas,a=o.canvas,{snapIndex:r,prevCanvasPoints:s,startCrossingIndex:l}=this.editData;if(void 0===l||void 0===r)return!1;if(-1===r)return!0;if(0!==r&&r!==s.length-1)return!1;const d=i,c=a,h=s[r],g=Ti.K4.create(),u=Ti.K4.create();Ti.K4.set(g,d[0]-c[0],d[1]-c[1]),Ti.K4.set(u,d[0]-h[0],d[1]-h[1]);const m=Ti.K4.dot(g,u),f=Math.sqrt(g[0]*g[0]+g[1]*g[1]),v=Math.sqrt(u[0]*u[0]+u[1]*u[1]);return Math.acos(m/(f*v))<Math.PI/2}function _d(){const{snapIndex:e,prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:o}=this.editData,i=[];if(0===e)for(let e=t.length-1;e>=o;e--){const n=t[e];i.push([n[0],n[1]])}else for(let e=0;e<o;e++){const n=t[e];i.push([n[0],n[1]])}if(Ti.K4.distance(t[o],n[0])<Ti.K4.distance(t[o],n[n.length-1]))for(let e=0;e<n.length;e++){const t=n[e];i.push([t[0],t[1]])}else for(let e=n.length-1;e>=0;e--){const t=n[e];i.push([t[0],t[1]])}return i}function Dd(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:o,snapIndex:i}=this.editData;if(void 0===o||void 0===i)return;const a=e.detail,{element:r}=a,s=[...n];let l,d;pd(r,s,t[i],this.commonData),s.length>n.length&&s.pop(),o>i?(l=i,d=o):(l=o,d=i);const c=Ti.K4.distance(t[l],s[0]),h=Ti.K4.distance(t[l],s[s.length-1]),g=Ti.K4.distance(t[d],s[0]),u=Ti.K4.distance(t[d],s[s.length-1]),m=[];for(let e=0;e<l;e++){const n=t[e];m.push([n[0],n[1]])}if(c+u<h+g)for(let e=0;e<s.length;e++){const t=s[e];m.push([t[0],t[1]])}else for(let e=s.length-1;e>=0;e--){const t=s[e];m.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];m.push([n[0],n[1]])}return m}function Sd(e){const t=e.detail,{element:n}=t,o=(0,J.getEnabledElement)(n),{viewport:i,renderingEngine:a}=o,{annotation:r,viewportIdsToRender:s}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>i.canvasToWorld(e)));r.data.polyline=c,r.data.isOpenContour=!0,r.data.handles.points=[c[0],c[c.length-1]],this.triggerAnnotationModified(r,o);const h=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[h],startCrossingIndex:void 0,editIndex:0},xa(a,s)}function Od(e){const t=e.detail,{element:n}=t;this.completeOpenContourEdit(n)}function yd(e){const t=(0,J.getEnabledElement)(e),{viewport:n,renderingEngine:o}=t,{annotation:i,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(yl(this.configuration)?Nl(this.configuration,r,s):r).map((e=>n.canvasToWorld(e)));i.data.polyline=e,i.data.isOpenContour=!0,i.data.handles.points=[e[0],e[e.length-1]],i.data.isOpenUShapeContour&&(i.data.openUShapeContourVectorToPeak=Pl(r,n)),this.triggerAnnotationModified(i,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,xa(o,a),this.deactivateOpenContourEdit(e)}function xd(e){this.completeOpenContourEdit(e)}const Md=function(e){e.activateOpenContourEdit=wd.bind(e),e.deactivateOpenContourEdit=Id.bind(e),e.mouseDragOpenContourEditCallback=Cd.bind(e),e.mouseUpOpenContourEditCallback=Od.bind(e),e.fuseEditPointsWithOpenContour=Dd.bind(e),e.finishEditOpenOnSecondCrossing=Sd.bind(e),e.checkIfShouldOverwriteAnEnd=bd.bind(e),e.fuseEditPointsForOpenContourEndEdit=_d.bind(e),e.openContourEditOverwriteEnd=Td.bind(e),e.cancelOpenContourEdit=xd.bind(e),e.completeOpenContourEdit=yd.bind(e)},{getSubPixelSpacingAndXYDirections:Rd}=R;function Nd(e,t,n,o){this.isDrawing=!0;const i=e.detail,{element:a}=i,r=(0,J.getEnabledElement)(a),{viewport:s}=r,{spacing:l,xDir:d,yDir:c}=Rd(s,this.configuration.subPixelResolution),h=t.data.polyline.map(s.worldToCanvas);0===t.data.handles.activeHandleIndex&&h.reverse();let g=!1;o.worldPosition&&(g=!0),this.drawData={canvasPoints:h,polylineIndex:h.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:l,xDir:d,yDir:c,movingTextBox:g},Ke.isInteractingWithTool=!0,a.addEventListener(ne.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(ne.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(ne.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(ne.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(ne.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(ne.TOUCH_TAP,this.mouseUpDrawCallback),Tr(a)}const Pd=function(e){e.activateOpenContourEndEdit=Nd.bind(e)},{pointsAreWithinCloseContourProximity:Ld}=R;function Ad(e,t){const n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},o=this.getStyle("lineWidth",n,t),i=this.getStyle("lineDash",n,t),a=this.getStyle("color",n,t);return{color:void 0===a?void 0:a,width:void 0===o?void 0:o,lineDash:void 0===i?void 0:i,connectLastToFirst:!t.data.isOpenContour}}function Ud(e,t,n){e?.viewport?.getImageData()&&(n.data.isOpenContour?n.data.isOpenUShapeContour?(!function(e,t){t.data.openUShapeContourVectorToPeak||(t.data.openUShapeContourVectorToPeak=function(e,t){const{viewport:n}=e;return Pl(t.data.polyline.map(n.worldToCanvas),n)}(e,t))}(e,n),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n):this.renderClosedContour(e,t,n))}function kd(e,t,n){const{viewport:o}=e,i=this._getRenderingOptions(e,n),a=n.data.polyline.map((e=>o.worldToCanvas(e)));ki(t,n.annotationUID,"1",a,i)}function Vd(e,t,n){const{viewport:o}=e,i=this._getRenderingOptions(e,n),a=n.data.polyline.map((e=>o.worldToCanvas(e)));ki(t,n.annotationUID,"1",a,i);const r=n.data.handles.activeHandleIndex;if(!0===this.configuration.alwaysRenderOpenContourHandles?.enabled){const e=this.configuration.alwaysRenderOpenContourHandles.radius,o="0",s=[a[0],a[a.length-1]];0===r?s.shift():1===r&&s.pop(),Ai(t,n.annotationUID,o,s,{color:i.color,handleRadius:e})}if(null!==r){const e="1",o=a[0===r?0:a.length-1];Ai(t,n.annotationUID,e,[o],{color:i.color})}}function Hd(e,t,n){const{viewport:o}=e,{polyline:i,openUShapeContourVectorToPeak:a}=n.data;if(this.renderOpenContour(e,t,n),!a)return;const r=o.worldToCanvas(i[0]),s=o.worldToCanvas(i[i.length-1]),l=[o.worldToCanvas(a[0]),o.worldToCanvas(a[1])],d=this._getRenderingOptions(e,n);ki(t,n.annotationUID,"first-to-last",[r,s],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"}),ki(t,n.annotationUID,"midpoint-to-open-contour",[l[0],l[1]],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"})}function Wd(e,t,n){const o=this._getRenderingOptions(e,n),{allowOpenContours:i}=this.configuration,{canvasPoints:a}=this.drawData;if(o.connectLastToFirst=!1,ki(t,n.annotationUID,"1",a,o),i){const e=a[0],i=a[a.length-1];if(Ld(e,i,this.configuration.closeContourProximity))ki(t,n.annotationUID,"2",[i,e],o);else{const i="0";Ai(t,n.annotationUID,i,[e],{color:o.color,handleRadius:2})}}}function Fd(e,t,n){const{fusedCanvasPoints:o}=this.editData;if(void 0===o)return void this.renderClosedContour(e,t,n);const i=this._getRenderingOptions(e,n);ki(t,n.annotationUID,"preview-1",o,i)}function Bd(e,t,n){const{fusedCanvasPoints:o}=this.editData;if(void 0===o)return void this.renderOpenContour(e,t,n);const i=this._getRenderingOptions(e,n);ki(t,n.annotationUID,"preview-1",o,i)}const Gd=function(e){e.renderContour=Ud.bind(e),e.renderClosedContour=kd.bind(e),e.renderOpenContour=Vd.bind(e),e.renderOpenUShapedContour=Hd.bind(e),e.renderContourBeingDrawn=Wd.bind(e),e.renderClosedContourBeingEdited=Fd.bind(e),e.renderOpenContourBeingEdited=Bd.bind(e),e._getRenderingOptions=Ad.bind(e)},{pointCanProjectOnLine:$d}=R,{EPSILON:Kd}=J.CONSTANTS,qd=1-Kd;class zd extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1}}){super(e,t),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a,l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=hs(o,this.getToolName()),u=r.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h,toolName:this.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[[...i]],label:"",cachedStats:{}}};return gu(m,o),this.activateDraw(e,m,g),e.preventDefault(),xa(s,g),m},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,a=hs(i,this.getToolName());this.activateOpenContourEndEdit(e,t,a,n)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n,i=hs(o,this.getToolName());t.data.isOpenContour?this.activateOpenContourEdit(e,t,i):this.activateClosedContourEdit(e,t,i)},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,r=t.data.polyline;let s=a.worldToCanvas(r[0]);for(let e=1;e<r.length;e++){const t=s,i=a.worldToCanvas(r[e]);if(!0===$d(n,t,i,o))return!0;s=i}if(t.data.isOpenContour)return!1;const l=a.worldToCanvas(r[0]),d=a.worldToCanvas(r[r.length-1]);return!0===$d(n,l,d,o)},this.cancel=e=>{const t=this.isDrawing,n=this.isEditingOpen,o=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):o&&this.cancelClosedContourEdit(e)},this.triggerAnnotationModified=(e,t)=>{const{viewportId:n,renderingEngineId:o}=t,i=ne.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:o};(0,J.triggerEvent)(J.eventTarget,i,a)},this.triggerAnnotationCompleted=e=>{const t=ne.ANNOTATION_COMPLETED,n={annotation:e};(0,J.triggerEvent)(J.eventTarget,t,n)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,renderingEngine:i}=e,{element:a}=o,r=this.getTargetId(o);let s=hu(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const l=this.isDrawing,d=this.isEditingOpen,c=this.isEditingClosed;if(l||d||c){const o=this.commonData.annotation.annotationUID;s.forEach((n=>{if(n.annotationUID===o)if(l)this.renderContourBeingDrawn(e,t,n);else if(c)this.renderClosedContourBeingEdited(e,t,n);else{if(!d)throw new Error(`Unknown ${this.getToolName()} annotation rendering state`);this.renderOpenContourBeingEdited(e,t,n)}else this.renderContour(e,t,n)})),n=!0}else s.forEach((n=>{this.renderContour(e,t,n)}));return this.configuration.calculateStats?(s.forEach((n=>{const a=this.commonData?.annotation.annotationUID;if(n.annotationUID!==a||this.commonData?.movingTextBox){if(!this.commonData?.movingTextBox){const{data:t}=n;t.cachedStats[r]&&void 0!==t.cachedStats[r].areaUnit?n.invalidated&&this._throttledCalculateCachedStats(n,o,i,e):(t.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(n,o,i,e))}this._renderStats(n,o,e,t)}})),n):void 0},this._calculateCachedStats=(e,t,n,o)=>{const i=e.data,{cachedStats:a,polyline:r}=i,s=Object.keys(a);for(let e=0;e<s.length;e++){const o=s[e],i=this.getTargetIdImage(o,n);if(!i)continue;const{imageData:l,metadata:d,hasPixelSpacing:c}=i,h=r.map((e=>t.worldToCanvas(e))),g=_l(h),u=J.utilities.transformWorldToIndex(l,r[0]);u[0]=Math.floor(u[0]),u[1]=Math.floor(u[1]),u[2]=Math.floor(u[2]);let m=u[0],f=u[0],v=u[1],p=u[1],E=u[2],w=u[2];for(let e=1;e<r.length;e++){const t=J.utilities.transformWorldToIndex(l,r[e]);t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),m=Math.min(m,t[0]),f=Math.max(f,t[0]),v=Math.min(v,t[1]),p=Math.max(p,t[1]),E=Math.min(E,t[2]),w=Math.max(w,t[2])}const I=.01*(f-m),C=.01*(p-v),T=.01*(w-E);m=Math.floor(m-I),f=Math.ceil(f+I),v=Math.floor(v-C),p=Math.ceil(p+C),E=Math.floor(E-T),w=Math.ceil(w+T);const b=[[m,f],[v,p],[E,w]],_=l.indexToWorld([f,p,w]),D=t.worldToCanvas(_);let S=0,O=0,y=0,x=-1/0;let M=0,R=[],N=0;Na(l,((e,n)=>{let o=!0;const i=t.worldToCanvas(e);return i[1]!=M&&(N=0,M=i[1],R=gl(h,i,[D[0],i[1]]),R.sort((function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}))),R.length&&i[0]>R[0][0]&&(R.shift(),N++),N%2==0&&(o=!1),o}),(({value:e})=>{e>x&&(x=e),O+=e,y+=e**2,S+=1}),b);const P=O/S;let L=y/S-P**2;L=Math.sqrt(L),a[o]={Modality:d.Modality,area:g,mean:P,max:x,stdDev:L,areaUnit:c?"mm":"px"}}return e.invalidated=!1,a},this._renderStats=(e,t,n,o)=>{const i=e.data,a=this.getTargetId(t),r=qs(t,a),s=this.isSuvScaled(t,a,e.metadata.referencedImageId),l=this._getTextLines(i,a,r,s);if(!l||0===l.length)return;const d=i.polyline.map((e=>t.worldToCanvas(e)));if(!i.handles.textBox.hasMoved){const e=Vs(d);i.handles.textBox.worldPosition=t.canvasToWorld(e)}const c=t.worldToCanvas(i.handles.textBox.worldPosition),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},g=Gi(o,e.annotationUID??"","1",l,c,d,{},this.getLinkedTextBoxStyle(h,e)),{x:u,y:m,width:f,height:v}=g;i.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([u,m]),topRight:t.canvasToWorld([u+f,m]),bottomLeft:t.canvasToWorld([u,m+v]),bottomRight:t.canvasToWorld([u+f,m+v])}},this._getTextLines=(e,t,n,o)=>{const i=e.cachedStats[t],{area:a,mean:r,stdDev:s,max:l,isEmptyArea:d,Modality:c,areaUnit:h}=i,g=[],u=Ks(c,n,o);if(a){const e=d?"Area: Oblique not supported":`Area: ${a.toFixed(2)} ${h}²`;g.push(e)}return r&&g.push(`Mean: ${r.toFixed(2)} ${u}`),l&&g.push(`Max: ${l.toFixed(2)} ${u}`),s&&g.push(`Std Dev: ${s.toFixed(2)} ${u}`),g},Zl(this),id(this),vd(this),Md(this),Pd(this),Gd(this),this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,J.getEnabledElement)(e),{viewport:o}=n;let i;if(o instanceof J.StackViewport)i=ta(o,t);else{if(!(o instanceof J.VolumeViewport))throw new Error(`Viewport Type ${o.type} not supported`);{const e=o.getCamera(),{spacingInNormalDirection:n}=J.utilities.getTargetVolumeAndSpacingInNormalDir(o,e);i=this.filterAnnotationsWithinSlice(t,e,n)}}return i}filterAnnotationsWithinSlice(e,t,n){const{viewPlaneNormal:o}=t,i=e.filter((e=>{const t=e.metadata.viewPlaneNormal,n=Math.abs(Ti.R3.dot(o,t))>qd;return t&&n}));if(!i.length)return[];const a=n/2,{focalPoint:r}=t,s=[];for(const e of i){const t=e.data.polyline[0];if(!e.isVisible)continue;const n=Ti.R3.create();Ti.R3.sub(n,r,t);const i=Ti.R3.dot(n,o);Math.abs(i)<a&&s.push(e)}return s}}zd.toolName="PlanarFreehandROI";const jd=zd;class Zd extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:Yd,changeTextCallback:Jd,preventHandleOutsideImage:!1,arrowFirst:!0}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;Tr(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),{arrowFirst:g}=this.configuration,u=r.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{text:"",handles:{points:[[...i],[...i]],activeHandleIndex:null,arrowFirst:g,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};gu(m,o);const f=hs(o,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),xa(s,f),m},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,[s,l]=r.handles.points,d=a.worldToCanvas(s),c=a.worldToCanvas(l),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return ws([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),Tr(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{viewportId:d,renderingEngineId:c,renderingEngine:h}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),a)this.configuration.getTextCallback((e=>{if(!e)return mu(o.annotationUID),xa(h,i),this.editData=null,void(this.isDrawing=!1);o.data.text=e;const t=ne.ANNOTATION_COMPLETED,n={annotation:o};(0,J.triggerEvent)(J.eventTarget,t,n),xa(h,i)}));else{const e=ne.ANNOTATION_MODIFIED,t={annotation:o,viewportId:d,renderingEngineId:c};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;xa(d,i)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let o=hu(this.getToolName(),n);if(o=this.filterInteractableAnnotationsForElement(n,o),!o?.length)return;const i=o.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!i)return;const a=i;this.configuration.changeTextCallback(i,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback)},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_MOVE,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_MOVE,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const i=a[e],{annotationUID:s,data:l}=i,{handles:d,text:c}=l,{points:h,activeHandleIndex:g}=d;r.annotationUID=s;const u=this.getStyle("lineWidth",r,i),m=this.getStyle("lineDash",r,i),f=this.getStyle("color",r,i),v=h.map((e=>o.worldToCanvas(e)));let p;if(ge(i)||this.editData||null===g||(p=[v[g]]),p){Ai(t,s,"0",v,{color:f,lineWidth:u})}const E="1";if(this.configuration.arrowFirst?Ki(t,s,E,v[1],v[0],{color:f,width:u,lineDash:m}):Ki(t,s,E,v[0],v[1],{color:f,width:u,lineDash:m}),n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!c)continue;if(!l.handles.textBox.hasMoved){const e=v[1];l.handles.textBox.worldPosition=o.canvasToWorld(e)}const w=o.worldToCanvas(l.handles.textBox.worldPosition),I=Gi(t,s,"1",[c],w,v,{},this.getLinkedTextBoxStyle(r,i)),{x:C,y:T,width:b,height:_}=I;l.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([C,T]),topRight:o.canvasToWorld([C+b,T]),bottomLeft:o.canvasToWorld([C,T+_]),bottomRight:o.canvasToWorld([C+b,T+_])}}return n}}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=hs(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),Tr(i);const d=(0,J.getEnabledElement)(i),{renderingEngine:c}=d;xa(c,l),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;const{renderingEngine:o,viewportId:i,renderingEngineId:a}=(0,J.getEnabledElement)(e),r=hs(e,this.getToolName());xa(o,r);const s=ne.ANNOTATION_MODIFIED;(0,J.triggerEvent)(J.eventTarget,s,{annotation:t,viewportId:i,renderingEngineId:a})}_isInsideVolume(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)}}function Yd(e){return e(prompt("Enter your annotation:"))}function Jd(e,t,n){return n(prompt("Enter your annotation:"))}Zd.toolName="ArrowAnnotate";const Xd=Zd;class Qd extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;Tr(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=r.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};gu(u,o);const m=hs(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),xa(s,m),u},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,[s,l,d]=r.handles.points,c=a.worldToCanvas(s),h=a.worldToCanvas(l),g=a.worldToCanvas(d),u={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}},m={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}},f=ws([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]),v=ws([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]);return f<=o||v<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=hs(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),Tr(o);const a=(0,J.getEnabledElement)(o),{renderingEngine:r}=a;xa(r,i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;if(this.angleStartedNotYetCompleted&&2===s.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(d,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;xa(d,i)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_MOVE,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_MOVE,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),f=this.getStyle("lineDash",l,d),v=this.getStyle("color",l,d),p=g.map((e=>o.worldToCanvas(e)));let E;if(h.cachedStats[r]?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(h.cachedStats[r]={angle:null},this._calculateCachedStats(d,s,e)),ge(d)||this.editData||null===u||(E=[p[u]]),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){Ai(t,c,"0",p,{color:v,lineDash:f,lineWidth:m})}let w="1";if(Ui(t,c,w,p[0],p[1],{color:v,width:m,lineDash:f}),n=!0,3!==p.length)return n;if(w="2",Ui(t,c,w,p[1],p[2],{color:v,width:m,lineDash:f}),!h.cachedStats[r]?.angle)continue;const I=this._getTextLines(h,r);if(!h.handles.textBox.hasMoved){const e=p[1];h.handles.textBox.worldPosition=o.canvasToWorld(e)}const C=o.worldToCanvas(h.handles.textBox.worldPosition),T=Gi(t,c,"1",I,C,p,{},this.getLinkedTextBoxStyle(l,d)),{x:b,y:_,width:D,height:S}=T;h.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([b,_]),topRight:o.canvasToWorld([b+D,_]),bottomLeft:o.canvasToWorld([b,_+S]),bottomRight:o.canvasToWorld([b+D,_+S])}}return n},this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let r,s=!1;n.worldPosition?s=!0:r=a.handles.points.findIndex((e=>e===n));const l=hs(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r,movingTextBox:s},this._activateModify(i),Tr(i);const d=(0,J.getEnabledElement)(i),{renderingEngine:c}=d;xa(c,l),e.preventDefault()}_getTextLines(e,t){const n=e.cachedStats[t],{angle:o}=n;if(void 0===o)return;return[`${o.toFixed(2)} ${String.fromCharCode(176)}`]}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a}=n;if(3!==o.handles.points.length)return;const r=o.handles.points[0],s=o.handles.points[1],l=o.handles.points[2],{cachedStats:d}=o,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=Wr([r,s],[s,l]);d[t]={angle:n}}e.invalidated=!1;const h=ne.ANNOTATION_MODIFIED,g={annotation:e,viewportId:i,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,h,g),d}}Qd.toolName="Angle";const ec=Qd,tc=(...e)=>{const t=2===e[0].length?[0,0]:[0,0,0],n=e.length;for(const o of e)t[0]+=o[0]/n,t[1]+=o[1]/n,3===t.length&&(t[2]+=o[2]/n);return t},nc=tc;class oc extends da{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;Tr(o),this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(r,i,d,c),g=r.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};gu(u,o);const m=hs(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),xa(s,m),u},this.isPointNearTool=(e,t,n,o)=>{const i=(0,J.getEnabledElement)(e),{viewport:a}=i,{data:r}=t,[s,l,d,c]=r.handles.points,h=a.worldToCanvas(s),g=a.worldToCanvas(l),u=a.worldToCanvas(d),m=a.worldToCanvas(c),f={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}},v={start:{x:u[0],y:u[1]},end:{x:m[0],y:m[1]}},p=ws([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]]),E=ws([v.start.x,v.start.y],[v.end.x,v.end.y],[n[0],n[1]]);return p<=o||E<=o},this.toolSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o;t.highlighted=!0;const a=hs(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),Tr(i);const r=(0,J.getEnabledElement)(i),{renderingEngine:s}=r;xa(s,a),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:s}=o;if(a&&!r)return;if(this.angleStartedNotYetCompleted&&s.handles.points.length<4)return Cr(n),void(this.editData.handleIndex=s.handles.points.length);this.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),Cr(n);const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&mu(o.annotationUID),xa(d,i),a){const e=ne.ANNOTATION_COMPLETED,t={annotation:o};(0,J.triggerEvent)(J.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,o=e.detail,{element:i,currentPoints:a}=o,r=a.world,{data:s}=t;return 1===n?(s.handles.points[1]=r,void(this.editData.hasMoved=s.handles.points[1][0]!==s.handles.points[0][0]||s.handles.points[1][1]!==s.handles.points[0][0])):3===n?(s.handles.points[3]=r,this.editData.hasMoved=s.handles.points[3][0]!==s.handles.points[2][0]||s.handles.points[3][1]!==s.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,Tr(i),s.handles.points[2]=s.handles.points[3]=r,void(this.editData.handleIndex=s.handles.points.length-1))},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:r}=this.editData,{data:s}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=s.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const l=(0,J.getEnabledElement)(n),{renderingEngine:d}=l;xa(d,i)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),Cr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;t.highlighted=!1,i.handles.activeHandleIndex=null;const a=(0,J.getEnabledElement)(e),{renderingEngine:r}=a;if(xa(r,n),o){const e=ne.ANNOTATION_COMPLETED,n={annotation:t};(0,J.triggerEvent)(J.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._mouseUpCallback),e.addEventListener(ne.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(ne.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(ne.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=e=>{Ke.isInteractingWithTool=!0,e.addEventListener(ne.MOUSE_UP,this._mouseUpCallback),e.addEventListener(ne.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(ne.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(ne.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(ne.MOUSE_DOWN,this._mouseDownCallback)},this._deactivateDraw=e=>{Ke.isInteractingWithTool=!1,e.removeEventListener(ne.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(ne.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(ne.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(ne.MOUSE_DOWN,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=hu(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r=this.getTargetId(o),s=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const d=a[i],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),f=this.getStyle("lineDash",l,d),v=this.getStyle("color",l,d),p=g.map((e=>o.worldToCanvas(e)));let E;if(h.cachedStats[r]?d.invalidated&&this._throttledCalculateCachedStats(d,s,e):(h.cachedStats[r]={angle:null},this._calculateCachedStats(d,s,e)),ge(d)||this.editData||null===u||(E=[p[u]]),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){Ai(t,c,"0",p,{color:v,lineDash:f,lineWidth:m})}let w="1";if(Ui(t,c,w,p[0],p[1],{color:v,width:m,lineDash:f}),n=!0,p.length<4)return n;w="2",Ui(t,c,w,p[2],p[3],{color:v,width:m,lineDash:f}),w="3";if(Ui(t,c,w,nc(p[0],p[1]),nc(p[2],p[3]),{color:v,lineWidth:"1",lineDash:"1,4"}),!h.cachedStats[r]?.angle)continue;const I=this._getTextLines(h,r);if(!h.handles.textBox.hasMoved){const e=Vs(p);h.handles.textBox.worldPosition=o.canvasToWorld(e)}const C=o.worldToCanvas(h.handles.textBox.worldPosition),T=Gi(t,c,"1",I,C,p,{},this.getLinkedTextBoxStyle(l,d)),{x:b,y:_,width:D,height:S}=T;h.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([b,_]),topRight:o.canvasToWorld([b+D,_]),bottomLeft:o.canvasToWorld([b,_+S]),bottomRight:o.canvasToWorld([b+D,_+S])}}return n},this._throttledCalculateCachedStats=_a(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n,o="mouse"){const i=e.detail,{element:a}=i,{data:r}=t;t.highlighted=!0;let s,l=!1;n.worldPosition?l=!0:s=r.handles.points.findIndex((e=>e===n));const d=hs(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:s,movingTextBox:l},this._activateModify(a),Tr(a);const c=(0,J.getEnabledElement)(a),{renderingEngine:h}=c;xa(h,d),e.preventDefault()}_getTextLines(e,t){const n=e.cachedStats[t],{angle:o}=n;if(void 0===o)return;return[`${o.toFixed(2)} ${String.fromCharCode(176)}`]}_calculateCachedStats(e,t,n){const o=e.data,{viewportId:i,renderingEngineId:a}=n;if(4!==o.handles.points.length)return;const r=[null,null],s=[null,null];let l=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=Ti.R3.distance(o.handles.points[e],o.handles.points[t]);n<l&&(l=n,r[1]=o.handles.points[e],r[0]=o.handles.points[(e+1)%2],s[0]=o.handles.points[t],s[1]=o.handles.points[2+(t-1)%2])}const{cachedStats:d}=o,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=Wr(r,s);d[t]={angle:n}}e.invalidated=!1;const h=ne.ANNOTATION_MODIFIED,g={annotation:e,viewportId:i,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,h,g),d}}oc.toolName="CobbAngle";const ic=oc;class ac extends sa{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:o}=t;this._currentCursorWorldPosition=o.world,this._currentCanvasPosition=o.canvas,this._elementWithCursor=n;const i=this.getActiveAnnotation(n);return null===i?(this.createInitialAnnotation(o.world,n),!1):(this.updateAnnotationPosition(n,i),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,J.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:o,renderingEngine:i}=n;this.isDrawing=!0;const a=o.getCamera(),{viewPlaneNormal:r,viewUp:s}=a;if(!r||!s)throw new Error("Camera not found");const l=this.getReferencedImageId(o,e,r,s),d=o.getFrameOfReferenceUID(),c={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...s],FrameOfReferenceUID:d,referencedImageId:l},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if(hu(this.getToolName(),t).length>0)return null;if(null===gu(c,t))return;const h=hs(t,this.getToolName(),!1);xa(i,h)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:o,camera:i}=t,a=(0,J.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const r=o.focalPoint,s=i.viewPlaneNormal,l=i.focalPoint,d=[0,0,0];if(Pr.ZP.subtract(l,r,d),0===d.reduce(((e,t)=>e+t),0))return;const c=Pr.ZP.dot(d,s);if(Math.abs(c)<.01)return;if(!this._currentCanvasPosition)return;const h=a.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=h,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,FrameOfReferenceUID:i}=e,a=this._elementWithCursor===o.element;this.configuration.positionSync&&!a&&this.updateViewportImage(o);const{element:r}=o;let s=hu(this.getToolName(),r);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(r,s),!s?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const i=s[e],{annotationUID:r,data:d}=i,{handles:c}=d,{points:h}=c;if(!r)return n;l.annotationUID=r;const g=parseFloat(this.getStyle("lineWidth",l,i)),u=g,m=this.getStyle("lineDash",l,i),f=this.getStyle("color",l,i);if(h[0].some((e=>isNaN(e))))return n;const v=h.map((e=>o.worldToCanvas(e)));if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!Pe(r))continue;const p={upper:"upper",right:"right",lower:"lower",left:"left"},[E,w]=v[0],I=a?20:7,C=a?5:7;Ui(t,r,p.upper,[E,w-(I/2+C)],[E,w-I/2],{color:f,lineDash:m,lineWidth:u}),Ui(t,r,p.lower,[E,w+(I/2+C)],[E,w+I/2],{color:f,lineDash:m,lineWidth:u}),Ui(t,r,p.right,[E+(I/2+C),w],[E+I/2,w],{color:f,lineDash:m,lineWidth:u}),Ui(t,r,p.left,[E-(I/2+C),w],[E-I/2,w],{color:f,lineDash:m,lineWidth:u}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=ou(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&Tr(e.viewport.element)}))}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=ou(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&Cr(e.viewport.element)}))}getActiveAnnotation(e){const t=hu(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const o=hs(e,this.getToolName(),!1),i=(0,J.getEnabledElement)(e);if(!i)return;const{renderingEngine:a}=i;xa(a,o)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],o=(0,J.getEnabledElement)(e)?.viewport;if(!o)return[];const i=o.getCamera(),{viewPlaneNormal:a,focalPoint:r}=i;if(!a||!r)return[];const s=n.data?.handles?.points;if(!(s instanceof Array)||1!==s.length)return[];const l=s[0],d=J.utilities.planar.planeEquation(a,r);return J.utilities.planar.planeDistanceToPoint(d,l)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some((e=>isNaN(e))))if(e instanceof J.StackViewport){const n=J.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof J.VolumeViewport){const{focalPoint:n,viewPlaneNormal:o}=e.getCamera();if(!n||!o)return;const i=J.utilities.planar.planeEquation(o,n),a=J.utilities.planar.planeDistanceToPoint(i,t,!0);if(Math.abs(a)<.5)return;const r=Ti.R3.normalize(Ti.R3.create(),Ti.R3.fromValues(...o)),s=Ti.R3.scale(Ti.R3.create(),r,a),l=Ti.R3.add(Ti.R3.create(),Ti.R3.fromValues(...n),s);if(!0){e.setCamera({focalPoint:l});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}ac.toolName="ReferenceCursors";const rc=ac,sc=[];class lc extends sa{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData={},this._init=()=>{const e=(0,J.getRenderingEngines)()[0];if(!e)return;const t=ou(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map((e=>(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)));let{viewport:o}=n[0];const{FrameOfReferenceUID:i}=n[0];if(this.configuration.viewportId&&n.forEach((e=>{e.viewport.id==this.configuration.viewportId&&(o=e.viewport)})),!o)return;const{viewUp:a,viewPlaneNormal:r}=o.getCamera(),s=J.utilities.getViewportImageCornersInWorld(o);let l=this.editData.annotation;const d=hu(this.getToolName(),o.element);if(d.length&&(l=d.filter((e=>e.data.viewportId==o.id))[0]),sc.includes(o.id))this.editData.annotation.data.viewportId==o.id&&(this.editData.annotation.data.handles.points=s,this.editData.annotation.data.viewportId=o.id);else{const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...a],FrameOfReferenceUID:i,referencedImageId:null},data:{handles:{points:s},viewportId:o.id}};sc.push(o.id),gu(e,o.element),l=e}this.editData={viewport:o,renderingEngine:e,annotation:l}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const o=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let i;return i="top"==n||"bottom"==n?o.filter((t=>t<.6*e&&t>.2*e)):o.filter((e=>e<.6*t&&e>.2*t)),i[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,o,i)=>{let a;"bottom"==t||"top"==t?a=i[0][0]-o[0][0]:"left"!=t&&"right"!=t||(a=i[0][1]-o[0][1]);const r=[],s=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const i={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};r.push(`${n}-tick${e}`),s.push(`tick${e}`),(e+1)%5==0?l.push([[o[0][0]+i[t][0][0],o[0][1]+i[t][0][1]],[o[1][0]+i[t][0][0],o[1][1]+i[t][0][1]]]):l.push([[o[0][0]+i[t][0][0],o[0][1]+i[t][0][1]],[o[1][0]+i[t][1][0],o[1][1]+i[t][1][1]]])}return{tickIds:r,tickUIDs:s,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let o,i=Ti.R3.subtract(Ti.R3.create(),n[0],n[1]);i=Ti.R3.normalize(Ti.R3.create(),i);let a=Ti.R3.subtract(Ti.R3.create(),n[2],n[0]);a=Ti.R3.normalize(Ti.R3.create(),a);const r={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},s=Ti.R3.add(Ti.R3.create(),r[t][0],r[t][0]).map((e=>e/2)),l=e/2/Math.sqrt(Math.pow(i[0],2)+Math.pow(i[1],2)+Math.pow(i[2],2));return"top"==t||"bottom"==t?o=[Ti.R3.subtract(Ti.R3.create(),s,a.map((e=>e*l))),Ti.R3.add(Ti.R3.create(),s,a.map((e=>e*l)))]:"left"!=t&&"right"!=t||(o=[Ti.R3.add(Ti.R3.create(),s,i.map((e=>e*l))),Ti.R3.subtract(Ti.R3.create(),s,i.map((e=>e*l)))]),o},this.computeCanvasScaleCoordinates=(e,t,n,o,i)=>{let a;if("top"==i||"bottom"==i){const o=t[0][0]-t[1][0];a=[[e.width/2-o/2,n.height],[e.width/2+o/2,n.height]]}else if("left"==i||"right"==i){const n=t[0][1]-t[1][1];a=[[o.width,e.height/2-n/2],[o.width,e.height/2+n/2]]}return a},this.computeScaleBounds=(e,t,n,o)=>{const i=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),r={bottom:[-a,-i],top:[a,i],left:[a,i],right:[-a,-i]},s={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:s[o][0]+r[o][0],width:s[o][1]+r[o][1]}}}renderAnnotation(e,t){if(!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:o}=e,i=hu(this.getToolName(),o.element).filter((e=>e.data.viewportId==o.id))[0],a=e.viewport.canvas;if(!o)return false;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},s={width:a.width,height:a.height},l=i.data.handles.points[0],d=i.data.handles.points[1],c=i.data.handles.points[2],h=i.data.handles.points[3],g=[l,c,d,h],u=Ti.R3.distance(c,h),m=Ti.R3.distance(l,c),f=this.computeScaleBounds(s,.05,.05,n),v=this.computeScaleBounds(s,.05,.05,n),p=this.computeScaleSize(u,m,n),E=this.computeWorldScaleCoordinates(p,n,g).map((e=>o.worldToCanvas(e))),w=this.computeCanvasScaleCoordinates(s,E,v,f,n),I=this.computeEndScaleTicks(w,n),{annotationUID:C}=i;r.annotationUID=C;const T=this.getStyle("lineWidth",r,i),b=this.getStyle("lineDash",r,i),_=this.getStyle("color",r,i),D=this.getStyle("shadow",r,i),S=`${C}-scaleline`;Ui(t,C,"1",w[0],w[1],{color:_,width:T,lineDash:b,shadow:D},S);const O=`${C}-left`;Ui(t,C,"2",I.endTick1[0],I.endTick1[1],{color:_,width:T,lineDash:b,shadow:D},O);const y=`${C}-right`;Ui(t,C,"3",I.endTick2[0],I.endTick2[1],{color:_,width:T,lineDash:b,shadow:D},y);const x={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},M=[w[0][0]+x[n][0],w[0][1]+x[n][1]],R=this._getTextLines(p),{tickIds:N,tickUIDs:P,tickCoordinates:L}=this.computeInnerScaleTicks(p,n,C,I.endTick1,I.endTick2);for(let e=0;e<P.length;e++)Ui(t,C,P[e],L[e][0],L[e][1],{color:_,width:T,lineDash:b,shadow:D},N[e]);return Wi(t,C,"text0",R,[M[0],M[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:_}),false}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}lc.toolName="ScaleOverlay";const dc=lc,{transformWorldToIndex:cc}=J.utilities;function hc(e,t,n=!0){const{volume:o,points:i,segmentsLocked:a,segmentIndex:r,segmentationId:s,constraintFn:l}=t,{imageData:d,dimensions:c}=o,h=o.getScalarData();let g=i.map((e=>cc(d,e)));g=g.map((e=>e.map((e=>Math.round(e)))));const u=La(g,c);if(u.every((([e,t])=>e!==t)))throw new Error("Oblique segmentation tools are not supported yet");Na(d,(()=>!0),(({value:e,index:t,pointIJK:n})=>{a.includes(e)||(l?l(n)&&(h[t]=r):h[t]=r)}),u),Kn(s)}function gc(e,t){hc(0,t,!0)}const{transformWorldToIndex:uc}=J.utilities;function mc(e,t,n=!0){const{volume:o,points:i,segmentsLocked:a,segmentationId:r}=t,{imageData:s,dimensions:l}=o,d=o.getScalarData(),c=i.map((e=>uc(s,e))),h=La(c,l);if(h.every((([e,t])=>e!==t)))throw new Error("Oblique segmentation tools are not supported yet");Na(s,(()=>!0),(({value:e,index:t})=>{a.includes(e)||(d[t]=0)}),h),Kn(r)}function fc(e,t){mc(0,t,!0)}class vc extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:gc,ERASE_INSIDE:fc},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.toolGroupId,g=ai(h);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:u,segmentationId:m,type:f}=g,v=wi(m),p=di(m),E=gi(h,u,v),{representationData:w}=jn(m),{volumeId:I}=w[f],C=J.cache.getVolume(I),T={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:E},data:{handles:{points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null}}},b=hs(o,this.getToolName());return this.editData={annotation:T,segmentation:C,segmentIndex:v,segmentsLocked:p,segmentColor:E,segmentationId:m,viewportIdsToRender:b,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(s,b),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a}=this.editData,{data:r}=o,{currentPoints:s}=t,l=(0,J.getEnabledElement)(n),{worldToCanvas:d,canvasToWorld:c}=l.viewport,h=s.world,{points:g}=r.handles;let u,m,f,v,p,E,w,I;switch(g[a]=[...h],a){case 0:case 3:u=d(g[0]),v=d(g[3]),m=[v[0],u[1]],f=[u[0],v[1]],E=c(m),w=c(f),g[1]=E,g[2]=w;break;case 1:case 2:m=d(g[1]),f=d(g[2]),u=[f[0],m[1]],v=[m[0],f[1]],p=c(u),I=c(v),g[0]=p,g[3]=I}o.invalidated=!0,this.editData.hasMoved=!0;const{renderingEngine:C}=l;xa(C,i)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:i,hasMoved:a,segmentation:r,segmentationId:s,segmentIndex:l,segmentsLocked:d}=this.editData,{data:c}=o;if(i&&!a)return;c.handles.activeHandleIndex=null,this._deactivateDraw(n),Cr(n);const h=(0,J.getEnabledElement)(n),{viewport:g}=h;if(this.editData=null,this.isDrawing=!1,g instanceof J.StackViewport)throw new Error("Not implemented yet");const u={points:c.handles.points,volume:r,segmentationId:s,segmentIndex:l,segmentsLocked:d};this.applyActiveStrategy(h,u)},this._activateDraw=e=>{e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{annotation:i}=this.editData,a=i.metadata,r=i.annotationUID,s=i.data,{points:l}=s.handles,d=l.map((e=>o.worldToCanvas(e))),c=`rgb(${a.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return $i(t,r,"0",d[0],d[3],{color:c}),n=!0,n}}}vc.toolName="RectangleScissor";const pc=vc;class Ec extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:$a},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,J.getEnabledElement)(o),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.toolGroupId,u=ai(g);if(!u)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:m,segmentationId:f,type:v}=u,p=wi(f),E=di(f),w=gi(g,m,p),{representationData:I}=jn(f),{volumeId:C}=I[v],T=J.cache.getVolume(C),b={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{handles:{points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},_=[s.id];return this.editData={annotation:b,segmentation:T,centerCanvas:a,segmentIndex:p,segmentationId:f,segmentsLocked:E,segmentColor:w,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(l,_),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerCanvas:h}=this.editData,{data:g}=d,u=Math.abs(i[0]-h[0]),m=Math.abs(i[1]-h[1]),f=Math.sqrt(u*u+m*m),v=[h[0],h[1]+f],p=[h[0],h[1]-f],E=[h[0]-f,h[1]],w=[h[0]+f,h[1]];g.handles.points=[l(v),l(p),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,xa(r,c)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:i,hasMoved:a,segmentation:r,segmentIndex:s,segmentsLocked:l,segmentationId:d}=this.editData,{data:c}=o,{viewPlaneNormal:h,viewUp:g}=o.metadata;if(i&&!a)return;c.handles.activeHandleIndex=null,this._deactivateDraw(n),Cr(n);const u=(0,J.getEnabledElement)(n),{viewport:m}=u;if(this.editData=null,this.isDrawing=!1,m instanceof J.StackViewport)throw new Error("Not implemented yet");const f={points:c.handles.points,volume:r,segmentIndex:s,segmentsLocked:l,viewPlaneNormal:h,segmentationId:d,viewUp:g};this.applyActiveStrategy(u,f)},this._activateDraw=e=>{e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback),e.addEventListener(ne.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{viewportIdsToRender:i}=this.editData;if(!i.includes(o.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>o.worldToCanvas(e))),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),f=`rgb(${r.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return Pi(t,s,"0",u,m,{color:f}),n=!0,n}}}Ec.toolName="CircleScissor";const wc=Ec;class Ic extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Va},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=n.canvas,r=(0,J.getEnabledElement)(o),{viewport:s,renderingEngine:l}=r;this.isDrawing=!0;const d=s.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.toolGroupId,u=ai(g);if(!u)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:m,segmentationId:f,type:v}=u,p=wi(f),E=di(f),w=gi(g,m,p),{representationData:I}=jn(f),{volumeId:C}=I[v],T=J.cache.getVolume(C);this.isDrawing=!0;const b={metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{invalidated:!0,handles:{points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},_=[s.id];return this.editData={annotation:b,segmentation:T,centerCanvas:a,segmentIndex:p,segmentsLocked:E,segmentColor:w,segmentationId:f,toolGroupId:g,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(l,_),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas,a=(0,J.getEnabledElement)(n),{renderingEngine:r,viewport:s}=a,{canvasToWorld:l}=s,{annotation:d,viewportIdsToRender:c,centerCanvas:h}=this.editData,{data:g}=d,u=Math.abs(i[0]-h[0]),m=Math.abs(i[1]-h[1]),f=Math.sqrt(u*u+m*m),v=[h[0],h[1]+f],p=[h[0],h[1]-f],E=[h[0]-f,h[1]],w=[h[0]+f,h[1]];g.handles.points=[l(v),l(p),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,xa(r,c)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:i,hasMoved:a,segmentation:r,segmentIndex:s,segmentsLocked:l,segmentationId:d}=this.editData,{data:c}=o,{viewPlaneNormal:h,viewUp:g}=o.metadata;if(i&&!a)return;o.highlighted=!1,c.handles.activeHandleIndex=null,this._deactivateDraw(n),Cr(n);const u=(0,J.getEnabledElement)(n),{viewport:m}=u;if(this.editData=null,this.isDrawing=!1,m instanceof J.StackViewport)throw new Error("Not implemented yet");const f={points:c.handles.points,volume:r,segmentIndex:s,segmentsLocked:l,segmentationId:d,viewPlaneNormal:h,viewUp:g};this.applyActiveStrategy(u,f)},this._activateDraw=e=>{e.addEventListener(ne.MOUSE_UP,this._endCallback),e.addEventListener(ne.MOUSE_DRAG,this._dragCallback),e.addEventListener(ne.MOUSE_CLICK,this._endCallback),e.addEventListener(ne.TOUCH_END,this._endCallback),e.addEventListener(ne.TOUCH_TAP,this._endCallback),e.addEventListener(ne.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(ne.MOUSE_UP,this._endCallback),e.removeEventListener(ne.MOUSE_DRAG,this._dragCallback),e.removeEventListener(ne.MOUSE_CLICK,this._endCallback),e.removeEventListener(ne.TOUCH_END,this._endCallback),e.removeEventListener(ne.TOUCH_DRAG,this._dragCallback),e.removeEventListener(ne.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{viewportIdsToRender:i}=this.editData;if(!i.includes(o.id))return n;const{annotation:a}=this.editData,r=a.metadata,s=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>o.worldToCanvas(e))),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),f=`rgb(${r.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return Pi(t,s,"0",u,m,{color:f}),n=!0,n}}}Ic.toolName="SphereScissor";const Cc=Ic;class Tc extends tl{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getTargetId(r);let g,u;if(r instanceof J.StackViewport)g=h.split("imageId:")[1];else{u=h.split("volumeId:")[1];const e=J.cache.getVolume(u);g=J.utilities.getClosestImageId(e,i,d)}const m=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:m,referencedImageId:g,toolName:this.getToolName(),volumeId:u},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},segmentationId:null}};gu(f,o);const v=hs(o,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:v,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(s,v),f},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,renderingEngineId:i}=e,{element:a}=o;let r=hu(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){const a=r[e],{annotationUID:l,data:d}=a,{points:c,activeHandleIndex:h}=d.handles,g=c.map((e=>o.worldToCanvas(e)));s.annotationUID=l;const u=this.getStyle("lineWidth",s,a),m=this.getStyle("lineDash",s,a),f=this.getStyle("color",s,a);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const v=ne.ANNOTATION_MODIFIED,p={annotation:a,viewportId:o.id,renderingEngineId:i};let E;if((0,J.triggerEvent)(J.eventTarget,v,p),!Pe(l))continue;if(ge(a)||this.editData||null===h||(E=[g[h]]),E){Ai(t,l,"0",E,{color:f})}$i(t,l,"0",g[0],g[3],{color:f,lineDash:m,lineWidth:u}),n=!0}return n}}}Tc.toolName="RectangleROIThreshold";const bc=Tc,{transformWorldToIndex:_c}=J.utilities;class Dc extends tl{constructor(e={},t={configuration:{numSlicesToPropagate:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r,renderingEngine:s}=a;this.isDrawing=!0;const l=r.getCamera(),{viewPlaneNormal:d,viewUp:c}=l;let h,g,u;if(r instanceof J.StackViewport)throw new Error("Stack Viewport Not implemented");u=this.getTargetId(r).split("volumeId:")[1],g=J.cache.getVolume(u),h=J.utilities.getClosestImageId(g,i,d);if(!h)throw new Error("This tool does not work on non-acquisition planes");const m=r.getCurrentImageIdIndex(),f=J.utilities.getSpacingInNormalDirection(g,d),v=this._getEndSliceIndex(g,i,f,d),p=r.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:p,referencedImageId:h,toolName:this.getToolName(),volumeId:u,spacingInNormal:f},data:{label:"",startSlice:m,endSlice:v,cachedStats:{projectionPoints:[],projectionPointsImageIds:[h]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...i],[...i],[...i],[...i]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(E,g),gu(E,o);const w=hs(o,this.getToolName());return this.editData={annotation:E,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),Tr(o),e.preventDefault(),xa(s,w),E},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,i=hu(this.getToolName(),o.element);if(!i?.length)return n;const a=o.getCurrentImageIdIndex(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<i.length;s++){const l=i[s],{annotationUID:d,data:c}=l,{startSlice:h,endSlice:g}=c,{points:u,activeHandleIndex:m}=c.handles,f=u.map((e=>o.worldToCanvas(e)));r.annotationUID=d;const v=this.getStyle("lineWidth",r,l),p=this.getStyle("lineDash",r,l),E=this.getStyle("color",r,l);if(a<Math.min(h,g)||a>Math.max(h,g))continue;l.invalidated&&this._throttledCalculateCachedStats(l,e);let w,I=!1;if(a!==h&&a!==g||(I=!0),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!Pe(d))continue;if(ge(l)||this.editData||null===m||!I||(w=[f[m]]),w){Ai(t,d,"0",w,{color:E})}let C=p;I||(C=2);$i(t,d,"0",f[0],f[3],{color:E,lineDash:C,lineWidth:v}),n=!0}return n},this._throttledCalculateCachedStats=_a(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:o}=e,{viewPlaneNormal:i,spacingInNormal:a}=o,{imageData:r}=t,{startSlice:s,endSlice:l}=n,{points:d}=n.handles,c=_c(r,d[0]);if(c[2]!==s)throw new Error("Start slice does not match");const h=Ti.R3.fromValues(c[0],c[1],l),g=Ti.R3.create();r.indexToWorldVec3(c,g);const u=Ti.R3.create();r.indexToWorldVec3(h,u);const m=Ti.R3.distance(g,u),f=[];for(let e=0;e<m;e+=a)f.push(d.map((t=>{const n=Ti.R3.create();return Ti.R3.scaleAndAdd(n,t,i,e),Array.from(n)})));n.cachedStats.projectionPoints=f;const v=[];for(const e of f){const n=J.utilities.getClosestImageId(t,e[0],i);v.push(n)}n.cachedStats.projectionPointsImageIds=v}_calculateCachedStatsTool(e,t){const n=e.data,{viewportId:o,renderingEngineId:i,viewport:a}=t,{cachedStats:r}=n,s=this.getTargetId(a),l=J.cache.getVolume(s.split("volumeId:")[1]);this._computeProjectionPoints(e,l),e.invalidated=!1;const d=ne.ANNOTATION_MODIFIED,c={annotation:e,viewportId:o,renderingEngineId:i};return(0,J.triggerEvent)(J.eventTarget,d,c),r}_getEndSliceIndex(e,t,n,o){const i=this.configuration.numSlicesToPropagate,a=Ti.R3.create();Ti.R3.scaleAndAdd(a,t,o,i*n);const r=n/2,{imageIds:s}=e;let l;for(let e=0;e<s.length;e++){const t=s[e],{imagePositionPatient:n}=J.metaData.get("imagePlaneModule",t),i=Ti.R3.create();Ti.R3.sub(i,a,n);const d=Ti.R3.dot(i,o);Math.abs(d)<r&&(l=e)}return l}}Dc.toolName="RectangleROIStartEndThreshold";const Sc=Dc;function Oc(e,t){return e===t}function yc(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}const xc=function(e,t,n={}){const o=n.onFlood,i=n.onBoundary,a=n.equals||Oc,r=n.diagonals||!1,s=m(t),l=function(){const e=function(e){const t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))};for(let o=0;o<Math.pow(3,e);o+=1){const i=yc(o.toString(3),"0",e);t.push(n(i))}return t}(t.length);return e.filter((function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||r)}))}(),d=[],c=[],h={},g={};for(d.push({currentArgs:t});d.length>0;)u(d.pop());return{flooded:c,boundaries:function(){const e=[];for(const t in g)void 0!==g[t]&&e.unshift(g[t]);return e}()};function u(e){const t=e.currentArgs,n=e.previousArgs;!0!==h[t]&&(!function(e){h[e]=!0}(t),function(e){const t=f(m,[e]);return f(a,[t,s])}(t)?(function(e){c.push(e),o&&o(...e)}(t),function(e){for(let t=0;t<l.length;t+=1){const n=l[t],o=e.slice(0);for(let t=0;t<e.length;t+=1)o[t]+=n[t];d.push({currentArgs:o,previousArgs:e})}}(t)):function(e){g[e]=e,i&&i(...e)}(n))}function m(t){return e(...t)}function f(e,t){try{return e(...t)}catch(e){return}}},{transformWorldToIndex:Mc,isEqual:Rc}=J.utilities;class Nc extends Ci{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,a=(0,J.getEnabledElement)(o),{viewport:r}=a,s=r.getCamera(),{viewPlaneNormal:l}=s,d=ai(this.toolGroupId);if(!d)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:c,type:h}=d,g=wi(c),u=di(c),{representationData:m}=jn(c),{volumeId:f}=m[h],v=J.cache.getVolume(f),{dimensions:p,direction:E}=v,w=v.getScalarData(),I=Mc(v.imageData,i),C=this.getFixedDimension(l,E);if(void 0===C)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:T,getLabelValue:b,getScalarDataPositionFromPlane:_,inPlaneSeedPoint:D,fixedDimensionValue:S}=this.generateHelpers(w,p,I,C);if(I[0]<0||I[0]>=p[0]||I[1]<0||I[1]>=p[1]||I[2]<0||I[2]>=p[2])return;const O=b(I[0],I[1],I[2]);if(u.includes(O))return;const y=xc(T,D),{flooded:x}=y;x.forEach((e=>{const t=_(e[0],e[1]);w[t]=g}));return Kn(c,this.getFramesModified(C,S,y)),!0},this.getFramesModified=(e,t,n)=>{const{boundaries:o}=n;if(2===e)return[t];let i=1/0,a=-1/0;for(let e=0;e<o.length;e++){const t=o[e][1];t<i&&(i=t),t>a&&(a=t)}const r=[];for(let e=i;e<=a;e++)r.push(e);return r},this.generateHelpers=(e,t,n,o=2)=>{let i,a;switch(o){case 0:i=n[0],a=[n[1],n[2]];break;case 1:i=n[1],a=[n[0],n[2]];break;case 2:i=n[2],a=[n[0],n[1]];break;default:throw new Error(`Invalid fixedDimension: ${o}`)}const r=(e,n,o)=>o*t[1]*t[0]+n*t[0]+e,s=(t,n,o)=>e[r(t,n,o)],l=this.generateFloodFillGetter(t,o,i,s);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane(r,o,i),getLabelValue:s,floodFillGetter:l,inPlaneSeedPoint:a,fixedDimensionValue:i}},this.generateFloodFillGetter=(e,t,n,o)=>{let i;switch(t){case 0:i=(t,i)=>{if(!(t>=e[1]||t<0||i>=e[2]||i<0))return o(n,t,i)};break;case 1:i=(t,i)=>{if(!(t>=e[0]||t<0||i>=e[2]||i<0))return o(t,n,i)};break;case 2:i=(t,i)=>{if(!(t>=e[0]||t<0||i>=e[1]||i<0))return o(t,i,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let o;switch(t){case 0:o=(t,o)=>e(n,t,o);break;case 1:o=(t,o)=>e(t,n,o);break;case 2:o=(t,o)=>e(t,o,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return o}}getFixedDimension(e,t){const n=t.slice(0,3),o=t.slice(3,6),i=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(Rc(a,r))return 0;const s=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];if(Rc(a,s))return 1;const l=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];return Rc(a,l)?2:void 0}}Nc.toolName="PaintFill";const Pc=Nc;const Lc=function(e,t,n={}){const o=[];return e.forEach((e=>{const{data:i}=e,{points:a}=i.handles,{imageData:r,dimensions:s}=t;let l=a;if(i.cachedStats?.projectionPoints){const{projectionPoints:e}=i.cachedStats;l=[].concat(...e)}const d=l.map((e=>J.utilities.transformWorldToIndex(r,e)));let c=La(d,s);n.numSlicesToProject&&!i.cachedStats?.projectionPoints&&(c=Pa(c,n.numSlicesToProject)),o.push(c)})),1===o.length?o[0]:o.reduce(((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)})),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})};const Ac=function(e,t,n,o){const i=e.map((e=>fu(e)));let a;!function(e){const t=[bc.toolName,Sc.toolName];for(const n of e){const e=n.metadata.toolName;if(!t.includes(e))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}(i);for(let e=0;e<n.length;e++){n[e].volume.getScalarData().length!==t.getScalarData().length&&0!==e||(a=Lc(i,n[e].volume,o))}return Mr(t,n,{...o,boundsIJK:a})};const Uc=function(e,t=1,n="mergedLabelmap"){e.forEach((({direction:t,dimensions:n,origin:o,spacing:i})=>{if(!(J.utilities.isEqual(n,e[0].dimensions)&&J.utilities.isEqual(t,e[0].direction)&&J.utilities.isEqual(i,e[0].spacing)&&J.utilities.isEqual(o,e[0].origin)))throw new Error("labelmaps must have the same size and shape")}));const o=e[0],i=new(0,o.getScalarData().constructor)(o.getScalarData().length);e.forEach((e=>{const n=e.getScalarData();for(let e=0;e<n.length;e++)n[e]===t&&(i[e]=t)}));const a={scalarData:i,metadata:o.metadata,spacing:o.spacing,origin:o.origin,direction:o.direction,dimensions:o.dimensions};return J.volumeLoader.createLocalVolume(a,n,!0)};function kc(e,t){if(e===ie.Labelmap)return function(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}(t);throw new Error(`Unknown representation type: ${e}`)}function Vc(e){const{type:t}=e;if(t===ie.Labelmap)return Un();throw new Error(`Unknown representation type: ${t}`)}async function Hc(e){const{viewportId:t,renderingEngineId:n,options:o}=e;let{segmentationId:i}=e;const a=(0,J.getEnabledElementByIds)(t,n);if(!a)throw new Error("element disabled");const{viewport:r}=a;if(!(r instanceof J.VolumeViewport))throw new Error("Segmentation only supports VolumeViewport");const{uid:s}=r.getDefaultActor();if(void 0===i&&(i=`${s}-based-segmentation-${o?.volumeId??J.utilities.uuidv4().slice(0,8)}`),o){const e=(0,re._cloneDeep)(o);await J.volumeLoader.createLocalVolume(e,i)}else{const{uid:e}=r.getDefaultActor();await J.volumeLoader.createAndCacheDerivedVolume(e,{volumeId:i})}return i}function Wc(e,t){const n=ou(e);if(void 0===n)return;Sr(e).forEach((e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()}));const o=n.getViewportsInfo(),i=Object.keys(o).map((e=>o[e]));if(!i.length)return;const{renderingEngineId:a}=i[0],r=n.getViewportIds(),s=(0,J.getRenderingEngine)(a);xa(s,r)}function Fc(e){const t=ou(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const o=Sr(e)[0];return o?o.configuration.brushSize:void 0}function Bc(e,t){const n=ou(e);if(void 0===n)return;Sr(e).forEach((e=>{e.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold=t}));const o=n.getViewportsInfo();if(!o.length)return;const{renderingEngineId:i}=o[0],a=n.getViewportIds(),r=(0,J.getRenderingEngine)(i);xa(r,a)}function Gc(e){const t=ou(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const o=Sr(e)[0];return o?o.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold:void 0}const $c=function(e,t,n,o){const i=e.getScalarData(),{baseVolumeIdx:a,volumeInfoList:r}=xr(e,n);return r.forEach((e=>{const{volumeSize:n}=e;n===i.length?function(e,t,n){const{referenceValues:o,lower:i,upper:a}=n;for(let n=0;n<e.length;n++)if(e[n]===t){const r=o[n];e[n]=r>=i&&r<=a?t:0}}(i,t,e):function(e,t,n,o,i,a){const{imageData:r,lower:s,upper:l,dimensions:d}=n;let c,h,g;for(let n=0;n<e.length;n++)if(e[n]===t){const u=yr(r,d,o[i].spacing,o[i].imageData.getPoint(n)),m=({value:e})=>{c+=1,e>=g.lower&&e<=g.upper&&(h+=1)};c=0,h=0,g={lower:s,upper:l};let f=!1;Na(r,(()=>!0),m,u),f=0===a?h>0:h===c,e[n]=f?t:0}}(i,t,e,r,a,o)})),Kn(e.volumeId),e};function Kc(e){let t="";const n=e[0]<0?"R":"L",o=e[1]<0?"A":"P",i=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=1e-4;for(let e=0;e<3;e++)if(a[0]>r&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>r&&a[1]>a[0]&&a[1]>a[2])t+=o,a[1]=0;else if(a[2]>r&&a[2]>a[0]&&a[2]>a[1])t+=i,a[2]=0;else if(a[0]>r&&a[1]>r&&a[0]===a[1])t+=n+o,a[0]=0,a[1]=0;else if(a[0]>r&&a[2]>r&&a[0]===a[2])t+=n+i,a[0]=0,a[2]=0;else{if(!(a[1]>r&&a[2]>r&&a[1]===a[2]))break;t+=o+i,a[1]=0,a[2]=0}return t}function qc(e){let t=e.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}var zc;!function(e){e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"}(zc||(zc={}));const jc=zc,Zc={};function Yc(e,t){const n=(0,J.getEnabledElement)(e),{viewportId:o}=n;Zc[o]=t}function Jc(e){const t=(0,J.getEnabledElement)(e),{viewportId:n}=t;return Zc[n]}const{triggerEvent:Xc}=J.utilities,Qc=!0,eh=!0,th=new Map;function nh(e,t){let n,o;if(void 0===e)throw new Error("playClip: element must not be undefined");const i=(0,J.getEnabledElement)(e);if(!i)throw new Error("playClip: element must be a valid Cornerstone enabled element");t.dynamicCineEnabled=t.dynamicCineEnabled??!0;const{viewport:a}=i,r=rh(a),s=function(e,t){if(e instanceof J.StackViewport)return function(e){const t=e.getImageIds();return{get numScrollSteps(){return t.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},scroll(t){Ma(e,{delta:t,debounceLoading:Qc})}}}(e);if(e instanceof J.VolumeViewport){const n=rh(e);return t.dynamicCineEnabled&&n?.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numTimePoints},get currentStepIndex(){return e.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll(t){e.timePointIndex+=t}}}(n):function(e,t){const{volumeId:n}=t,o={viewPlaneNormal:Ti.R3.create(),scrollInfo:null},i=()=>{const t=e.getCamera();if(!o.scrollInfo||!Ti.R3.equals(t.viewPlaneNormal,o.viewPlaneNormal)){const i=J.utilities.getVolumeViewportScrollInfo(e,n);o.viewPlaneNormal=t.viewPlaneNormal,o.scrollInfo=i}return o.scrollInfo};return{get numScrollSteps(){return i().numScrollSteps},get currentStepIndex(){return i().currentStepIndex},get frameTimeVectorEnabled(){const n=e.getCamera(),o=t.direction.slice(6,9).map((e=>-e)),i=Ti.R3.dot(o,n.viewPlaneNormal);return Ti.DV.equals(i,1)},scroll(t){i().currentStepIndex+=t,Ma(e,{delta:t})}}}(e,n)}throw new Error("Unknown viewport type")}(a,t);let l=Jc(e);const d=t.dynamicCineEnabled&&r?.isDynamicVolume();if(d&&ah(e),l?ih(e,d):(l={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:t.frameTimeVector??void 0,speed:t.frameTimeVectorSpeedMultiplier??1,reverse:t.reverse??!1,loop:t.loop??!0},Yc(e,l)),l.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(l.framesPerSecond=Number(t.framesPerSecond),l.reverse=l.framesPerSecond<0,l.ignoreFrameTimeVector=!0),!0!==l.ignoreFrameTimeVector&&l.frameTimeVector&&l.frameTimeVector.length===s.numScrollSteps&&s.frameTimeVectorEnabled){const{timeouts:e,isTimeVarying:t}=function(e,t){let n,o,i,a=0;const r=e.length,s=[];let l=!1;("number"!=typeof t||t<=0)&&(t=1);for(n=1;n<r;n++)i=Number(e[n])/t|0,s.push(i),1===n?o=i:i!==o&&(l=!0),a+=i;s.length>0&&(i=l?a/s.length|0:s[0],s.push(i));return{timeouts:s,isTimeVarying:l}}(l.frameTimeVector,l.speed);n=e,o=t}const c=()=>{const{numScrollSteps:t,currentStepIndex:n}=s;let o=n+(l.reverse?-1:1);if(!eh&&(o<0||o>=t)){ih(e,d);const t={element:e};return void Xc(e,jc.CLIP_STOPPED,t)}o>=t?o=0:o<0&&(o=t-1);const i=o-n;i&&s.scroll(i)};d&&th.set(r.volumeId,e),n&&n.length>0&&o?(l.usingFrameTimeVector=!0,l.intervalId=window.setTimeout((function e(){l.intervalId=window.setTimeout(e,n[s.currentStepIndex]),c()}),0)):(l.usingFrameTimeVector=!1,l.intervalId=window.setInterval(c,1e3/Math.abs(l.framesPerSecond)));const h={element:e};Xc(e,jc.CLIP_STARTED,h)}function oh(e){ih(e,!0)}function ih(e,t){const n=(0,J.getEnabledElement)(e);if(!n)return;const{viewport:o}=n,i=Jc(o.element);i&&function(e){const t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}(i),t&&o instanceof J.BaseVolumeViewport&&ah(e)}function ah(e){const{viewport:t}=(0,J.getEnabledElement)(e),n=rh(t);if(n?.isDynamicVolume()){const t=th.get(n.volumeId);th.delete(n.volumeId),t&&t!==e&&oh(t)}}function rh(e){const t=function(e){return e.getActors().map((e=>J.cache.getVolume(e.uid))).filter((e=>!!e))}(e);return t.find((e=>e.isDynamicVolume()))??t[0]}function sh(e,t,n){if(function(e,t,n){if(!t?.data?.polyline||n<=0)return!0;if(!e.viewport)return!0;const{renderingEngineId:o,viewportId:i,FrameOfReferenceUID:a}=e,r=Ng(i,o);if(t.metadata.FrameOfReferenceUID!==a)return!0;if(!r)return!0;const s=r.getToolInstance(t.metadata.toolName);return!(s instanceof jd)||s.isDrawing||s.isEditingOpen||s.isEditingClosed}(e,t,n))return!1;const{viewport:o}=e,i=t.data.polyline.map(o.worldToCanvas),a=Ol(i,0,i.length,n);return a!==i&&(t.data.polyline=a.map(o.canvasToWorld),!0)}const lh={interpolateAnnotation:sh},dh={};function ch(e){const t=(0,J.getEnabledElement)(e),{viewportId:n}=t;return dh[n]}const hh=J.Enums.RequestType.Prefetch,gh=0;let uh,mh={maxImagesToPrefetch:1/0,preserveExistingPool:!1};const fh=10;function vh(e,t){e=Math.round(e)||0;const n=[];let o=(t=Math.round(t)||0)-e+1;if(o<=0)return n;for(;o--;)n[o]=t--;return n}function ph(e){const t=(0,J.getEnabledElement)(e);if(!t)throw new Error("stackPrefetch: element must be a valid Cornerstone enabled element");const{viewport:n}=t;if(!(n instanceof J.StackViewport))throw new Error("stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented");return{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}}function Eh(e){const t=ch(e);if(!t)return;const n=t||{},o=ph(e);if(!o||!o.imageIds||0===o.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");if(n.indicesToRequest&&n.indicesToRequest.length||(n.enabled=!1),!1===n.enabled)return;function i(e){const t=n.indicesToRequest.indexOf(e);t>-1&&n.indicesToRequest.splice(t,1)}t.indicesToRequest.sort(((e,t)=>e-t));if(n.indicesToRequest.slice().forEach((function(e){const t=o.imageIds[e];if(!t)return;J.cache.getImageLoadObject(t)&&i(e)})),!n.indicesToRequest.length)return;mh.preserveExistingPool||J.imageLoadPoolManager.clearRequestStack(hh);const a=function(e,t){let n=0,o=e.length-1;return e.forEach(((e,i)=>{e<t?n=Math.max(i,n):e>t&&(o=Math.min(i,o))})),{low:n,high:o}}(n.indicesToRequest,o.currentImageIdIndex);let r,s;let l=a.low,d=a.high;const c=[];for(;l>=0||d<n.indicesToRequest.length;){const e=o.currentImageIdIndex,t=!(e-n.indicesToRequest[l]>mh.maxImagesToPrefetch)&&l>=0,i=!(n.indicesToRequest[d]-e>mh.maxImagesToPrefetch)&&d<n.indicesToRequest.length;if(!i&&!t)break;t&&(s=n.indicesToRequest[l--],r=o.imageIds[s],c.push(r)),i&&(s=n.indicesToRequest[d++],r=o.imageIds[s],c.push(r))}const h=(e,t)=>J.imageLoader.loadAndCacheImage(e,t),{useNorm16Texture:g}=(0,J.getConfiguration)().rendering;c.forEach((e=>{const t={targetBuffer:{type:g?void 0:"Float32Array"},preScale:{enabled:!0},requestType:hh};J.imageLoadPoolManager.addRequest(h.bind(null,e,t),hh,{imageId:e},gh)}))}function wh(e){return function(t){const n=t.detail;let o;try{o=ph(e)}catch(e){return}if(!o||!o.imageIds||0===o.imageIds.length)return;const i=o.imageIds.indexOf(n.imageId);if(i<0)return;const a=ch(e);a&&a.data&&a.data.length&&a.indicesToRequest.push(i)}}function Ih(e){clearTimeout(uh),uh=setTimeout((function(){const t=e.target;try{Eh(t)}catch(e){return}}),fh)}function Ch(e){const t=ph(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n={indicesToRequest:vh(0,t.imageIds.length-1),enabled:!0,direction:1},o=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(o,1),function(e,t){const n=(0,J.getEnabledElement)(e),{viewportId:o}=n;dh[o]=t}(e,n),Eh(e),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,Ih),e.addEventListener(J.Enums.Events.STACK_NEW_IMAGE,Ih);const i=wh(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,i),J.eventTarget.addEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,i)}function Th(e){clearTimeout(uh),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,Ih);const t=wh(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=ch(e);n&&n.data.length&&(n.enabled=!1,J.imageLoadPoolManager.clearRequestStack(hh))}function bh(){return mh}function _h(e){mh=e}const Dh=function(e,t){const n=t.frameNumbers||[...Array(e.numTimePoints).keys()];if(!t.maskVolumeId&&!t.imageCoordinate)throw new Error("No ROI provided");if(t.maskVolumeId&&t.imageCoordinate)throw new Error("Please provide only one ROI");if(t.maskVolumeId){const o=J.cache.getVolume(t.maskVolumeId),i=function(e,t,n){const o=n.getScalarDataArrays(),i=[];for(let n=0;n<t.length;n++){const a=[];e.forEach((e=>{const i=o[e];a.push(i[t[n]])})),i.push(a)}return i}(n,o.getScalarData().map(((e,t)=>t)).filter((e=>0!==o.getScalarData()[e])),e);return i}if(t.imageCoordinate){const o=function(e,t,n){const{dimensions:o,imageData:i}=n,a=i.worldToIndex(t);if(a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),!J.utilities.indexWithinDimensions(a,o))throw new Error("outside bounds");const r=o[0],s=o[0]*o[1],l=n.getScalarDataArrays(),d=[];return e.forEach((e=>{const t=l[e],n=a[2]*s+a[1]*r+a[0];d.push(t[n])})),d}(n,t.imageCoordinate,e);return o}};const Sh=function(e,t,n){const o=n||[...Array(e.numTimePoints).keys()],i=o.length;if(o.length<=1)throw new Error("Please provide two or more time points");const a=e.getScalarDataArrays(),r=a[0].length,s=new Float32Array(r);if(t===J.Enums.DynamicOperatorType.SUM){for(let e=0;e<i;e++){const t=a[o[e]];for(let e=0;e<r;e++)s[e]+=t[e]}return s}if(t===J.Enums.DynamicOperatorType.SUBTRACT){if(o.length>2)throw new Error("Please provide only 2 time points for subtraction.");for(let e=0;e<r;e++)s[e]+=a[o[0]][e]-a[o[1]][e];return s}if(t===J.Enums.DynamicOperatorType.AVERAGE){for(let e=0;e<i;e++){const t=a[o[e]];for(let e=0;e<r;e++)s[e]+=t[e]}for(let e=0;e<r;e++)s[e]=s[e]/i;return s}};const Oh=function(e){if(!e.detail.removed.length)return;(0,J.getRenderingEngines)().forEach((e=>{const t=e.getViewports().map((e=>e.id));xa(e,t)}))};const yh=function(e){const{viewportId:t,renderingEngineId:n}=e.detail,o=(0,J.getRenderingEngine)(n);xa(o,[t])},xh=function(e){Ji(e.detail.element)},Mh={enable:function(e){e.addEventListener(J.Enums.Events.IMAGE_RENDERED,xh)},disable:function(e){e.removeEventListener(J.Enums.Events.IMAGE_RENDERED,xh)}},{Active:Rh}=X;function Nh(e,t,n){if(Ke.isInteractingWithTool)return!1;const{renderingEngineId:o,viewportId:i}=n.detail,a=Ng(i,o);if(!a)return!1;let r;const s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const n=s[e],o=a.toolOptions[n],i=a.getToolInstance(n);if(o.mode===Rh&&"function"==typeof i[t]){r=a.getToolInstance(n);break}}r&&r[t](n)}const Ph=Nh.bind(null,"Mouse","mouseClickCallback"),Lh=Nh.bind(null,"Mouse","doubleClickCallback");function Ah(e,t,n,o="mouse"){const i="touch"===o?36:6,a=[];return t.forEach((({tool:t,annotations:o})=>{for(const r of o){if(r.isLocked||!r.isVisible)continue;const o=t.getHandleNearImagePoint(e,r,n,i);if(o){a.push({tool:t,annotation:r,handle:o});break}}})),a}function Uh(e,t){const n=[];for(let o=0;o<t.length;o++){const i=t[o];if(!i){console.warn("undefined tool in filterToolsWithAnnotationsForElement");continue}let a=hu(i.constructor.toolName,e);a?.length&&("function"==typeof i.filterInteractableAnnotationsForElement&&(a=i.filterInteractableAnnotationsForElement(e,a)),a.length>0&&n.push({tool:i,annotations:a}))}return n}function kh(e,t,n,o="mouse"){const i="touch"===o?36:6,a=[];return t.forEach((({tool:t,annotations:r})=>{for(const s of r){if(s.isLocked||!s.isVisible)continue;if(t.isPointNearTool(e,s,n,i,o)){a.push({tool:t,annotation:s});break}}})),a}const Vh=e=>e.shiftKey?e.ctrlKey?Z.ShiftCtrl:e.altKey?Z.ShiftAlt:e.metaKey?Z.ShiftMeta:Z.Shift:e.ctrlKey?e.altKey?Z.CtrlAlt:e.metaKey?Z.CtrlMeta:Z.Ctrl:e.altKey?e.metaKey&&Z.AltMeta||Z.Alt:e.metaKey?Z.Meta:void 0,{Active:Hh}=X;function Wh(e){const{renderingEngineId:t,viewportId:n}=e.detail,o=e.detail.event,i=Vh(o)||xn.getModifierKey(),a=Ng(n,t);if(!a)return null;const r=Object.keys(a.toolOptions),s=a.getDefaultMousePrimary();for(let e=0;e<r.length;e++){const t=r[e],n=a.toolOptions[t],l=n.bindings.length&&n.bindings.some((e=>e.mouseButton===(o?o.buttons:s)&&e.modifierKey===i));if(n.mode===Hh&&l)return a.getToolInstance(t)}}function Fh(e,t,n){const{renderingEngineId:o,viewportId:i}=e.detail,a=Ng(i,o);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const o=s[e],i=a.toolOptions[o],l=null!=n&&i.bindings.length&&i.bindings.some((e=>e.mouseButton===n));if(t.includes(i.mode)&&(!n||l)){const e=a.getToolInstance(o);r.push(e)}}return r}const{Active:Bh,Passive:Gh}=X;function $h(e){if(Ke.isInteractingWithTool)return;const t=Wh(e);if(t&&"function"==typeof t.preMouseDownCallback){if(t.preMouseDownCallback(e))return}const n=1===e.detail.event.buttons,o=[...Fh(e,[Bh],e.detail.event.buttons)||[],...(n?Fh(e,[Gh]):void 0)||[]],i=e.detail,{element:a}=i,r=Uh(a,o),s=i.currentPoints.canvas,l=Ah(a,r,s,"mouse"),d=!!e.detail.event.shiftKey;if(l.length>0){const{tool:t,annotation:n,handle:o}=Kh(l);return qh(n.annotationUID,d),void t.handleSelectedCallback(e,n,o,"Mouse")}const c=kh(a,r,s,"mouse");if(c.length>0){const{tool:t,annotation:n}=Kh(c);return qh(n.annotationUID,d),void t.toolSelectedCallback(e,n,"Mouse")}if(t&&"function"==typeof t.postMouseDownCallback){if(t.postMouseDownCallback(e))return}}function Kh(e){return e.length>1&&e.find((e=>!ge(e.annotation)&&Pe(e.annotation.annotationUID)))||e[0]}function qh(e,t=!1){if(t)if(De(e))Ce(e,!1);else{Ce(e,!0,!0)}else{Ce(e,!0,!1)}}function zh(e){if(Ke.isInteractingWithTool)return;const t=Wh(e);if(t&&!Ke.isMultiPartToolActive&&t.addNewAnnotation){Ce(t.addNewAnnotation(e,"mouse").annotationUID)}}function jh(e){if(Ke.isInteractingWithTool)return;const t=Wh(e);!t||"function"!=typeof t.mouseDragCallback||t.mouseDragCallback(e)}const{Active:Zh,Passive:Yh}=X;function Jh(e){if(Ke.isInteractingWithTool||Ke.isMultiPartToolActive)return;const t=Fh(e,[Zh,Yh]),n=e.detail,{element:o}=n,i=Uh(o,t),a=t.filter((e=>!i.some((t=>t.tool.getToolName()===e.getToolName()))));let r=!1;for(const{tool:t,annotations:n}of i)"function"==typeof t.mouseMoveCallback&&(r=t.mouseMoveCallback(e,n)||r);a.forEach((t=>{"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)})),!0===r&&Ji(o)}const Xh=Nh.bind(null,"Mouse","mouseUpCallback"),Qh=Nh.bind(null,"MouseWheel","mouseWheelCallback"),eg={enable:function(e){e.addEventListener(ne.MOUSE_CLICK,Ph),e.addEventListener(ne.MOUSE_DOWN,$h),e.addEventListener(ne.MOUSE_DOWN_ACTIVATE,zh),e.addEventListener(ne.MOUSE_DOUBLE_CLICK,Lh),e.addEventListener(ne.MOUSE_DRAG,jh),e.addEventListener(ne.MOUSE_MOVE,Jh),e.addEventListener(ne.MOUSE_UP,Xh),e.addEventListener(ne.MOUSE_WHEEL,Qh)},disable:function(e){e.removeEventListener(ne.MOUSE_CLICK,Ph),e.removeEventListener(ne.MOUSE_DOWN,$h),e.removeEventListener(ne.MOUSE_DOWN_ACTIVATE,zh),e.removeEventListener(ne.MOUSE_DOUBLE_CLICK,Lh),e.removeEventListener(ne.MOUSE_DRAG,jh),e.removeEventListener(ne.MOUSE_MOVE,Jh),e.removeEventListener(ne.MOUSE_UP,Xh),e.removeEventListener(ne.MOUSE_WHEEL,Qh)}},{Active:tg}=X;function ng(e){const{renderingEngineId:t,viewportId:n}=e.detail,o=rt.mouseButton,i=xn.getModifierKey(),a=Ng(n,t);if(!a)return null;const r=Object.keys(a.toolOptions),s=a.getDefaultMousePrimary();for(let e=0;e<r.length;e++){const t=r[e],n=a.toolOptions[t],l=n.bindings.length&&n.bindings.some((e=>e.mouseButton===(o??s)&&e.modifierKey===i));if(n.mode===tg&&l)return a.getToolInstance(t)}}function og(e){const t=ng(e);if(!t)return;const{renderingEngineId:n,viewportId:o}=e.detail,i=Ng(o,n),a=t.getToolName();Object.keys(i.toolOptions).includes(a)&&i.setViewportsCursorByToolName(a)}function ig(e){const t=ng(e);if(!t)return;const{renderingEngineId:n,viewportId:o}=e.detail,i=Ng(o,n);_n.keyCode=void 0;const a=t.getToolName();Object.keys(i.toolOptions).includes(a)&&i.setViewportsCursorByToolName(a)}const ag={enable:function(e){e.addEventListener(ne.KEY_DOWN,og),e.addEventListener(ne.KEY_UP,ig)},disable:function(e){e.removeEventListener(ne.KEY_DOWN,og),e.removeEventListener(ne.KEY_UP,ig)}},{Active:rg,Passive:sg,Enabled:lg}=X,dg=function(e){Fh(e,[rg,sg,lg]).forEach((t=>{t.onCameraModified&&t.onCameraModified(e)}))},cg={enable:function(e){e.addEventListener(J.Enums.Events.CAMERA_MODIFIED,dg)},disable:function(e){e.removeEventListener(J.Enums.Events.CAMERA_MODIFIED,dg)}},{Active:hg,Passive:gg,Enabled:ug}=X,mg=function(e){Fh(e,[hg,gg,ug]).forEach((t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},fg={enable:function(e){e.addEventListener(J.Enums.Events.IMAGE_SPACING_CALIBRATED,mg)},disable:function(e){e.removeEventListener(J.Enums.Events.IMAGE_SPACING_CALIBRATED,mg)}},{Active:vg}=X;function pg(e){const{renderingEngineId:t,viewportId:n}=e.detail,o=e.detail.event,i=Ng(n,t);if(!i)return null;const a=Object.keys(i.toolOptions),r=Object.keys(o.touches).length,s=Vh(o)||xn.getModifierKey(),l=i.getDefaultMousePrimary();for(let e=0;e<a.length;e++){const t=a[e],n=i.toolOptions[t],o=n.bindings.length&&n.bindings.some((e=>(e.numTouchPoints===r||1===r&&e.mouseButton===l)&&e.modifierKey===s));if(n.mode===vg&&o)return i.getToolInstance(t)}}function Eg(e,t,n){const{renderingEngineId:o,viewportId:i}=e.detail,a=Ng(i,o);if(!a)return[];const r=[],s=Object.keys(a.toolOptions);for(let e=0;e<s.length;e++){const o=s[e],i=a.toolOptions[o],l=null!=n&&i.bindings.length&&i.bindings.some((e=>e.numTouchPoints===n));if(t.includes(i.mode)&&(!n||l)){const e=a.getToolInstance(o);r.push(e)}}return r}const{Active:wg,Passive:Ig}=X;function Cg(e){if(Ke.isInteractingWithTool)return;const t=pg(e);if(t&&"function"==typeof t.preTouchStartCallback){if(t.preTouchStartCallback(e))return}const n=1===Object.keys(e.detail.event.touches).length,o=[...Eg(e,[wg],Object.keys(e.detail.event.touches).length)||[],...(n?Eg(e,[Ig]):void 0)||[],t],i=e.detail,{element:a}=i,r=Uh(a,o),s=i.currentPoints.canvas,l=Ah(a,r,s,"touch");if(l.length>0){const{tool:t,annotation:n,handle:o}=Tg(l);return bg(n.annotationUID,false),void t.handleSelectedCallback(e,n,o,"Touch")}const d=kh(a,r,s,"touch");if(d.length>0){const{tool:t,annotation:n}=Tg(d);return bg(n.annotationUID,false),void t.toolSelectedCallback(e,n,"Touch")}if(t&&"function"==typeof t.postTouchStartCallback){if(t.postTouchStartCallback(e))return}}function Tg(e){return e.length>1&&e.find((e=>!ge(e.annotation)&&Pe(e.annotation.annotationUID)))||e[0]}function bg(e,t=!1){if(t)if(De(e))Ce(e,!1);else{Ce(e,!0,!0)}else{Ce(e,!0,!1)}}function _g(e){if(Ke.isInteractingWithTool)return;const t=pg(e);if(t&&!Ke.isMultiPartToolActive&&t.addNewAnnotation){Ce(t.addNewAnnotation(e,"touch").annotationUID)}}function Dg(e){if(Ke.isInteractingWithTool)return;const t=pg(e);!t||"function"!=typeof t.touchDragCallback||t.touchDragCallback(e)}const Sg=Nh.bind(null,"Touch","touchEndCallback"),Og=Nh.bind(null,"Touch","touchTapCallback"),yg=Nh.bind(null,"Touch","touchPressCallback"),xg={enable:function(e){e.addEventListener(ne.TOUCH_START,Cg),e.addEventListener(ne.TOUCH_START_ACTIVATE,_g),e.addEventListener(ne.TOUCH_DRAG,Dg),e.addEventListener(ne.TOUCH_END,Sg),e.addEventListener(ne.TOUCH_TAP,Og),e.addEventListener(ne.TOUCH_PRESS,yg)},disable:function(e){e.removeEventListener(ne.TOUCH_START,Cg),e.removeEventListener(ne.TOUCH_START_ACTIVATE,_g),e.removeEventListener(ne.TOUCH_DRAG,Dg),e.removeEventListener(ne.TOUCH_END,Sg),e.removeEventListener(ne.TOUCH_PRESS,yg)}};function Mg(e){const{element:t,viewportId:n}=e.detail,o=function(e){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),o=`svg-layer-${e}`;n.classList.add("svg-layer"),n.setAttribute("id",o),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const i=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),r=document.createElementNS(t,"feOffset"),s=document.createElementNS(t,"feColorMatrix"),l=document.createElementNS(t,"feBlend");return a.setAttribute("id",`shadow-${o}`),a.setAttribute("filterUnits","userSpaceOnUse"),r.setAttribute("result","offOut"),r.setAttribute("in","SourceGraphic"),r.setAttribute("dx","0.5"),r.setAttribute("dy","0.5"),s.setAttribute("result","matrixOut"),s.setAttribute("in","offOut"),s.setAttribute("in2","matrix"),s.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","matrixOut"),l.setAttribute("mode","normal"),a.appendChild(r),a.appendChild(s),a.appendChild(l),i.appendChild(a),n.appendChild(i),n}(n);var i;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;Ke.svgNodeCache[o]={}}(t),i=o,t.querySelector("div.viewport-element").appendChild(i),Yi.addViewportElement(n,t),bt.enable(t),Tn.enable(t),vn.enable(t),xn.enable(t),Mh.enable(t),cg.enable(t),fg.enable(t),eg.enable(t),ag.enable(t),xg.enable(t),Ke.enabledElements.push(t)}const Rg=function(e,t){const n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let o=0;o<Ke.synchronizers.length;o++){const i=Ke.synchronizers[o],a=!i.isDisabled(),r=i.hasSourceViewport(t,e),s=i.hasTargetViewport(t,e);a&&(r||s)&&n.push(i)}return n};const Ng=function(e,t){const n=Ke.toolGroups.filter((n=>n.viewportsInfo.some((n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)))));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only\n      have one tool group per viewport in a renderingEngine.`);return n[0]}},Pg="viewport-element";const Lg=e=>{const t=(0,J.getEnabledElement)(e);Rg(t.viewportId,t.renderingEngineId).forEach((e=>{e.remove(t)}))},Ag=e=>{const{renderingEngineId:t,viewportId:n}=(0,J.getEnabledElement)(e),o=Ng(n,t);o&&o.removeViewports(t,n)};const Ug=function(e){const t=Ke.enabledElements.findIndex((t=>t===e));t>-1&&Ke.enabledElements.splice(t,1)},kg=function(e){const{element:t,viewportId:n}=e.detail;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;delete Ke.svgNodeCache[o]}(t),function(e){const t=e.querySelector(`div.${Pg}`),n=t.querySelector("svg");n&&t.removeChild(n)}(t),Yi.removeViewportElement(n,t),bt.disable(t),Tn.disable(t),vn.disable(t),xn.disable(t),Mh.disable(t),cg.disable(t),fg.disable(t),eg.disable(t),ag.disable(t),xg.disable(t),Lg(t),Ag(t),Ug(t)};function Vg(e){const t=Uh(e,qi(e,[X.Active,X.Passive]));for(const{tool:n}of t){const t=n.cancel(e);if(t)return t}}function Hg(e,t){return e.findIndex((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))}function Wg(e,t){return e.some((e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId))}const Fg=class{constructor(e,t,n){this._viewportOptions={},this._onEvent=e=>{if(!0===this._ignoreFiredEvents)return;if(!this._targetViewports.length)return;const t=(0,J.getEnabledElement)(e.currentTarget);if(!t)return;const{renderingEngineId:n,viewportId:o}=t;this._sourceViewports.find((e=>e.viewportId===o))&&this.fireEvent({renderingEngineId:n,viewportId:o},e)},this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e,t={}){this._viewportOptions[e]=t}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(Wg(this._sourceViewports,e))return;const{renderingEngineId:t,viewportId:n}=e,{element:o}=(0,J.getRenderingEngine)(t).getViewport(n);o.addEventListener(this._eventName,this._onEvent.bind(this)),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){Wg(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach((e=>this.removeSource(e))),this._targetViewports.forEach((e=>this.removeTarget(e)))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){const t=Hg(this._sourceViewports,e);if(-1===t)return;const n=function(e){const t=(0,J.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error(`No RenderingEngine for Id: ${e.renderingEngineId}`);return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._updateDisableHandlers()}removeTarget(e){const t=Hg(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return Wg(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return Wg(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(!this.isDisabled()&&!this._ignoreFiredEvents){this._ignoreFiredEvents=!0;try{for(let n=0;n<this._targetViewports.length;n++){const o=this._targetViewports[n];e.viewportId===o.viewportId||this._eventHandler(this,e,o,t)}}catch(e){console.warn(`Synchronizer, for: ${this._eventName}`,e)}finally{this._ignoreFiredEvents=!1}}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){const e=function(e,t){const n=[],o=e.concat(t);for(let e=0;e<o.length;e++){const t=o[e];n.some((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=e=>{t(e.detail.element)};e.forEach((function(e){const t=(0,J.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);if(!t)return;const{element:o}=t;o.removeEventListener(J.Enums.Events.ELEMENT_DISABLED,n),o.addEventListener(J.Enums.Events.ELEMENT_DISABLED,n)}))}};const Bg=function(e,t,n){if(Ke.synchronizers.some((t=>t.id===e)))throw new Error(`Synchronizer with id '${e}' already exists.`);const o=new Fg(e,t,n);return Ke.synchronizers.push(o),o};const Gg=function(){for(;Ke.synchronizers.length>0;){Ke.synchronizers.pop().destroy()}};const $g=function(e){return Ke.synchronizers.find((t=>t.id===e))};const Kg=function(){return Ke.synchronizers};const qg=function(e){const t=Ke.synchronizers.findIndex((t=>t.id===e));if(t>-1){Ke.synchronizers[t].destroy(),Ke.synchronizers.splice(t,1)}};var zg=n(65406),jg=n.n(zg);const{Active:Zg,Passive:Yg,Enabled:Jg,Disabled:Xg}=X;class Qg{constructor(e){this.viewportsInfo=[],this.toolOptions={},this._toolInstances={},this.id=e}getViewportIds(){return this.viewportsInfo.map((({viewportId:e})=>e))}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(e){const t=this._toolInstances[e];if(t)return t;console.warn(`'${e}' is not registered with this toolGroup.`)}addTool(e,t={}){const n=Ke.tools[e],o=void 0!==e&&""!==e,i=this.toolOptions[e];if(!o)return void console.warn("Tool with configuration did not produce a toolName: ",t);if(!n)return void console.warn(`'${e}' is not registered with the library. You need to use cornerstoneTools.addTool to register it.`);if(i)return void console.warn(`'${e}' is already registered for ToolGroup ${this.id}.`);const{toolClass:a}=n,r=new a({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=r}addToolInstance(e,t,n={}){let o=Ke.tools[e]?.toolClass;if(!o){const n=Ke.tools[t].toolClass;class i extends n{}i.toolName=e,o=i,Ke.tools[e]={toolClass:i}}this.addTool(o.toolName,n)}addViewport(e,t){const n=(0,J.getRenderingEngines)();if(!t&&n.length>1)throw new Error("You must specify a renderingEngineId when there are multiple rendering engines.");const o=t||n[0].id;this.viewportsInfo.some((({viewportId:t})=>t===e))||this.viewportsInfo.push({viewportId:e,renderingEngineId:o});const i=this.getActivePrimaryMouseButtonTool();J.Settings.getRuntimeSettings().get("useCursors")&&this.setViewportsCursorByToolName(i)}removeViewports(e,t){const n=[];if(this.viewportsInfo.forEach(((o,i)=>{let a=!1;o.renderingEngineId===e&&(a=!0,t&&o.viewportId!==t&&(a=!1)),a&&n.push(i)})),n.length)for(let e=n.length-1;e>=0;e--)this.viewportsInfo.splice(n[e],1)}setActiveStrategy(e,t){const n=this._toolInstances[e];void 0!==n?n.setActiveStrategy(t):console.warn(`Tool ${e} not added to toolGroup, can't set tool configuration.`)}setToolMode(e,t,n={}){e?t!==X.Active?t!==X.Passive?t!==X.Enabled?t!==X.Disabled?console.warn("setToolMode: mode must be defined"):this.setToolDisabled(e):this.setToolEnabled(e):this.setToolPassive(e):this.setToolActive(e,n):console.warn("setToolMode: toolName must be defined")}setToolActive(e,t={}){const n=this._toolInstances[e];if(void 0===n)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);if(!n)return void console.warn(`'${e}' instance ${n} is not registered with this toolGroup, can't set tool mode.`);const o={bindings:[...this.toolOptions[e]?this.toolOptions[e].bindings:[],...t.bindings?t.bindings:[]].reduce(((e,t)=>{const n=void 0!==t.numTouchPoints,o=void 0!==t.mouseButton;return e.some((e=>function(e,t){if(e.mouseButton!==t.mouseButton)return!1;return e.modifierKey===t.modifierKey}(e,t)))||!n&&!o||e.push(t),e}),[]),mode:Zg};this.toolOptions[e]=o,this._toolInstances[e].mode=Zg;const i=J.Settings.getRuntimeSettings().get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&i)this.setViewportsCursorByToolName(e);else{if(!this.getActivePrimaryMouseButtonTool()&&i){const e=Za.getDefinedCursor("default");this._setCursorForViewports(e)}}"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports()}setToolPassive(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n=this.getToolOptions(e),o=Object.assign({bindings:n?n.bindings:[]},n,{mode:Yg}),i=this.getDefaultMousePrimary();o.bindings=o.bindings.filter((e=>e.mouseButton!==i||e.modifierKey));let a=Yg;0!==o.bindings.length&&(a=Zg,o.mode=a),this.toolOptions[e]=o,t.mode=a,"function"==typeof t.onSetToolPassive&&t.onSetToolPassive(),this._renderViewports()}setToolEnabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:Jg};this.toolOptions[e]=n,t.mode=Jg,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports()}setToolDisabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:Xg};this.toolOptions[e]=n,t.mode=Xg,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports()}getToolOptions(e){const t=this.toolOptions[e];if(void 0!==t)return t}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find((e=>{const t=this.toolOptions[e];return t.mode===Zg&&this._hasMousePrimaryButtonBinding(t)}))}setViewportsCursorByToolName(e,t){const n=this._getCursor(e,t);this._setCursorForViewports(n)}_getCursor(e,t){let n,o;return t&&(n=`${e}.${t}`,o=gr.getDefinedCursor(n,!0),o)?o:(n=`${e}`,o=gr.getDefinedCursor(n,!0),o||(n=e,o=gr.getDefinedCursor(n,!0),o||Za.getDefinedCursor("default")))}_setCursorForViewports(e){this.viewportsInfo.forEach((({renderingEngineId:t,viewportId:n})=>{const o=(0,J.getEnabledElementByIds)(n,t);if(!o)return;const{viewport:i}=o;wr(i.element,e)}))}setToolConfiguration(e,t,n){if(void 0===this._toolInstances[e])return console.warn(`Tool ${e} not present, can't set tool configuration.`),!1;let o;return o=n?t:J.utilities.deepMerge(this._toolInstances[e].configuration,t),this._toolInstances[e].configuration=o,this._renderViewports(),!0}getDefaultMousePrimary(){return j.Primary}getToolConfiguration(e,t){if(void 0===this._toolInstances[e])return void console.warn(`Tool ${e} not present, can't set tool configuration.`);const n=jg()(this._toolInstances[e].configuration,t);return se()(n)}_hasMousePrimaryButtonBinding(e){const t=this.getDefaultMousePrimary();return e?.bindings?.some((e=>e.mouseButton===t&&void 0===e.modifierKey))}_renderViewports(){this.viewportsInfo.forEach((({renderingEngineId:e,viewportId:t})=>{(0,J.getRenderingEngine)(e).renderViewport(t)}))}}const eu=function(e){if(Ke.toolGroups.some((t=>t.id===e)))return void console.warn(`'${e}' already exists.`);const t=new Qg(e);return Ke.toolGroups.push(t),t};const tu=function(e){const t=Ke.toolGroups.findIndex((t=>t.id===e));t>-1&&(ga.removeToolGroup(e),ei(e),Ke.toolGroups.splice(t,1))};const nu=function(){const e=[...Ke.toolGroups];for(const t of e)tu(t.id);Ke.toolGroups=[]};const ou=function(e){return Ke.toolGroups.find((t=>t.id===e))};const iu=function(){return Ke.toolGroups},au=[X.Active,X.Passive,X.Enabled];const ru=function(e){return Ke.toolGroups.filter((({toolOptions:t})=>{const n=Object.keys(t);for(let o=0;o<n.length;o++)if(e===n[o]&&t[e]&&au.includes(t[e].mode))return!0;return!1}))};let su=Fe;function lu(){return su}function du(e){su=e}function cu(){su=Fe}function hu(e,t){const n=lu(),o=n.getGroupKey(t);return n.getAnnotations(o,e)}function gu(e,t){void 0===e.annotationUID&&(e.annotationUID=J.utilities.uuidv4());const n=lu(),o=n.getGroupKey(t);return n.addAnnotation(e,o),t instanceof HTMLDivElement?function(e,t){const n=(0,J.getEnabledElement)(t),{renderingEngine:o,viewportId:i}=n,a=ne.ANNOTATION_ADDED,r={annotation:e,viewportId:i,renderingEngineId:o.id};(0,J.triggerEvent)(J.eventTarget,a,r)}(e,t):function(e){const{toolName:t}=e.metadata,n=ru(t);if(!n.length)return;const o=[];if(n.forEach((t=>{t.viewportsInfo.forEach((t=>{const{renderingEngineId:n,viewportId:i}=t,{FrameOfReferenceUID:a}=(0,J.getEnabledElementByIds)(i,n);e.metadata.FrameOfReferenceUID===a&&o.push(t)}))})),!o.length)return;const i=ne.ANNOTATION_ADDED;o.forEach((({renderingEngineId:t,viewportId:n})=>{const o={annotation:e,viewportId:n,renderingEngineId:t};(0,J.triggerEvent)(J.eventTarget,i,o)}))}(e),e.annotationUID}function uu(e,t){const n=lu(),o=n.getGroupKey(t);return n.getNumberOfAnnotations(o,e)}function mu(e){const t=lu(),n=t.getAnnotation(e);if(!n)return;t.removeAnnotation(e);const o=ne.ANNOTATION_REMOVED,i={annotation:n,annotationManagerUID:t.uid};(0,J.triggerEvent)(J.eventTarget,o,i)}function fu(e){return lu().getAnnotation(e)}function vu(){lu().removeAllAnnotations()}let pu=!1;function Eu(e={}){pu||(!function(){Iu();const e=J.Enums.Events.ELEMENT_ENABLED,t=J.Enums.Events.ELEMENT_DISABLED;J.eventTarget.addEventListener(e,Mg),J.eventTarget.addEventListener(t,kg)}(),Cu(),J.eventTarget.addEventListener(ne.ANNOTATION_MODIFIED,yh),J.eventTarget.addEventListener(ne.ANNOTATION_SELECTION_CHANGE,Oh),J.eventTarget.addEventListener(ne.ANNOTATION_SELECTION_CHANGE,Oh),J.eventTarget.addEventListener(ne.SEGMENTATION_MODIFIED,Ea),J.eventTarget.addEventListener(ne.SEGMENTATION_DATA_MODIFIED,va),J.eventTarget.addEventListener(ne.SEGMENTATION_REPRESENTATION_MODIFIED,fa),J.eventTarget.addEventListener(ne.SEGMENTATION_REPRESENTATION_REMOVED,pa),pu=!0)}function wu(){Iu(),Cu(),nu(),qe();const e=lu(),t=zn();e.restoreAnnotations({}),t.resetState(),pu=!1}function Iu(){const e=J.Enums.Events.ELEMENT_ENABLED,t=J.Enums.Events.ELEMENT_DISABLED;J.eventTarget.removeEventListener(e,Mg),J.eventTarget.removeEventListener(t,kg)}function Cu(){J.eventTarget.removeEventListener(ne.ANNOTATION_MODIFIED,yh),J.eventTarget.removeEventListener(ne.ANNOTATION_SELECTION_CHANGE,Oh),J.eventTarget.removeEventListener(ne.ANNOTATION_SELECTION_CHANGE,Oh),J.eventTarget.removeEventListener(ne.SEGMENTATION_MODIFIED,Ea),J.eventTarget.removeEventListener(ne.SEGMENTATION_DATA_MODIFIED,va),J.eventTarget.removeEventListener(ne.SEGMENTATION_REPRESENTATION_MODIFIED,fa),J.eventTarget.removeEventListener(ne.SEGMENTATION_REPRESENTATION_REMOVED,pa)}function Tu(e,t,n,o){const{camera:i}=o.detail,a=(0,J.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const r=a.getViewport(n.viewportId);r.setCamera(i),r.render()}const{CAMERA_MODIFIED:bu}=J.Enums.Events;function _u(e){return Bg(e,bu,Tu)}function Du(e,t,n,o){const i=o.detail,{volumeId:a,range:r}=i,s=(0,J.getRenderingEngine)(n.renderingEngineId);if(!s)throw new Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);const l=s.getViewport(n.viewportId);if(l instanceof J.VolumeViewport)l.setProperties({voiRange:r},a);else{if(!(l instanceof J.StackViewport))throw new Error("Viewport type not supported.");l.setProperties({voiRange:r})}l.render()}function Su(e){return Bg(e,J.Enums.Events.VOI_MODIFIED,Du)}function Ou(e,t,n){const o=(0,J.getRenderingEngine)(n.renderingEngineId);if(!o)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const i=e.getOptions(n.viewportId),a=o.getViewport(n.viewportId),r=o.getViewport(t.viewportId);if(!1!==i?.syncZoom){const e=r.getZoom();a.setZoom(e)}if(!1!==i?.syncPan){const e=r.getPan();a.setPan(e)}a.render()}const{CAMERA_MODIFIED:yu}=J.Enums.Events;function xu(e){return Bg(e,yu,Ou)}async function Mu(e,t,n){const o=(0,J.getRenderingEngine)(n.renderingEngineId);if(!o)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const i=o.getViewport(t.viewportId),a=o.getViewport(n.viewportId),r=i.getFrameOfReferenceUID(),s=a.getFrameOfReferenceUID(),l=i.getCurrentImageId(),d=J.metaData.get("imagePlaneModule",l).imagePositionPatient,c=a.getImageIds();if(function(e,t){const{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:o}=t.getCamera(),i=Ti.R3.dot(n,o);return Math.abs(i)>.9}(i,a))if(r===s){const e=Ru(d,c);if(-1!==e.index&&a.getCurrentImageIdIndex()!==e.index)return void await Ra(a.element,{imageIndex:e.index})}else{const e=J.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",[n.viewportId,t.viewportId]);if(!e)throw new Error(`No registration matrix found for sourceViewport: ${t.viewportId} and targetViewport: ${n.viewportId}, viewports with different frameOfReferenceUIDs must have a registration matrix in the registrationMetadataProvider. Use calculateViewportsRegistrationMatrix to calculate the matrix.`);const o=Ru(Ti.R3.transformMat4(Ti.R3.create(),d,e),c);-1!==o.index&&a.getCurrentImageIdIndex()!==o.index&&await Ra(a.element,{imageIndex:o.index})}}function Ru(e,t){return t.reduce(((t,n,o)=>{const{imagePositionPatient:i}=J.metaData.get("imagePlaneModule",n),a=Ti.R3.distance(i,e);return a<t.distance?{distance:a,index:o}:t}),{distance:1/0,index:-1})}const{STACK_NEW_IMAGE:Nu}=J.Enums.Events;function Pu(e){return Bg(e,Nu,Mu)}},65406:(e,t,n)=>{var o="__lodash_hash_undefined__",i=1/0,a="[object Function]",r="[object GeneratorFunction]",s="[object Symbol]",l=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,d=/^\w*$/,c=/^\./,h=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,g=/\\(\\)?/g,u=/^\[object .+?Constructor\]$/,m="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,f="object"==typeof self&&self&&self.Object===Object&&self,v=m||f||Function("return this")();var p,E=Array.prototype,w=Function.prototype,I=Object.prototype,C=v["__core-js_shared__"],T=(p=/[^.]+$/.exec(C&&C.keys&&C.keys.IE_PROTO||""))?"Symbol(src)_1."+p:"",b=w.toString,_=I.hasOwnProperty,D=I.toString,S=RegExp("^"+b.call(_).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),O=v.Symbol,y=E.splice,x=W(v,"Map"),M=W(Object,"create"),R=O?O.prototype:void 0,N=R?R.toString:void 0;function P(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function L(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function A(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function U(e,t){for(var n,o,i=e.length;i--;)if((n=e[i][0])===(o=t)||n!=n&&o!=o)return i;return-1}function k(e,t){var n;t=function(e,t){if($(e))return!1;var n=typeof e;if("number"==n||"symbol"==n||"boolean"==n||null==e||q(e))return!0;return d.test(e)||!l.test(e)||null!=t&&e in Object(t)}(t,e)?[t]:$(n=t)?n:F(n);for(var o=0,i=t.length;null!=e&&o<i;)e=e[B(t[o++])];return o&&o==i?e:void 0}function V(e){if(!K(e)||(t=e,T&&T in t))return!1;var t,n=function(e){var t=K(e)?D.call(e):"";return t==a||t==r}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?S:u;return n.test(function(e){if(null!=e){try{return b.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}function H(e,t){var n,o,i=e.__data__;return("string"==(o=typeof(n=t))||"number"==o||"symbol"==o||"boolean"==o?"__proto__"!==n:null===n)?i["string"==typeof t?"string":"hash"]:i.map}function W(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return V(n)?n:void 0}P.prototype.clear=function(){this.__data__=M?M(null):{}},P.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},P.prototype.get=function(e){var t=this.__data__;if(M){var n=t[e];return n===o?void 0:n}return _.call(t,e)?t[e]:void 0},P.prototype.has=function(e){var t=this.__data__;return M?void 0!==t[e]:_.call(t,e)},P.prototype.set=function(e,t){return this.__data__[e]=M&&void 0===t?o:t,this},L.prototype.clear=function(){this.__data__=[]},L.prototype.delete=function(e){var t=this.__data__,n=U(t,e);return!(n<0)&&(n==t.length-1?t.pop():y.call(t,n,1),!0)},L.prototype.get=function(e){var t=this.__data__,n=U(t,e);return n<0?void 0:t[n][1]},L.prototype.has=function(e){return U(this.__data__,e)>-1},L.prototype.set=function(e,t){var n=this.__data__,o=U(n,e);return o<0?n.push([e,t]):n[o][1]=t,this},A.prototype.clear=function(){this.__data__={hash:new P,map:new(x||L),string:new P}},A.prototype.delete=function(e){return H(this,e).delete(e)},A.prototype.get=function(e){return H(this,e).get(e)},A.prototype.has=function(e){return H(this,e).has(e)},A.prototype.set=function(e,t){return H(this,e).set(e,t),this};var F=G((function(e){var t;e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(q(e))return N?N.call(e):"";var t=e+"";return"0"==t&&1/e==-i?"-0":t}(t);var n=[];return c.test(e)&&n.push(""),e.replace(h,(function(e,t,o,i){n.push(o?i.replace(g,"$1"):t||e)})),n}));function B(e){if("string"==typeof e||q(e))return e;var t=e+"";return"0"==t&&1/e==-i?"-0":t}function G(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var o=arguments,i=t?t.apply(this,o):o[0],a=n.cache;if(a.has(i))return a.get(i);var r=e.apply(this,o);return n.cache=a.set(i,r),r};return n.cache=new(G.Cache||A),n}G.Cache=A;var $=Array.isArray;function K(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function q(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&D.call(e)==s}e.exports=function(e,t,n){var o=null==e?void 0:k(e,t);return void 0===o?n:o}}}]);
//# sourceMappingURL=270.bundle.2cd8dce18409663d9d9e.js.map