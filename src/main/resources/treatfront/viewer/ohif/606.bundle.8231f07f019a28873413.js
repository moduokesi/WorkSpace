/*! For license information please see 606.bundle.8231f07f019a28873413.js.LICENSE.txt */
(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[606],{4606:(e,n,t)=>{"use strict";t.d(n,{adaptersSR:()=>ct});var r=t(22737),a=t(73373),i=t.n(a),o=t(71975),u=t.n(o),s=t(88256);function c(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?c(Object(t),!0).forEach((function(n){g(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):c(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function d(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function f(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,y(r.key),r)}}function p(e,n,t){return n&&f(e.prototype,n),t&&f(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function g(e,n,t){return(n=y(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function h(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,a,i,o,u=[],s=!0,c=!1;try{if(i=(t=t.call(e)).next,0===n){if(Object(t)!==t)return;s=!1}else for(;!(s=(r=i.call(t)).done)&&(u.push(r.value),u.length!==n);s=!0);}catch(e){c=!0,a=e}finally{try{if(!s&&null!=t.return&&(o=t.return(),Object(o)!==o))return}finally{if(c)throw a}}return u}}(e,n)||v(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e){return function(e){if(Array.isArray(e))return S(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||v(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(e,n){if(e){if("string"==typeof e)return S(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?S(e,n):void 0}}function S(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function y(e){var n=function(e,n){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:String(n)}var I=function(e){return Array.isArray(e)?e:[e]},T=function(e){return function(n){return n.ConceptNameCodeSequence.CodeMeaning===e}},D=r.hC.TID1500,C=r.hC.addAccessors,O=r.U7.StructuredReport,b=r.oq.Normalizer,R=D.TID1500MeasurementReport,x=D.TID1501MeasurementGroup,M=r.aT.DicomMetaDictionary,w={CodingSchemeDesignator:"DCM",CodeValue:"121071"},A={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},E={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},P=function(e,n,t){var r=e.ConceptNameCodeSequence;if(r){var a=r.CodingSchemeDesignator,i=r.CodeValue;return a==n.CodingSchemeDesignator&&i==n.CodeValue||t&&a==t.CodingSchemeDesignator&&i==t.CodeValue}};var N=function(){function e(){d(this,e)}return p(e,null,[{key:"getSetupMeasurementData",value:function(e){var n=e.ContentSequence,t=I(n),r=t.find((function(e){return P(e,w)})),a=t.filter((function(e){return P(e,A,E)}))||[],i=t.find((function(e){return"NUM"===e.ValueType})),o=I(i.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),u=o.ContentSequence.ReferencedSOPSequence,s=u.ReferencedSOPInstanceUID,c=u.ReferencedFrameNumber,l={sopInstanceUid:s,frameIndex:c||1,complete:!0,finding:r?C(r.ConceptCodeSequence):void 0,findingSites:a.map((function(e){return C(e.ConceptCodeSequence)}))};l.finding&&(l.description=l.finding.CodeMeaning);var d=l.findingSites&&l.findingSites[0];return d&&(l.location=d[0]&&d[0].CodeMeaning||d.CodeMeaning),{defaultState:l,findingGroup:r,findingSiteGroups:a,NUMGroup:i,SCOORDGroup:o,ReferencedSOPSequence:u,ReferencedSOPInstanceUID:s,ReferencedFrameNumber:c}}},{key:"generateReport",value:function(e,n,t){var r=[],a=Object.keys(e)[0];if(!a)throw new Error("No measurements provided.");var i=n.get("generalSeriesModule",a),o=i.studyInstanceUID,u=i.seriesInstanceUID;Object.keys(e).forEach((function(t){var a=n.get("sopCommonModule",t),i=n.get("frameNumber",t),o=e[t],u=Object.keys(o),s={ReferencedSOPClassUID:a.sopClassUID,ReferencedSOPInstanceUID:a.sopInstanceUID};b.isMultiframeSOPClassUID(a.sopClassUID)&&(s.ReferencedFrameNumber=i);var c=[];u.forEach((function(e){var n=function(e,n,t){var r=n[e],a=N.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(r&&r.data&&r.data.length&&a){var i=r.data.map((function(e){return function(e,n,t,r){var a=r.getTID300RepresentationArguments(e);return a.ReferencedSOPSequence=t,new r.TID300Representation(a)}(e,0,t,a)}));return new x(i)}}(e,o,s);n&&c.push(n)})),r=r.concat(c)}));var s=new R({TID1501MeasurementGroups:r},t),c=new Uint8Array(2);c[1]=1;var l={StudyInstanceUID:o,SeriesInstanceUID:u},d={FileMetaInformationVersion:{Value:[c.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[M.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};l._meta=d,l._vrMap={PixelData:"OW"};var f=new O([l]),p=s.contentItem(l);return f.dataset=Object.assign(f.dataset,p),f.dataset._meta=d,f}},{key:"generateToolState",value:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("1500"!==n.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var r=I(n.ContentSequence).find(T("Imaging Measurements")),a=I(r.ContentSequence).filter(T("Measurement Group")),i={},o=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,u=[];return Object.keys(o).forEach((function(e){u.push(o[e]),i[e]=[]})),a.forEach((function(e){var r=I(e.ContentSequence).find((function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning})).TextValue,a=t.getToolClass?t.getToolClass(e,n,u):u.find((function(e){return e.isValidCornerstoneTrackingIdentifier(r)}));if(a){var o=a.getMeasurementData(e);console.log("=== ".concat(a.toolType," ===")),console.log(o),i[a.toolType].push(o)}})),i}},{key:"registerTool",value:function(n){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[n.utilityToolType]=n,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[n.toolType]=n,e.MEASUREMENT_BY_TOOLTYPE[n.toolType]=n.utilityToolType}}]),e}();N.MEASUREMENT_BY_TOOLTYPE={},N.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},N.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={};var q="cornerstoneTools@^4.0.0",V=r.hC.TID300.Length,k="Length",G=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup,o=l(l({},r),{},{length:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=h(i.GraphicData,4);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites;return{point1:n.start,point2:n.end,distance:e.length,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Length",finding:t,findingSites:r||[]}}}]),e}();G.toolType=k,G.utilityToolType=k,G.TID300Representation=V,G.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===k},N.registerTool(G);var _=r.hC.TID300.Polyline,U=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){for(var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.SCOORDGroup,i=t.NUMGroup,o=l(l({},r),{},{toolType:e.toolType,handles:{points:[],textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=a.GraphicData,s=0;s<u.length;s+=2)o.handles.points.push({x:u[s],y:u[s+1]});return o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites,a=e.cachedStats,i=void 0===a?{}:a,o=n.points,u=i.area,s=void 0===u?0:u,c=i.perimeter;return{points:o,area:s,perimeter:void 0===c?0:c,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:FreehandRoi",finding:t,findingSites:r||[]}}}]),e}();U.toolType="FreehandRoi",U.utilityToolType="FreehandRoi",U.TID300Representation=_,U.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===U.toolType},N.registerTool(U);var F=r.hC.TID300.Bidirectional,B="Bidirectional",j=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=n.ContentSequence,r=I(t).find((function(e){return"121071"===e.ConceptNameCodeSequence.CodeValue})),a=I(t).filter((function(e){return"G-C0E3"===e.ConceptNameCodeSequence.CodeValue})),i=I(t).find((function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning})),o=I(i.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),u=I(t).find((function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning})),s=I(u.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),c=o.ContentSequence.ReferencedSOPSequence,l=c.ReferencedSOPInstanceUID,d=c.ReferencedFrameNumber,f=String(i.MeasuredValueSequence.NumericValue),p=String(u.MeasuredValueSequence.NumericValue),g=Math.max(o.GraphicData[0],o.GraphicData[2],s.GraphicData[0],s.GraphicData[2]),h=Math.max(o.GraphicData[1],o.GraphicData[3],s.GraphicData[1],s.GraphicData[3]);return{sopInstanceUid:l,frameIndex:d||1,toolType:e.toolType,active:!1,handles:{start:{x:o.GraphicData[0],y:o.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:0},end:{x:o.GraphicData[2],y:o.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:1},perpendicularStart:{x:s.GraphicData[0],y:s.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:2},perpendicularEnd:{x:s.GraphicData[2],y:s.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:3},textBox:{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0,x:g+10,y:h+10}},invalidated:!1,isCreating:!1,longestDiameter:f,shortestDiameter:p,toolName:"Bidirectional",visible:!0,finding:r?r.ConceptCodeSequence:void 0,findingSites:a.map((function(e){return e.ConceptCodeSequence}))}}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=n.start,r=n.end,a=n.perpendicularStart,i=n.perpendicularEnd,o=e.shortestDiameter;return{longAxis:{point1:t,point2:r},shortAxis:{point1:a,point2:i},longAxisLength:e.longestDiameter,shortAxisLength:o,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Bidirectional",finding:e.finding,findingSites:e.findingSites||[]}}}]),e}();j.toolType=B,j.utilityToolType=B,j.TID300Representation=F,j.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===B},N.registerTool(j);var L=r.hC.TID300.Ellipse,Y="EllipticalRoi",z=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup.GraphicData,o=[{x:i[0],y:i[1]},{x:i[2],y:i[3]}],u=[{x:i[4],y:i[5]},{x:i[6],y:i[7]}],s=Math.sqrt(Math.pow(u[0].x-u[1].x,2)+Math.pow(u[0].y-u[1].y,2)),c=(u[1].x-u[0].x)/s,d=(u[1].y-u[0].y)/s,f=s/2,p={x:o[0].x+c*f,y:o[0].y+d*f},g={x:o[1].x-c*f,y:o[1].y-d*f};return l(l({},r),{},{toolType:e.toolType,active:!1,cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0},handles:{end:{x:p.x,y:p.y,highlight:!1,active:!1},initialRotation:0,start:{x:g.x,y:g.y,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.cachedStats,t=void 0===n?{}:n,r=e.handles,a=e.finding,i=e.findingSites,o=r.start,u=r.end,s=t.area,c=Math.abs(o.x-u.x)/2,l=Math.abs(o.y-u.y)/2,d=[],f={x:(o.x+u.x)/2,y:(o.y+u.y)/2};c>l?(d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}),d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l})):(d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l}),d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}));return{area:s,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:EllipticalRoi",finding:a,findingSites:i||[]}}}]),e}();z.toolType=Y,z.utilityToolType=Y,z.TID300Representation=L,z.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===Y},N.registerTool(z);var H=r.hC.TID300.Circle,X="CircleRoi",W=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup.GraphicData,o={x:i[0],y:i[1]},u={x:i[2],y:i[3]};return l(l({},r),{},{toolType:e.toolType,active:!1,cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},handles:{end:l(l({},u),{},{highlight:!1,active:!1}),initialRotation:0,start:l(l({},o),{},{highlight:!1,active:!1}),textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.cachedStats,t=void 0===n?{}:n,r=e.handles,a=e.finding,i=e.findingSites,o=r.start,u=r.end,s=t.area,c=t.radius,l=2*Math.PI*c,d=[];d.push(o),d.push(u);return{area:s,perimeter:l,radius:c,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CircleRoi",finding:a,findingSites:i||[]}}}]),e}();W.toolType=X,W.utilityToolType=X,W.TID300Representation=H,W.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===X},N.registerTool(W);var J=r.hC.TID300.Point,K="ArrowAnnotate",Q="CORNERSTONEFREETEXT",$=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.SCOORDGroup,i=t.findingGroup.ConceptCodeSequence.CodeMeaning,o=a.GraphicData;return l(l({},r),{},{toolType:e.toolType,active:!1,handles:{start:{x:o[0],y:o[1],highlight:!0,active:!1},end:{x:4==o.length?o[2]:o[0]+20,y:4==o.length?o[3]:o[1]+20,highlight:!0,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,text:i,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=[e.handles.start,e.handles.end],t=e.finding,r={points:n,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:ArrowAnnotate",findingSites:e.findingSites||[]};return t&&t.CodeValue===Q||(t={CodeValue:Q,CodingSchemeDesignator:"CST4",CodeMeaning:e.text}),r.finding=t,r}}]),e}();$.toolType=K,$.utilityToolType=K,$.TID300Representation=J,$.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===K},N.registerTool($);var Z=r.hC.orientation,ee=Z.rotateDirectionCosinesInPlane,ne=Z.flipImageOrientationPatient,te=Z.flipMatrix2D,re=Z.rotateMatrix902D,ae=r.hC.datasetToBlob,ie=r.hC.BitArray,oe=r.hC.DicomMessage,ue=r.hC.DicomMetaDictionary,se=r.oq.Normalizer,ce=r.U7.Segmentation,le={generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=n.toolState,a=n.segments,i=e[0],o={x:i.columns,y:i.rows,z:e.length};if(o.xy=o.x*o.y,!fe(s,a))throw new Error("No segments to export!");for(var u=i.imageId.includes("?frame"),s=function(e,n,t){var r=[];if(n){var a=e[0].data.byteArray.buffer,i=oe.readFile(a),o=ue.naturalizeDataset(i.dict);o._meta=ue.namifyDataset(i.meta),r.push(o)}else for(var u=0;u<e.length;u++){var s=e[u].data.byteArray.buffer,c=oe.readFile(s),l=ue.naturalizeDataset(c.dict);l._meta=ue.namifyDataset(c.meta),r.push(l)}var d=se.normalizeToDataset(r);return new ce([d],t)}(e,u,t),c=function(e,n,t){for(var r=[],a=[],i=0;i<t.length;i++)t[i]&&(r.push(i),a.push([]));for(var o=0;o<n.length;o++)for(var u=e[n[o].imageId],s=0;s<r.length;s++){var c=r[s];u&&u.brush&&u.brush.data&&u.brush.data[c]&&u.brush.data[c].pixelData&&a[s].push(o)}return{referencedFramesPerSegment:a,segmentIndicies:r}}(r,e,a),l=c.referencedFramesPerSegment,d=c.segmentIndicies,f=0,p=0;p<l.length;p++)f+=l[p].length;s.setNumberOfFrames(f);for(var g=0;g<d.length;g++){var h=d[g],m=l[g],v=m.map((function(e){return e+1})),S=a[h];s.addSegment(S,de(h,m,r,e,o),v)}return s.bitPackPixelData(),ae(s.dataset)},generateToolState:function(e,n,t){var a=oe.readFile(n),o=ue.naturalizeDataset(a.dict);o._meta=ue.namifyDataset(a.meta);var u=se.normalizeToDataset([o]),s=t.get("imagePlaneModule",e[0]);s||console.warn("Insufficient metadata, imagePlaneModule missing.");for(var c=function(e){var n=[];n[0]=e,n[1]=ne.h(e),n[2]=ne.v(e);var t=ee(e,Math.PI/2);return n[3]=t,n[4]=ne.h(t),n[5]=ne.v(t),n[6]=ee(e,Math.PI),n[7]=ee(e,1.5*Math.PI),n}(Array.isArray(s.rowCosines)?[].concat(m(s.rowCosines),m(s.columnCosines)):[s.rowCosines.x,s.rowCosines.y,s.rowCosines.z,s.columnCosines.x,s.columnCosines.y,s.columnCosines.z]),l=u.SharedFunctionalGroupsSequence,d=l.PlaneOrientationSequence?l.PlaneOrientationSequence.ImageOrientationPatient:void 0,f=u.Columns*u.Rows,p=function(e){var n=[],t=e.SegmentSequence;if(Array.isArray(t))for(var r=0;r<t.length;r++)n.push(t[r]);else n.push(t);return{seriesInstanceUid:e.ReferencedSeriesSequence.SeriesInstanceUID,data:n}}(u),g=function(e){var n=e.SegmentationType;if("BINARY"===n)return ie.unpack(e.PixelData);var t=new Uint8Array(e.PixelData),a=e.MaximumFractionalValue,i=void 0===t.find((function(e){return 0!==e&&e!==a}));if(!i)return void r.cM.warn("This is a fractional segmentation, which is not currently supported.");return r.cM.warn("This segmentation object is actually binary... processing as such."),t}(u),h=u.PerFrameFunctionalGroupsSequence,v={},S=!0,y=0;y<h.length;y++){var I=h[y],T=d||I.PlaneOrientationSequence.ImageOrientationPatient,D=he(i()(new Uint8Array(g.buffer,y*f,f),[u.Rows,u.Columns]),T,c);if(!D){console.warn("This segmentation object is not in-plane with the source data. Bailing out of IO. It'd be better to render this with vtkjs. "),S=!1;break}var C=I.SegmentIdentificationSequence.ReferencedSegmentNumber-1;pe(v,ge(l.DerivationImageSequence&&l.DerivationImageSequence.SourceImageSequence?l.DerivationImageSequence.SourceImageSequence[y]:I.DerivationImageSequence.SourceImageSequence,e,t),C,D)}if(!S)return;return{toolState:v,segMetadata:p}}};function de(e,n,t,r,a){for(var i=new Uint8Array(a.xy*n.length),o=0,u=0;u<n.length;u++)for(var s=t[r[n[u]].imageId].brush.data[e].pixelData,c=0;c<s.length;c++)i[o]=s[c],o++;return i}function fe(e,n){for(var t=0,r=0;r<n.length;r++)n[r]&&t++;return t}function pe(e,n,t,r){e[n]?e[n].brush?e[n].brush.data||(e[n].brush.data=[]):(e[n].brush={},e[n].brush.data=[]):(e[n]={},e[n].brush={},e[n].brush.data=[]),e[n].brush.data[t]={};var a=e[n].brush.data[t];a.pixelData=new Uint8Array(r.data.length);for(var i=a.pixelData,o=0;o<i.length;o++)r.data[o]?i[o]=1:i[o]=0}function ge(e,n,t){var r=e.ReferencedSOPInstanceUID,a=e.ReferencedFrameNumber;return a?function(e,n,t,r){var a=t.find((function(t){var a=r.get("sopCommonModule",t);if(a){var i=Number(t.split("frame=")[1]);return a.sopInstanceUID===e&&i===n-1}}));return a}(r,a,n,t):function(e,n,t){return n.find((function(n){var r=t.get("sopCommonModule",n);if(r)return r.sopInstanceUID===e}))}(r,n,t)}function he(e,n,t){return ve(n,t[0])?e:ve(n,t[1])?te.v(e):ve(n,t[2])?te.h(e):ve(n,t[3])?re(e):ve(n,t[4])?te.h(re(e)):ve(n,t[5])?te.v(re(e)):ve(n,t[6])?re(re(e)):ve(n,t[7])?re(re(re(e))):void 0}var me=1e-5;function ve(e,n){return Math.abs(e[0]-n[0])<me&&Math.abs(e[1]-n[1])<me&&Math.abs(e[2]-n[2])<me&&Math.abs(e[3]-n[3])<me&&Math.abs(e[4]-n[4])<me&&Math.abs(e[5]-n[5])<me}var Se=r.hC.orientation,ye=Se.rotateDirectionCosinesInPlane,Ie=Se.flipImageOrientationPatient,Te=Se.flipMatrix2D,De=Se.rotateMatrix902D,Ce=Se.nearlyEqual,Oe=r.hC.datasetToBlob,be=r.hC.BitArray,Re=r.hC.DicomMessage,xe=r.hC.DicomMetaDictionary,Me=r.oq.Normalizer,we=r.U7.Segmentation,Ae=r.hC.compression,Ee=Ae.encode,Pe=Ae.decode,Ne={generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=e[0].imageId.includes("?frame");return Ve(function(e,n,t){var r=[];if(n){var a=e[0].data.byteArray.buffer,i=Re.readFile(a),o=xe.naturalizeDataset(i.dict);o._meta=xe.namifyDataset(i.meta),r.push(o)}else for(var u=0;u<e.length;u++){var s=e[u].data.byteArray.buffer,c=Re.readFile(s),l=xe.naturalizeDataset(c.dict);l._meta=xe.namifyDataset(c.meta),r.push(l)}var d=Me.normalizeToDataset(r);return new we([d],t)}(e,r,t),n,t)},generateToolState:function(e,n,t){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,u=Re.readFile(n),s=xe.naturalizeDataset(u.dict);s._meta=xe.namifyDataset(u.meta);var c=Me.normalizeToDataset([s]),l=t.get("imagePlaneModule",e[0]),d=t.get("generalSeriesModule",e[0]).seriesInstanceUID;l||console.warn("Insufficient metadata, imagePlaneModule missing.");var f,p=function(e){var n=[];n[0]=e,n[1]=Ie.h(e),n[2]=Ie.v(e);var t=ye(e,Math.PI/2);return n[3]=t,n[4]=Ie.h(t),n[5]=Ie.v(t),n[6]=ye(e,Math.PI),n[7]=ye(e,1.5*Math.PI),n}(Array.isArray(l.rowCosines)?[].concat(m(l.rowCosines),m(l.columnCosines)):[l.rowCosines.x,l.rowCosines.y,l.rowCosines.z,l.columnCosines.x,l.columnCosines.y,l.columnCosines.z]),g=c.Columns*c.Rows,S=function(e,n){var t=e.SegmentSequence,r=[];r=Array.isArray(t)?[void 0].concat(m(t)):[void 0,t];return{seriesInstanceUid:n,data:r}}(c,d);if("1.2.840.10008.1.2.5"===c._meta.TransferSyntaxUID.Value[0]){var y=Array.isArray(c.PixelData)?c.PixelData:[c.PixelData];if(f=Pe(y,c.Rows,c.Columns),1===c.BitsStored)return void console.warn("No implementation for rle + bitbacking.")}else if(f=function(e){var n,t=e.SegmentationType;n=Array.isArray(e.PixelData)?e.PixelData[0]:e.PixelData;void 0===n&&r.cM.error("This segmentation pixeldata is undefined.");if("BINARY"===t)return be.unpack(n);var a=new Uint8Array(n),i=e.MaximumFractionalValue,o=void 0===a.find((function(e){return 0!==e&&e!==i}));if(!o)return;return r.cM.warn("This segmentation object is actually binary... processing as such."),a}(c),!f)throw new Error("Fractional segmentations are not yet supported");var I,T=function(e,n,t,r){var a=e.SharedFunctionalGroupsSequence,i=e.PerFrameFunctionalGroupsSequence,o=a.PlaneOrientationSequence?a.PlaneOrientationSequence.ImageOrientationPatient:void 0,u=i[0],s=o||u.PlaneOrientationSequence.ImageOrientationPatient,c=n.some((function(e){return je(s,e,r)}));if(c)return"Planar";if(function(e,n,t){var r=Math.abs(e[0]*n[0]+e[1]*n[1]+e[2]*n[2]),a=Math.abs(e[3]*n[3]+e[4]*n[4]+e[5]*n[5]);return(r<t||Math.abs(r-1)<t)&&(a<t||Math.abs(a-1)<t)}(s,n[0],r)&&t.includes(e.Rows)&&t.includes(e.Columns))return"Perpendicular";return"Oblique"}(c,p,[l.rows,l.columns,e.length],o),D=!1;a||(D=function(e,n,t,r,a,o){var u=n.SharedFunctionalGroupsSequence,s=n.PerFrameFunctionalGroupsSequence,c=n.SegmentSequence,l=n.Rows,d=n.Columns;if(c.length<2)return!1;for(var f=u.PlaneOrientationSequence?u.PlaneOrientationSequence.ImageOrientationPatient:void 0,p=d*l,g=s.length,m=new Map,S=function(){if(void 0===Ue(n,y))return console.warn("Could not retrieve the segment index for frame segment "+y+", skipping this frame."),"continue";var e=Ge(n,y,t,a,o);if(!e)return console.warn("Image not present in stack, can't import frame : "+y+"."),"continue";var r=t.findIndex((function(n){return n===e}));if(m.has(r)){var i=m.get(r);i.includes(y)||(i.push(y),m.set(r,i))}else m.set(r,[y])},y=0;y<g;++y)S();var I,T=function(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=v(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,u=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return o=e.done,e},e:function(e){u=!0,i=e},f:function(){try{o||null==t.return||t.return()}finally{if(u)throw i}}}}(m.entries());try{for(T.s();!(I=T.n()).done;)for(var D=h(I.value,2)[1],C=new Uint16Array(p).fill(0),O=0;O<D.length;++O){var b=D[O],R=s[b],x=f||R.PlaneOrientationSequence.ImageOrientationPatient,M=Be(i()(new Uint8Array(e.buffer,b*p,p),[l,d]),x,r,o);if(M){for(var w=M.data,A=0,E=w.length;A<E;++A)if(0!==w[A]&&(C[A]++,C[A]>1))return!0}else console.warn("Individual SEG frames are out of plane with respect to the first SEG frame, this is not yet supported, skipping this frame.")}}catch(e){T.e(e)}finally{T.f()}return!1}(f,c,e,p,t,o));switch(T){case"Planar":I=D?_e:Fe;break;case"Perpendicular":throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case"Oblique":throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.")}var C=[];C[0]=[];var O=[],b=g*e.length*2,R=[];return R[0]=new ArrayBuffer(b),I(O,C,R,f,c,e,p,t,o),{labelmapBufferArray:R,segMetadata:S,segmentsOnFrame:O,segmentsOnFrameArray:C}},fillSegmentation:Ve},qe={includeSliceSpacing:!0,rleEncode:!0};function Ve(e,n){for(var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=Object.assign({},qe,t),a=Array.isArray(n)?n:[n],i=0,o=[],u=function(){for(var e=a[s],n=e.labelmaps2D,t=e.metadata,r=[],u=1;u<t.length;u++)t[u]&&(r[u]=[]);for(var c=function(e){var t=n[e];n[e]&&t.segmentsOnLabelmap.forEach((function(n){0!==n&&(r[n].push(e),i++)}))},l=0;l<n.length;l++)c(l);o[s]=r},s=0;s<a.length;s++)u();e.setNumberOfFrames(i);for(var c=0;c<a.length;c++)for(var l=o[c],d=a[c],f=d.metadata,p=1;p<l.length;p++){var g=l[p];if(g){var h=g.map((function(e){return e+1})),m=f[p],v=ke(d,g);e.addSegmentFromLabelmap(m,v,p,h)}}if(r.rleEncode){var S=Ee(e.dataset.PixelData,i,e.dataset.Rows,e.dataset.Columns);e.assignToDataset({BitsAllocated:"8",BitsStored:"8",HighBit:"7",SegmentationType:"FRACTIONAL",SegmentationFractionalType:"PROBABILITY",MaximumFractionalValue:"255"}),e.dataset._meta.TransferSyntaxUID={Value:["1.2.840.10008.1.2.5"],vr:"UI"},e.dataset._vrMap.PixelData="OB",e.dataset.PixelData=S}else e.bitPackPixelData();return Oe(e.dataset)}function ke(e,n){for(var t=e.labelmaps2D,r=[],a=0;a<n.length;a++){var i=n[a];r.push(t[i].pixelData)}return r}function Ge(e,n,t,r,a){var i=void 0;if(!e)return i;var o=e.FrameOfReferenceUID,u=e.PerFrameFunctionalGroupsSequence,s=e.SourceImageSequence,c=e.ReferencedSeriesSequence;if(!u||0===u.length)return i;var l=u[n];if(!l)return i;var d=void 0;if(s&&0!==s.length)d=s[n];else if(l.DerivationImageSequence){var f=l.DerivationImageSequence;Array.isArray(f)&&(f=0!==f.length?f[0]:void 0),f&&(d=f.SourceImageSequence,Array.isArray(d)&&(d=0!==d.length?d[0]:void 0))}(d&&(i=function(e,n,t){var r=e.ReferencedSOPInstanceUID,a=e.ReferencedFrameNumber;return a?function(e,n,t,r){var a=t.find((function(t){var a=r.get("sopCommonModule",t);if(a){var i=Number(t.split("frame=")[1]);return a.sopInstanceUID===e&&i===n-1}}));return a}(r,a,n,t):function(e,n,t){return n.find((function(n){var r=t.get("sopCommonModule",n);if(r)return r.sopInstanceUID===e}))}(r,n,t)}(d,t,r)),void 0===i&&c)&&(i=function(e,n,t,r,a,i){if(void 0===e||void 0===t.PlanePositionSequence||void 0===t.PlanePositionSequence[0]||void 0===t.PlanePositionSequence[0].ImagePositionPatient)return;for(var o=0;o<r.length;++o){var u=a.get("instance",r[o]);if(void 0!==u&&void 0!==u.ImagePositionPatient&&u.FrameOfReferenceUID===n&&u.SeriesInstanceUID===e&&je(t.PlanePositionSequence[0].ImagePositionPatient,u.ImagePositionPatient,i))return r[o]}}((Array.isArray(c)?c[0]:c).SeriesInstanceUID,o,l,t,r,a));return i}function _e(e,n,t,r,a,o,s,c,l){for(var d=a.SharedFunctionalGroupsSequence,f=a.PerFrameFunctionalGroupsSequence,p=a.Rows,g=a.Columns,h=d.PlaneOrientationSequence?d.PlaneOrientationSequence.ImageOrientationPatient:void 0,m=g*p,v=m*o.length*2,S=1,y=0,I=t[y].slice(0),T=u()(n[y]),D=a.SegmentSequence.length,C=1;C<=D;++C){for(var O=function(d){var D=f[d],O=Ue(a,d);if(void 0===O)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");if(O!==C)return b=d,"continue";var R=h||D.PlaneOrientationSequence.ImageOrientationPatient,x=Be(i()(new Uint8Array(r.buffer,d*m,m),[p,g]),R,s,l);if(!x)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var M=Ge(a,d,o,c,l);if(!M)return console.warn("Image not present in stack, can't import frame : "+d+"."),b=d,"continue";var w=c.get("instance",M);if(p!==w.Rows||g!==w.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var A=o.findIndex((function(e){return e===M})),E=new Uint16Array(I,2*m*A,m),P=x.data,N=!1,q=0,V=x.data.length;q<V;++q)if(P[q]){if(0!==E[q]){++y>=S&&(t[y]=new ArrayBuffer(v),n[y]=[],S++),I=t[y].slice(0),T=u()(n[y]),d=0;break}E[q]=O,N=!0}N&&(T[A]||(T[A]=[]),T[A].push(O),e[A]||(e[A]=[]),e[A].push(O)),b=d},b=0,R=f.length;b<R;++b)O(b);t[y]=I.slice(0),n[y]=u()(T),I=t[y=0].slice(0),T=u()(n[y])}}var Ue=function(e,n){var t=e.PerFrameFunctionalGroupsSequence,r=e.SharedFunctionalGroupsSequence,a=t[n];return a&&a.SegmentIdentificationSequence?a.SegmentIdentificationSequence.ReferencedSegmentNumber:r.SegmentIdentificationSequence?r.SegmentIdentificationSequence.ReferencedSegmentNumber:void 0};function Fe(e,n,t,r,a,o,u,s,c){for(var l=a.SharedFunctionalGroupsSequence,d=a.PerFrameFunctionalGroupsSequence,f=a.Rows,p=a.Columns,g=l.PlaneOrientationSequence?l.PlaneOrientationSequence.ImageOrientationPatient:void 0,h=p*f,m=function(){var n=d[v],l=g||n.PlaneOrientationSequence.ImageOrientationPatient,m=Be(i()(new Uint8Array(r.buffer,v*h,h),[f,p]),l,u,c);if(!m)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var S=Ue(a,v);if(void 0===S)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");var y=Ge(a,v,o,s,c);if(!y)return console.warn("Image not present in stack, can't import frame : "+v+"."),"continue";var I=s.get("instance",y);if(f!==I.Rows||p!==I.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var T=o.findIndex((function(e){return e===y})),D=2*h*T,C=new Uint16Array(t[0],D,h),O=m.data,b=0,R=m.data.length;b<R;++b)if(O[b]){for(var x=b;x<R;++x)O[x]&&(C[x]=S);e[T]||(e[T]=[]),e[T].push(S);break}},v=0,S=d.length;v<S;++v)m()}function Be(e,n,t,r){return je(n,t[0],r)?e:je(n,t[1],r)?Te.v(e):je(n,t[2],r)?Te.h(e):je(n,t[3],r)?De(e):je(n,t[4],r)?De(Te.h(e)):je(n,t[5],r)?De(Te.v(e)):je(n,t[6],r)?De(De(e)):je(n,t[7],r)?De(De(De(e))):void 0}function je(e,n,t){if(e.length!=n.length)return!1;for(var r=0;r<e.length;++r)if(!Ce(e[r],n[r],t))return!1;return!0}var Le={generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===r)return Ne.generateSegmentation(e,n,t);if(3===r)return le.generateSegmentation(e,n,t);console.warn("No generateSegmentation adapater for cornerstone version ".concat(r,", exiting."))},generateToolState:function(e,n,t){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4;if(4===i)return Ne.generateToolState(e,n,t,r,a);if(3===i)return le.generateToolState(e,n,t);console.warn("No generateToolState adapater for cornerstone version ".concat(i,", exiting."))},fillSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===r)return Ne.fillSegmentation(e,n,t);console.warn("No generateSegmentation adapater for cornerstone version ".concat(r,", exiting."))}};var Ye=r.hC.TID300.CobbAngle,ze="CobbAngle",He=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup,o=l(l({},r),{},{rAngle:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},start2:{highlight:!0,drawnIndependently:!0},end2:{highlight:!0,drawnIndependently:!0},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=h(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o.handles.start2.x=u[4],o.handles.start2.y=u[5],o.handles.end2.x=u[6],o.handles.end2.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites;return{point1:n.start,point2:n.end,point3:n.start2,point4:n.end2,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CobbAngle",finding:t,findingSites:r||[]}}}]),e}();He.toolType=ze,He.utilityToolType=ze,He.TID300Representation=Ye,He.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===ze},N.registerTool(He);var Xe=r.hC.TID300.Angle,We="Angle",Je=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup,o=l(l({},r),{},{rAngle:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},middle:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=h(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.middle.x=u[2],o.handles.middle.y=u[3],o.handles.middle.x=u[4],o.handles.middle.y=u[5],o.handles.end.x=u[6],o.handles.end.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites;return{point1:n.start,point2:n.middle,point3:n.middle,point4:n.end,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Angle",finding:t,findingSites:r||[]}}}]),e}();Je.toolType=We,Je.utilityToolType=We,Je.TID300Representation=Xe,Je.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===We},N.registerTool(Je);var Ke=r.hC.TID300.Polyline,Qe=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n){var t=N.getSetupMeasurementData(n),r=t.defaultState,a=t.SCOORDGroup,i=t.NUMGroup,o=l(l({},r),{},{toolType:e.toolType,handles:{start:{},end:{},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},initialRotation:0},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=h(a.GraphicData,6);return o.handles.start.x=u[0],o.handles.start.y=u[1],u[2],u[3],o.handles.end.x=u[4],o.handles.end.y=u[5],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.finding,t=e.findingSites,r=e.cachedStats,a=void 0===r?{}:r,i=e.handles,o=i.start,u=i.end;return{points:[o,{x:o.x,y:u.y},u,{x:u.x,y:o.y}],area:a.area,perimeter:a.perimeter,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:RectangleRoi",finding:n,findingSites:t||[]}}}]),e}();Qe.toolType="RectangleRoi",Qe.utilityToolType="RectangleRoi",Qe.TID300Representation=Ke,Qe.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===q&&r===Qe.toolType},N.registerTool(Qe);var $e={Length:G,FreehandRoi:U,Bidirectional:j,EllipticalRoi:z,CircleRoi:W,ArrowAnnotate:$,MeasurementReport:N,Segmentation:Le,CobbAngle:He,Angle:Je,RectangleRoi:Qe},Ze=function(){return Ze=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var a in n=arguments[t])Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a]);return e},Ze.apply(this,arguments)};function en(e,n,t){if(t||2===arguments.length)for(var r,a=0,i=n.length;a<i;a++)!r&&a in n||(r||(r=Array.prototype.slice.call(n,0,a)),r[a]=n[a]);return e.concat(r||Array.prototype.slice.call(n))}var nn="Cornerstone3DTools@^0.1.0",tn={CodingSchemeDesignator:"CORNERSTONEJS",codeValues:{CORNERSTONEFREETEXT:"CORNERSTONEFREETEXT"}},rn=r.hC.TID1500,an=r.hC.addAccessors,on=r.U7.StructuredReport,un=r.oq.Normalizer,sn=rn.TID1500MeasurementReport,cn=rn.TID1501MeasurementGroup,ln=r.aT.DicomMetaDictionary,dn={CodingSchemeDesignator:"DCM",CodeValue:"121071"},fn={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},pn={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},gn=function(e,n,t){var r=e.ConceptNameCodeSequence;if(r){var a=r.CodingSchemeDesignator,i=r.CodeValue;return a==n.CodingSchemeDesignator&&i==n.CodeValue||t&&a==t.CodingSchemeDesignator&&i==t.CodeValue}};function hn(e,n,t,r){var a=n[e],i=mn.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(a&&a.data&&a.data.length&&i){var o=a.data.map((function(e){return function(e,n,t,r,a){var i=r.getTID300RepresentationArguments(e,a);return i.ReferencedSOPSequence=t,new r.TID300Representation(i)}(e,0,t,i,r)}));return new cn(o)}}var mn=function(){function e(){}return e.getCornerstoneLabelFromDefaultState=function(e){var n=e.findingSites,t=void 0===n?[]:n,r=e.finding,a=tn.codeValues.CORNERSTONEFREETEXT,i=t.find((function(e){return e.CodeValue===a}));return i?i.CodeMeaning:r&&r.CodeValue===a?r.CodeMeaning:void 0},e.generateDatasetMeta=function(){var e=new Uint8Array(2);return e[1]=1,{FileMetaInformationVersion:{Value:[e.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[ln.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}}},e.getSetupMeasurementData=function(n,t,r,a){var i=n.ContentSequence,o=I(i),u=o.find((function(e){return gn(e,dn)})),s=o.filter((function(e){return gn(e,fn,pn)}))||[],c=o.find((function(e){return"NUM"===e.ValueType})),l=I(c.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),d=l.ContentSequence.ReferencedSOPSequence,f=d.ReferencedSOPInstanceUID,p=d.ReferencedFrameNumber,g=t[f],h=r.get("imagePlaneModule",g),m=u?an(u.ConceptCodeSequence):void 0,v=s.map((function(e){return an(e.ConceptCodeSequence)})),S={description:void 0,sopInstanceUid:f,annotation:{annotationUID:ln.uid(),metadata:{toolName:a,referencedImageId:g,FrameOfReferenceUID:h.frameOfReferenceUID,label:""},data:void 0},finding:m,findingSites:v};return S.finding&&(S.description=S.finding.CodeMeaning),S.annotation.metadata.label=e.getCornerstoneLabelFromDefaultState(S),{defaultState:S,NUMGroup:c,SCOORDGroup:l,ReferencedSOPSequence:d,ReferencedSOPInstanceUID:f,ReferencedFrameNumber:p}},e.generateReport=function(n,t,r,a){var i=[],o={},u=[],s=e.generateDatasetMeta();Object.keys(n).forEach((function(a){var s=t.get("sopCommonModule",a),c=t.get("instance",a),l=s.sopInstanceUID,d=s.sopClassUID,f=c.SeriesInstanceUID;if(o[l]=f,!u.find((function(e){return e.SeriesInstanceUID===f}))){var p=e.generateDerivationSourceDataset(c);u.push(p)}var g=t.get("frameNumber",a),h=n[a],m=Object.keys(h),v={ReferencedSOPClassUID:d,ReferencedSOPInstanceUID:l,ReferencedFrameNumber:void 0};(c&&c.NumberOfFrames&&c.NumberOfFrames>1||un.isMultiframeSOPClassUID(d))&&(v.ReferencedFrameNumber=g);var S=[];m.forEach((function(e){var n=hn(e,h,v,r);n&&S.push(n)})),i=i.concat(S)}));var c=new sn({TID1501MeasurementGroups:i},a),l=new on(u,a),d=c.contentItem(u,Ze(Ze({},a),{sopInstanceUIDsToSeriesInstanceUIDMap:o}));return l.dataset=Object.assign(l.dataset,d),l.dataset._meta=s,l},e.generateToolState=function(n,t,r,a,i){if("1500"!==n.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var o=I(n.ContentSequence).find(T("Imaging Measurements")),u=I(o.ContentSequence).filter(T("Measurement Group")),s={},c=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,l=[];return Object.keys(c).forEach((function(e){l.push(c[e]),s[e]=[]})),u.forEach((function(e){var o;try{var u=I(e.ContentSequence).find((function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning})).TextValue,c=(null===(o=null==i?void 0:i.getToolClass)||void 0===o?void 0:o.call(i,e,n,l))||l.find((function(e){return e.isValidCornerstoneTrackingIdentifier(u)}));if(c){var d=c.getMeasurementData(e,t,r,a);console.log("=== ".concat(c.toolType," ===")),console.log(d),s[c.toolType].push(d)}}catch(n){console.warn("Unable to generate tool state for",e,n)}})),s},e.registerTool=function(n){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[n.utilityToolType]=n,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[n.toolType]=n,e.MEASUREMENT_BY_TOOLTYPE[n.toolType]=n.utilityToolType},e.CORNERSTONE_3D_TAG=nn,e.MEASUREMENT_BY_TOOLTYPE={},e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={},e.generateDerivationSourceDataset=function(n){var t=e.generateDatasetMeta();return Ze(Ze({},n),{_meta:t,_vrMap:{PixelData:"OW"}})},e}(),vn=r.hC.TID300.Point,Sn="ArrowAnnotate",yn="".concat(nn,":").concat(Sn),In=tn.codeValues,Tn=tn.CodingSchemeDesignator,Dn=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n,t,r,a){for(var i=mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=o.annotation.metadata.label,d=u.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(c,[d[p],d[p+1]]);f.push(g)}if(1===f.length){var h=a.get("imagePixelModule",c),m=10,v=10;if(h)m=h.columns/10,v=h.rows/10;var S=r(c,[d[0]+m,d[1]+v]);f.push(S)}var y=o;return y.annotation.data={text:l,handles:{arrowFirst:!0,points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},frameNumber:s},y}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,r=e.metadata,a=e.finding,i=e.findingSites,o=r.referencedImageId;if(!o)throw new Error("ArrowAnnotate.getTID300RepresentationArguments: referencedImageId is not defined");var u=t.handles,s=u.points,c=n(o,u.arrowFirst?s[0]:s[1]),l={points:[{x:c[0],y:c[1]}],trackingIdentifierTextValue:yn,findingSites:i||[]};return a&&a.CodeValue===In.CORNERSTONEFREETEXT||(a={CodeValue:In.CORNERSTONEFREETEXT,CodingSchemeDesignator:Tn,CodeMeaning:t.text}),l.finding=a,l}}]),e}();Dn.toolType=Sn,Dn.utilityToolType=Sn,Dn.TID300Representation=vn,Dn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===nn&&r===Sn},mn.registerTool(Dn);var Cn=r.hC.TID300.Bidirectional,On="Bidirectional",bn="".concat(nn,":").concat(On),Rn=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){var i,o=mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.ReferencedFrameNumber,c=u.annotation.metadata.referencedImageId,l=n.ContentSequence,d=I(l).find((function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning})),f=I(d.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),p=I(l).find((function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning})),g=I(p.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),h=[];[f,g].forEach((function(e){for(var n=e.GraphicData,t=0;t<n.length;t+=2){var a=r(c,[n[t],n[t+1]]);h.push(a)}}));var m=u;return m.annotation.data={handles:{points:[h[0],h[1],h[2],h[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(c)]={length:d.MeasuredValueSequence.NumericValue,width:p.MeasuredValueSequence.NumericValue},i),frameNumber:s},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Bidirectional.getTID300RepresentationArguments: referencedImageId is not defined");var l,d,f=u["imageId:".concat(c)]||{},p=f.length,g=f.width,h=s.points,m=[h[0],h[1]],v=[h[2],h[3]];Math.sqrt(Math.pow(m[0][0]-m[1][0],2)+Math.pow(m[0][1]-m[1][1],2)+Math.pow(m[0][2]-m[1][2],2))>Math.sqrt(Math.pow(v[0][0]-v[1][0],2)+Math.pow(v[0][1]-v[1][1],2)+Math.pow(v[0][2]-v[1][2],2))?(l=m,d=v):(l=v,d=m);var S=n(c,l[0]),y=n(c,l[1]),I=n(c,d[0]),T=n(c,d[1]);return{longAxis:{point1:{x:S[0],y:S[1]},point2:{x:y[0],y:y[1]}},shortAxis:{point1:{x:I[0],y:I[1]},point2:{x:T[0],y:T[1]}},longAxisLength:p,shortAxisLength:g,trackingIdentifierTextValue:bn,finding:r,findingSites:a||[]}},e.toolType=On,e.utilityToolType=On,e.TID300Representation=Cn,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===nn&&r===On},e}();mn.registerTool(Rn);var xn=r.hC.TID300.CobbAngle,Mn="Angle",wn="".concat(nn,":").concat(Mn),An=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,p=[],g=0;g<f.length;g+=2){var h=r(d,[f[g],f[g+1]]);p.push(h)}var m=u;return m.annotation.data={handles:{points:[p[0],p[1],p[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={angle:s?s.MeasuredValueSequence.NumericValue:null},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Angle.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=n(c,s.points[2]),p={x:l[0],y:l[1]},g={x:d[0],y:d[1]};return{point1:p,point2:g,point3:g,point4:{x:f[0],y:f[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:wn,finding:r,findingSites:a||[]}},e.toolType=Mn,e.utilityToolType=Mn,e.TID300Representation=xn,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===nn&&r===Mn},e}();mn.registerTool(An);var En=r.hC.TID300.CobbAngle,Pn="CobbAngle",Nn="".concat(nn,":").concat(Pn),qn=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,p=[],g=0;g<f.length;g+=2){var h=r(d,[f[g],f[g+1]]);p.push(h)}var m=u;return m.annotation.data={handles:{points:[p[0],p[1],p[2],p[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={angle:s?s.MeasuredValueSequence.NumericValue:null},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=n(c,s.points[2]),p=n(c,s.points[3]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},point3:{x:f[0],y:f[1]},point4:{x:p[0],y:p[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:Nn,finding:r,findingSites:a||[]}},e.toolType=Pn,e.utilityToolType=Pn,e.TID300Representation=En,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===nn&&r===Pn},e}();function Vn(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===nn&&r.toLowerCase()===this.toolType.toLowerCase()}mn.registerTool(qn);var kn=r.hC.TID300.Circle,Gn="CircleROI",_n=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,p=[],g=0;g<f.length;g+=2){var h=r(d,[f[g],f[g+1]]);p.push(h)}var m=u;return m.annotation.data={handles:{points:en([],p,!0),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={area:s?s.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CircleROI.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=[];f.push({x:l[0],y:l[1]}),f.push({x:d[0],y:d[1]});var p=u["imageId:".concat(c)]||{},g=p.area,h=p.radius;return{area:g,perimeter:2*Math.PI*h,radius:h,points:f,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:r,findingSites:a||[]}},e.trackingIdentifierTextValue="".concat(nn,":").concat(Gn),e.toolType=Gn,e.utilityToolType=Gn,e.TID300Representation=kn,e.isValidCornerstoneTrackingIdentifier=Vn,e}();mn.registerTool(_n);var Un=r.hC.TID300.Ellipse,Fn="EllipticalROI",Bn=1e-4,jn=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,c=o.NUMGroup,l=o.SCOORDGroup,d=o.ReferencedFrameNumber,f=u.annotation.metadata.referencedImageId,p=l.GraphicData,g=[],h=0;h<p.length;h+=2){var m=r(f,[p[h],p[h+1]]);g.push(m)}var v=s.R3.fromValues.apply(s.R3,g[0]),S=s.R3.fromValues.apply(s.R3,g[1]),y=s.R3.fromValues.apply(s.R3,g[2]),I=s.R3.fromValues.apply(s.R3,g[3]),T=s.R3.create();s.R3.sub(T,S,v),s.R3.normalize(T,T);var D=s.R3.create();s.R3.sub(D,I,y),s.R3.normalize(D,D);var C=a.get("imagePlaneModule",f);if(!C)throw new Error("imageId does not have imagePlaneModule metadata");var O=C.columnCosines,b=s.R3.fromValues(O[0],O[1],O[2]),R=s.R3.dot(b,T),x=s.R3.dot(b,D),M=Math.abs(R),w=Math.abs(x),A=[];Math.abs(M-1)<Bn?A=[g[0],g[1],g[2],g[3]]:Math.abs(w-1)<Bn?A=[g[2],g[3],g[0],g[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");var E=u;return E.annotation.data={handles:{points:en([],A,!0),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(f)]={area:c?c.MeasuredValueSequence.NumericValue:0},i),frameNumber:d},E},e.getTID300RepresentationArguments=function(e,n){var t,r,a,i,o=e.data,u=e.finding,s=e.findingSites,c=e.metadata,l=o.cachedStats,d=void 0===l?{}:l,f=o.handles,p=o.initialRotation||0,g=c.referencedImageId;if(!g)throw new Error("EllipticalROI.getTID300RepresentationArguments: referencedImageId is not defined");90==p||270==p?(r=n(g,f.points[2]),t=n(g,f.points[3]),a=n(g,f.points[0]),i=n(g,f.points[1])):(t=n(g,f.points[0]),r=n(g,f.points[1]),a=n(g,f.points[2]),i=n(g,f.points[3]));var h=[];return Math.abs(t[1]-r[1])>Math.abs(a[0]-i[0])?(h.push({x:t[0],y:t[1]}),h.push({x:r[0],y:r[1]}),h.push({x:a[0],y:a[1]}),h.push({x:i[0],y:i[1]})):(h.push({x:a[0],y:a[1]}),h.push({x:i[0],y:i[1]}),h.push({x:t[0],y:t[1]}),h.push({x:r[0],y:r[1]})),{area:(d["imageId:".concat(g)]||{}).area,points:h,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:u,findingSites:s||[]}},e.trackingIdentifierTextValue="".concat(nn,":").concat(Fn),e.toolType=Fn,e.utilityToolType=Fn,e.TID300Representation=Un,e.isValidCornerstoneTrackingIdentifier=Vn,e}();mn.registerTool(jn);var Ln=r.hC.TID300.Polyline,Yn="RectangleROI",zn="".concat(nn,":").concat(Yn),Hn=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,p=[],g=0;g<f.length;g+=2){var h=r(d,[f[g],f[g+1]]);p.push(h)}var m=u;return m.annotation.data={handles:{points:[p[0],p[1],p[3],p[2]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={area:s?s.MeasuredValueSequence.NumericValue:null},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=s.points.map((function(e){return n(c,e)})),d=u.area,f=u.perimeter;return{points:[l[0],l[1],l[3],l[2],l[0]],area:d,perimeter:f,trackingIdentifierTextValue:zn,finding:r,findingSites:a||[]}},e.toolType=Yn,e.utilityToolType=Yn,e.TID300Representation=Ln,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===nn&&r===Yn},e}();mn.registerTool(Hn);var Xn=r.hC.TID300.Length,Wn="Length",Jn="".concat(nn,":").concat(Wn),Kn=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n,t,r,a){for(var i=mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],p=0;p<d.length;p+=2){var h=r(l,[d[p],d[p+1]]);f.push(h)}var m=o;return m.annotation.data={handles:{points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:g({},"imageId:".concat(l),{length:u?u.MeasuredValueSequence.NumericValue:0}),frameNumber:c},m}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Length.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},distance:(u["imageId:".concat(c)]||{}).length,trackingIdentifierTextValue:Jn,finding:r,findingSites:a||[]}}}]),e}();Kn.toolType=Wn,Kn.utilityToolType=Wn,Kn.TID300Representation=Xn,Kn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===nn&&r===Wn},mn.registerTool(Kn);var Qn=r.hC.TID300.Polyline,$n="PlanarFreehandROI",Zn="".concat(nn,":").concat($n),et=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i=mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=u.GraphicData,f=[],p=0;p<d.length;p+=2){var g=r(l,[d[p],d[p+1]]);f.push(g)}var h=!0;s.R3.distance(f[f.length-1],f[0])<1e-5&&(f.pop(),h=!1);var m=[];h&&m.push(f[0],f[f.length-1]);var v=o;return v.annotation.data={polyline:f,isOpenContour:h,handles:{points:m,activeHandleIndex:null,textBox:{hasMoved:!1}},frameNumber:c},v},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.isOpenContour,u=t.polyline,s=i.referencedImageId;if(!s)throw new Error("PlanarFreehandROI.getTID300RepresentationArguments: referencedImageId is not defined");var c=u.map((function(e){return n(s,e)}));if(!o){var l=c[0];c.push([l[0],l[1]])}return{points:c,area:0,perimeter:0,trackingIdentifierTextValue:Zn,finding:r,findingSites:a||[]}},e.toolType=$n,e.utilityToolType=$n,e.TID300Representation=Qn,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===nn&&r===$n},e}();mn.registerTool(et);var nt=r.hC.TID300.Point,tt="Probe",rt="".concat(nn,":").concat(tt),at=function(){function e(){d(this,e)}return p(e,null,[{key:"getMeasurementData",value:function(n,t,r,a){for(var i=mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=u.GraphicData,d=[],f=0;f<l.length;f+=2){var p=r(c,[l[f],l[f+1]]);d.push(p)}var g=o;return g.annotation.data={handles:{points:d,activeHandleIndex:null,textBox:{hasMoved:!1}},frameNumber:s},g}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,r=e.metadata,a=e.finding,i=e.findingSites,o=r.referencedImageId;if(!o)throw new Error("Probe.getTID300RepresentationArguments: referencedImageId is not defined");return{points:t.handles.points.map((function(e){var t=n(o,e);return{x:t[0],y:t[1]}})),trackingIdentifierTextValue:rt,findingSites:i||[],finding:a}}}]),e}();at.toolType=tt,at.utilityToolType=tt,at.TID300Representation=nt,at.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=h(e.split(":"),2),t=n[0],r=n[1];return t===nn&&r===tt},mn.registerTool(at);var it={Bidirectional:Rn,CobbAngle:qn,Angle:An,Length:Kn,CircleROI:_n,EllipticalROI:jn,RectangleROI:Hn,ArrowAnnotate:Dn,Probe:at,PlanarFreehandROI:et,MeasurementReport:mn,CodeScheme:tn,CORNERSTONE_3D_TAG:nn},ot=r.aT.Colors,ut=r.aT.BitArray;function st(e){var n=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;switch(n){case 1:return Math.abs(e);case 2:return Math.sqrt(e[0]*e[0]+e[1]*e[1]);case 3:return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);default:for(var t=0,r=0;r<n;r++)t+=e[r]*e[r];return Math.sqrt(t)}}(e);return 0!==n&&(e[0]/=n,e[1]/=n,e[2]/=n),n}var ct={Cornerstone:$e,Cornerstone3D:it,VTKjs:{Segmentation:function(){function e(){d(this,e)}return p(e,null,[{key:"generateSegments",value:function(e){"Array"!==e.SegmentSequence.constructor.name&&(e.SegmentSequence=[e.SegmentSequence]),e.SegmentSequence.forEach((function(e){var n,t,r=(n=e.RecommendedDisplayCIELabValue,(t=ot.dicomlab2RGB(n).map((function(e){return Math.round(255*e)}))).push(255),t);segments[e.SegmentNumber]={color:r,functionalGroups:[],offset:null,size:null,pixelData:null}})),e.PerFrameFunctionalGroupsSequence.forEach((function(e){var n=e.SegmentIdentificationSequence.ReferencedSegmentNumber;segments[n].functionalGroups.push(e)}));var n=Math.ceil(e.Rows*e.Columns/8),t=0;return Object.keys(segments).forEach((function(r){var a=segments[r];a.numberOfFrames=a.functionalGroups.length,a.size=a.numberOfFrames*n,a.offset=t,t=a.offset+a.size;var i=e.PixelData.slice(a.offset,t);a.pixelData=ut.unpack(i);var o=function(e,n){var t={},r=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,a=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,i=n[0],o=n[n.length-1],u=i.PlanePositionSequence.ImagePositionPatient.map(Number),s=o.PlanePositionSequence.ImagePositionPatient.map(Number);t.origin=u,t.spacing=[r.PixelSpacing[1],r.PixelSpacing[0],r.SpacingBetweenSlices].map(Number),t.dimensions=[e.Columns,e.Rows,n.length].map(Number);var c,l,d,f,p,g,h=a.ImageOrientationPatient.map(Number),m=h.slice(0,3),v=h.slice(3,6);return t.planeNormal=[],c=m,l=v,d=t.planeNormal,f=c[1]*l[2]-c[2]*l[1],p=c[2]*l[0]-c[0]*l[2],g=c[0]*l[1]-c[1]*l[0],d[0]=f,d[1]=p,d[2]=g,t.sliceStep=[],function(e,n,t){t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2]}(s,u,t.sliceStep),st(t.sliceStep),t.direction=m.concat(v).concat(t.sliceStep),t}(e,a.functionalGroups);a.geometry=o})),segments}}]),e}()}}},78738:e=>{"use strict";e.exports=function(e){for(var n=new Array(e),t=0;t<e;++t)n[t]=t;return n}},28998:e=>{e.exports=function(e){return null!=e&&null!=e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}},73373:(e,n,t)=>{var r=t(78738),a=t(28998),i="undefined"!=typeof Float64Array;function o(e,n){return e[0]-n[0]}function u(){var e,n=this.stride,t=new Array(n.length);for(e=0;e<t.length;++e)t[e]=[Math.abs(n[e]),e];t.sort(o);var r=new Array(t.length);for(e=0;e<r.length;++e)r[e]=t[e][1];return r}function s(e,n){var t=["View",n,"d",e].join("");n<0&&(t="View_Nil"+e);var a="generic"===e;if(-1===n){var i="function "+t+"(a){this.data=a;};var proto="+t+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+t+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+t+"(a){return new "+t+"(a);}";return new Function(i)()}if(0===n){i="function "+t+"(a,d) {this.data = a;this.offset = d};var proto="+t+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+t+"_copy() {return new "+t+"(this.data,this.offset)};proto.pick=function "+t+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+t+"_get(){return "+(a?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+t+"_set(v){return "+(a?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+t+"(a,b,c,d){return new "+t+"(a,d)}";return new Function("TrivialArray",i)(c[e][0])}i=["'use strict'"];var o=r(n),s=o.map((function(e){return"i"+e})),l="this.offset+"+o.map((function(e){return"this.stride["+e+"]*i"+e})).join("+"),d=o.map((function(e){return"b"+e})).join(","),f=o.map((function(e){return"c"+e})).join(",");i.push("function "+t+"(a,"+d+","+f+",d){this.data=a","this.shape=["+d+"]","this.stride=["+f+"]","this.offset=d|0}","var proto="+t+".prototype","proto.dtype='"+e+"'","proto.dimension="+n),i.push("Object.defineProperty(proto,'size',{get:function "+t+"_size(){return "+o.map((function(e){return"this.shape["+e+"]"})).join("*"),"}})"),1===n?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),n<4?(i.push("function "+t+"_order(){"),2===n?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===n&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+t+"_set("+s.join(",")+",v){"),a?i.push("return this.data.set("+l+",v)}"):i.push("return this.data["+l+"]=v}"),i.push("proto.get=function "+t+"_get("+s.join(",")+"){"),a?i.push("return this.data.get("+l+")}"):i.push("return this.data["+l+"]}"),i.push("proto.index=function "+t+"_index(",s.join(),"){return "+l+"}"),i.push("proto.hi=function "+t+"_hi("+s.join(",")+"){return new "+t+"(this.data,"+o.map((function(e){return["(typeof i",e,"!=='number'||i",e,"<0)?this.shape[",e,"]:i",e,"|0"].join("")})).join(",")+","+o.map((function(e){return"this.stride["+e+"]"})).join(",")+",this.offset)}");var p=o.map((function(e){return"a"+e+"=this.shape["+e+"]"})),g=o.map((function(e){return"c"+e+"=this.stride["+e+"]"}));i.push("proto.lo=function "+t+"_lo("+s.join(",")+"){var b=this.offset,d=0,"+p.join(",")+","+g.join(","));for(var h=0;h<n;++h)i.push("if(typeof i"+h+"==='number'&&i"+h+">=0){d=i"+h+"|0;b+=c"+h+"*d;a"+h+"-=d}");i.push("return new "+t+"(this.data,"+o.map((function(e){return"a"+e})).join(",")+","+o.map((function(e){return"c"+e})).join(",")+",b)}"),i.push("proto.step=function "+t+"_step("+s.join(",")+"){var "+o.map((function(e){return"a"+e+"=this.shape["+e+"]"})).join(",")+","+o.map((function(e){return"b"+e+"=this.stride["+e+"]"})).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(h=0;h<n;++h)i.push("if(typeof i"+h+"==='number'){d=i"+h+"|0;if(d<0){c+=b"+h+"*(a"+h+"-1);a"+h+"=ceil(-a"+h+"/d)}else{a"+h+"=ceil(a"+h+"/d)}b"+h+"*=d}");i.push("return new "+t+"(this.data,"+o.map((function(e){return"a"+e})).join(",")+","+o.map((function(e){return"b"+e})).join(",")+",c)}");var m=new Array(n),v=new Array(n);for(h=0;h<n;++h)m[h]="a[i"+h+"]",v[h]="b[i"+h+"]";i.push("proto.transpose=function "+t+"_transpose("+s+"){"+s.map((function(e,n){return e+"=("+e+"===undefined?"+n+":"+e+"|0)"})).join(";"),"var a=this.shape,b=this.stride;return new "+t+"(this.data,"+m.join(",")+","+v.join(",")+",this.offset)}"),i.push("proto.pick=function "+t+"_pick("+s+"){var a=[],b=[],c=this.offset");for(h=0;h<n;++h)i.push("if(typeof i"+h+"==='number'&&i"+h+">=0){c=(c+this.stride["+h+"]*i"+h+")|0}else{a.push(this.shape["+h+"]);b.push(this.stride["+h+"])}");return i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+t+"(data,shape,stride,offset){return new "+t+"(data,"+o.map((function(e){return"shape["+e+"]"})).join(",")+","+o.map((function(e){return"stride["+e+"]"})).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",i.join("\n"))(c[e],u)}var c={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};e.exports=function(e,n,t,r){if(void 0===e)return(0,c.array[0])([]);"number"==typeof e&&(e=[e]),void 0===n&&(n=[e.length]);var o=n.length;if(void 0===t){t=new Array(o);for(var u=o-1,l=1;u>=0;--u)t[u]=l,l*=n[u]}if(void 0===r){r=0;for(u=0;u<o;++u)t[u]<0&&(r-=(n[u]-1)*t[u])}for(var d=function(e){if(a(e))return"buffer";if(i)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}(e),f=c[d];f.length<=o+1;)f.push(s(d,f.length-1));return(0,f[o+1])(e,n,t,r)}}}]);
//# sourceMappingURL=606.bundle.8231f07f019a28873413.js.map